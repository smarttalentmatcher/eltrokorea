<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            color: #000;
            line-height: 1.5;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: -1;
        }
        
        .page {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #fff;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        
        h1 {
            text-align: center;
            margin: 0;
            padding-bottom: 10px;
        }
        
        .top-menu {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .left-menu {
            display: flex;
            gap: 3px;
        }
        
        .right-menu {
            display: flex;
            gap: 3px;
        }
        
        .top-menu-btn {
            font-size: 0.9rem;
            padding: 5px 10px;
            margin: 0 3px;
            cursor: pointer;
            border: 1px solid #ccc;
            background: #fff;
            color: #000;
            border-radius: 3px;
            min-width: 80px;
            height: 30px;
            line-height: 1.2;
        }
        
        .top-menu-btn:hover {
            background: #f0f0f0;
            border-color: #999;
        }
        
        .top-menu-btn.mode-btn.selected {
            background: black;
            color: white;
            border-color: black;
        }
        
        .split-btn {
            width: 20px;
            height: 20px;
            font-size: 12px;
            padding: 0;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            border-radius: 3px;
            box-sizing: border-box;
        }
        
        .split-btn:hover {
            background: #f0f0f0;
            border-color: #999;
        }
        
        .split-btn.split-active {
            background: black;
            color: white;
            border-color: black;
        }
        
        .split-btn.split-inactive {
            background: #fff;
            color: black;
            border-color: #ccc;
        }
        
        .year-display {
            font-size: 0.9rem;
            font-weight: 600;
            color: #000;
            min-width: 50px;
            text-align: center;
            padding: 0 5px;
            margin: 0 3px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 30px;
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
        }
        
        .week-display {
            font-size: 0.9rem;
            font-weight: 600;
            color: #000;
            min-width: 50px;
            text-align: center;
            padding: 0 5px;
            margin: 0 3px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 30px;
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            cursor: help;
        }
        
        .week-display:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        
        .year-btn {
            min-width: 30px;
            width: 30px;
            padding: 5px;
        }

        .order-table-container {
            margin-top: 20px;
            overflow-x: auto;
            width: 100%;
            max-width: 100%;
            position: relative;
        }
        
        #orderTable {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
            border: 1px solid #ccc;
            font-size: 0.9rem;
        }
        
        #orderTable th,
        #orderTable td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }
        
        #orderTable thead th {
            position: sticky;
            top: 0;
            background-color: #f5f5f5;
            z-index: 10;
        }
        
        #orderTable th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        
        #orderTable td {
            font-size: 0.9rem;
        }
        
        .bottom-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            border-top: 1px solid #e0e0e0;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .expand-handle {
            position: absolute;
            top: -15px;
            left: 20px;
            z-index: 10;
        }

        .expand-btn {
            font-size: 0.8rem;
            padding: 4px 12px;
            cursor: pointer;
            border: 1px solid #ccc;
            background: #f8f8f8;
            color: #666;
            border-radius: 8px 8px 0 0;
            min-width: 40px;
            height: 20px;
            line-height: 1;
            transition: all 0.2s ease;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }

        .expand-btn:hover {
            background: #e8e8e8;
            border-color: #999;
            box-shadow: 0 -3px 6px rgba(0,0,0,0.15);
        }

        .expand-btn.expanded {
            transform: rotate(180deg);
            background: #e0e0e0;
        }

        .main-button-group {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: flex-start;
            padding: 15px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }

        .detail-button-area {
            margin-top: 10px;
            padding: 12px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            animation: slideDown 0.3s ease;
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .detail-button-area button {
            margin: 0;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        .order-table-container {
            margin-bottom: 120px;
        }

        .deleteButton {
            font-size: 0.75rem;
            padding: 1px 3px;
            cursor: pointer;
            margin: 0;
            display: inline-block;
            width: 22px;
            height: 18px;
            min-width: 22px;
            border: 1px solid #ccc;
            background: #fff;
            color: #000;
            border-radius: 3px;
            line-height: 1.2;
            box-sizing: border-box;
            text-align: center;
        }

        .deleteButton:hover {
            background: #f0f0f0;
            border-color: #999;
        }

        
        /* ì—´ í­ ì„¤ì • - 13ê°œ ì—´ (ë¶ˆëŸ‰ ì—´ ì¶”ê°€) */
        #orderTable th:nth-child(1), #orderTable td:nth-child(1) { width: 90px; max-width: 90px; min-width: 90px; text-align: center; white-space: nowrap; overflow: hidden; }
        #orderTable th:nth-child(2), #orderTable td:nth-child(2) { width: 100px; max-width: 100px; min-width: 100px; text-align: center; white-space: nowrap; overflow: hidden; }
        #orderTable th:nth-child(3), #orderTable td:nth-child(3) { width: 50px; max-width: 50px; min-width: 50px; text-align: center; white-space: nowrap; overflow: hidden; }
        #orderTable th:nth-child(4), #orderTable td:nth-child(4) { width: 100px; max-width: 100px; min-width: 100px; text-align: center; white-space: nowrap; overflow: hidden; }
        #orderTable th:nth-child(5), #orderTable td:nth-child(5) { width: 30px; max-width: 30px; min-width: 30px; text-align: center; white-space: nowrap; overflow: hidden; }
        #orderTable th:nth-child(6), #orderTable td:nth-child(6) { width: 30px; max-width: 30px; min-width: 30px; text-align: center; white-space: nowrap; overflow: hidden; }
        #orderTable th:nth-child(7), #orderTable td:nth-child(7) { width: 30px; max-width: 30px; min-width: 30px; text-align: center; white-space: nowrap; overflow: hidden; }
        #orderTable th:nth-child(8), #orderTable td:nth-child(8) { width: 30px; max-width: 30px; min-width: 30px; text-align: center; white-space: nowrap; overflow: hidden; }
        #orderTable th:nth-child(9), #orderTable td:nth-child(9) { width: 30px; max-width: 30px; min-width: 30px; text-align: center; white-space: nowrap; overflow: hidden; }
        #orderTable th:nth-child(10) { width: 70px; max-width: 70px; min-width: 70px; text-align: center; white-space: nowrap; overflow: hidden; }
        #orderTable td:nth-child(10) { width: 70px; max-width: 70px; min-width: 70px; text-align: right; white-space: nowrap; overflow: hidden; }
        #orderTable th:nth-child(11) { width: 30px; max-width: 30px; min-width: 30px; text-align: center; white-space: nowrap; overflow: hidden; }
        #orderTable td:nth-child(11) { width: 30px; max-width: 30px; min-width: 30px; text-align: right; white-space: nowrap; overflow: hidden; }
        #orderTable th:nth-child(12) { width: 70px; max-width: 70px; min-width: 70px; text-align: center; white-space: nowrap; overflow: hidden; }
        #orderTable td:nth-child(12) { width: 70px; max-width: 70px; min-width: 70px; text-align: right; white-space: nowrap; overflow: hidden; }
        #orderTable th:nth-child(13), #orderTable td:nth-child(13) { width: 30px; max-width: 30px; min-width: 30px; text-align: center; white-space: nowrap; overflow: hidden; }
        
        /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ - ì²´í¬ë˜ì§€ ì•Šìœ¼ë©´ í°ìƒ‰, ì²´í¬ë˜ë©´ íŒŒë€ìƒ‰ */
        .row-checkbox {
          transform: scale(1.2);
          cursor: pointer;
          -webkit-appearance: none;
          -moz-appearance: none;
          appearance: none;
          width: 12px;
          height: 12px;
          border: 1px solid #ccc;
          border-radius: 2px;
          background-color: white; /* ê¸°ë³¸ ìƒíƒœ: í°ìƒ‰ */
          position: relative;
        }
        
        /* ì²´í¬ëœ ìƒíƒœ: íŒŒë€ìƒ‰ */
        .row-checkbox:checked {
          background-color: #007bff;
          border-color: #007bff;
        }
        
        /* ì²´í¬ë§ˆí¬ í‘œì‹œ */
        .row-checkbox:checked::after {
          content: 'âœ“';
          position: absolute;
          top: -1px;
          left: 1px;
          color: white;
          font-size: 10px;
          font-weight: bold;
        }
        
        /* í˜¸ë²„ íš¨ê³¼ */
        .row-checkbox:hover {
          border-color: #007bff;
        }
    </style>
</head>
<body>
<div class="page">
    <h1>Shipment</h1>

    <div class="top-menu">
        <div class="left-menu">
            <button type="button" onclick="location.href='eltrokorea9.html'" class="top-menu-btn">Home</button>
            
            <button type="button" id="yearDownBtn" class="top-menu-btn year-btn">â–¼</button>
            <span id="yearDisplay" class="year-display">2025</span>
            <button type="button" id="yearUpBtn" class="top-menu-btn year-btn">â–²</button>
            
            <div class="week-display" id="weekDisplay" title="">
                <span id="weekNumber">W</span>
            </div>
        </div>
        
        <div class="right-menu">
            <button id="allBtn" class="top-menu-btn mode-btn selected">All</button>
            <button id="ntBtn" class="top-menu-btn mode-btn">NT</button>
            <button id="smBtn" class="top-menu-btn mode-btn">SM</button>
        </div>
    </div>

    <div class="order-table-container">
        <table id="orderTable">
            <thead>
                <tr>
                    <th>Delivery No</th>
                    <th>Order No</th>
                    <th>Item No</th>
                    <th>Item</th>
                    <th>ì£¼ë¬¸R</th>
                <th>ì„ ì R</th>
                <th>ë‚¨ì€R</th>
                    <th>ì™„ë£Œ</th>
                <th>Split</th>
                    <th>DeliveredKG</th>
                    <th>U/P</th>
                    <th>Price</th>
                    <th>ë¶ˆëŸ‰</th>
                </tr>
            </thead>
            <tbody id="orderTableBody">
                <!-- ë¹ˆ í…Œì´ë¸” -->
            </tbody>
        </table>
    </div>
</div>

<!-- í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ -->
<div class="bottom-buttons">
    <div class="expand-handle">
        <button id="expandButton" type="button" class="expand-btn">â–¼</button>
    </div>
    
    <div class="main-button-group">
        <button type="button" onclick="location.href='shipmentupdate.html'" class="top-menu-btn">Update</button>
    </div>

    <div id="detailButtonArea" class="detail-button-area" style="display: none;">
        <!-- í•„ìš”ì‹œ ì¶”ê°€ ë²„íŠ¼ë“¤ -->
    </div>
</div>

<script>
    // ========================================
    // ë…„ë„ ì„ íƒ ê´€ë ¨ ê¸°ëŠ¥ë“¤
    // ========================================
    
    // ë…„ë„ ì„ íƒ ì´ˆê¸°í™”
    let currentYear = new Date().getFullYear();

    // DOM ìš”ì†Œ ìºì‹±
    const yearDisplay = document.getElementById("yearDisplay");
    const yearUpBtn = document.getElementById("yearUpBtn");
    const yearDownBtn = document.getElementById("yearDownBtn");

    yearDisplay.textContent = currentYear;

    // ë…„ë„ ë³€ê²½ ê³µí†µ í•¨ìˆ˜
    function changeYear(delta) {
        const newYear = currentYear + delta;
        if (newYear >= 2020) {
            currentYear = newYear;
        yearDisplay.textContent = currentYear;
            loadOrderDataAndFillTable();
        }
    }

    // ë…„ë„ ì¦ê°€ ë²„íŠ¼
    yearUpBtn.addEventListener("click", () => {
        changeYear(1);
    });

    // ë…„ë„ ê°ì†Œ ë²„íŠ¼
    yearDownBtn.addEventListener("click", () => {
        changeYear(-1);
    });

    // ========================================
    // ì£¼ì°¨ ê³„ì‚° ê´€ë ¨ ê¸°ëŠ¥ë“¤
    // ========================================

    // ISO 8601 í‘œì¤€ì— ë”°ë¥¸ ì£¼ì°¨ ê³„ì‚° í•¨ìˆ˜
    function getWeekNumber(date) {
        const targetDate = new Date(date.valueOf());
        const dayNumber = (date.getUTCDay() + 6) % 7;
        targetDate.setUTCDate(targetDate.getUTCDate() - dayNumber + 3);
        const firstThursday = targetDate.valueOf();
        targetDate.setUTCMonth(0, 1);
        if (targetDate.getUTCDay() !== 4) {
            targetDate.setUTCMonth(0, 1 + ((4 - targetDate.getUTCDay()) + 7) % 7);
        }
        return 1 + Math.ceil((firstThursday - targetDate) / 604800000);
    }
    
    // ì£¼ì°¨ í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (DOM ìš”ì†Œ ìºì‹±)
    function updateWeekDisplay() {
        const now = new Date();
        const weekNumber = getWeekNumber(now);
        const year = now.getFullYear();
        const dateStr = now.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'long'
        });
        
        // DOM ìš”ì†Œ ìºì‹± (í•œ ë²ˆë§Œ ì¿¼ë¦¬)
        if (!updateWeekDisplay.weekDisplay) {
            updateWeekDisplay.weekDisplay = document.getElementById('weekDisplay');
            updateWeekDisplay.weekNumberSpan = document.getElementById('weekNumber');
        }
        
        updateWeekDisplay.weekNumberSpan.textContent = `W${weekNumber}`;
        updateWeekDisplay.weekDisplay.title = `${dateStr} (${year}ë…„ ${weekNumber}ì£¼ì°¨)`;
    }


    // ========================================
    // ëª¨ë“œ ë²„íŠ¼ ê´€ë ¨ ê¸°ëŠ¥ë“¤
    // ========================================
    
    // í˜„ì¬ ì„ íƒëœ ëª¨ë“œ (All, NT, SM)
    let currentMode = 'All';

    // DOM ìš”ì†Œ ìºì‹±
    const modeButtons = {
        all: document.getElementById('allBtn'),
        nt: document.getElementById('ntBtn'),
        sm: document.getElementById('smBtn')
    };

    // ëª¨ë“œ ë³€ê²½ ê³µí†µ í•¨ìˆ˜
    function changeMode(newMode) {
        if (currentMode === newMode) return; // ê°™ì€ ëª¨ë“œë©´ ë³€ê²½í•˜ì§€ ì•ŠìŒ
        
        // ì´ì „ ëª¨ë“œ ë²„íŠ¼ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
        const prevButton = modeButtons[currentMode.toLowerCase()];
        if (prevButton) {
            prevButton.classList.remove('selected');
        }
        
        // ìƒˆ ëª¨ë“œ ì„¤ì •
        currentMode = newMode;
        
        // ìƒˆ ëª¨ë“œ ë²„íŠ¼ì— selected í´ë˜ìŠ¤ ì¶”ê°€
        const newButton = modeButtons[newMode.toLowerCase()];
        if (newButton) {
            newButton.classList.add('selected');
        }
        
        // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        loadOrderDataAndFillTable();
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        // ì£¼ì°¨ í‘œì‹œ ì—…ë°ì´íŠ¸ ë° ë°ì´í„° ë¡œë“œ
        updateWeekDisplay();
        loadOrderDataAndFillTable();
        setupExpandButton();
        
        // ì´ˆê¸° ëª¨ë“œ ë²„íŠ¼ ìƒíƒœ ì„¤ì •
        modeButtons.all.classList.add('selected');
        
        // ëª¨ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        modeButtons.all.addEventListener('click', () => changeMode('All'));
        modeButtons.nt.addEventListener('click', () => changeMode('NT'));
        modeButtons.sm.addEventListener('click', () => changeMode('SM'));
        
    });
    
    // ========================================
    // ë°ì´í„° ë¡œë“œ ë° í…Œì´ë¸” ì±„ìš°ê¸° ê´€ë ¨ ê¸°ëŠ¥ë“¤
    // ========================================
    
    // ëª¨ë“œ ë§¤ì¹­ í•¨ìˆ˜
    function isModeMatch(order) {
        if (currentMode === 'All') return true;
        if (currentMode === 'NT') return order.mode === 'NT';
        if (currentMode === 'SM') return order.mode === 'SM-B' || order.mode === 'SM-C';
        return false;
    }
    
    // ì•„ì´í…œ ë°ì´í„° ë³€í™˜ í•¨ìˆ˜
    function createItemData(order, item) {
        const orderR = parseFloat(item.adjustment || item.quantity || '0');
        const completedR = parseFloat(item.deliveredR || '0');
        const leftoverR = orderR - completedR;
        
        // ê°™ì€ orderNoì˜ ëª¨ë“  ì•„ì´í…œ ë²ˆí˜¸ ìˆ˜ì§‘
        const allItemNos = order.items.map(i => i.itemNo);
        
        // í˜„ì¬ ì•„ì´í…œ ë²ˆí˜¸ì— .1ì´ ë¶™ì€ ì•„ì´í…œì´ ìˆëŠ”ì§€ í™•ì¸
        const hasSplitItem = allItemNos.includes(item.itemNo + '.1');
        
        return {
                            orderNo: order.orderNo,
                            itemNo: item.itemNo,
                            item: `PHD-${item.phd}(${item.width})${item.x}`,
            orderR: item.adjustment || item.quantity || '',
            completedR: item.deliveredR || '',
            leftoverR: leftoverR.toString(),
            status: item.deliveredkg || '',
            'd/nno': item['d/nno'] || '',
            'd/ndate': item['d/ndate'] || '',
            'p/ino': item['p/ino'] || '',
            'p/idate': item['p/idate'] || '',
            'p/ino2': item['p/ino2'] || '',
            'p/idate2': item['p/idate2'] || '',
                            'invoiceno': item.invoiceno || '',
                            'invoicedate': item.invoicedate || '',
            phd: item.phd,
            mode: order.mode,
            deliveredkg: item.deliveredkg || '0',
            'U/P': item['U/P'] || '',
            hasSplitItem: hasSplitItem,
            deliveryNo: item.deliveryNo || '',
            defective: item.defective || false
        };
    }
    
    // Split ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupSplitButtons() {
        const splitButtons = document.querySelectorAll('.split-btn');
        splitButtons.forEach(button => {
            button.addEventListener('click', function() {
                const row = this.closest('tr');
                const { orderNo, actualItemNo } = extractRowData(row, '');
                
                if (orderNo && actualItemNo) {
                    // Split ê¸°ëŠ¥ êµ¬í˜„
                    if (confirm(`ì•„ì´í…œ ${orderNo}-${actualItemNo}ì„ ë¶„í• í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        splitItem(actualItemNo, row);
                    }
                } else {
                    alert('ì£¼ë¬¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            });
        });
    }
    
    // orderData ë¡œë“œ ë° í…Œì´ë¸” ì±„ìš°ê¸°
    async function loadOrderDataAndFillTable() {
        try {
            const response = await fetch('/api/orders');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const orderData = await response.json();
            
            // Delivery Noë³„ë¡œ ì•„ì´í…œë“¤ì„ ê·¸ë£¹í™”
            const deliveryGroups = {};
            
            // íš¨ìœ¨ì ì¸ ë‹¨ì¼ ë£¨í”„ë¡œ í•„í„°ë§ ë° ê·¸ë£¹í™”
            for (const order of orderData) {
                if (!isModeMatch(order) || !order.items?.length) continue;
                
                for (const item of order.items) {
                    const deliveryNo = item.deliveryNo;
                    if (!deliveryNo) continue;
                    
                    // ë…„ë„ í•„í„°ë§
                    const oldestDate = getOldestDateFromItem(item);
                    if (oldestDate && oldestDate.getFullYear() !== currentYear) continue;
                    
                    // ê·¸ë£¹ ì´ˆê¸°í™”
                    if (!deliveryGroups[deliveryNo]) {
                        deliveryGroups[deliveryNo] = [];
                    }
                    
                    // ì•„ì´í…œ ë°ì´í„° ì¶”ê°€
                    deliveryGroups[deliveryNo].push(createItemData(order, item));
                }
            }
            
            // í…Œì´ë¸” ì±„ìš°ê¸°
            await fillTable(deliveryGroups);
            
        } catch (error) {
            console.error('OrderData ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // í…Œì´ë¸” ì±„ìš°ê¸° í•¨ìˆ˜
    async function fillTable(deliveryGroups) {
        const tbody = document.getElementById('orderTableBody');
        tbody.innerHTML = '';
        
        // Delivery Noë¥¼ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
        const sortedDeliveryNos = sortDeliveryNosByDate(deliveryGroups);
        
        for (const deliveryNo of sortedDeliveryNos) {
            const items = deliveryGroups[deliveryNo];
            
            for (let index = 0; index < items.length; index++) {
                const item = items[index];
                const row = document.createElement('tr');
                
                let deliveryNoCell = '';
                if (index === 0) {
                    // ì²« ë²ˆì§¸ ì•„ì´í…œì—ì„œë§Œ ëª¨ë“  ì •ë³´ë¥¼ í‘œì‹œí•˜ê³  rowspan ì„¤ì •
                    const firstItem = items[0];
                    
                    // p/ino2, p/idate2ëŠ” ëª¨ë“  ì•„ì´í…œì—ì„œ ì°¾ì•„ì„œ ì²« ë²ˆì§¸ë¡œ ë°œê²¬ëœ ê°’ ì‚¬ìš©
                    let pino2 = '', pidate2 = '';
                    for (const item of items) {
                        if (item['p/ino2'] && !pino2) pino2 = item['p/ino2'];
                        if (item['p/idate2'] && !pidate2) pidate2 = item['p/idate2'];
                    }
                    
                    
                    const dnnno = firstItem['d/nno'] || '';
                    const dndate = firstItem['d/ndate'] || '';
                    const pino = firstItem['p/ino'] || '';
                    const pidate = firstItem['p/idate'] || '';
                    const invoiceno = firstItem['invoiceno'] || '';
                    const invoicedate = firstItem['invoicedate'] || '';
                    
                    // deliveryNo, d/nno, (d/ndate), p/ino, (p/idate), p/ino2, (p/idate2), invoiceno, (invoicedate) í‘œì‹œ
                    let deliveryInfo = `${deliveryNo}`;
                    if (dnnno) {
                        deliveryInfo += `<br>${dnnno}`;
                    }
                    if (dndate) {
                        deliveryInfo += `<br>(${dndate})`;
                    }
                    if (pino) {
                        deliveryInfo += `<br>${pino}`;
                    }
                    if (pidate) {
                        deliveryInfo += `<br>(${pidate})`;
                    }
                    if (pino2) {
                        deliveryInfo += `<br>${pino2}`;
                    }
                    if (pidate2) {
                        deliveryInfo += `<br>(${pidate2})`;
                    }
                    if (invoiceno) {
                        deliveryInfo += `<br>${invoiceno}`;
                    }
                    if (invoicedate) {
                        deliveryInfo += `<br>(${invoicedate})`;
                    }
                    
                    deliveryNoCell = `<td rowspan="${items.length}">${deliveryInfo}</td>`;
                }
                
                // ì„ ì  ì²´í¬ë°•ìŠ¤ ìƒì„± (ë‚¨ì€R <= 0ì¼ ë•Œ ìë™ ì²´í¬, ì½ê¸° ì „ìš©)
                const leftoverR = parseFloat(item.leftoverR || '0');
                const isChecked = leftoverR <= 0 ? 'checked' : '';
                const deliveredCheckbox = `<input type="checkbox" class="row-checkbox" onchange="toggleDeliveredStatus(this)" disabled ${isChecked}>`;
                
                // ë¶ˆëŸ‰ ì²´í¬ë°•ìŠ¤ ìƒì„± (defective: trueì´ë©´ ì²´í¬)
                const isDefect = item.defective === true ? 'checked' : '';
                const defectCheckbox = `<input type="checkbox" class="defect-checkbox" onchange="toggleDefectStatus(this)" ${isDefect}>`;
                
                // KG ì—´ê³¼ U/P ì—´ ê°’ ì„¤ì • (ëª¨ë“  ëª¨ë“œì—ì„œ KG í‘œì‹œ, NT ëª¨ë“œì—ì„œë§Œ U/P í‘œì‹œ)
                const kgValue = item.status || ''; // ëª¨ë“  ëª¨ë“œì—ì„œ KG í‘œì‹œ
                const upValue = item.mode === 'NT' ? (item['U/P'] || '') : ''; // NT ëª¨ë“œì¼ ë•Œë§Œ U/P ê°’ í‘œì‹œ
                
                // Price ê³„ì‚°: U/P Ã— KG = Price
                let priceValue = '';
                if (upValue && kgValue) {
                    const up = parseFloat(upValue) || 0;
                    const kg = parseFloat(kgValue) || 0;
                    const price = up * kg;
                    priceValue = `$${price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                }
                
                row.innerHTML = `
                    ${deliveryNoCell}
                    <td>${item.orderNo}</td>
                    <td>${item.itemNo}</td>
                    <td>${item.item}</td>
                    <td>${item.orderR}</td>
                    <td>${item.completedR}</td>
                    <td>${item.leftoverR}</td>
                    <td style="text-align: center !important;">${deliveredCheckbox}</td>
                    <td style="text-align: center !important;"><button class="split-btn" ${item.hasSplitItem ? 'style="background-color: black; color: white; border-color: black;"' : ''}>S</button></td>
                    <td style="text-align: right !important;">${kgValue}</td>
                    <td style="text-align: right !important;">${upValue}</td>
                    <td style="text-align: right !important;">${priceValue}</td>
                    <td style="text-align: center !important;">${defectCheckbox}</td>
                `;
                
                tbody.appendChild(row);
            }
        }
        
        // Split ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        setupSplitButtons();
    }
    
    // ========================================
    // Delivery No ì •ë ¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
    // ========================================
    
    // DD.MM.YYYY í˜•ì‹ì˜ ë‚ ì§œ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜
    function parseDateString(dateString) {
        if (!dateString) return null;
        
        const parts = dateString.split('.');
        if (parts.length >= 3) {
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1; // JavaScript ì›”ì€ 0ë¶€í„° ì‹œì‘
            const year = parseInt(parts[2]);
            return new Date(year, month, day);
        }
        
        return null;
    }
    
    // ì•„ì´í…œì—ì„œ ê°€ì¥ ì˜¤ë˜ëœ ë‚ ì§œ(Date ê°ì²´)ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
    function getOldestDateFromItem(item) {
        const dates = [];
        
        // ê° ë‚ ì§œë¥¼ íŒŒì‹±í•˜ì—¬ Date ê°ì²´ë¡œ ë³€í™˜
        if (item['d/ndate']) {
            const parsedDate = parseDateString(item['d/ndate']);
            if (parsedDate && parsedDate.getTime() > 0) dates.push(parsedDate);
        }
        if (item['p/idate']) {
            const parsedDate = parseDateString(item['p/idate']);
            if (parsedDate && parsedDate.getTime() > 0) dates.push(parsedDate);
        }
        if (item['p/i2date']) {
            const parsedDate = parseDateString(item['p/i2date']);
            if (parsedDate && parsedDate.getTime() > 0) dates.push(parsedDate);
        }
        if (item['invoicedate']) {
            const parsedDate = parseDateString(item['invoicedate']);
            if (parsedDate && parsedDate.getTime() > 0) dates.push(parsedDate);
        }
        
        // ë‚ ì§œê°€ ì—†ìœ¼ë©´ null ë°˜í™˜
        if (dates.length === 0) return null;
        
        // ê°€ì¥ ì˜¤ë˜ëœ ë‚ ì§œ ë°˜í™˜
        return dates.reduce((oldest, current) => {
            return current < oldest ? current : oldest;
        });
    }
    
    // Delivery Noë¥¼ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ëŠ” í•¨ìˆ˜
    function sortDeliveryNosByDate(deliveryGroups) {
        return Object.keys(deliveryGroups).sort((a, b) => {
            const aItems = deliveryGroups[a];
            const bItems = deliveryGroups[b];
            
            // ê° delivery groupì˜ ì²« ë²ˆì§¸ ì•„ì´í…œì—ì„œ ë‚ ì§œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const aFirstItem = aItems[0];
            const bFirstItem = bItems[0];
            
            // ê° delivery groupì˜ ê°€ì¥ ì˜¤ë˜ëœ ë‚ ì§œ ì°¾ê¸°
            const aOldestDate = getOldestDateFromItem(aFirstItem);
            const bOldestDate = getOldestDateFromItem(bFirstItem);
            
            // ê°€ì¥ ì˜¤ë˜ëœ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ìµœì‹ ì´ ìœ„ë¡œ)
            if (aOldestDate && bOldestDate) {
                return bOldestDate.getTime() - aOldestDate.getTime();
            } else if (aOldestDate) {
                return -1; // aê°€ ë‚ ì§œê°€ ìˆìœ¼ë©´ aê°€ ìœ„ë¡œ
            } else if (bOldestDate) {
                return 1; // bê°€ ë‚ ì§œê°€ ìˆìœ¼ë©´ bê°€ ìœ„ë¡œ
            } else {
                // ë‘˜ ë‹¤ ë‚ ì§œê°€ ì—†ìœ¼ë©´ EK-ë²ˆí˜¸ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
                const aNum = parseInt(a.replace('EK-', '')) || 0;
                const bNum = parseInt(b.replace('EK-', '')) || 0;
                return bNum - aNum;
            }
        });
    }
    
    // ========================================
    // ì•„ì´í…œ Split ê´€ë ¨ ê¸°ëŠ¥ë“¤
    // ========================================
    
    // ì•„ì´í…œ Split ê¸°ëŠ¥ (ë‹¨ì¼ API í˜¸ì¶œ)
    async function splitItem(originalItemNo, row) {
        try {
            // 1. í•´ë‹¹ í–‰ì˜ ë°ì´í„° ìˆ˜ì§‘ (rowspan êµ¬ì¡° ê³ ë ¤)
            const { orderNo, actualItemNo } = extractRowData(row, originalItemNo);
            
            if (!orderNo || !actualItemNo) {
                alert('ì£¼ë¬¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // 2. api/splitë¡œ ìƒˆ ì•„ì´í…œ ìƒì„±
            const splitResponse = await fetch('/api/split', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderNo, originalItemNo: actualItemNo })
            });
            
            if (splitResponse.ok) {
                // 3. UI ì—…ë°ì´íŠ¸ - ìƒˆ ì•„ì´í…œì´ ìƒì„±ë˜ì—ˆìœ¼ë¯€ë¡œ hasSplitItemì€ true
                updateSplitButton(row, true);
                loadOrderDataAndFillTable();
                alert('ì•„ì´í…œì´ ì„±ê³µì ìœ¼ë¡œ ë¶„í• ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                const error = await splitResponse.json();
                alert(`ìƒˆ ì•„ì´í…œ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
            }
        } catch (error) {
            console.error('Split ì˜¤ë¥˜:', error);
            alert('Split ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    // í–‰ì—ì„œ ì£¼ë¬¸ ì •ë³´ ì¶”ì¶œ (rowspan êµ¬ì¡° ê³ ë ¤)
    function extractRowData(row, fallbackItemNo) {
        // ëª¨ë“  td ìš”ì†Œë¥¼ ê°€ì ¸ì™€ì„œ ì¸ë±ìŠ¤ë¡œ ì ‘ê·¼
        const cells = row.querySelectorAll('td');
        
        // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
        console.log('ğŸ” extractRowData ë””ë²„ê¹…:');
        console.log('  - cells.length:', cells.length);
        console.log('  - fallbackItemNo:', fallbackItemNo);
        
        // ëª¨ë“  ì…€ ë‚´ìš© ì¶œë ¥
        for (let i = 0; i < Math.min(cells.length, 5); i++) {
            console.log(`  - cells[${i}]:`, cells[i]?.textContent.trim());
        }
        
        // rowspan ë•Œë¬¸ì— ì²« ë²ˆì§¸ í–‰ê³¼ ë‚˜ë¨¸ì§€ í–‰ì˜ ì—´ êµ¬ì¡°ê°€ ë‹¤ë¦„
        // ì²« ë²ˆì§¸ í–‰: deliveryNoCell(rowspan) + Delete + Order No + Item No + Item + ...
        // ë‚˜ë¨¸ì§€ í–‰ë“¤: Delete + Order No + Item No + Item + ...
        
        let orderNo = '';
        let itemNo = fallbackItemNo;
        
        if (cells.length >= 4) {
            // ì²« ë²ˆì§¸ í–‰ì¸ì§€ í™•ì¸ (deliveryNoCellì´ ìˆëŠ”ì§€)
            const hasDeliveryNoCell = cells[0].hasAttribute('rowspan');
            console.log('  - hasDeliveryNoCell:', hasDeliveryNoCell);
            
            if (hasDeliveryNoCell) {
                // ì²« ë²ˆì§¸ í–‰: cells[1] = Order No, cells[2] = Item No (deliveryNoCellì´ ìˆìœ¼ë¯€ë¡œ ì¸ë±ìŠ¤ +1)
                orderNo = cells[1]?.textContent.trim() || '';
                itemNo = cells[2]?.textContent.trim() || fallbackItemNo;
                console.log('  - ì²« ë²ˆì§¸ í–‰: orderNo=', orderNo, 'itemNo=', itemNo);
            } else {
                // ë‚˜ë¨¸ì§€ í–‰ë“¤: cells[0] = Order No, cells[1] = Item No
                orderNo = cells[0]?.textContent.trim() || '';
                itemNo = cells[1]?.textContent.trim() || fallbackItemNo;
                console.log('  - ë‚˜ë¨¸ì§€ í–‰: orderNo=', orderNo, 'itemNo=', itemNo);
            }
        }
        
        console.log('  - ìµœì¢… ê²°ê³¼: orderNo=', orderNo, 'actualItemNo=', itemNo);
        return { orderNo, actualItemNo: itemNo };
    }
    
    // Split ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    function updateSplitButton(row, hasSplitItem) {
        const splitButton = row.querySelector('.split-btn');
        if (!splitButton) return;
        
        // CSS í´ë˜ìŠ¤ ì‚¬ìš©ìœ¼ë¡œ íš¨ìœ¨ì„± í–¥ìƒ
        if (hasSplitItem) {
            splitButton.classList.add('split-active');
            splitButton.classList.remove('split-inactive');
            } else {
            splitButton.classList.add('split-inactive');
            splitButton.classList.remove('split-active');
        }
    }
    
    // ========================================
    // ì„ ì  ì²´í¬ë°•ìŠ¤ í† ê¸€ í•¨ìˆ˜
    // ========================================
    
    // ì„ ì  ì™„ë£Œ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³€ê²½ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    // ë‚¨ì€R <= 0ì¼ ë•Œë§Œ ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë¨ (ì½ê¸° ì „ìš©)
    // ì„œë²„ ì €ì¥ ì—†ìŒ, ìˆ˜ë™ ì²´í¬/í•´ì œ ë¶ˆê°€ëŠ¥
    function toggleDeliveredStatus(checkbox) {
        const row = checkbox.closest('tr');
        
        // ë‚¨ì€R ê°’ ê³„ì‚°í•˜ì—¬ ì²´í¬ ì—¬ë¶€ í™•ì¸
        const orderRCell = row.querySelector('td:nth-child(6)'); // ì£¼ë¬¸R ì—´
        const completedRCell = row.querySelector('td:nth-child(7)'); // ì™„ë£ŒR ì—´
        
        const orderR = parseFloat(orderRCell?.textContent.trim() || '0');
        const completedR = parseFloat(completedRCell?.textContent.trim() || '0');
        const leftoverR = orderR - completedR;
        
        // ë‚¨ì€R <= 0ì´ë©´ ì²´í¬, ì•„ë‹ˆë©´ í•´ì œ
        checkbox.checked = leftoverR <= 0;
    }
    
    // ë¶ˆëŸ‰ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³€ê²½ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ (shipmentarchive NTì²­êµ¬ì„œ ë°©ì‹)
    async function toggleDefectStatus(checkbox) {
        const isDefect = checkbox.checked;
        
        // ì²´í¬ë°•ìŠ¤ê°€ ìˆëŠ” í–‰ì—ì„œ orderNoì™€ itemNo ì¶”ì¶œ
        const row = checkbox.closest('tr');
        const cells = row.querySelectorAll('td');
        
        let orderNo = '';
        let itemNo = '';
        
        // rowspan ë•Œë¬¸ì— ì²« ë²ˆì§¸ í–‰ê³¼ ë‚˜ë¨¸ì§€ í–‰ì˜ ì—´ êµ¬ì¡°ê°€ ë‹¤ë¦„
        const hasDeliveryNoCell = cells[0] && cells[0].hasAttribute('rowspan');
        
        if (hasDeliveryNoCell) {
            // ì²« ë²ˆì§¸ í–‰: cells[1] = Order No, cells[2] = Item No (deliveryNoCellì´ ìˆìœ¼ë¯€ë¡œ ì¸ë±ìŠ¤ +1)
            orderNo = cells[1]?.textContent.trim() || '';
            itemNo = cells[2]?.textContent.trim() || '';
        } else {
            // ë‚˜ë¨¸ì§€ í–‰ë“¤: cells[0] = Order No, cells[1] = Item No
            orderNo = cells[0]?.textContent.trim() || '';
            itemNo = cells[1]?.textContent.trim() || '';
        }
        
        try {
            await updateDefectStatusByOrderNo(orderNo, itemNo, isDefect);
        } catch (error) {
            console.error('ë¶ˆëŸ‰ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
            alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¼
            checkbox.checked = !isDefect;
        }
    }

    // ë¶ˆëŸ‰ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (orderNoì™€ itemNoë¡œ ì •í™•í•œ ì•„ì´í…œ í•˜ë‚˜ë§Œ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸)
    async function updateDefectStatusByOrderNo(orderNo, itemNo, isDefect) {
        try {
            // ëª¨ë“  ì£¼ë¬¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const allOrdersResponse = await fetch('/api/orders');
            const allOrders = await allOrdersResponse.json();

            // í•´ë‹¹ orderNoì™€ itemNoë¥¼ ê°€ì§„ ì£¼ë¬¸ ì°¾ê¸°
            const targetOrder = allOrders.find(order => order.orderNo === orderNo);
            
            if (!targetOrder) {
                alert(`ì£¼ë¬¸ ${orderNo}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            // í•´ë‹¹ ì•„ì´í…œ ì°¾ê¸°
            const targetItem = targetOrder.items.find(item => item.itemNo === itemNo);
            
            if (!targetItem) {
                alert(`ì£¼ë¬¸ ${orderNo}ì˜ ì•„ì´í…œ ${itemNo}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            // API í˜¸ì¶œë¡œ ì—…ë°ì´íŠ¸
            const updateData = {
                searchOrderBy: 'orderNo',
                orderNo: orderNo,
                searchMethod: 'itemNo',
                items: [{
                    itemNo: itemNo,
                    defective: isDefect
                }],
                itemUpdateFields: ['defective']
            };

            const response = await fetch('/api/updateOrder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            });

            const result = await response.json();

            if (response.ok && result.message && result.message.includes('successfully')) {
                alert(`ë¶ˆëŸ‰ ìƒíƒœê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${result.updatedItems || 1}ê°œ`);
            } else {
                alert(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }

        } catch (error) {
            console.error('ë¶ˆëŸ‰ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
            throw error;
        }
    }

    // ë¶ˆëŸ‰ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (shipmentarchive NTì²­êµ¬ì„œ ë°©ì‹) - ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€
    async function updateDefectStatus(deliveryNo, itemNo, isDefect) {
        try {
            // ëª¨ë“  ì£¼ë¬¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const allOrdersResponse = await fetch('/api/orders');
            const allOrders = await allOrdersResponse.json();

            // í•´ë‹¹ deliveryNoì™€ itemNoë¥¼ ê°€ì§„ ì£¼ë¬¸ë“¤ ì°¾ê¸°
            const ordersWithItem = allOrders.filter(order =>
                order.items && order.items.some(item => 
                    item.deliveryNo === deliveryNo && item.itemNo === itemNo
                )
            );

            if (ordersWithItem.length === 0) {
                alert(`í•´ë‹¹ deliveryNo(${deliveryNo})-itemNo(${itemNo})ë¥¼ ê°€ì§„ ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            let totalUpdated = 0;
            let totalSkipped = 0;
            let hasError = false;

            // ê° ì£¼ë¬¸ë³„ë¡œ API í˜¸ì¶œ
            for (const order of ordersWithItem) {
                try {
                    const updateData = {
                        searchOrderBy: 'orderNo',
                        orderNo: order.orderNo,
                        searchMethod: 'deliveryNo',
                        items: [{
                            deliveryNo: deliveryNo,
                            itemNo: itemNo,
                            defective: isDefect
                        }],
                        itemUpdateFields: ['defective']
                    };

                    const response = await fetch('/api/updateOrder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });

                    const result = await response.json();

                    if (response.ok && result.message && result.message.includes('successfully')) {
                        totalUpdated += result.updatedItems || 0;
                    } else {
                        totalSkipped += result.skippedItems || 0;
                        hasError = true;
                    }
                } catch (error) {
                    totalSkipped++;
                    console.error(`[ë¶ˆëŸ‰ ìƒíƒœ] ${order.orderNo} ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:`, error);
                    hasError = true;
                }
            }

            // ê²°ê³¼ í‘œì‹œ (shipmentarchiveì™€ ë™ì¼í•œ ë°©ì‹)
            if (totalUpdated > 0) {
                alert(`ë¶ˆëŸ‰ ìƒíƒœê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${totalUpdated}ê°œ${totalSkipped > 0 ? `, ê±´ë„ˆë›´ ì•„ì´í…œ: ${totalSkipped}ê°œ` : ''}`);
            } else if (hasError) {
                alert(`ì¼ë¶€ ë¶ˆëŸ‰ ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${totalUpdated}ê°œ, ê±´ë„ˆë›´ ì•„ì´í…œ: ${totalSkipped}ê°œ`);
            } else {
                alert(`ë¶ˆëŸ‰ ìƒíƒœ ì—…ë°ì´íŠ¸í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
            }

        } catch (error) {
            console.error('ë¶ˆëŸ‰ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
            throw error;
        }
    }
    
    // í™•ì¥/ì¶•ì†Œ ê¸°ëŠ¥
    function setupExpandButton() {
        const expandButton = document.getElementById("expandButton");
        if (expandButton) {
            expandButton.addEventListener("click", () => {
                const detailArea = document.getElementById("detailButtonArea");
                
                if (detailArea.style.display === "none") {
                    detailArea.style.display = "flex";
                    expandButton.classList.add("expanded");
                    expandButton.textContent = "â–²";
                } else {
                    detailArea.style.display = "none";
                    expandButton.classList.remove("expanded");
                    expandButton.textContent = "â–¼";
                }
            });
        }
    }
    
    // ì•„ì´í…œ ì •ë³´ ì‚­ì œ í•¨ìˆ˜ (X ë²„íŠ¼ ì—´ ì œê±°ë¡œ ì¸í•´ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
    /*
    async function deleteItemInfo(orderNo, itemNo) {
        if (!confirm(`ì •ë§ë¡œ ì´ ì•„ì´í…œì˜ D/N, P/I ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì£¼ë¬¸ë²ˆí˜¸: ${orderNo}\nì•„ì´í…œë²ˆí˜¸: ${itemNo}`)) {
            return;
        }

        try {
            const response = await fetch('/api/deletedeliveryNo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    orderNo: orderNo,
                    itemNo: itemNo
                })
            });

            const result = await response.json();

            if (result.success) {
                alert(`ì•„ì´í…œ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\nì‚­ì œëœ í•„ë“œ: deliveryNo, d/nno, d/ndate, p/ino, p/idate, p/i2no, p/i2date, invoiceno, invoicedate, invoicedue, invoiceprice, deliveredR, isshipmentcomplete`);
                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë³€ê²½ì‚¬í•­ ë°˜ì˜
                loadOrderDataAndFillTable();
            } else {
                alert(`ì‚­ì œ ì‹¤íŒ¨: ${result.message}`);
            }
        } catch (error) {
            alert('ì•„ì´í…œ ì •ë³´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    */
    
</script>
</body>
</html>