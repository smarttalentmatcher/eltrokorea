<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipment Archive</title>
  <!-- jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ (í•œê¸€ ì§€ì› ë²„ì „) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <!-- PDF-lib ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ (PDF í¸ì§‘ìš©) -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      color: #000;
      line-height: 1.5;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: -1;
    }
    .page {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      margin: 0;
      padding-bottom: 10px;
    }
    .top-menu {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .left-menu {
      display: flex;
      gap: 3px;
    }
    .right-menu {
      display: flex;
      gap: 3px;
    }
    .top-menu-btn {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
    }
    .top-menu-btn:hover {
      background: #f0f0f0;
      border-color: #999;
    }
    .top-menu-btn.mode-btn.selected {
      background: black;
      color: white;
      border-color: black;
    }
    
    /* ë…„ë„ í‘œì‹œ ìŠ¤íƒ€ì¼ */
    .year-display {
      font-size: 0.9rem;
      font-weight: 600;
      color: #000;
      min-width: 50px;
      text-align: center;
      padding: 0 5px;
      margin: 0 3px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 30px;
      background: #f8f8f8;
      border: 1px solid #e0e0e0;
      border-radius: 3px;
    }
    
    /* ë…„ë„ ë²„íŠ¼ íŠ¹ë³„ ìŠ¤íƒ€ì¼ */
    .year-btn {
      min-width: 30px;
      width: 30px;
      padding: 5px;
    }

    /* ì£¼ë¬¸ ëª©ë¡ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    .order-table-container {
      margin-top: 20px;
      overflow-x: auto;
      width: 100%;
    }
    
    
    #orderTable th,
    #orderTable td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
      vertical-align: middle;
    }
    
    #orderTable thead th {
      position: sticky;
      top: 0;
      background-color: #f5f5f5;
      z-index: 10;
    }
    
    #orderTable th {
      background-color: #f5f5f5;
      font-weight: bold;
    }
    
    #orderTable td {
      font-size: 0.9rem;
    }
    
    /* í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ ì „ì²´ - order.htmlê³¼ ë™ì¼ */
    .bottom-buttons {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      padding: 15px;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    /* í™•ì¥ ì†ì¡ì´ (ì„œë ì†ì¡ì´ì²˜ëŸ¼ ìœ„ìª½ì— íŠ€ì–´ë‚˜ì˜´) */
    .expand-handle {
      position: absolute;
      top: -15px;
      left: 20px;
      z-index: 10;
    }

    /* í™•ì¥/ì¶•ì†Œ ë²„íŠ¼ */
    .expand-btn {
      font-size: 0.8rem;
      padding: 4px 12px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #f8f8f8;
      color: #666;
      border-radius: 8px 8px 0 0;
      min-width: 40px;
      height: 20px;
      line-height: 1;
      transition: all 0.2s ease;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
    }

    .expand-btn:hover {
      background: #e8e8e8;
      border-color: #999;
      box-shadow: 0 -3px 6px rgba(0,0,0,0.15);
    }

    /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ - shipment.htmlê³¼ ë™ì¼ */
    .delivery-checkbox {
        transform: scale(1.2);
        cursor: pointer;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 12px;
        height: 12px;
        border: 1px solid #ccc;
        border-radius: 2px;
        background-color: white;
        position: relative;
    }
    
    .delivery-checkbox:checked {
        background-color: white;
        border-color: #007bff;
    }
    
    .delivery-checkbox:checked::after {
        content: 'âœ“';
        position: absolute;
        top: -2px;
        left: 1px;
        color: black;
        font-size: 10px;
        font-weight: bold;
    }

    /* íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .preview-modal-content {
      background: white;
      border-radius: 10px;
      width: 95%;
      max-width: 1200px;
      height: 90%;
      display: flex;
      flex-direction: row;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
    .preview-sidebar {
      width: 250px;
      background: #f8f9fa;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      border-radius: 10px 0 0 10px;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #ddd;
      background: #e9ecef;
      border-radius: 10px 0 0 0;
    }

    .sidebar-title {
      margin: 0;
      font-size: 16px;
      color: #495057;
    }

    .file-list {
      height: 540px;
      overflow-y: auto;
      padding: 10px 0;
    }

    .file-item {
      padding: 8px 15px;
      cursor: pointer;
      border-bottom: 1px solid #e9ecef;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .file-item:hover {
      background-color: #e9ecef;
    }

    .file-item.active {
      background-color: #007bff;
      color: white;
    }

    .file-icon {
      font-size: 16px;
    }

    .file-name {
      flex: 1;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .delete-file-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      padding: 2px 4px;
      border-radius: 3px;
      transition: background-color 0.2s;
      opacity: 0.7;
    }

    .delete-file-btn:hover {
      background-color: #dc3545;
      color: white;
      opacity: 1;
    }

    /* ntminusprice ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (accounting.htmlê³¼ ë™ì¼) */
    .delete-ntminusprice-btn {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      color: black;
      border: none;
      width: 14px;
      height: 14px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
      padding: 0;
      margin: 0;
    }

    .delete-ntminusprice-btn:hover {
      color: #666;
    }

    .delete-ntminusprice-btn:active {
      color: #333;
    }

    /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
    .preview-main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #ddd;
      background: #f8f9fa;
    }

    .preview-header h3 {
      margin: 0;
      font-size: 16px;
      color: #333;
    }

    .close-btn {
      background: transparent;
      color: #333;
      border: none;
      border-radius: 0;
      width: 30px;
      height: 30px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      background: #f8f9fa;
      color: #000;
    }

    .preview-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #ddd;
    }

    .nav-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .nav-btn:hover {
      background: #0056b3;
    }

    /* PDF Edit ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .pdf-edit-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: transparent;
      z-index: 1001;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .pdf-edit-modal-content {
      background: white;
      border-radius: 5px;
      width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      position: relative;
      display: flex;
      flex-direction: column;
      margin: 2% auto;
      border: 1px solid #888;
    }

    .pdf-edit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background-color: #f8f8f8;
      border-bottom: 1px solid #ddd;
      border-radius: 5px 5px 0 0;
    }

    .pdf-edit-header h2 {
      margin: 0;
      font-size: 1.2rem;
      color: #333;
    }

    .pdf-edit-close-btn {
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 5px;
    }

    .pdf-edit-close-btn:hover {
      background: #f0f0f0;
      color: #000;
    }

    .pdf-edit-upload-area {
      margin: 15px;
      text-align: center;
    }

    .pdf-edit-file-select-btn {
      width: 100%;
      padding: 12px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .pdf-edit-file-select-btn:hover {
      background: #0056b3;
    }

    .pdf-edit-upload-area.has-file {
      border: 2px dashed #ccc;
      border-radius: 5px;
      padding: 20px;
      background: #f9f9f9;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .pdf-edit-upload-area.has-file:hover {
      border-color: #007bff;
      background: #f0f8ff;
    }

    .pdf-edit-upload-area.has-file.dragover {
      border-color: #007bff;
      background: #e3f2fd;
    }

    .pdf-edit-file-info {
      margin-top: 10px;
      font-size: 0.85rem;
      color: #666;
    }

    .pdf-edit-file-name {
      font-weight: 500;
      color: #333;
      margin-bottom: 5px;
    }

    .pdf-edit-page-selector {
      margin: 15px;
      display: none;
    }

    .pdf-edit-page-selector h4 {
      margin: 0 0 10px 0;
      font-size: 0.9rem;
      color: #333;
    }

    .pdf-edit-page-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin: 10px 0;
      max-height: 150px;
      overflow-y: auto;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
    }

    .pdf-edit-page-checkbox {
      padding: 5px 10px;
      border: 2px solid #ddd;
      border-radius: 3px;
      cursor: pointer;
      background: white;
      transition: all 0.2s;
      min-width: 35px;
      text-align: center;
      font-size: 0.85rem;
    }

    .pdf-edit-page-checkbox:hover {
      border-color: #007bff;
      background: #f0f8ff;
    }

    .pdf-edit-page-checkbox.selected {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }

    .pdf-edit-output-area {
      margin: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      display: none;
    }

    .pdf-edit-output-area h4 {
      margin: 0 0 15px 0;
      font-size: 0.9rem;
      color: #333;
    }

    .pdf-edit-btn-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .pdf-edit-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .pdf-edit-btn-primary {
      background: #007bff;
      color: white;
    }

    .pdf-edit-btn-primary:hover {
      background: #0056b3;
    }

    .pdf-edit-btn-secondary {
      background: #6c757d;
      color: white;
    }

    .pdf-edit-btn-secondary:hover {
      background: #5a6268;
    }

    .pdf-edit-btn-success {
      background: #28a745;
      color: white;
    }

    .pdf-edit-btn-success:hover {
      background: #218838;
    }

    .pdf-edit-form-group {
      margin: 15px 0;
    }

    .pdf-edit-form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .pdf-edit-form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    .pdf-edit-progress-bar {
      width: 100%;
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin: 15px 0;
      display: none;
    }

    .pdf-edit-progress-fill {
      height: 100%;
      background: #007bff;
      width: 0%;
      transition: width 0.3s;
    }

    .pdf-edit-status {
      margin: 15px 0;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }

    .pdf-edit-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .pdf-edit-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .pdf-edit-status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .pdf-edit-form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    .nav-btn:disabled {
      background: #007bff;
      opacity: 0.5;
      cursor: not-allowed;
    }

    .download-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .download-btn:hover {
      background: #218838;
    }

    #fileCounter {
      font-weight: bold;
      color: #333;
    }

    .preview-body {
      flex: 1;
      padding: 20px;
      overflow: auto;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .preview-iframe-container {
      width: 100%;
      max-width: 800px;
      height: 600px;
      border: 1px solid #ddd;
      border-radius: 5px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .preview-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .preview-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-top: 1px solid #ddd;
      background: #f8f9fa;
      border-radius: 0 0 10px 10px;
    }

    .expand-btn.expanded {
      transform: rotate(180deg);
      background: #e0e0e0;
    }

    /* ê¸°ë³¸ ë²„íŠ¼ ê·¸ë£¹ ë ˆì´ì•„ì›ƒ */
    .main-button-group {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
      padding: 15px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
    }

    /* ìƒì„¸ ë²„íŠ¼ ì˜ì—­ */
    .detail-button-area {
      margin-top: 10px;
      padding: 12px;
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      animation: slideDown 0.3s ease;
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .detail-button-area button {
      margin: 0;
    }

    /* ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Email ë²„íŠ¼ - order.html ë²„íŠ¼ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼ */
    #emailBtn {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
      transition: all 0.2s ease;
    }

    #emailBtn:hover {
      background: #f0f0f0;
      border-color: #999;
    }

    /* PDF EDIT ë²„íŠ¼ - Email ë²„íŠ¼ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼ */
    #pdfEditBtn {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
      transition: all 0.2s ease;
    }

    #pdfEditBtn:hover {
      background: #f0f0f0;
      border-color: #999;
    }

    /* í…Œì´ë¸” í•˜ë‹¨ ì—¬ë°± (ê³ ì • ë²„íŠ¼ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡) */
    .order-table-container {
      margin-bottom: 120px;
    }
    
    /* ì—´ í­ ì„¤ì • - orderarchive.htmlê³¼ ë™ì¼í•˜ê²Œ íƒ€ì´íŠ¸í•˜ê²Œ ì¡°ì • */
    #orderTable {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    
    /* ëª¨ë“  ì—´ì— ê³µí†µ ìŠ¤íƒ€ì¼ ì ìš© */
    #orderTable th,
    #orderTable td {
      width: 100px;
      max-width: 100px;
      min-width: 100px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      vertical-align: middle;
    }
  </style>
</head>
<body>
<div class="page">
  <h1>Shipment Archive</h1>

  <div class="top-menu">
    <!-- ì™¼ìª½: Home, Year -->
    <div class="left-menu">
      <button type="button" onclick="location.href='eltrokorea9.html'" class="top-menu-btn">Home</button>
      
      <!-- ë…„ë„ ì„ íƒ ë²„íŠ¼ -->
      <button type="button" id="yearDownBtn" class="top-menu-btn year-btn">â–¼</button>
      <span id="yearDisplay" class="year-display">2025</span>
      <button type="button" id="yearUpBtn" class="top-menu-btn year-btn">â–²</button>
      <button type="button" id="addBtn" class="top-menu-btn">Add</button>
    </div>
    <!-- ì˜¤ë¥¸ìª½: NT, SM -->
    <div class="right-menu">
      <button id="ntBtn" class="top-menu-btn mode-btn selected">NT</button>
      <button id="smBtn" class="top-menu-btn mode-btn">SM</button>
    </div>
  </div>

  <div class="order-table-container">
    <table id="orderTable">
      <thead>
        <tr>
          <th>Delivery No</th>
          <th>Delivery Note</th>
          <th>Proforma Invoice</th>
          <th>SWIFT</th>
          <th>Invoice</th>
          <th>BL</th>
          <th>Origin</th>
          <th>ë¶„ì„í‘œ</th>
          <th>í†µê´€</th>
          <th>NTì²­êµ¬ì„œ</th>
        </tr>
        <tr id="secondHeaderRow" style="display: none;">
          <th></th>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
        </tr>
      </thead>
      <tbody id="orderTableBody">
        <!-- ì£¼ë¬¸ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </tbody>
    </table>
  </div>
</div>

<!-- í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ - order.htmlê³¼ ë™ì¼í•œ êµ¬ì¡° -->
<div class="bottom-buttons">
  <!-- í™•ì¥/ì¶•ì†Œ ë²„íŠ¼ (ì„œë ì†ì¡ì´ì²˜ëŸ¼ ìœ„ìª½ì— íŠ€ì–´ë‚˜ì˜´) -->
  <div class="expand-handle">
    <button id="expandButton" type="button" class="expand-btn">â–¼</button>
  </div>
  
  <!-- ê¸°ë³¸ ë²„íŠ¼ ì˜ì—­ (í•­ìƒ ë³´ì„) -->
  <div class="main-button-group">
    <button id="emailBtn">Email</button>
    <button id="pdfEditBtn">PDF EDIT</button>
  </div>

  <!-- í™•ì¥ ê°€ëŠ¥í•œ ìƒì„¸ ë²„íŠ¼ ì˜ì—­ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€) -->
  <div id="detailButtonArea" class="detail-button-area" style="display: none;">
    <!-- í•„ìš”ì‹œ ì¶”ê°€ ë²„íŠ¼ë“¤ -->
    </div>
</div>

<!-- PDF Edit ëª¨ë‹¬ -->
<div id="pdfEditModal" class="pdf-edit-modal">
  <div class="pdf-edit-modal-content">
    <div class="pdf-edit-header">
      <h2>PDF í¸ì§‘</h2>
      <button class="pdf-edit-close-btn" onclick="closePdfEditModal()">Ã—</button>
    </div>
    
    <!-- PDF ì—…ë¡œë“œ ì˜ì—­ -->
    <div class="pdf-edit-upload-area" id="pdfEditUploadArea">
      <button class="pdf-edit-file-select-btn" id="pdfEditFileSelectBtn">ğŸ“„ íŒŒì¼ ì„ íƒ</button>
      <input type="file" id="pdfEditFileInput" accept=".pdf" style="display: none;">
      <div class="pdf-edit-file-info" id="pdfEditFileInfo" style="display: none;">
        <div class="pdf-edit-file-name" id="pdfEditFileName"></div>
        <div>íŒŒì¼ì„ ë‹¤ì‹œ ë“œë˜ê·¸í•˜ì—¬ êµì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
      </div>
    </div>

    <!-- í˜ì´ì§€ ì„ íƒ ì˜ì—­ -->
    <div class="pdf-edit-page-selector" id="pdfEditPageSelector" style="display: none;">
      <h4>ì¶”ì¶œí•  í˜ì´ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</h4>
      <div class="pdf-edit-page-checkboxes" id="pdfEditPageCheckboxes"></div>
    </div>

    <!-- ì €ì¥ ì„¤ì • -->
    <div class="pdf-edit-output-area" id="pdfEditOutputArea" style="display: none;">
      <div class="pdf-edit-form-group">
        <label for="pdfEditFileName">ì €ì¥í•  íŒŒì¼ëª…:</label>
        <input type="text" id="pdfEditOutputFileName" placeholder="ì˜ˆ: extracted_pages (ìë™ìœ¼ë¡œ .pdf ì¶”ê°€)">
      </div>
      <div class="pdf-edit-btn-group">
        <button class="pdf-edit-btn pdf-edit-btn-success" onclick="savePdfToServer()">ì €ì¥</button>
      </div>
    </div>

    <!-- ìƒíƒœ ë©”ì‹œì§€ -->
    <div class="pdf-edit-status" id="pdfEditStatus" style="display: none;"></div>
  </div>
</div>

<!-- íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
<div id="previewModal" class="preview-modal" style="display: none;">
  <div class="preview-modal-content">
    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
    <div class="preview-sidebar">
      <div class="sidebar-header">
        <h3 class="sidebar-title">ğŸ“ íŒŒì¼ ëª©ë¡</h3>
        <div></div>
      </div>
      <div class="file-list" id="fileList">
        <!-- íŒŒì¼ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </div>
    </div>
    
    <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
    <div class="preview-main">
      <div class="preview-header">
        <h3 id="previewTitle">íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°</h3>
        <button id="closePreviewBtn" class="close-btn">&times;</button>
      </div>
      <div class="preview-navigation">
        <button id="prevFileBtn" class="nav-btn">â¬…ï¸ ì´ì „</button>
        <span id="fileCounter">1 / 1</span>
        <button id="nextFileBtn" class="nav-btn">ë‹¤ìŒ â¡ï¸</button>
      </div>
      <div class="preview-body">
        <div class="preview-iframe-container">
          <iframe id="previewFrame" class="preview-iframe" src="" frameborder="0"></iframe>
        </div>
      </div>
      <div class="preview-footer">
        <div></div>
        <button id="downloadCurrentBtn" class="download-btn">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
      </div>
    </div>
  </div>
</div>

<script>
        // ========================================
        // ë‚ ì§œ ì²˜ë¦¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ (shipment.htmlê³¼ ë™ì¼í•œ íš¨ìœ¨ì ì¸ ë¡œì§)
        // ========================================
        
        // DD.MM.YYYY í˜•ì‹ì˜ ë‚ ì§œ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜
        function parseDateString(dateString) {
            if (!dateString) return null;
            
            const parts = dateString.split('.');
            if (parts.length >= 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // JavaScript ì›”ì€ 0ë¶€í„° ì‹œì‘
                const year = parseInt(parts[2]);
                return new Date(year, month, day);
            }
            
            return null;
        }
        
        // ì•„ì´í…œì—ì„œ ê°€ì¥ ì˜¤ë˜ëœ ë‚ ì§œ(Date ê°ì²´)ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ (ìµœì í™”ëœ ë²„ì „)
        function getOldestDateFromItem(item) {
            const dateFields = ['d/ndate', 'p/idate', 'invoicedate'];
            let oldestDate = null;
            
            // ë‹¨ì¼ ë£¨í”„ë¡œ ìµœì í™”
            for (const field of dateFields) {
                if (item[field]) {
                    const parsedDate = parseDateString(item[field]);
                    if (parsedDate && parsedDate.getTime() > 0) {
                        if (!oldestDate || parsedDate < oldestDate) {
                            oldestDate = parsedDate;
                        }
                    }
                }
            }
            
            return oldestDate;
        }
        
        // ========================================
        // ëª¨ë“œ ë²„íŠ¼ ê´€ë ¨ ê¸°ëŠ¥ë“¤ 
        // ========================================
        
        // í˜„ì¬ ì„ íƒëœ ëª¨ë“œ (NT, SM)
        let currentMode = 'NT';

        // DOM ìš”ì†Œ ìºì‹±
        const modeButtons = {
            nt: document.getElementById('ntBtn'),
            sm: document.getElementById('smBtn')
        };

        // ëª¨ë“œ ë³€ê²½ ê³µí†µ í•¨ìˆ˜ (ìµœì í™”ëœ ë²„ì „)
        function changeMode(newMode) {
            if (currentMode === newMode) return;
            
            // ë²„íŠ¼ í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸ (ì¤‘ë³µ ì œê±°)
            const prevButton = modeButtons[currentMode.toLowerCase()];
            const newButton = modeButtons[newMode.toLowerCase()];
            
            prevButton?.classList.remove('selected');
            newButton?.classList.add('selected');
            
            // ëª¨ë“œ ë³€ê²½
            currentMode = newMode;
            
            // í—¤ë” ë° ë°ì´í„° ì—…ë°ì´íŠ¸
            updateSecondHeader();
            loadOrderData();
        }
        
        // ë‘ ë²ˆì§¸ í—¤ë” í–‰ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ìµœì í™”ëœ ë²„ì „)
        function updateSecondHeader() {
            const secondHeaderRow = document.getElementById('secondHeaderRow');
            if (!secondHeaderRow) return;
            
            // ëª¨ë“œë³„ í—¤ë” ë‚´ìš© ì •ì˜
            const headerContents = {
                'NT': `
                        <th></th>
                        <th>NT<br>ê´€ì„¸ì‚¬</th>
                        <th>EK</th>
                        <th>TF</th>
                        <th>ê´€ì„¸ì‚¬</th>
                        <th>ê´€ì„¸ì‚¬<br>í¬ì›Œë”+ëª…íŒ ìš°í¸</th>
                        <th>NT</th>
                        <th>NT</th>
                        <th>ê´€ì„¸ì‚¬<br>ì„¸ë¬´ì‚¬</th>
                        <th>NT</th>
                `,
                'SM': `
                <th></th>
                <th>SM ìš°í¸</th>
                <th>ì—†ìŒ</th>
                <th>ì—†ìŒ</th>
                <th>SM ìš°í¸</th>
                <th>SM ìš°í¸</th>
                <th>SM ìš°í¸</th>
                <th>SM</th>
                <th>ì—†ìŒ</th>
                <th>ì—†ìŒ</th>
                `
            };
            
            const content = headerContents[currentMode];
            if (content) {
                // NT/SM ëª¨ë“œ: í‘œì‹œ ë° ë‚´ìš© ì„¤ì •
                secondHeaderRow.style.display = 'table-row';
                secondHeaderRow.innerHTML = content;
            } else {
                // ëª¨ë“œê°€ ì—†ìœ¼ë©´ ìˆ¨ê¹€
                secondHeaderRow.style.display = 'none';
            }
        }
        
        // ë…„ë„ ì„ íƒ ì´ˆê¸°í™”
        let currentYear = new Date().getFullYear();
        const yearDisplay = document.getElementById("yearDisplay");
        yearDisplay.textContent = currentYear;
        
        // ========================================
        // ë°ì´í„° ë¡œë“œ ë° í…Œì´ë¸” ì±„ìš°ê¸° ê´€ë ¨ ê¸°ëŠ¥ë“¤ 
        // ========================================
        
        // ëª¨ë“œ ë§¤ì¹­ í•¨ìˆ˜
        function isModeMatch(order) {
            if (currentMode === 'NT') return order.mode === 'NT';
            if (currentMode === 'SM') return order.mode === 'SM-B' || order.mode === 'SM-C';
            return false;
        }
        
        // ì„œë²„ì—ì„œ ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ ë° í‘œì‹œ
        async function loadOrderData() {
            try {
                const response = await fetch('/api/orders');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const allOrders = await response.json();
                
                // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ì´ë©”ì¼ ê¸°ëŠ¥ì—ì„œ ì‚¬ìš©)
                window.allOrdersData = allOrders;
                
                // Delivery Noë³„ë¡œ ì•„ì´í…œë“¤ì„ ê·¸ë£¹í™”
                const deliveryGroups = {};
                
                // íš¨ìœ¨ì ì¸ ë‹¨ì¼ ë£¨í”„ë¡œ í•„í„°ë§ ë° ê·¸ë£¹í™” (ìµœì í™”ëœ ë²„ì „)
                for (const order of allOrders) {
                    if (!isModeMatch(order) || !order.items?.length) continue;
                    
                    for (const item of order.items) {
                        const deliveryNo = item.deliveryNo; // ì¤‘ë³µ ì œê±°
                        if (!deliveryNo) continue;
                        
                        // ë…„ë„ í•„í„°ë§ (ìµœì í™”)
                        const oldestDate = getOldestDateFromItem(item);
                        if (oldestDate && oldestDate.getFullYear() !== currentYear) continue;
                        
                        // ê·¸ë£¹ ì´ˆê¸°í™” (ìµœì í™”)
                                if (!deliveryGroups[deliveryNo]) {
                                    deliveryGroups[deliveryNo] = {
                                deliveryNo: deliveryNo,
                                        finalDate: order.finalDate,
                                        orderDate: order.orderDate,
                                        orderCount: 0,
                                        orders: []
                                    };
                                }
                        
                        // ì£¼ë¬¸ ë°ì´í„° ì¶”ê°€
                                deliveryGroups[deliveryNo].orderCount++;
                                deliveryGroups[deliveryNo].orders.push(order);
                            }
                    }
                
                // deliveryNo ë°°ì—´ë¡œ ë³€í™˜
                const deliveryList = Object.values(deliveryGroups);
                
                // í…Œì´ë¸” ì—…ë°ì´íŠ¸
                updateOrderTable(deliveryList);
                
            } catch (error) {
                console.error("[SHIPMENT ARCHIVE] ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
                updateOrderTable([]);
            }
        }
        

        // ì£¼ë¬¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateOrderTable(deliveryList) {
            const tbody = document.getElementById('orderTableBody');
            tbody.innerHTML = '';
            
            if (deliveryList.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="10" style="text-align: center; color: #666;">í•´ë‹¹ ì¡°ê±´ì˜ ë°°ì†¡ì´ ì—†ìŠµë‹ˆë‹¤.</td>';
                tbody.appendChild(row);
                return;
            }
            
            // Delivery Noë¥¼ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ìµœì í™”ëœ ë²„ì „)
            deliveryList.sort((a, b) => {
                // ê³µí†µ í•¨ìˆ˜ë¡œ ì²« ë²ˆì§¸ ì•„ì´í…œ ì°¾ê¸°
                const getFirstItem = (delivery) => {
                    const order = delivery.orders?.[0];
                    return order?.items?.find(item => item.deliveryNo === delivery.deliveryNo);
                };
                
                const aFirstItem = getFirstItem(a);
                const bFirstItem = getFirstItem(b);
                
                // ê° delivery groupì˜ ê°€ì¥ ì˜¤ë˜ëœ ë‚ ì§œ ì°¾ê¸°
                const aOldestDate = aFirstItem ? getOldestDateFromItem(aFirstItem) : null;
                const bOldestDate = bFirstItem ? getOldestDateFromItem(bFirstItem) : null;
                
                // ë‚ ì§œ ê¸°ì¤€ ì •ë ¬
                if (aOldestDate && bOldestDate) {
                    return bOldestDate.getTime() - aOldestDate.getTime();
                } else if (aOldestDate) {
                    return -1;
                } else if (bOldestDate) {
                    return 1;
                } else {
                    // ë‚ ì§œê°€ ì—†ìœ¼ë©´ EK-ë²ˆí˜¸ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
                    const aNum = parseInt(a.deliveryNo.replace('EK-', '')) || 0;
                    const bNum = parseInt(b.deliveryNo.replace('EK-', '')) || 0;
                    return bNum - aNum;
                }
            });
            
            // ê³µí†µ ìŠ¤íƒ€ì¼ ì •ì˜ (ì¤‘ë³µ ì œê±°)
            const buttonStyle = "padding: 2px 4px; margin: 0 1px; border: 1px solid #ccc; border-radius: 2px; background: #fff; cursor: pointer; font-size: 10px; min-width: 20px; height: 20px; line-height: 1;";
            const textStyle = "font-size: 0.8rem; color: #666;";
            const inputStyle = "width: 100%; height: 30px; border: 1px solid #ccc; border-radius: 3px; padding: 5px 10px; font-size: 0.8rem; color: #666; text-align: center; box-sizing: border-box;";
            
            // íŒŒì¼ íƒ€ì…ë³„ ë²„íŠ¼ ìƒì„± í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°)
            const createFileButtons = (deliveryNo, fileType, uploadFunction, viewFunction, icon = "ğŸ“¤") => {
                return `
                    <button class="top-menu-btn" onclick="${uploadFunction}('${deliveryNo}')" style="${buttonStyle}" title="${fileType} ì—…ë¡œë“œ">${icon}</button>
                    <button class="top-menu-btn preview-btn" onclick="${viewFunction}('${deliveryNo}')" data-delivery-no="${deliveryNo}" data-file-type="${fileType}" style="${buttonStyle}" title="${fileType} ë³´ê¸°">ğŸ‘ï¸</button>
                `;
            };
            
            // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°)
            const formatPrice = (value, prefix = '') => {
                return value ? `${prefix}${Number(value).toLocaleString()}` : '';
            };
            
            deliveryList.forEach(delivery => {
                // ë°ì´í„° ì¶”ì¶œ ìµœì í™” (undefined ì²˜ë¦¬ ê°œì„ )
                const getItemData = (item) => {
                const fields = ['d/nno', 'd/ndate', 'p/ino', 'p/idate', 'p/iprice', 'p/ino2', 'p/idate2', 'p/iprice2', 
                              'invoiceno', 'invoicedate', 'invoicedue', 'invoiceprice', 'vessel', 'etd', 'eta', 
                              'swiftdate', 'swiftamount', 'swiftdate2', 'swiftamount2', 'reportno', 'reportdate', 'addprice',
                              'ntinvoicedate', 'ntinvoicedue', 'ntinvoiceprice', 'ntminusprice', 'complete'];
                    const data = {};
                    fields.forEach(field => {
                        const value = item[field];
                        data[field.replace('/', '')] = (value !== undefined && value !== null) ? value : '';
                    });
                    
                    // deliveryNo ì¶”ê°€
                    data.deliveryNo = item.deliveryNo || '';
                    
                    // ë””ë²„ê¹…: vessel, etd, eta ê°’ í™•ì¸
                    console.log(`[LOAD] ${delivery.deliveryNo} - Vessel: "${data.vessel}", ETD: "${data.etd}", ETA: "${data.eta}"`);
                    
                    return data;
                };
                
                // ì²« ë²ˆì§¸ ì•„ì´í…œ ë°ì´í„° ì¶”ì¶œ (ì¤‘ë³µ ì œê±°)
                const firstItem = delivery.orders?.[0]?.items?.find(item => item.deliveryNo === delivery.deliveryNo);
                const itemData = firstItem ? getItemData(firstItem) : {};
                
                // ì²« ë²ˆì§¸ í–‰ (ë²„íŠ¼ì´ ìˆëŠ” í–‰)
                const firstRow = document.createElement('tr');
                
                // deliveryNoì™€ ì²´í¬ë°•ìŠ¤ í‘œì‹œ
                let deliveryInfo = `<input type="checkbox" class="delivery-checkbox" data-deliveryNo="${delivery.deliveryNo}" style="margin-right: 8px;">${delivery.deliveryNo || 'N/A'}`;
                
                firstRow.innerHTML = `
                    <td rowspan="4">${deliveryInfo}</td>
                    <td>${createFileButtons(delivery.deliveryNo, 'Delivery Note', 'uploadDeliveryNote', 'viewDeliveryNote')}</td>
                    <td>${createFileButtons(delivery.deliveryNo, 'Proforma Invoice', 'uploadProformaInvoice', 'viewProformaInvoice')}</td>
                    <td>${createFileButtons(delivery.deliveryNo, 'SWIFT', 'uploadSWIFT', 'viewSWIFT')}</td>
                    <td>${createFileButtons(delivery.deliveryNo, 'Invoice', 'uploadInvoice', 'viewInvoice')}</td>
                    <td>${createFileButtons(delivery.deliveryNo, 'BL', 'uploadBL2', 'viewBL2')}</td>
                    <td>${createFileButtons(delivery.deliveryNo, 'Origin', 'uploadOrigin', 'viewOrigin')}</td>
                    <td>${createFileButtons(delivery.deliveryNo, 'ë¶„ì„í‘œ', 'uploadAnalysis', 'viewAnalysis', 'ğŸ“‹')}</td>
                    <td>${createFileButtons(delivery.deliveryNo, 'í†µê´€', 'uploadCustoms', 'viewCustoms')}</td>
                    <td>${createFileButtons(delivery.deliveryNo, 'NTì²­êµ¬ì„œ', 'uploadNTInvoice', 'viewNTInvoice')}</td>
                `;
                tbody.appendChild(firstRow);
                
                // ë‘ ë²ˆì§¸ í–‰ (ë²ˆí˜¸ ì •ë³´ í‘œì‹œ)
                const secondRow = document.createElement('tr');
                secondRow.innerHTML = `
                    <td style="${textStyle}">${itemData.dnno || ''}</td>
                    <td style="${textStyle}">${itemData.pino}${itemData.pino2 ? '<br/>' + itemData.pino2 : ''}</td>
                    <td></td>
                    <td style="${textStyle}">${itemData.invoiceno || ''}</td>
                    <td style="${textStyle} font-weight: bold;">Vessel</td>
                    <td style="${textStyle} font-weight: bold;">ETD</td>
                    <td style="${textStyle} font-weight: bold;">ETA</td>
                    <td style="${textStyle}">${itemData.reportno || ''}</td>
                    <td style="${textStyle}"><input type="checkbox" class="nt-checkbox" data-deliveryno="${itemData.deliveryNo}" ${itemData.complete === true ? 'checked' : ''} onchange="handleNTCheckbox(this)"></td>
                `;
                tbody.appendChild(secondRow);
                
                // ì„¸ ë²ˆì§¸ í–‰ (ë‚ ì§œ ì •ë³´ í‘œì‹œ)
                const thirdRow = document.createElement('tr');
                thirdRow.innerHTML = `
                    <td style="${textStyle}">${itemData.dndate}</td>
                    <td style="${textStyle}">${itemData.pidate}${itemData.pidate2 ? '<br/>' + itemData.pidate2 : ''}</td>
                    <td style="${textStyle}">${itemData.swiftdate}${itemData.swiftdate2 ? '<br/>' + itemData.swiftdate2 : ''}</td>
                    <td style="${textStyle}">${itemData.invoicedate}${itemData.invoicedue ? '<br/>' + itemData.invoicedue : ''}</td>
                    <td><input type="text" class="vessel-input" placeholder="" value="${itemData.vessel}" style="${inputStyle}"></td>
                    <td><input type="text" class="etd-input" placeholder="" value="${itemData.etd}" style="${inputStyle}"></td>
                    <td><input type="text" class="eta-input" placeholder="" value="${itemData.eta}" style="${inputStyle}"></td>
                    <td style="${textStyle}">${itemData.reportdate || ''}</td>
                    <td style="${textStyle}">${itemData.ntinvoicedate || ''}<br/>${itemData.ntinvoicedue || ''}</td>
                `;
                tbody.appendChild(thirdRow);
                
                // ë„¤ ë²ˆì§¸ í–‰ (ê°€ê²© ì •ë³´ í‘œì‹œ)
                const fourthRow = document.createElement('tr');
                
                // piprice + piprice2ì™€ invoiceprice ë¹„êµí•˜ì—¬ ë°°ê²½ìƒ‰ ì„¤ì •
                let invoicePriceStyle = textStyle;
                if (itemData.invoiceprice) {
                    const pipriceNum = Number(itemData.piprice) || 0;
                    const piprice2Num = Number(itemData.piprice2) || 0;
                    const totalPiPrice = pipriceNum + piprice2Num;
                    const invoicepriceNum = Number(itemData.invoiceprice);
                    if (!isNaN(invoicepriceNum) && totalPiPrice > invoicepriceNum) {
                        invoicePriceStyle = `${textStyle} background-color: #d4edda;`;
                    }
                }
                
                fourthRow.innerHTML = `
                    <td></td>
                    <td style="${textStyle}">${formatPrice(itemData.piprice, '$')}${itemData.piprice2 ? '<br/>' + formatPrice(itemData.piprice2, '$') : ''}</td>
                    <td style="${textStyle}">${formatPrice(itemData.swiftamount, '$')}${itemData.swiftamount2 ? '<br/>' + formatPrice(itemData.swiftamount2, '$') : ''}</td>
                    <td style="${invoicePriceStyle}">${formatPrice(itemData.invoiceprice, '$')}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td style="${textStyle}">${formatPrice(itemData.addprice, 'â‚©')}</td>
                    <td style="${textStyle}; position: relative;">
                        ${formatPrice(itemData.ntinvoiceprice, 'â‚©')}
                        ${itemData.ntminusprice ? `<div style="position: relative; display: inline-block; margin-left: 5px; padding-right: 14px;">
                            ${formatPrice(itemData.ntminusprice, 'â‚©')}
                            <button type="button" class="delete-ntminusprice-btn" onclick="deleteNtminusprice('${delivery.deliveryNo}')" title="ntminusprice ì‚­ì œ">Ã—</button>
                        </div>` : ''}
                    </td>
                `;
                tbody.appendChild(fourthRow);
            });
            
            // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            updatePreviewButtonStyles();
        }
        
        // ========================================
        // ì´ë©”ì¼ ê´€ë ¨ ê¸°ëŠ¥ë“¤ 
        // ========================================
        
        // ì²´í¬ëœ deliveryNoë“¤ì„ íš¨ìœ¨ì ìœ¼ë¡œ ìˆ˜ì§‘í•˜ëŠ” í•¨ìˆ˜
        function getCheckedDeliveryNos() {
            const checkboxes = document.querySelectorAll('.delivery-checkbox:checked');
            return Array.from(checkboxes).map(checkbox => 
                checkbox.getAttribute('data-deliveryNo')
            );
        }
        
        // ì´ë©”ì¼ í…ìŠ¤íŠ¸ ìƒì„±
        function generateEmailText() {
            const checkedDeliveryNos = getCheckedDeliveryNos();
            
            if (checkedDeliveryNos.length === 0) {
                return { success: false, message: "ì„ íƒëœ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤." };
            }
            
            // ì²« ë²ˆì§¸ ì„ íƒëœ deliveryNo ì‚¬ìš©
            const deliveryNo = checkedDeliveryNos[0];
            
            // vessel, ETD, ETA ì •ë³´ ì°¾ê¸°
            let vessel = '';
            let etd = '';
            let eta = '';
            
            if (window.allOrdersData) {
                for (const order of window.allOrdersData) {
                    if (!order.items) continue;
                    
                    for (const item of order.items) {
                        if (item.deliveryNo === deliveryNo) {
                            vessel = item.vessel || '';
                            etd = item.etd || '';
                            eta = item.eta || '';
                            break;
                        }
                    }
                    if (vessel || etd || eta) break;
                }
            }
            
            // ì´ë©”ì¼ í…ìŠ¤íŠ¸ ìƒì„±
            const emailText = `ì•ˆë…•í•˜ì„¸ìš”

${deliveryNo}ì˜ ì„ ì  ì •ë³´ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤ 

vessel : ${vessel}
ETD : ${etd}
ETA : ${eta}

ê°ì‚¬í•©ë‹ˆë‹¤`;
            
            return { success: true, text: emailText };
        }
        
        // í´ë¦½ë³´ë“œì— í…ìŠ¤íŠ¸ ë³µì‚¬ (ìµœì í™”ëœ ë²„ì „)
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (err) {
                // fallback for older browsers (ì¤‘ë³µ ì œê±°)
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    return document.execCommand('copy');
                } finally {
                    document.body.removeChild(textArea);
                }
            }
        }
        
        
        // ========================================
        // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê´€ë¦¬
        // ========================================
        
        // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±° ìµœì í™”)
        const setButtonStyle = (button, hasFiles) => {
            button.style.background = hasFiles ? '#87CEEB' : '#fff';
            button.style.color = hasFiles ? 'white' : 'black';
        };

        async function updatePreviewButtonStyles() {
            const previewButtons = document.querySelectorAll('.preview-btn');
            
            const promises = Array.from(previewButtons).map(async (button) => {
                const deliveryNo = button.getAttribute('data-delivery-no');
                const fileType = button.getAttribute('data-file-type');
                
                try {
                    const response = await fetch(`/api/listFiles/${currentMode}/DeliveryNO/${deliveryNo}/${encodeURIComponent(fileType)}`);
                    const hasFiles = response.ok && (await response.json()).files?.length > 0;
                    setButtonStyle(button, hasFiles);
                } catch (error) {
                    setButtonStyle(button, false);
                }
            });
            
            await Promise.all(promises);
        }
        
        function updateSinglePreviewButton(deliveryNo, fileType, hasFiles = null) {
            const button = document.querySelector(`[data-delivery-no="${deliveryNo}"][data-file-type="${fileType}"]`);
            if (button) {
                if (hasFiles === null) {
                    // íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ë¥¼ í™•ì¸
                    fetch(`/api/listFiles/${currentMode}/DeliveryNO/${deliveryNo}/${encodeURIComponent(fileType)}`)
                        .then(response => response.ok ? response.json() : { files: [] })
                        .then(data => {
                            const hasFiles = data.files && data.files.length > 0;
                            setButtonStyle(button, hasFiles);
                        })
                        .catch(() => setButtonStyle(button, false));
                } else {
                    setButtonStyle(button, hasFiles);
                }
            }
        }
        
        // ========================================
        // íŒŒì¼ ì—…ë¡œë“œ/ë³´ê¸° í•¨ìˆ˜ ìƒì„±
        // ========================================
        
        // ê°œë³„ í•¨ìˆ˜ë“¤ (ì¤‘ë³µ ì œê±° ìµœì í™”)
        const createFileFunction = (action, fileType) => (deliveryNo) => {
            console.log(`[SHIPMENT ARCHIVE] ${fileType} ${action}: ${deliveryNo}`);
            action === 'ì—…ë¡œë“œ' ? uploadFile(deliveryNo, fileType) : viewFile(deliveryNo, fileType);
        };

        const uploadCustoms = createFileFunction('ì—…ë¡œë“œ', 'í†µê´€');
        const viewCustoms = createFileFunction('ë³´ê¸°', 'í†µê´€');
        const uploadDeliveryNote = createFileFunction('ì—…ë¡œë“œ', 'Delivery Note');
        const viewDeliveryNote = createFileFunction('ë³´ê¸°', 'Delivery Note');
        const uploadProformaInvoice = createFileFunction('ì—…ë¡œë“œ', 'Proforma Invoice');
        const viewProformaInvoice = createFileFunction('ë³´ê¸°', 'Proforma Invoice');
        const uploadSWIFT = createFileFunction('ì—…ë¡œë“œ', 'SWIFT');
        const viewSWIFT = createFileFunction('ë³´ê¸°', 'SWIFT');
        const uploadBL2 = createFileFunction('ì—…ë¡œë“œ', 'BL');
        const viewBL2 = createFileFunction('ë³´ê¸°', 'BL');
        const uploadInvoice = createFileFunction('ì—…ë¡œë“œ', 'Invoice');
        const viewInvoice = createFileFunction('ë³´ê¸°', 'Invoice');
        const uploadOrigin = createFileFunction('ì—…ë¡œë“œ', 'Origin');
        const viewOrigin = createFileFunction('ë³´ê¸°', 'Origin');
        const uploadNTInvoice = createFileFunction('ì—…ë¡œë“œ', 'NTì²­êµ¬ì„œ');
        const viewNTInvoice = createFileFunction('ë³´ê¸°', 'NTì²­êµ¬ì„œ');
        
        
        // ========================================
        // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ê´€ë¦¬
        // ========================================
        
        // ë¯¸ë¦¬ë³´ê¸° ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
        let currentFiles = [];
        let currentFileIndex = 0;
        let currentDeliveryNo = '';
        let currentFileType = '';

        // íŒŒì¼ ëª©ë¡ ì¡°íšŒ ë° ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ
        function viewFile(deliveryNo, fileType) {
            console.log(`[SHIPMENT ARCHIVE] ${fileType} ë³´ê¸°: ${deliveryNo}`);
            
            // ì„œë²„ì—ì„œ íŒŒì¼ ëª©ë¡ ì¡°íšŒ (OrderID/OrderNOì™€ ë™ì¼í•œ êµ¬ì¡°)
            fetch(`/api/listFiles/${currentMode}/DeliveryNO/${deliveryNo}/${encodeURIComponent(fileType)}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                })
                .then(data => {
                    if (data.files && data.files.length > 0) {
                        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
                        currentFiles = data.files;
                        currentFileIndex = 0;
                        currentDeliveryNo = deliveryNo;
                        currentFileType = fileType;
                        
                        // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ
                        showPreviewModal();
                    } else {
                        alert(`${fileType} íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.`);
                    }
                })
                .catch(error => {
                    console.error(`[VIEW] íŒŒì¼ ì¡°íšŒ ì‹¤íŒ¨:`, error);
                    alert(`${fileType} íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì—ëŸ¬: ${error.message}`);
                });
        }

        // ========================================
        // íŒŒì¼ ì•„ì´ì½˜ ë° ëª©ë¡ ê´€ë¦¬
        // ========================================
        
        // íŒŒì¼ ì•„ì´ì½˜ ê²°ì • í•¨ìˆ˜ (ìµœì í™”ëœ ë²„ì „)
        function getFileIcon(filename) {
            const extension = getFileExtension(filename);
            const iconMap = {
                'pdf': 'ğŸ“„',
                'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸',
                'doc': 'ğŸ“', 'docx': 'ğŸ“',
                'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š'
            };
            return iconMap[extension] || 'ğŸ“„';
        }
        
        // íŒŒì¼ ëª©ë¡ ìƒì„± í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°)
        function createFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            currentFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = `file-item ${index === currentFileIndex ? 'active' : ''}`;
                fileItem.onclick = () => selectFile(index);
                
                fileItem.innerHTML = `
                    <span class="file-icon">${getFileIcon(file.filename)}</span>
                    <span class="file-name" title="${file.filename}">${file.filename}</span>
                    <button class="delete-file-btn" onclick="deleteFile(event, ${index})" title="íŒŒì¼ ì‚­ì œ">ğŸ—‘ï¸</button>
                `;
                
                fileList.appendChild(fileItem);
            });
        }
        
        // ========================================
        // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ë° íŒŒì¼ ì„ íƒ ê´€ë¦¬
        // ========================================
        
        // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ (ì¤‘ë³µ ì œê±° ìµœì í™”)
        function showPreviewModal() {
            const modal = document.getElementById('previewModal');
            const title = document.getElementById('previewTitle');
            const downloadBtn = document.getElementById('downloadCurrentBtn');
            
            // ì œëª© ì„¤ì •
            title.textContent = `${currentDeliveryNo} ${currentFileType}`;
            
            // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            downloadBtn.textContent = currentFileType === 'ë¶„ì„í‘œ' ? 'ğŸ“ í´ë” ë‹¤ìš´ë¡œë“œ' : 'ğŸ“¥ ë‹¤ìš´ë¡œë“œ';
            
            // ëª¨ë‹¬ í‘œì‹œ
            modal.style.display = 'flex';
            
            // ì²« ë²ˆì§¸ íŒŒì¼ í‘œì‹œ (ì¹´ìš´í„°ì™€ íŒŒì¼ëª©ë¡ ì—…ë°ì´íŠ¸ í¬í•¨)
            showCurrentFile();
        }

        // íŒŒì¼ ì„ íƒ í•¨ìˆ˜
        function selectFile(index) {
            currentFileIndex = index;
            showCurrentFile();
        }

        // íŒŒì¼ í™•ì¥ì í™•ì¸ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°)
        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }
        
        // ë¯¸ë¦¬ë³´ê¸° ê°€ëŠ¥í•œ íŒŒì¼ í˜•ì‹ í™•ì¸
        function isPreviewableFile(filename) {
            const extension = getFileExtension(filename);
            return ['pdf', 'jpg', 'jpeg', 'png', 'gif'].includes(extension);
        }
        
        // ========================================
        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ê´€ë¦¬
        // ========================================
        
        // ë‹¤ìš´ë¡œë“œ í˜ì´ì§€ HTML ìƒì„± (ìµœì í™”)
        function createDownloadPageHTML(file, downloadUrl) {
            return `
                <html>
                <body style="text-align:center;padding:50px;font-family:Arial;">
                    <h3>ë¯¸ë¦¬ë³´ê¸° ë¶ˆê°€ëŠ¥í•œ íŒŒì¼ í˜•ì‹</h3>
                    <p>íŒŒì¼ëª…: ${file.filename}</p>
                    <p>í¬ê¸°: ${(file.size / 1024).toFixed(1)} KB</p>
                    <a href="${downloadUrl}" style="background:#007bff;color:white;padding:10px 20px;text-decoration:none;border-radius:5px;">ğŸ“¥ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</a>
                </body>
                </html>
            `;
        }
        
        // í˜„ì¬ íŒŒì¼ í‘œì‹œ (ì¤‘ë³µ ì œê±° ìµœì í™”)
        function showCurrentFile() {
            if (currentFiles.length === 0) return;
            
            const currentFile = currentFiles[currentFileIndex];
            const previewFrame = document.getElementById('previewFrame');
            const counter = document.getElementById('fileCounter');
            
            // ë¯¸ë¦¬ë³´ê¸° URL ìƒì„±
            const previewUrl = `/api/previewFile/${currentMode}/DeliveryNO/${currentDeliveryNo}/${encodeURIComponent(currentFileType)}/${encodeURIComponent(currentFile.filename)}`;
            
            // íŒŒì¼ í˜•ì‹ì— ë”°ë¥¸ ì²˜ë¦¬
            if (isPreviewableFile(currentFile.filename)) {
                previewFrame.src = previewUrl;
            } else {
                const downloadUrl = `/api/downloadFile/${currentMode}/DeliveryNO/${currentDeliveryNo}/${encodeURIComponent(currentFileType)}/${encodeURIComponent(currentFile.filename)}`;
                previewFrame.src = `data:text/html,${createDownloadPageHTML(currentFile, downloadUrl)}`;
            }
            
            // ì¹´ìš´í„° ì—…ë°ì´íŠ¸
            counter.textContent = `${currentFileIndex + 1} / ${currentFiles.length}`;
            
            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateNavigationButtons();
            
            // íŒŒì¼ ëª©ë¡ ì—…ë°ì´íŠ¸
            createFileList();
        }

        // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevFileBtn');
            const nextBtn = document.getElementById('nextFileBtn');
            
            prevBtn.disabled = currentFileIndex === 0;
            nextBtn.disabled = currentFileIndex === currentFiles.length - 1;
        }

        // ========================================
        // íŒŒì¼ ì‚­ì œ ê´€ë¦¬
        // ========================================
        
        // íŒŒì¼ ì‚­ì œ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±° ìµœì í™”)
        async function deleteFile(event, fileIndex) {
            event.stopPropagation();
            
            if (currentFiles.length === 0 || fileIndex >= currentFiles.length) return;
            
            const fileToDelete = currentFiles[fileIndex];
            if (!confirm(`íŒŒì¼ "${fileToDelete.filename}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }
            
            try {
                const encodedFilename = encodeURIComponent(fileToDelete.filename);
                const response = await fetch(`/api/deleteFile/${currentMode}/DeliveryNO/${currentDeliveryNo}/${encodeURIComponent(currentFileType)}/${encodedFilename}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    currentFiles.splice(fileIndex, 1);
                    currentFileIndex = Math.max(0, Math.min(currentFileIndex, currentFiles.length - 1));
                    
                    if (currentFiles.length === 0) {
                        document.getElementById('previewModal').style.display = 'none';
                        // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (íŒŒì¼ì´ ì—†ìœ¼ë¯€ë¡œ íšŒìƒ‰ìœ¼ë¡œ)
                        updateSinglePreviewButton(currentDeliveryNo, currentFileType, false);
                    } else {
                        showCurrentFile(); // createFileList() í¬í•¨ë¨
                    }
                    alert('íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    const errorData = await response.json();
                    alert(`íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                console.error('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                alert(`íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }
        
        // ========================================
        // íŒŒì¼ ì—…ë¡œë“œ ê´€ë¦¬
        // ========================================
        
        // íŒŒì¼ ì—…ë¡œë“œ ê³µí†µ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±° ìµœì í™”)
        function uploadFile(deliveryNo, fileType) {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf,.doc,.docx,.jpg,.jpeg,.png,.txt';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', async function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                console.log(`[UPLOAD] ì„ íƒëœ íŒŒì¼: ${file.name}, í¬ê¸°: ${file.size} bytes`);
                
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('deliveryNo', deliveryNo);
                    formData.append('fileType', fileType);
                    formData.append('mode', currentMode);
                    formData.append('originalFileName', file.name);
                    
                    const response = await fetch('/api/uploadFile', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`[UPLOAD] ì—…ë¡œë“œ ì„±ê³µ:`, result);
                        alert(`${fileType} íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\nê²½ë¡œ: ${currentMode}/DeliveryNO/${deliveryNo}/${fileType}`);
                        
                        // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (í˜ì´ì§€ ë¦¬ë¡œë“œ ëŒ€ì‹ )
                        updateSinglePreviewButton(deliveryNo, fileType);
                    } else {
                        const errorData = await response.json();
                        alert(`${fileType} íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì—ëŸ¬: ${errorData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                    }
                } catch (error) {
                    console.error(`[UPLOAD] ì—…ë¡œë“œ ì‹¤íŒ¨:`, error);
                    alert(`${fileType} íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì—ëŸ¬: ${error.message}`);
                }
                
                document.body.removeChild(fileInput);
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
        }
        
        // ë¶„ì„í‘œ ì—…ë¡œë“œ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±° ìµœì í™”)
        async function uploadAnalysis(deliveryNo) {
            try {
                const response = await fetch('/api/copyAnalysisFiles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: currentMode, deliveryNo: deliveryNo })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    if (result.totalCopied > 0) {
                        alert(`ë¶„ì„í‘œ ë³µì‚¬ ì™„ë£Œ!\në³µì‚¬ëœ íŒŒì¼: ${result.totalCopied}ê°œ`);
                        updateSinglePreviewButton(deliveryNo, 'ë¶„ì„í‘œ');
                    } else {
                        alert('ë³µì‚¬í•  ë¶„ì„í‘œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € production í˜ì´ì§€ì—ì„œ í•´ë‹¹ ì•„ì´í…œë“¤ì˜ ë¶„ì„í‘œë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                    }
                } else {
                    alert(`ë¶„ì„í‘œ ë³µì‚¬ ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                console.error('ë¶„ì„í‘œ ë³µì‚¬ ì˜¤ë¥˜:', error);
                alert(`ë¶„ì„í‘œ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }
        
        function viewAnalysis(deliveryNo) {
            console.log(`[SHIPMENT ARCHIVE] ë¶„ì„í‘œ ë³´ê¸°: ${deliveryNo}`);
            viewFile(deliveryNo, 'ë¶„ì„í‘œ');
        }

        
        // í†µí•©ëœ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeEventListeners() {
            // ëª¨ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì¤‘ë³µ ì œê±°)
            modeButtons.nt.addEventListener('click', () => changeMode('NT'));
            modeButtons.sm.addEventListener('click', () => changeMode('SM'));
            
            // Email ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById("emailBtn").addEventListener("click", async () => {
            try {
                const result = generateEmailText();
                
                if (!result.success) {
                    alert(result.message + (result.message.includes("ì„ íƒëœ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤") ? "\n\nì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒí•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”." : ""));
                    return;
                }
                
                const success = await copyToClipboard(result.text);
                
                if (success) {
                    alert('Email ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\në°”ë¡œ ë¶™ì—¬ë„£ê¸°(Ctrl+V)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            } catch (error) {
                console.error("ì´ë©”ì¼ í…ìŠ¤íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜:", error);
                alert("ì´ë©”ì¼ í…ìŠ¤íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });

        // PDF EDIT ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById("pdfEditBtn").addEventListener("click", () => {
            openPdfEditModal();
        });

            // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
            const modal = document.getElementById('previewModal');
            const closeBtn = document.getElementById('closePreviewBtn');
            const prevBtn = document.getElementById('prevFileBtn');
            const nextBtn = document.getElementById('nextFileBtn');
            const downloadBtn = document.getElementById('downloadCurrentBtn');

            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            prevBtn.addEventListener('click', () => {
            if (currentFileIndex > 0) {
                currentFileIndex--;
                showCurrentFile();
            }
        });

            nextBtn.addEventListener('click', () => {
            if (currentFileIndex < currentFiles.length - 1) {
                currentFileIndex++;
                showCurrentFile();
            }
        });

            downloadBtn.addEventListener('click', () => {
                    const link = document.createElement('a');
                
                if (currentFileType === 'ë¶„ì„í‘œ') {
                    link.href = `/api/downloadAnalysisFolder/${currentMode}/${currentDeliveryNo}`;
                    link.download = `${currentDeliveryNo}ë¶„ì„í‘œ.zip`;
                } else {
                    const currentFile = currentFiles[currentFileIndex];
                    link.href = `/api/downloadFile/${currentMode}/DeliveryNO/${currentDeliveryNo}/${encodeURIComponent(currentFileType)}/${encodeURIComponent(currentFile.filename)}`;
                    link.download = currentFile.filename;
                }
                
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            modal.addEventListener('click', (e) => {
            if (e.target.id === 'previewModal') {
                    modal.style.display = 'none';
                }
            });


            // í™•ì¥/ì¶•ì†Œ ê¸°ëŠ¥ (ì¤‘ë³µ ì œê±° ìµœì í™”)
        document.getElementById("expandButton").addEventListener("click", () => {
            const detailArea = document.getElementById("detailButtonArea");
            const expandBtn = document.getElementById("expandButton");
                const isExpanded = detailArea.style.display === "flex";
                
                detailArea.style.display = isExpanded ? "none" : "flex";
                expandBtn.classList.toggle("expanded", !isExpanded);
                expandBtn.textContent = isExpanded ? "â–¼" : "â–²";
            });

            // ë…„ë„ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì¤‘ë³µ ì œê±° ìµœì í™”)
            const yearUpBtn = document.getElementById("yearUpBtn");
            const yearDownBtn = document.getElementById("yearDownBtn");
            
            const updateYear = (newYear) => {
                currentYear = newYear;
                yearDisplay.textContent = currentYear;
                loadOrderData();
            };
            
            yearUpBtn.addEventListener("click", () => updateYear(currentYear + 1));
            yearDownBtn.addEventListener("click", () => currentYear > 2020 && updateYear(currentYear - 1));

            // ========================================
            // Add ë²„íŠ¼ - Vessel/ETD/ETA ë°ì´í„° ì €ì¥
            // ========================================
            
            // Add ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ìµœì í™”ëœ ë²„ì „)
            const addBtn = document.getElementById('addBtn');
            if (addBtn) {
                addBtn.addEventListener('click', async () => {
                    console.log('[ADD] Add ë²„íŠ¼ í´ë¦­ë¨');
                    
                    try {
                        // í…Œì´ë¸”ì—ì„œ ì…ë ¥ëœ ë°ì´í„° ìˆ˜ì§‘ (ë””ë²„ê¹… ì¶”ê°€)
                        const deliveryData = {};
                        const tableRows = document.querySelectorAll('#orderTableBody tr');
                        let currentDeliveryNo = null;
                        
                        console.log('[ADD] ì´ í–‰ ìˆ˜:', tableRows.length);
                        
                        tableRows.forEach((row, index) => {
                            const cells = row.cells;
                            console.log(`[ADD] í–‰ ${index}: ì…€ ìˆ˜ ${cells.length}`);
                            
                            if (cells.length === 9) { // ì²« ë²ˆì§¸ í–‰ (ë²„íŠ¼ì´ ìˆëŠ” í–‰)
                                const deliveryNoCell = cells[0];
                                if (deliveryNoCell && deliveryNoCell.textContent.trim()) {
                                    currentDeliveryNo = deliveryNoCell.textContent.trim();
                                    deliveryData[currentDeliveryNo] = { vessel: '', etd: '', eta: '' };
                                    console.log(`[ADD] DeliveryNo ë°œê²¬: ${currentDeliveryNo}`);
                                }
                            } else if (cells.length === 8 && currentDeliveryNo) { // ì…ë ¥ í•„ë“œê°€ ìˆëŠ” í–‰ (2ë²ˆì§¸ í–‰)
                                // ì…ë ¥ í•„ë“œ ì°¾ê¸° (BL, Origin, ë¶„ì„í‘œ ì—´)
                                const vesselInput = cells[4].querySelector('.vessel-input'); // BL ì—´
                                const etdInput = cells[5].querySelector('.etd-input');     // Origin ì—´  
                                const etaInput = cells[6].querySelector('.eta-input');     // ë¶„ì„í‘œ ì—´
                                
                                console.log(`[ADD] ì…ë ¥ í•„ë“œ ì°¾ê¸° - Vessel: ${vesselInput?.value}, ETD: ${etdInput?.value}, ETA: ${etaInput?.value}`);
                                
                                if (vesselInput && etdInput && etaInput) {
                                    deliveryData[currentDeliveryNo].vessel = vesselInput.value.trim();
                                    deliveryData[currentDeliveryNo].etd = etdInput.value.trim();
                                    deliveryData[currentDeliveryNo].eta = etaInput.value.trim();
                                    console.log(`[ADD] ë°ì´í„° ì €ì¥: ${currentDeliveryNo}`, deliveryData[currentDeliveryNo]);
                                }
                            }
                        });
                        
                        // ì…ë ¥ëœ ë°ì´í„°ë§Œ í•„í„°ë§
                        const filteredData = Object.entries(deliveryData)
                            .filter(([_, data]) => data.vessel || data.etd || data.eta)
                            .reduce((acc, [deliveryNo, data]) => ({ ...acc, [deliveryNo]: data }), {});
                        
                        if (Object.keys(filteredData).length === 0) {
                            alert('ì…ë ¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                            return;
                        }
                        
                     
                        // Add ë²„íŠ¼ ì²˜ë¦¬ (ëª¨ë“  ì£¼ë¬¸ ì—…ë°ì´íŠ¸)
                        let totalUpdated = 0;
                        let totalSkipped = 0;
                        let hasError = false;
                        
                        // ê° deliveryNoë³„ë¡œ ëª¨ë“  ì£¼ë¬¸ ì—…ë°ì´íŠ¸
                        for (const [deliveryNo, data] of Object.entries(filteredData)) {
                            console.log(`[ADD] ${deliveryNo} ì²˜ë¦¬ ì‹œì‘`);
                            
                            // 1. deliveryNoë¡œ ëª¨ë“  ì£¼ë¬¸ ì°¾ê¸°
                            const allOrdersResponse = await fetch('/api/orders');
                            const allOrders = await allOrdersResponse.json();
                            
                            // 2. deliveryNoê°€ í¬í•¨ëœ ëª¨ë“  ì£¼ë¬¸ ì°¾ê¸°
                            const matchingOrders = allOrders.filter(order => 
                                order.items && order.items.some(item => item.deliveryNo === deliveryNo)
                            );
                            
                            console.log(`[ADD] ${deliveryNo} ë§¤ì¹­ ì£¼ë¬¸: ${matchingOrders.length}ê°œ`);
                            
                            // 3. ê° ì£¼ë¬¸ë³„ë¡œ ê°œë³„ ì—…ë°ì´íŠ¸
                            for (const order of matchingOrders) {
                                try {
                                    const response = await fetch('/api/updateOrder', {
                            method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            searchOrderBy: 'orderNo',
                                            orderNo: order.orderNo,
                                            searchMethod: 'deliveryNo',
                                            items: [{
                                                deliveryNo: deliveryNo,
                                                vessel: data.vessel,
                                                etd: data.etd,
                                                eta: data.eta
                                            }],
                                            itemUpdateFields: ['vessel', 'etd', 'eta']
                                        })
                                    });
                                    
                                    if (response.ok) {
                                        const result = await response.json();
                                        totalUpdated += result.updatedItems || 0;
                                        totalSkipped += result.skippedItems || 0;
                                        console.log(`[ADD] ${order.orderNo} ì—…ë°ì´íŠ¸ ì„±ê³µ: ${result.updatedItems}ê°œ ì•„ì´í…œ`);
                                    } else {
                                        console.error(`[ADD] ${order.orderNo} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, response.status);
                                        hasError = true;
                                    }
                                } catch (error) {
                                    console.error(`[ADD] ${order.orderNo} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
                                    hasError = true;
                                }
                            }
                        }
                        
                        // 4. ê²°ê³¼ í‘œì‹œ
                        if (totalUpdated > 0) {
                            alert(`Vessel, ETD, ETA ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${totalUpdated}ê°œ${totalSkipped > 0 ? `, ê±´ë„ˆë›´ ì•„ì´í…œ: ${totalSkipped}ê°œ` : ''}`);
                            location.reload();
                        } else if (hasError) {
                            alert(`ì¼ë¶€ ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${totalUpdated}ê°œ, ê±´ë„ˆë›´ ì•„ì´í…œ: ${totalSkipped}ê°œ`);
                        } else {
                            alert('ì—…ë°ì´íŠ¸í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    } catch (error) {
                        console.error('[ADD] ì €ì¥ ì‹¤íŒ¨:', error);
                        alert(`ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                    }
                });
            }
        }

        // ESC í‚¤ë¡œ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('previewModal').style.display === 'flex') {
                document.getElementById('previewModal').style.display = 'none';
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° í‘œì‹œ (ì¤‘ë³µ ì œê±° ìµœì í™”)
        document.addEventListener('DOMContentLoaded', async () => {
            // ì´ˆê¸° ëª¨ë“œ ì„¤ì • (ì¤‘ë³µ ì œê±°)
            changeMode('NT');
            
            // ë‘ ë²ˆì§¸ í—¤ë” ê°•ì œ í‘œì‹œ ë° ë‚´ìš© ì„¤ì • (NT ëª¨ë“œ)
            const secondHeaderRow = document.getElementById('secondHeaderRow');
            if (secondHeaderRow) {
                secondHeaderRow.style.display = 'table-row';
                // NT ëª¨ë“œ í—¤ë” ë‚´ìš© ì§ì ‘ ì„¤ì •
                secondHeaderRow.innerHTML = `
                    <th></th>
                    <th>NT<br>ê´€ì„¸ì‚¬</th>
                    <th>EK</th>
                    <th>TF</th>
                    <th>ê´€ì„¸ì‚¬</th>
                    <th>ê´€ì„¸ì‚¬<br>í¬ì›Œë”+ëª…íŒ ìš°í¸</th>
                    <th>NT</th>
                    <th>NT</th>
                    <th>ê´€ì„¸ì‚¬<br>ì„¸ë¬´ì‚¬</th>
                    <th>NT</th>
                `;
            }
            
            // í†µí•©ëœ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
            initializeEventListeners();
            
            loadOrderData();
        });

    // NT ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    async function handleNTCheckbox(checkbox) {
        const deliveryNo = checkbox.getAttribute('data-deliveryno');
        const isChecked = checkbox.checked;
        
        try {
            await updateNTComplete(deliveryNo, isChecked);
        } catch (error) {
            console.error('NT ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
            alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¼
            checkbox.checked = !isChecked;
        }
    }

    // ntminusprice ì‚­ì œ í•¨ìˆ˜
    async function deleteNtminusprice(deliveryNo) {
        if (!confirm(`${deliveryNo}ì˜ ëª¨ë“  ntminuspriceë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }

        try {
            // ëª¨ë“  ì£¼ë¬¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const allOrdersResponse = await fetch('/api/orders');
            const allOrders = await allOrdersResponse.json();

            // í•´ë‹¹ deliveryNoë¥¼ ê°€ì§„ ì£¼ë¬¸ë“¤ ì°¾ê¸°
            const ordersWithDeliveryNo = allOrders.filter(order =>
                order.items && order.items.some(item => item.deliveryNo === deliveryNo)
            );

            if (ordersWithDeliveryNo.length === 0) {
                alert(`í•´ë‹¹ deliveryNo(${deliveryNo})ë¥¼ ê°€ì§„ ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            let totalUpdated = 0;
            let totalSkipped = 0;
            let hasError = false;

            // ê° ì£¼ë¬¸ë³„ë¡œ API í˜¸ì¶œ
            for (const order of ordersWithDeliveryNo) {
                try {
                    const response = await fetch('/api/updateOrder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            searchOrderBy: 'orderNo',
                            orderNo: order.orderNo,
                            searchMethod: 'deliveryNo',
                            items: [{
                                deliveryNo: deliveryNo,
                                ntminusprice: '' // ë¹ˆ ê°’ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì‚­ì œ
                            }],
                            itemUpdateFields: ['ntminusprice']
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        totalUpdated += result.updatedItems || 0;
                        totalSkipped += result.skippedItems || 0;
                    } else {
                        hasError = true;
                    }
                } catch (error) {
                    console.error(`[DELETE ntminusprice] ${order.orderNo} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
                    hasError = true;
                }
            }

            // ê²°ê³¼ í‘œì‹œ
            if (totalUpdated > 0) {
                alert(`${deliveryNo}ì˜ ntminuspriceê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${totalUpdated}ê°œ${totalSkipped > 0 ? `, ê±´ë„ˆë›´ ì•„ì´í…œ: ${totalSkipped}ê°œ` : ''}`);
                loadOrderData(); // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
            } else if (hasError) {
                alert(`ì¼ë¶€ ntminusprice ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${totalUpdated}ê°œ, ê±´ë„ˆë›´ ì•„ì´í…œ: ${totalSkipped}ê°œ`);
            } else {
                alert(`${deliveryNo}ì˜ ntminuspriceë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            }
        } catch (error) {
            console.error('[DELETE ntminusprice] ì˜¤ë¥˜:', error);
            alert(`ntminusprice ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
    }

    // NT Complete ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (accounting1 ë°©ì‹)
    async function updateNTComplete(deliveryNo, isComplete) {
        try {
            console.log(`[NT Complete] ì²˜ë¦¬ ì‹œì‘ - deliveryNo: ${deliveryNo}, isComplete: ${isComplete}`);
            
            // ëª¨ë“  ì£¼ë¬¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const allOrdersResponse = await fetch('/api/orders');
            const allOrders = await allOrdersResponse.json();
            console.log(`[NT Complete] ì „ì²´ ì£¼ë¬¸ ìˆ˜: ${allOrders.length}`);

            // í•´ë‹¹ deliveryNoë¥¼ ê°€ì§„ ì£¼ë¬¸ë“¤ ì°¾ê¸°
            const ordersWithDeliveryNo = allOrders.filter(order =>
                order.items && order.items.some(item => item.deliveryNo === deliveryNo)
            );
            console.log(`[NT Complete] ${deliveryNo}ì™€ ê´€ë ¨ëœ ì£¼ë¬¸ ìˆ˜: ${ordersWithDeliveryNo.length}`);

            if (ordersWithDeliveryNo.length === 0) {
                console.log(`[NT Complete] ${deliveryNo}ë¥¼ ê°€ì§„ ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                console.log(`[NT Complete] ì‚¬ìš© ê°€ëŠ¥í•œ deliveryNoë“¤:`, allOrders.flatMap(order => 
                    order.items ? order.items.map(item => item.deliveryNo) : []
                ).filter(Boolean));
                alert(`í•´ë‹¹ deliveryNo(${deliveryNo})ë¥¼ ê°€ì§„ ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            let totalUpdated = 0;
            let totalSkipped = 0;
            let hasError = false;

            // ê° ì£¼ë¬¸ë³„ë¡œ API í˜¸ì¶œ
            for (const order of ordersWithDeliveryNo) {
                try {
                    const updateData = {
                        searchOrderBy: 'orderNo',
                        orderNo: order.orderNo,
                        searchMethod: 'deliveryNo',
                        items: [{
                            deliveryNo: deliveryNo,
                            complete: isComplete
                        }],
                        itemUpdateFields: ['complete']
                    };

                    const response = await fetch('/api/updateOrder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });

                    const result = await response.json();

                    if (response.ok && result.message && result.message.includes('successfully')) {
                        totalUpdated += result.updatedItems || 0;
                        console.log(`[NT Complete] ${order.orderNo} ì—…ë°ì´íŠ¸ ì„±ê³µ: ${result.updatedItems || 0}ê°œ ì•„ì´í…œ`);
                    } else {
                        totalSkipped += result.skippedItems || 0;
                        console.warn(`[NT Complete] ${order.orderNo} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${response.status}`, result);
                        hasError = true;
                    }
                } catch (error) {
                    totalSkipped++;
                    console.error(`[NT Complete] ${order.orderNo} ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:`, error);
                    hasError = true;
                }
            }

            // ê²°ê³¼ í‘œì‹œ (accounting1ê³¼ ë™ì¼í•œ ë°©ì‹)
            if (totalUpdated > 0) {
                alert(`NT Complete ìƒíƒœê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${totalUpdated}ê°œ${totalSkipped > 0 ? `, ê±´ë„ˆë›´ ì•„ì´í…œ: ${totalSkipped}ê°œ` : ''}`);
            } else if (hasError) {
                alert(`ì¼ë¶€ NT Complete ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${totalUpdated}ê°œ, ê±´ë„ˆë›´ ì•„ì´í…œ: ${totalSkipped}ê°œ`);
            } else {
                alert(`NT Complete ì—…ë°ì´íŠ¸í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
            }

        } catch (error) {
            console.error('NT Complete ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
            throw error;
        }
    }

    // ===== PDF Edit ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ =====
    let pdfEditDoc = null;
    let pdfEditSelectedPages = [];

    // PDF Edit ëª¨ë‹¬ ì—´ê¸°
    function openPdfEditModal() {
        const modal = document.getElementById('pdfEditModal');
        modal.style.display = 'flex';
        resetPdfEditModal();
    }

    // PDF Edit ëª¨ë‹¬ ë‹«ê¸°
    function closePdfEditModal() {
        const modal = document.getElementById('pdfEditModal');
        modal.style.display = 'none';
        resetPdfEditModal();
    }

    // ëª¨ë‹¬ ì´ˆê¸°í™”
    function resetPdfEditModal() {
        pdfEditDoc = null;
        pdfEditSelectedPages = [];
        
        document.getElementById('pdfEditFileInput').value = '';
        document.getElementById('pdfEditPageSelector').style.display = 'none';
        document.getElementById('pdfEditOutputArea').style.display = 'none';
        document.getElementById('pdfEditStatus').style.display = 'none';
        document.getElementById('pdfEditStatus').className = 'pdf-edit-status';
        
        // ì—…ë¡œë“œ ì˜ì—­ ì´ˆê¸°í™”
        const uploadArea = document.getElementById('pdfEditUploadArea');
        const fileInfo = document.getElementById('pdfEditFileInfo');
        const fileSelectBtn = document.getElementById('pdfEditFileSelectBtn');
        
        uploadArea.classList.remove('has-file');
        fileInfo.style.display = 'none';
        fileSelectBtn.style.display = 'block';
        
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        const fileNameInput = document.getElementById('pdfEditOutputFileName');
        if (fileNameInput) {
            fileNameInput.value = '';
        }
    }

    // PDF Edit ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    document.addEventListener('DOMContentLoaded', () => {
        const uploadArea = document.getElementById('pdfEditUploadArea');
        const fileInput = document.getElementById('pdfEditFileInput');
        const fileSelectBtn = document.getElementById('pdfEditFileSelectBtn');
        const modal = document.getElementById('pdfEditModal');

        // íŒŒì¼ ì„ íƒ ë²„íŠ¼ í´ë¦­
        fileSelectBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // íŒŒì¼ ì„ íƒ í›„ ë“œë˜ê·¸ ì•¤ ë“œë¡­ í™œì„±í™” (íŒŒì¼ì´ ì„ íƒëœ í›„ì—ë§Œ)
        function setupDragAndDrop() {
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ ìƒˆë¡œìš´ ìš”ì†Œ ì‚¬ìš©
            if (!uploadArea.hasAttribute('data-drag-setup')) {
                uploadArea.setAttribute('data-drag-setup', 'true');
                
                uploadArea.addEventListener('dragover', (e) => {
                    if (uploadArea.classList.contains('has-file')) {
                        e.preventDefault();
                        uploadArea.classList.add('dragover');
                    }
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    if (uploadArea.classList.contains('has-file')) {
                        e.preventDefault();
                        uploadArea.classList.remove('dragover');
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            handlePdfEditFile(files[0]);
                        }
                    }
                });

                // íŒŒì¼ì´ ì„ íƒëœ í›„ ì˜ì—­ í´ë¦­ìœ¼ë¡œ êµì²´ ê°€ëŠ¥
                uploadArea.addEventListener('click', (e) => {
                    if (uploadArea.classList.contains('has-file') && e.target !== fileSelectBtn) {
                        fileInput.click();
                    }
                });
            }
        }

        // íŒŒì¼ ì„ íƒ
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handlePdfEditFile(e.target.files[0]);
            }
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closePdfEditModal();
            }
        });

        // ESC í‚¤ë¡œ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.style.display === 'flex') {
                closePdfEditModal();
            }
        });

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì • (ì´ˆê¸°ì—ëŠ” ì„¤ì •ë§Œ í•˜ê³ , íŒŒì¼ ì„ íƒ í›„ í™œì„±í™”)
        setupDragAndDrop();
    });

    // PDF íŒŒì¼ ì²˜ë¦¬
    async function handlePdfEditFile(file) {
        if (!file.type.includes('pdf')) {
            showPdfEditStatus('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
            return;
        }

        try {
            showPdfEditStatus('PDF íŒŒì¼ì„ ë¡œë”© ì¤‘...', 'info');

            const arrayBuffer = await file.arrayBuffer();
            pdfEditDoc = await PDFLib.PDFDocument.load(arrayBuffer);
            
            const totalPages = pdfEditDoc.getPageCount();
            pdfEditSelectedPages = [];
            
            // ì—…ë¡œë“œ ì˜ì—­ ì—…ë°ì´íŠ¸ (íŒŒì¼ ì„ íƒ í›„ ìƒíƒœ)
            const uploadArea = document.getElementById('pdfEditUploadArea');
            const fileInfo = document.getElementById('pdfEditFileInfo');
            const fileName = document.getElementById('pdfEditFileName');
            const fileSelectBtn = document.getElementById('pdfEditFileSelectBtn');
            
            uploadArea.classList.add('has-file');
            fileName.textContent = file.name;
            fileInfo.style.display = 'block';
            fileSelectBtn.style.display = 'none';
            
            // í˜ì´ì§€ ì„ íƒ ì˜ì—­ê³¼ ì €ì¥ ì„¤ì • í‘œì‹œ
            document.getElementById('pdfEditPageSelector').style.display = 'block';
            document.getElementById('pdfEditOutputArea').style.display = 'block';
            
            // í˜ì´ì§€ ì²´í¬ë°•ìŠ¤ ìƒì„±
            createPdfPageCheckboxes(totalPages);
            
            showPdfEditStatus('PDF íŒŒì¼ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ì„ íƒí•˜ê³  ì €ì¥í•˜ì„¸ìš”.', 'success');
            
        } catch (error) {
            console.error('PDF ë¡œë“œ ì˜¤ë¥˜:', error);
            showPdfEditStatus('PDF íŒŒì¼ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        }
    }

    // í˜ì´ì§€ ì²´í¬ë°•ìŠ¤ ìƒì„±
    function createPdfPageCheckboxes(totalPages) {
        const container = document.getElementById('pdfEditPageCheckboxes');
        container.innerHTML = '';
        
        for (let i = 1; i <= totalPages; i++) {
            const checkbox = document.createElement('div');
            checkbox.className = 'pdf-edit-page-checkbox';
            checkbox.textContent = i;
            checkbox.onclick = () => togglePdfPage(i);
            container.appendChild(checkbox);
        }
    }

    // í˜ì´ì§€ ì„ íƒ í† ê¸€
    function togglePdfPage(pageNum) {
        const index = pdfEditSelectedPages.indexOf(pageNum);
        if (index > -1) {
            pdfEditSelectedPages.splice(index, 1);
        } else {
            pdfEditSelectedPages.push(pageNum);
        }
        
        // UI ì—…ë°ì´íŠ¸
        const checkboxes = document.querySelectorAll('.pdf-edit-page-checkbox');
        checkboxes.forEach((cb, idx) => {
            if (pdfEditSelectedPages.includes(idx + 1)) {
                cb.classList.add('selected');
            } else {
                cb.classList.remove('selected');
            }
        });
    }


    // PDF ë‹¤ìš´ë¡œë“œ (í˜ì´ì§€ ì¶”ì¶œ í¬í•¨)
    async function savePdfToServer() {
        if (!pdfEditDoc || pdfEditSelectedPages.length === 0) {
            showPdfEditStatus('í˜ì´ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        let fileName = document.getElementById('pdfEditOutputFileName').value || 'extracted_pages';
        // .pdf í™•ì¥ìê°€ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ì¶”ê°€
        if (!fileName.endsWith('.pdf')) {
            fileName = fileName + '.pdf';
        }

        try {
            showPdfEditStatus('í˜ì´ì§€ ì¶”ì¶œ ë° ë‹¤ìš´ë¡œë“œ ì¤‘...', 'info');

            // í˜ì´ì§€ ì¶”ì¶œ
            const newPdf = await PDFLib.PDFDocument.create();
            for (let i = 0; i < pdfEditSelectedPages.length; i++) {
                const pageNum = pdfEditSelectedPages[i];
                const [copiedPage] = await newPdf.copyPages(pdfEditDoc, [pageNum - 1]);
                newPdf.addPage(copiedPage);
            }
            const extractedBytes = await newPdf.save();
            
            // ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ
            const blob = new Blob([extractedBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showPdfEditStatus('íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            setTimeout(() => {
                closePdfEditModal();
            }, 1500);
        } catch (error) {
            console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
            showPdfEditStatus('ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        }
    }

    // í˜„ì¬ ì„ íƒëœ DeliveryNo ê°€ì ¸ì˜¤ê¸°
    function getCurrentDeliveryNo() {
        // ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© (preview ëª¨ë‹¬ì—ì„œ ì„¤ì •ë¨)
        if (typeof currentDeliveryNo !== 'undefined' && currentDeliveryNo) {
            return currentDeliveryNo;
        }
        return null;
    }

    // í˜„ì¬ ì„ íƒëœ FileType ê°€ì ¸ì˜¤ê¸°
    function getCurrentFileType() {
        // ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© (preview ëª¨ë‹¬ì—ì„œ ì„¤ì •ë¨)
        if (typeof currentFileType !== 'undefined' && currentFileType) {
            return currentFileType;
        }
        return null;
    }

    // í˜„ì¬ ëª¨ë“œ ê°€ì ¸ì˜¤ê¸°
    function getCurrentMode() {
        // ì „ì—­ ë³€ìˆ˜ ì‚¬ìš©
        if (typeof currentMode !== 'undefined' && currentMode) {
            return currentMode;
        }
        return 'NT'; // ê¸°ë³¸ê°’
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function showPdfEditStatus(message, type) {
        const statusElement = document.getElementById('pdfEditStatus');
        statusElement.textContent = message;
        statusElement.className = `pdf-edit-status ${type}`;
        statusElement.style.display = 'block';
    }

</script>
</body>
</html>
