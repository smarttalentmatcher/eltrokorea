<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Order Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      color: #000;
      line-height: 1.5;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: -1;
    }
    .page {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #fff !important;
      border: 1px solid #ccc;
      box-sizing: border-box;
      max-height: 100vh;
      overflow-y: auto;
    }
    h1 {
      text-align: center;
      margin: 0; /* ìƒë‹¨ ì—¬ë°± ì œê±° */
      padding-bottom: 10px;
    }
    .top-menu {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 20px;
      gap: 10px;
    }
    .mode-btn {
      padding: 8px 16px;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      cursor: pointer;
    }
    .mode-btn.selected {
      background: #000; /* ê²€ì • ë°°ê²½ */
      color: #fff;      /* í° ê¸€ì”¨ */
      border-color: #000;
    }


    table {
      width: auto;
      border-collapse: collapse;
      margin-bottom: 80px;
    }
    thead th {
      border: 1px solid #000;
      background-color: #f0f0f0;
      padding: 5px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    /* í…Œì´ë¸” ë°”ë””ì˜ í–‰ì€ í…Œë‘ë¦¬ ì—†ìŒ */
    #orderTableBody {
      background: #fff !important;
    }
    
    #orderTableBody tr td {
      border: none;
      text-align: center;
      vertical-align: middle;
      padding: 5px;
      background: #fff !important;
    }

    /* ê° ì—´ì„ ê°œë³„ì ìœ¼ë¡œ ì„¤ì • */
      /* 1ì—´: Drag + X + S */
      #orderTableBody tr td:nth-child(1) {
        width: 80px;
        min-width: 80px;
      }
    
    /* 2ì—´: PHD */
    #orderTableBody tr td:nth-child(2) {
      width: auto;
    }
    
    /* 3ì—´: Width */
    #orderTableBody tr td:nth-child(3) {
      width: auto;
    }
    
    /* 4ì—´: Length */
    #orderTableBody tr td:nth-child(4) {
      width: auto;
    }
    
    /* 5ì—´: X */
    #orderTableBody tr td:nth-child(5) {
      width: auto;
    }
    
    /* 6ì—´: KG */
    #orderTableBody tr td:nth-child(6) {
      width: auto;
    }
    
    /* 7ì—´: Quantity */
    #orderTableBody tr td:nth-child(7) {
      width: auto;
    }
    
    /* 8ì—´: Convert */
    #orderTableBody tr td:nth-child(8) {
      width: auto;
    }
    
    
    /* 10ì—´: ì¡°ì • */
    #orderTableBody tr td:nth-child(10) {
      width: auto;
    }
    
    /* 11ì—´: ë‚˜ë¨¸ì§€ */
    #orderTableBody tr td:nth-child(11) {
      width: auto;
    }
    /* í…Œì´ë¸” í—¤ë” ìŠ¤íƒ€ì¼ */
    #orderTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 5px;
      border: 1px solid #e0e0e0;
      background: #fff !important;
    }

    #orderTable thead {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: #fff;
    }

    #orderTable thead th {
      background: #fff;
      color: #000;
      padding: 15px 8px;
      text-align: center;
      font-size: 0.9rem;
      font-weight: 600;
      border: 1px solid #e0e0e0;
      border-bottom: 2px solid #ccc;
      line-height: 1.4;
      vertical-align: middle;
      min-width: 40px;
      height: 50px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: relative;
    }

    #orderTable thead th:hover {
      background: #f8f8f8;
      border-color: #999;
    }

    /* 1ì—´ í—¤ë” í­ ì„¤ì • */
    .drag-select-header {
      width: 80px;
      background: #f8f8f8 !important;
      min-width: 80px;
    }

    /* ê° ì—´ì„ ê°œë³„ì ìœ¼ë¡œ ì„¤ì • */
    /* PHD ì—´ */
    th:nth-child(3) {
      width: auto;
    }
    
    /* Width ì—´ */
    th:nth-child(4) {
      width: auto;
    }
    
    /* Length ì—´ */
    th:nth-child(5) {
      width: auto;
    }
    
    /* X ì—´ */
    th:nth-child(6) {
      width: auto;
    }
    
    /* KG ì—´ */
    th:nth-child(7) {
      width: auto;
    }
    
    /* Quantity ì—´ */
    th:nth-child(8) {
      width: auto;
    }
    
    /* Convert ì—´ */
    th:nth-child(9) {
      width: auto;
    }
    
    
    /* ì¡°ì • ì—´ */
    th:nth-child(11) {
      width: auto;
    }
    
    /* ë‚˜ë¨¸ì§€ ì—´ */
    th:nth-child(12) {
      width: auto;
    }

    /* íŠ¹ì • í—¤ë” í´ë˜ìŠ¤ë“¤ë„ ê°œë³„ ì„¤ì • */
    .x-header {
      width: 0px;
      min-width: 0px;
    }
    
    .adjust-header {
      width: 0px;
      min-width: 0px;
    }
    
    .adjust2-header {
      width: 0px;
      min-width: 0px;
    }
    
    .remainder-header {
      width: 0px;
      min-width: 0px;
    }

    /* ë“œë˜ê·¸ + Select í•©ì³ì§„ ì…€ */
    .drag-select-cell {
      width: 0px;
      padding: 0px;
      text-align: center;
      vertical-align: middle;
    }

    /* ë“œë˜ê·¸ í•¸ë“¤ */
    .drag-handle {
      width: 22px;
      cursor: move;
      font-size: 1rem;
      text-align: center;
    }

    /* Select ë²„íŠ¼ë“¤ ì»¨í…Œì´ë„ˆ */
    .select-buttons {
      display: flex;
      flex-direction: column;
      gap: 2px;
      align-items: center;
    }

    /* Select ë²„íŠ¼ í–‰ */
    .select-row {
      display: flex;
      gap: 2px;
      justify-content: center;
    }

    .deleteButton {
      font-size: 0.75rem;
      padding: 1px 3px;
      cursor: pointer;
      margin: 0;
      display: inline-block;
      width: 22px;
      height: 18px;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 2px;
    }

    /* S ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .s-button {
      width: 20px;
      height: 20px;
      font-size: 12px;
      font-weight: normal;
      padding: 0;
      margin: 0;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      cursor: pointer;
      display: inline-block;
      text-align: center;
      line-height: 18px;
      transition: all 0.2s ease;
    }
    .s-button:hover {
      background: #f0f0f0;
      border-color: #999;
    }
    .s-button.selected {
      background: #007bff !important;
      color: white !important;
      border-color: #007bff !important;
    }
    /* 1ì—´ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    .button-container {
      display: flex;
      gap: 2px;
      align-items: center;
      justify-content: center;
      flex-wrap: nowrap;
    }
    
    .adjustUpButton, .adjustDownButton {
      font-size: 0.9rem;
      padding: 2px 4px;
      cursor: pointer;
      margin: 2px;
      display: block;
      width: 20px;
      height: 20px;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
    }
    
    .adjustUpButton:hover, .adjustDownButton:hover {
      background: #f0f0f0;
    }

    /* 1ì—´ í—¤ë”ì˜ organize ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #sortPHDButton {
      font-size: 0.7rem;
      padding: 2px 4px;
      margin: 0;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 2px;
      min-width: 50px;
      height: 18px;
      line-height: 1;
      display: block;
      margin: 0 auto;
    }

    #sortPHDButton:hover {
      background: #f0f0f0;
      border-color: #999;
    }
    input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 4px;
      box-sizing: border-box;
      height: 30px;
      font-size: 0.95rem;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    
    
    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20width='12'%20height='12'%3E%3Cpolygon%20points='0,0%206,6%2012,0'%20style='fill:%23666;'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 12px;
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    /* í•˜ë‹¨ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
    .bottom-buttons {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #ccc;
      padding: 15px 20px;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    /* ê¸°íƒ€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #refreshBtn, #addRowButton, #convertBtn, #optimizeBtn, #saveBtn, #emailBtn {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
    }

    /* Convert, Unconvert, Optimize ë²„íŠ¼ë“¤ - organize ë²„íŠ¼ê³¼ ë™ì¼í•œ í¬ê¸° */
    #convert1Button, #convert2Button, #unconvertButton, #opt1Button, #opt2Button {
      font-size: 0.8rem;
      padding: 2px 4px;
      margin: 0 2px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 60px;
      height: 20px;
      line-height: 1.2;
    }

    /* ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
    #refreshBtn:hover, #addRowButton:hover, #convertBtn:hover, #optimizeBtn:hover, #saveBtn:hover, #emailBtn:hover {
      background: #f0f0f0;
      border-color: #999;
    }

    #convert1Button:hover, #convert2Button:hover, #unconvertButton:hover, #opt1Button:hover, #opt2Button:hover {
      background: #f0f0f0;
      border-color: #999;
    }


    /* í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ ì „ì²´ */
    .bottom-buttons {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      padding: 15px;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    /* í™•ì¥ ì†ì¡ì´ (ì„œë ì†ì¡ì´ì²˜ëŸ¼ ìœ„ìª½ì— íŠ€ì–´ë‚˜ì˜´) */
    .expand-handle {
      position: absolute;
      top: -15px;
      left: 20px;
      z-index: 10;
    }

    /* í™•ì¥/ì¶•ì†Œ ë²„íŠ¼ */
    .expand-btn {
      font-size: 0.8rem;
      padding: 4px 12px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #f8f8f8;
      color: #666;
      border-radius: 8px 8px 0 0;
      min-width: 40px;
      height: 20px;
      line-height: 1;
      transition: all 0.2s ease;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
    }

    .expand-btn:hover {
      background: #e8e8e8;
      border-color: #999;
      box-shadow: 0 -3px 6px rgba(0,0,0,0.15);
    }

    .expand-btn.expanded {
      transform: rotate(180deg);
      background: #e0e0e0;
    }

    /* ê¸°ë³¸ ë²„íŠ¼ ê·¸ë£¹ ë ˆì´ì•„ì›ƒ */
    .main-button-group {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
    }

    /* ìƒì„¸ ë²„íŠ¼ ì˜ì—­ */
    .detail-button-area {
      margin-top: 10px;
      padding: 12px;
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      animation: slideDown 0.3s ease;
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .detail-button-area button {
      margin: 0;
    }

    /* ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* í…Œì´ë¸” í•˜ë‹¨ ì—¬ë°± (ê³ ì • ë²„íŠ¼ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡) */
    #orderTable {
      margin-bottom: 120px;
    }

    /* + ë²„íŠ¼ì€ ì •ì‚¬ê°í˜•ìœ¼ë¡œ */
    #refreshBtn {
      min-width: 30px;
      width: 30px;
      height: 30px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: normal;
    }

    #addRowButton {
      min-width: 30px;
      width: 30px;
      height: 30px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: normal;
    }


    /* ë²„íŠ¼ ê·¸ë£¹ ë‚´ë¶€ ê°„ê²© ì¡°ì • */
    .left-button-group button, .center-button-group button {
      margin-right: 5px;
    }

    .left-button-group button:last-child, .center-button-group button:last-child {
      margin-right: 0;
    }

    /* ì‘ì€ ë²„íŠ¼ë“¤ì„ í° ë²„íŠ¼ê³¼ ì¤‘ê°„ ì •ë ¬ ë§ì¶”ê¸° */
    #convert1Button, #convert2Button, #unconvertButton, #opt1Button, #opt2Button {
      vertical-align: middle;
      margin-top: 5px; /* í° ë²„íŠ¼ê³¼ ì¤‘ê°„ ì •ë ¬ì„ ìœ„í•´ ìœ„ìª½ ì—¬ë°± ì¡°ì • */
    }

    /* ìƒë‹¨ ë©”ë‰´ ì¢Œìš° ë°°ì¹˜ ë ˆì´ì•„ì›ƒ */
    .top-menu {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .left-menu {
      display: flex;
      gap: 3px;
    }

    .right-menu {
      display: flex;
      gap: 3px;
    }

    /* ìƒë‹¨ ë©”ë‰´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .top-menu-btn {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
    }

    .top-menu-btn:hover {
      background: #f0f0f0;
      border-color: #999;
    }

    /* ëª¨ë“œ ë²„íŠ¼ ì„ íƒ ìƒíƒœ */
    .top-menu-btn.mode-btn.selected {
      background: black;
      color: white;
      border-color: black;
    }

    /* ëª¨ë“œ ë²„íŠ¼ ë¹„í™œì„±í™” ìƒíƒœ */
    .top-menu-btn.mode-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #f0f0f0;
      color: #999;
      border-color: #ccc;
    }

    .top-menu-btn.mode-btn:disabled:hover {
      background: #f0f0f0;
      border-color: #ccc;
    }

    /* ëª¨ë‹¬ ì°½ ìŠ¤íƒ€ì¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 0;
      border: 1px solid #888;
      width: 500px;
      max-height: 90vh;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 15px 20px;
      background-color: #f8f8f8;
      border-bottom: 1px solid #ddd;
      border-radius: 5px 5px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      color: #333;
    }

    .close-server, .close-filename, .close-delete {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .close-server:hover, .close-filename:hover, .close-delete:hover {
      color: #000;
    }

    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .close:hover {
      color: #000;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .file-input-section {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .file-info {
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #e0e0e0;
    }

    .file-info h4 {
      margin: 0 0 10px 0;
      color: #333;
    }

    .modal-footer {
      padding: 15px 20px;
      background-color: #f8f8f8;
      border-top: 1px solid #ddd;
      border-radius: 0 0 5px 5px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* ëª¨ë‹¬ ë‚´ë¶€ ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
    .modal button:hover {
      background: #f0f0f0 !important;
      border-color: #999 !important;
    }

    /* ë³€í™˜ëœ í–‰ì€ ì´ˆë¡ìƒ‰ ê¸€ì */
    .converted {
      color: green;
    }

    /* Order Header ìŠ¤íƒ€ì¼ */
    .order-header {
      display: flex;
      justify-content: space-between;
      padding-top: 10px;
      margin-top: 10px;
      font-weight: bold;
      font-size: 1.1rem;
    }
    /* ì™¼ìª½/ì˜¤ë¥¸ìª½ ì˜ì—­ì— input ì‚¬ìš© */
    .order-header .left, .order-header .right {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .order-header .left input,
    .order-header .right input {
      font-size: 1rem;
      width: 140px;
      padding: 4px 4px;
      height: 24px;
    }
  </style>
  <!-- SortableJS (ë“œë˜ê·¸ ì •ë ¬) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>

<body>
<div class="page">
  <h1>Order Form</h1>

  <!-- ìƒë‹¨ ë©”ë‰´ ì˜ì—­ -->
  <div class="top-menu">
    <!-- ì™¼ìª½: Home -->
    <div class="left-menu">
      <button type="button" onclick="location.href='eltrokorea9.html'" class="top-menu-btn">Home</button>
    </div>
    <!-- ì˜¤ë¥¸ìª½: NT, SM-B, SM-C -->
    <div class="right-menu">
      <button id="ntBtn" class="top-menu-btn mode-btn selected">NT</button>
      <button id="smbBtn" class="top-menu-btn mode-btn">SM-B</button>
      <button id="smcBtn" class="top-menu-btn mode-btn">SM-C</button>
    </div>
  </div>

  <!-- Order IDì™€ Date ì…ë ¥ ì˜ì—­ -->
  <div class="order-header">
    <div class="left">
      ORDER ID :
      <input type="text" id="orderIdInput" autocomplete="off" />
    </div>
    <div class="right">
      DATE :
      <input type="text" id="orderDateInput" autocomplete="off" />
      ì…ê³  :
      <input type="text" id="warehouseInput" autocomplete="off" />
    </div>
  </div>

  <table id="orderTable">
    <thead>
      <tr>
        <!-- Row Number -->
        <th class="row-number-header" style="width: 25px; min-width: 25px; background: #f8f8f8 !important;"></th>
        <!-- Drag + Select (í•©ì³ì§„ ì—´) -->
        <th class="drag-select-header" style="width: 80px; min-width: 80px;">
          <button id="sortPHDButton" type="button">organize</button>
        </th>
        <!-- PHD -->
        <th>PHD</th>
        <th>Width</th>
        <th>Length</th>
        <th class="x-header">X</th>
        <th style="width: 80px; min-width: 80px;">KG<br><span id="totalKg" style="font-size: 0.8em; color: #666;">ì´: 0</span></th>
        <th style="width: 80px; min-width: 80px;">Quantity<br><span id="totalQuantity" style="font-size: 0.8em; color: #666;">ì´: 0</span></th>
        <!-- 9ë²ˆì§¸ ì—´: Adjustment -->
        <th class="adjust-header">Convert<br><span id="totalAdjustment" style="font-size: 0.8em; color: #666;">ì´: 0</span></th>
        <!-- 11ë²ˆì§¸ ì—´: ì¡°ì • ë²„íŠ¼ -->
        <th class="adjust-buttons-header">ì¡°ì •</th>
        <!-- 12ë²ˆì§¸ ì—´: ë‚˜ë¨¸ì§€ -->
        <th class="remainder-header">ë‚˜ë¨¸ì§€</th>
      </tr>
    </thead>
    <tbody id="orderTableBody">
      <!-- ì´ˆê¸°ì—ëŠ” ë¹ˆ ìƒíƒœ -->
    </tbody>
  </table>

  <div class="bottom-buttons">
    <!-- í™•ì¥/ì¶•ì†Œ ë²„íŠ¼ (ì„œë ì†ì¡ì´ì²˜ëŸ¼ ìœ„ìª½ì— íŠ€ì–´ë‚˜ì˜´) -->
    <div class="expand-handle">
      <button id="expandButton" type="button" class="expand-btn">â–¼</button>
    </div>
    
          <!-- ê¸°ë³¸ ë²„íŠ¼ ì˜ì—­ (í•­ìƒ ë³´ì„) -->
      <div class="main-button-group">
        <button id="refreshBtn" type="button" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
        <button id="addRowButton" type="button">+</button>
        <button id="convertBtn" type="button">Convert</button>
        <button id="optimizeBtn" type="button">Optimize</button>
        <button id="saveBtn" type="button">Save</button>
        <button id="emailBtn" type="button">Email</button>
        <div style="margin-left: auto; display: flex; gap: 8px;">
          <button type="button" onclick="startNewOrder()" class="top-menu-btn">Update</button>
          <button type="button" id="openServerBtn" class="top-menu-btn">Open</button>
        </div>
      </div>
    
    <!-- í™•ì¥ ê°€ëŠ¥í•œ ìƒì„¸ ë²„íŠ¼ ì˜ì—­ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€) -->
    <div id="detailButtonArea" class="detail-button-area" style="display: none;">
    <button id="convert1Button" type="button">Convert1</button>
    <button id="convert2Button" type="button">Convert2</button>
    <button id="unconvertButton" type="button">Unconvert</button>
      <button id="opt1Button" type="button">Opt1</button>
      <button id="opt2Button" type="button">Opt2</button>
    </div>
  </div>
</div>


<!-- ì„œë²„ íŒŒì¼ ëª©ë¡ ëª¨ë‹¬ -->
<div id="serverFileModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</h3>
      <span class="close-server">&times;</span>
    </div>
    <div class="modal-body">
      <div style="margin-bottom: 15px;">
        <select id="modeFilter" style="width: 67px; padding: 6px 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
          <option value="all">ì „ì²´</option>
          <option value="NT">NT</option>
          <option value="SM-B">SM-B</option>
          <option value="SM-C">SM-C</option>
        </select>
      </div>
      <div id="serverFileList">
        <p>ì„œë²„ì—ì„œ íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
    </div>
    <div class="modal-footer">
    </div>
  </div>
</div>


<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="deleteConfirmModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>íŒŒì¼ ì‚­ì œ í™•ì¸</h3>
      <span class="close-delete">&times;</span>
    </div>
    <div class="modal-body">
      <div style="text-align: center; padding: 20px;">
        <div style="font-size: 18px; margin-bottom: 15px;">
          <strong id="deleteFileName"></strong> íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?
        </div>
        <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 4px; margin: 15px 0;">
          <strong>âš ï¸ ì£¼ì˜:</strong> ì‚­ì œëœ íŒŒì¼ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </div>
        <div id="deleteFileInfo" style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px;">
          <!-- íŒŒì¼ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" id="confirmDeleteBtn" class="top-menu-btn" style="background-color: #dc3545; color: white; border-color: #dc3545;">ì‚­ì œ</button>
      <button type="button" id="cancelDeleteBtn" class="top-menu-btn">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- í…œí”Œë¦¿: ì›ë³¸ í–‰ -->
<template id="baseRowTemplate">
  <tr>
    <!-- Row Number -->
    <td class="row-number-cell" style="text-align: center; width: 25px; min-width: 25px;">
      <span class="row-number">1</span>
    </td>
    <!-- 1: Drag + X + S (í•©ì³ì§„ ì—´) -->
    <td class="drag-select-cell">
      <div class="button-container">
        <div class="drag-handle">â˜°</div>
        <button class="deleteButton" type="button">X</button>
        <button class="s-button" type="button">S</button>
      </div>
    </td>
    <!-- 4: PHD -->
    <td>
      <select class="phdSelect">
        <option value="3">3</option>
        <option value="3.5">3.5</option>
        <option value="4">4</option>
        <option value="4.5">4.5</option>
        <option value="5">5</option>
        <option value="5.5">5.5</option>
        <option value="6">6</option>
        <option value="6.5">6.5</option>
        <option value="7">7</option>
        <option value="7.5">7.5</option>
        <option value="8">8</option>
        <option value="8.5">8.5</option>
        <option value="9">9</option>
        <option value="9.5">9.5</option>
        <option value="10">10</option>
        <option value="10.5">10.5</option>
        <option value="11">11</option>
        <option value="11.5">11.5</option>
        <option value="12">12</option>
        <option value="12.5">12.5</option>
        <option value="13">13</option>
        <option value="13.5">13.5</option>
        <option value="14">14</option>
        <option value="14.5">14.5</option>
        <option value="15">15</option>
        <option value="15.5">15.5</option>
        <option value="16">16</option>
        <option value="16.5">16.5</option>
        <option value="17">17</option>
        <option value="17.5">17.5</option>
        <option value="18">18</option>
        <option value="18.5">18.5</option>
        <option value="19">19</option>
        <option value="19.5">19.5</option>
        <option value="20">20</option>
      </select>
    </td>
    <!-- 5: Width -->
    <td><input type="number" class="widthInput"></td>
    <!-- 6: Length -->
    <td><input type="number" class="lengthInput"></td>
    <!-- 7: X -->
    <td><input type="text" class="xOutput"></td>
    <!-- 8: KG -->
    <td><input type="number" class="kgInput"></td>
    <!-- 9: Quantity -->
    <td><input type="number" class="quantityOutput"></td>
    <!-- 10: 1ì•ˆ -->
    <td><input type="number" class="adjustmentInput" ></td>
    <!-- 12: ì¡°ì • ë²„íŠ¼ -->
    <td>
      <button class="adjustUpButton" type="button" title="ìœ„ë¡œ ì¡°ì •">â–²</button>
      <button class="adjustDownButton" type="button" title="ì•„ë˜ë¡œ ì¡°ì •">â–¼</button>
    </td>
    <!-- 13: ë‚˜ë¨¸ì§€ -->
    <td><input type="number" class="remainderInput"></td>
  </tr>
</template>

<!-- í…œí”Œë¦¿: ë³€í™˜ í–‰ (.converted) -->
<template id="convertedRowTemplate">
  <tr class="converted">
    <!-- Row Number -->
    <td class="row-number-cell" style="text-align: center; width: 25px; min-width: 25px;">
      <span class="row-number">1</span>
    </td>
    <!-- 1: Drag + X + S (í•©ì³ì§„ ì—´) -->
    <td class="drag-select-cell">
      <div class="button-container">
        <div class="drag-handle">â˜°</div>
        <button class="deleteButton" type="button">X</button>
        <button class="s-button" type="button">S</button>
      </div>
    </td>
    <!-- 4: PHD -->
    <td>
      <select class="phdSelect">
        <option value="3">3</option>
        <option value="3.5">3.5</option>
        <option value="4">4</option>
        <option value="4.5">4.5</option>
        <option value="5">5</option>
        <option value="5.5">5.5</option>
        <option value="6">6</option>
        <option value="6.5">6.5</option>
        <option value="7">7</option>
        <option value="7.5">7.5</option>
        <option value="8">8</option>
        <option value="8.5">8.5</option>
        <option value="9">9</option>
        <option value="9.5">9.5</option>
        <option value="10">10</option>
        <option value="10.5">10.5</option>
        <option value="11">11</option>
        <option value="11.5">11.5</option>
        <option value="12">12</option>
        <option value="12.5">12.5</option>
        <option value="13">13</option>
        <option value="13.5">13.5</option>
        <option value="14">14</option>
        <option value="14.5">14.5</option>
        <option value="15">15</option>
        <option value="15.5">15.5</option>
        <option value="16">16</option>
        <option value="16.5">16.5</option>
        <option value="17">17</option>
        <option value="17.5">17.5</option>
        <option value="18">18</option>
        <option value="18.5">18.5</option>
        <option value="19">19</option>
        <option value="19.5">19.5</option>
        <option value="20">20</option>
      </select>
    </td>
    <!-- 5: Width -->
    <td><input type="number" class="widthInput"></td>
    <!-- 6: Length -->
    <td><input type="number" class="lengthInput"></td>
    <!-- 7: X -->
    <td><input type="text" class="xOutput"></td>
    <!-- 8: KG -->
    <td><input type="number" class="kgInput"></td>
    <!-- 9: Quantity -->
    <td><input type="number" class="quantityOutput"></td>
    <!-- 10: 1ì•ˆ -->
    <td><input type="number" class="adjustmentInput" ></td>
    <!-- 12: ì¡°ì • ë²„íŠ¼ -->
    <td>
      <button class="adjustUpButton" type="button" title="ìœ„ë¡œ ì¡°ì •">â–²</button>
      <button class="adjustDownButton" type="button" title="ì•„ë˜ë¡œ ì¡°ì •">â–¼</button>
    </td>
    <!-- 13: ë‚˜ë¨¸ì§€ -->
    <td><input type="number" class="remainderInput"></td>
  </tr>
</template>

<script>
  // ================== mode selection =====================
  let selectedMode = "NT"; // default mode

  const ntBtn  = document.getElementById("ntBtn");
  const smbBtn = document.getElementById("smbBtn");
  const smcBtn = document.getElementById("smcBtn");

  ntBtn.addEventListener("click", () => {
    selectedMode = "NT";
    ntBtn.classList.add("selected");
    smbBtn.classList.remove("selected");
    smcBtn.classList.remove("selected");
  });
  smbBtn.addEventListener("click", () => {
    selectedMode = "SM-B";
    smbBtn.classList.add("selected");
    ntBtn.classList.remove("selected");
    smcBtn.classList.remove("selected");
  });
  smcBtn.addEventListener("click", () => {
    selectedMode = "SM-C";
    smcBtn.classList.add("selected");
    ntBtn.classList.remove("selected");
    smbBtn.classList.remove("selected");
  });

  // PHDë³„ baseê°’(ì˜ˆì‹œ) - Quantity ê³„ì‚°í•  ë•Œ ì‚¬ìš©
  const phdMapping = {
    "3": 13000, "3.5": 11200, "4": 10000, "4.5": 9100,
    "5": 8100, "5.5": 7400, "6": 6750, "6.5": 6200,
    "7": 5750, "7.5": 5350, "8": 5000, "8.5": 4700,
    "9": 4500, "10": 4050, "12": 3350, "15": 2650,
    "18": 2200, "20": 2000
  };







  //===================================================
  // 1ì•ˆ ê°’ ìœ„/ì•„ë˜ ì¡°ì • (ë¹„ìœ¨ì— ë§ëŠ” ë‹¤ìŒ/ì´ì „ ê°’)
  //===================================================
  function adjustAdjustmentValue(row, direction) {
    // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
    if (row.isAdjusting) {
      return;
    }
    row.isAdjusting = true;
    
    const phdVal = row.querySelector(".phdSelect").value;
    const lengthVal = parseFloat(row.querySelector(".lengthInput").value) || 0;
    const widthVal = parseFloat(row.querySelector(".widthInput").value) || 0;
    const currentAdjustment = parseFloat(row.querySelector(".adjustmentInput").value) || 0;
    
    // ë””ë²„ê·¸: ì‹œì‘ ìƒíƒœ ë¡œê¹…
    
    // currentAdjustment === 0 ì´ë”ë¼ë„ ë™ì‘í•´ì•¼ í•˜ë¯€ë¡œ ì œê±°
    if (!phdVal || lengthVal === 0 || widthVal === 0) {
      row.isAdjusting = false;
      return;
    }
    
    let newAdjustment = currentAdjustment;

    // 1ë²ˆ ë£°: 620 +ë²„íŠ¼ì€ ì–¸ì œë‚˜ ì‘ë™, -ë²„íŠ¼ì€ ë‚˜ë¨¸ì§€ ì¡°ê±´ ì ìš©
    if (widthVal === 620) {
      const currentAdj = parseFloat(row.querySelector(".adjustmentInput").value) || 0;
      const currentRem = getRemainderValue(row);
      
      if (direction === 'up') {
        // 620 +ë²„íŠ¼: ì–¸ì œë‚˜ ì‘ë™, 620 1ì•ˆ +1, ë‚˜ë¨¸ì§€ +1
        row.querySelector(".adjustmentInput").value = currentAdj + 1;
        row.querySelector(".remainderInput").value = currentRem + 1;
      } else {
        // 620 -ë²„íŠ¼: ë‚˜ë¨¸ì§€ê°€ >0ì¸ ê²½ìš°ì—ë§Œ ì‘ë™
        if (currentRem <= 0) {
          updateTotals();
          row.isAdjusting = false;
          return;
        }
        
        if (currentAdj <= 0) {
          updateTotals();
          row.isAdjusting = false;
          return;
        }
        row.querySelector(".adjustmentInput").value = currentAdj - 1;
        row.querySelector(".remainderInput").value = Math.max(0, currentRem - 1);
      }
      updateTotals();
      row.isAdjusting = false;
      return;
    }

    // 2ë²ˆ ë£°: 620Â·820 ìˆê³  920 ì—†ìŒ
    if (widthVal === 620) {
      const allRows = document.querySelectorAll("#orderTableBody tr");
      const sameGroupRows = Array.from(allRows).filter(row => {
        const rowPhd = row.querySelector(".phdSelect").value;
        const rowLength = parseFloat(row.querySelector(".lengthInput").value) || 0;
        return rowPhd === phdVal && rowLength === lengthVal;
      });
      
      const hasRow820 = sameGroupRows.some(r => parseFloat(r.querySelector(".widthInput").value) === 820);
      const hasRow920 = sameGroupRows.some(r => {
        const width = parseFloat(r.querySelector(".widthInput").value);
        const adjustment = parseFloat(r.querySelector(".adjustmentInput").value);
        return width === 920 && adjustment > 0;
      });
      
      if (hasRow820 && !hasRow920) {
        const currentAdj = parseFloat(row.querySelector(".adjustmentInput").value) || 0;
        const currentRem = getRemainderValue(row);
        
        if (direction === 'up') {
          // 620 +ë²„íŠ¼: ì–¸ì œë‚˜ ì‘ë™, 620 1ì•ˆ +1, ë‚˜ë¨¸ì§€ +1
          row.querySelector(".adjustmentInput").value = currentAdj + 1;
          row.querySelector(".remainderInput").value = currentRem + 1;
        } else {
          // 620 -ë²„íŠ¼: ë‚˜ë¨¸ì§€ê°€ >0ì¸ ê²½ìš°ì—ë§Œ ì‘ë™
          if (currentRem <= 0) {
            updateTotals();
            row.isAdjusting = false;
            return;
          }
          
          if (currentAdj <= 0) {
            updateTotals();
            row.isAdjusting = false;
            return;
          }
          row.querySelector(".adjustmentInput").value = currentAdj - 1;
          row.querySelector(".remainderInput").value = Math.max(0, currentRem - 1);
        }
        updateTotals();
        row.isAdjusting = false;
        return;
      }
    }
    
    if (widthVal === 820) {
      const allRows = document.querySelectorAll("#orderTableBody tr");
      const sameGroupRows = Array.from(allRows).filter(row => {
        const rowPhd = row.querySelector(".phdSelect").value;
        const rowLength = parseFloat(row.querySelector(".lengthInput").value) || 0;
        return rowPhd === phdVal && rowLength === lengthVal;
      });
      
      // 630, 850, 745, 770ì„ ì œì™¸í•˜ê³  620, 820, 920ë§Œ ê³ ë ¤
      const hasRow620 = sameGroupRows.some(r => parseFloat(r.querySelector(".widthInput").value) === 620);
      const hasRow920 = sameGroupRows.some(r => {
        const width = parseFloat(r.querySelector(".widthInput").value);
        const adjustment = parseFloat(r.querySelector(".adjustmentInput").value);
        return width === 920 && adjustment > 0;
      });
      
      if (hasRow620 && !hasRow920) {
        const row620_e = sameGroupRows.find(r => parseFloat(r.querySelector(".widthInput").value) === 620);
        const row820_e = row;
        const adj820 = parseFloat(row820_e.querySelector(".adjustmentInput").value) || 0;
        const adj620 = parseFloat(row620_e.querySelector(".adjustmentInput").value) || 0;
        const rem620 = getRemainderValue(row620_e);
        
        if (direction === 'up') {
          row820_e.querySelector(".adjustmentInput").value = adj820 + 3;
          
          // 620 ë‚˜ë¨¸ì§€ì— ë”°ë¥¸ ì²˜ë¦¬
          if (rem620 === 0) {
            // 620 ë‚˜ë¨¸ì§€ê°€ 0ì´ë‚˜ ê³µë€ì¸ ê²½ìš°
            row620_e.querySelector(".adjustmentInput").value = adj620 + 3;
          } else if (rem620 >= 1 && rem620 <= 2) {
            // 620 ë‚˜ë¨¸ì§€ê°€ 1ì´ë‚˜ 2ì¼ ë•Œ
            // 620 1ì•ˆì€ 820 1ì•ˆê³¼ ê°™ì€ ê°’, ë‚˜ë¨¸ì§€ 0
            row620_e.querySelector(".adjustmentInput").value = adj820 + 3;
            row620_e.querySelector(".remainderInput").value = 0;
          } else if (rem620 >= 3) {
            // 620 ë‚˜ë¨¸ì§€ê°€ 3ì´ìƒì¼ ë•Œ
            row620_e.querySelector(".remainderInput").value = rem620 - 3;
          }
        } else {
          if (adj820 <= 0) {
            updateTotals();
            row.isAdjusting = false;
            return;
          }
          row820_e.querySelector(".adjustmentInput").value = adj820 - 3;
          
          // 620 ë‚˜ë¨¸ì§€ì— ë”°ë¥¸ ì²˜ë¦¬
          if (rem620 === 0) {
            // 620 ë‚˜ë¨¸ì§€ê°€ 0ì´ë‚˜ ê³µë€ì¸ ê²½ìš°
            row620_e.querySelector(".adjustmentInput").value = Math.max(0, adj620 - 3);
          } else if (rem620 >= 1 && rem620 <= 2) {
            // 620 ë‚˜ë¨¸ì§€ê°€ 1ì´ë‚˜ 2ì¼ ë•Œ - ë‚˜ë¨¸ì§€ ê·¸ëŒ€ë¡œ
            // 620 1ì•ˆì€ ê·¸ëŒ€ë¡œ ìœ ì§€
          } else if (rem620 >= 3) {
            // 620 ë‚˜ë¨¸ì§€ê°€ 3ì´ìƒì¼ ë•Œ - ë‚˜ë¨¸ì§€ ê·¸ëŒ€ë¡œ
            // 620 1ì•ˆì€ ê·¸ëŒ€ë¡œ ìœ ì§€
          }
        }
        updateTotals();
        row.isAdjusting = false;
        return;
      }
    }

    // 3ë²ˆ ë£°: 620Â·920 ìˆê³  820 ì—†ìŒ
    if (widthVal === 620) {
      const allRows = document.querySelectorAll("#orderTableBody tr");
      const sameGroupRows = Array.from(allRows).filter(row => {
        const rowPhd = row.querySelector(".phdSelect").value;
        const rowLength = parseFloat(row.querySelector(".lengthInput").value) || 0;
        return rowPhd === phdVal && rowLength === lengthVal;
      });
      
      const hasRow820 = sameGroupRows.some(r => {
        const width = parseFloat(r.querySelector(".widthInput").value);
        const adjustment = parseFloat(r.querySelector(".adjustmentInput").value);
        return width === 820 && adjustment > 0;
      });
      const hasRow920 = sameGroupRows.some(r => {
        const width = parseFloat(r.querySelector(".widthInput").value);
        const adjustment = parseFloat(r.querySelector(".adjustmentInput").value);
        return width === 920 && adjustment > 0;
      });
      
      if (!hasRow820 && hasRow920) {
        const currentAdj = parseFloat(row.querySelector(".adjustmentInput").value) || 0;
        const currentRem = getRemainderValue(row);
        
        if (direction === 'up') {
          // 620 +ë²„íŠ¼: ì–¸ì œë‚˜ ì‘ë™, 620 1ì•ˆ +1, ë‚˜ë¨¸ì§€ +1
          row.querySelector(".adjustmentInput").value = currentAdj + 1;
          row.querySelector(".remainderInput").value = currentRem + 1;
        } else {
          // 620 -ë²„íŠ¼: ë‚˜ë¨¸ì§€ê°€ >0ì¸ ê²½ìš°ì—ë§Œ ì‘ë™
          if (currentRem <= 0) {
            updateTotals();
            row.isAdjusting = false;
            return;
          }
          
          if (currentAdj <= 0) {
            updateTotals();
            row.isAdjusting = false;
            return;
          }
          row.querySelector(".adjustmentInput").value = currentAdj - 1;
          row.querySelector(".remainderInput").value = Math.max(0, currentRem - 1);
        }
        updateTotals();
        row.isAdjusting = false;
        return;
      }
    }
    
    if (widthVal === 920) {
      
      const allRows = document.querySelectorAll("#orderTableBody tr");
      const sameGroupRows = Array.from(allRows).filter(row => {
        const rowPhd = row.querySelector(".phdSelect").value;
        const rowLength = parseFloat(row.querySelector(".lengthInput").value) || 0;
        return rowPhd === phdVal && rowLength === lengthVal;
      });
      
      // 630, 850, 745, 770ì„ ì œì™¸í•˜ê³  620, 820, 920ë§Œ ê³ ë ¤
      const hasRow620 = sameGroupRows.some(r => {
        const width = parseFloat(r.querySelector(".widthInput").value);
        const adjustment = parseFloat(r.querySelector(".adjustmentInput").value);
        return width === 620 && adjustment > 0;
      });
      const hasRow820 = sameGroupRows.some(r => {
        const width = parseFloat(r.querySelector(".widthInput").value);
        const adjustment = parseFloat(r.querySelector(".adjustmentInput").value);
        return width === 820 && adjustment > 0;
      });
      
      
      if (hasRow620 && !hasRow820) {
        const row620_e3 = sameGroupRows.find(r => parseFloat(r.querySelector(".widthInput").value) === 620);
        const row920_e3 = row;
        const adj920 = parseFloat(row920_e3.querySelector(".adjustmentInput").value) || 0;
        const adj620 = parseFloat(row620_e3.querySelector(".adjustmentInput").value) || 0;
        const rem620 = getRemainderValue(row620_e3);
        
        
        if (direction === 'up') {
          row920_e3.querySelector(".adjustmentInput").value = adj920 + 4;
          if (rem620 > 0) {
            row620_e3.querySelector(".remainderInput").value = Math.max(0, rem620 - 1);
          } else {
            row620_e3.querySelector(".adjustmentInput").value = adj620 + 1;
          }
        } else {
          if (adj920 <= 0) {
            updateTotals();
            row.isAdjusting = false;
            return;
          }
          row920_e3.querySelector(".adjustmentInput").value = adj920 - 4;
          if (rem620 > 0) {
            row620_e3.querySelector(".remainderInput").value = rem620 + 1;
          } else {
            row620_e3.querySelector(".adjustmentInput").value = Math.max(0, adj620 - 1);
          }
        }
        updateTotals();
        row.isAdjusting = false;
        return;
      } else {
      }
    }

    // 4ë²ˆ ë£°: 820Â·920 ìˆê³  620 ì—†ìŒ (820ë§Œ ì¡°ì • ê°€ëŠ¥)
    if (widthVal === 820) {
      const allRows = document.querySelectorAll("#orderTableBody tr");
      const sameGroupRows = Array.from(allRows).filter(row => {
        const rowPhd = row.querySelector(".phdSelect").value;
        const rowLength = parseFloat(row.querySelector(".lengthInput").value) || 0;
        return rowPhd === phdVal && rowLength === lengthVal;
      });
      
      // 630, 850, 745, 770ì„ ì œì™¸í•˜ê³  620, 820, 920ë§Œ ê³ ë ¤
      const hasRow620 = sameGroupRows.some(r => {
        const width = parseFloat(r.querySelector(".widthInput").value);
        const adjustment = parseFloat(r.querySelector(".adjustmentInput").value);
        return width === 620 && adjustment > 0;
      });
      const hasRow820 = sameGroupRows.some(r => {
        const width = parseFloat(r.querySelector(".widthInput").value);
        const adjustment = parseFloat(r.querySelector(".adjustmentInput").value);
        return width === 820 && adjustment > 0;
      });
      const hasRow920 = sameGroupRows.some(r => {
        const width = parseFloat(r.querySelector(".widthInput").value);
        const adjustment = parseFloat(r.querySelector(".adjustmentInput").value);
        return width === 920 && adjustment > 0;
      });
      
      if (!hasRow620 && hasRow820 && hasRow920) {
        const row820_e4 = sameGroupRows.find(r => parseFloat(r.querySelector(".widthInput").value) === 820);
        const row920_e4 = sameGroupRows.find(r => parseFloat(r.querySelector(".widthInput").value) === 920);
        const adj820 = parseFloat(row820_e4.querySelector(".adjustmentInput").value) || 0;
        const adj920 = parseFloat(row920_e4.querySelector(".adjustmentInput").value) || 0;
        
        if (direction === 'up') {
          row820_e4.querySelector(".adjustmentInput").value = adj820 + 3;
          row920_e4.querySelector(".adjustmentInput").value = adj920 + 2;
        } else {
          if (adj820 <= 0) {
            updateTotals();
            row.isAdjusting = false;
            return;
          }
          row820_e4.querySelector(".adjustmentInput").value = adj820 - 3;
          row920_e4.querySelector(".adjustmentInput").value = Math.max(0, adj920 - 2);
        }
        updateTotals();
        row.isAdjusting = false;
        return;
      }
    }

    // 5ë²ˆ ë£°: 620Â·820Â·920 ëª¨ë‘ ìˆìŒ
    if (widthVal === 620) {
      const allRows = document.querySelectorAll("#orderTableBody tr");
      const sameGroupRows = Array.from(allRows).filter(row => {
        const rowPhd = row.querySelector(".phdSelect").value;
        const rowLength = parseFloat(row.querySelector(".lengthInput").value) || 0;
        return rowPhd === phdVal && rowLength === lengthVal;
      });
      
      const hasRow820 = sameGroupRows.some(r => {
        const width = parseFloat(r.querySelector(".widthInput").value);
        const adjustment = parseFloat(r.querySelector(".adjustmentInput").value);
        return width === 820 && adjustment > 0;
      });
      const hasRow920 = sameGroupRows.some(r => {
        const width = parseFloat(r.querySelector(".widthInput").value);
        const adjustment = parseFloat(r.querySelector(".adjustmentInput").value);
        return width === 920 && adjustment > 0;
      });
      
      if (hasRow820 && hasRow920) {
        const currentAdj = parseFloat(row.querySelector(".adjustmentInput").value) || 0;
        const currentRem = getRemainderValue(row);
        
        if (direction === 'up') {
          // 620 +ë²„íŠ¼: ì–¸ì œë‚˜ ì‘ë™, 620 1ì•ˆ +1, ë‚˜ë¨¸ì§€ +1
          row.querySelector(".adjustmentInput").value = currentAdj + 1;
          row.querySelector(".remainderInput").value = currentRem + 1;
        } else {
          // 620 -ë²„íŠ¼: ë‚˜ë¨¸ì§€ê°€ >0ì¸ ê²½ìš°ì—ë§Œ ì‘ë™
          if (currentRem <= 0) {
            updateTotals();
            row.isAdjusting = false;
            return;
          }
          
          if (currentAdj <= 0) {
            updateTotals();
            row.isAdjusting = false;
            return;
          }
          row.querySelector(".adjustmentInput").value = currentAdj - 1;
          row.querySelector(".remainderInput").value = Math.max(0, currentRem - 1);
        }
        updateTotals();
        row.isAdjusting = false;
        return;
      }
    }
    
    if (widthVal === 820 || widthVal === 920) {
      const allRows = document.querySelectorAll("#orderTableBody tr");
      const sameGroupRows = Array.from(allRows).filter(row => {
        const rowPhd = row.querySelector(".phdSelect").value;
        const rowLength = parseFloat(row.querySelector(".lengthInput").value) || 0;
        return rowPhd === phdVal && rowLength === lengthVal;
      });
      
      // 630, 850, 745, 770ì„ ì œì™¸í•˜ê³  620, 820, 920ë§Œ ê³ ë ¤
      const hasRow620 = sameGroupRows.some(r => {
        const width = parseFloat(r.querySelector(".widthInput").value);
        const adjustment = parseFloat(r.querySelector(".adjustmentInput").value);
        return width === 620 && adjustment > 0;
      });
      const hasRow820 = sameGroupRows.some(r => {
        const width = parseFloat(r.querySelector(".widthInput").value);
        const adjustment = parseFloat(r.querySelector(".adjustmentInput").value);
        return width === 820 && adjustment > 0;
      });
      const hasRow920 = sameGroupRows.some(r => {
        const width = parseFloat(r.querySelector(".widthInput").value);
        const adjustment = parseFloat(r.querySelector(".adjustmentInput").value);
        return width === 920 && adjustment > 0;
      });
      
      if (hasRow620 && hasRow820 && hasRow920) {
        const row620_e5 = sameGroupRows.find(r => parseFloat(r.querySelector(".widthInput").value) === 620);
        const row820_e5 = sameGroupRows.find(r => parseFloat(r.querySelector(".widthInput").value) === 820);
        const row920_e5 = sameGroupRows.find(r => parseFloat(r.querySelector(".widthInput").value) === 920);
        const adj620 = parseFloat(row620_e5.querySelector(".adjustmentInput").value) || 0;
        const adj820 = parseFloat(row820_e5.querySelector(".adjustmentInput").value) || 0;
        const adj920 = parseFloat(row920_e5.querySelector(".adjustmentInput").value) || 0;
        const rem620 = getRemainderValue(row620_e5);
        
        if (widthVal === 820) {
          if (direction === 'up') {
            row820_e5.querySelector(".adjustmentInput").value = adj820 + 3;
            row920_e5.querySelector(".adjustmentInput").value = adj920 + 2;
          } else {
            if (adj820 <= 0) {
              updateTotals();
              row.isAdjusting = false;
              return;
            }
            row820_e5.querySelector(".adjustmentInput").value = adj820 - 3;
            row920_e5.querySelector(".adjustmentInput").value = Math.max(0, adj920 - 2);
          }
        } else if (widthVal === 920) {
          if (direction === 'up') {
            row920_e5.querySelector(".adjustmentInput").value = adj920 + 4;
            if (rem620 > 0) {
              row620_e5.querySelector(".remainderInput").value = Math.max(0, rem620 - 1);
            } else {
              row620_e5.querySelector(".adjustmentInput").value = adj620 + 1;
            }
          } else {
            if (adj920 <= 0) {
              updateTotals();
              row.isAdjusting = false;
              return;
            }
            if (adj620 === rem620) {
              updateTotals();
              row.isAdjusting = false;
              return;
            }
            row920_e5.querySelector(".adjustmentInput").value = adj920 - 4;
            if (rem620 > 0) {
              row620_e5.querySelector(".remainderInput").value = rem620 + 1;
            } else {
              row620_e5.querySelector(".adjustmentInput").value = Math.max(0, adj620 - 1);
            }
          }
        }
        updateTotals();
        row.isAdjusting = false;
        return;
      }
    }

    // 6ë²ˆ ë£°: 630 ë²„íŠ¼
    if (widthVal === 630) {
      const adj630 = parseFloat(row.querySelector(".adjustmentInput").value) || 0;
      if (direction === 'up') {
        row.querySelector(".adjustmentInput").value = adj630 + 1;
      } else {
        if (adj630 <= 0) {
          updateTotals();
          row.isAdjusting = false;
          return;
        }
        row.querySelector(".adjustmentInput").value = adj630 - 1;
      }
      updateTotals();
      row.isAdjusting = false;
      return;
    }

    // 7ë²ˆ ë£°: 850 ë²„íŠ¼
    if (widthVal === 850) {
      const adj850 = parseFloat(row.querySelector(".adjustmentInput").value) || 0;
      if (direction === 'up') {
        row.querySelector(".adjustmentInput").value = adj850 + 5;
      } else {
        if (adj850 <= 0) {
          updateTotals();
          row.isAdjusting = false;
          return;
        }
        row.querySelector(".adjustmentInput").value = adj850 - 5;
      }
      updateTotals();
      row.isAdjusting = false;
      return;
    }

    // 8ë²ˆ ë£°: 745 ë²„íŠ¼ (620ê³¼ ì—°ë™)
    if (widthVal === 620) {
      const allRows = document.querySelectorAll("#orderTableBody tr");
      const sameGroupRows = Array.from(allRows).filter(row => {
        const rowPhd = row.querySelector(".phdSelect").value;
        const rowLength = parseFloat(row.querySelector(".lengthInput").value) || 0;
        return rowPhd === phdVal && rowLength === lengthVal;
      });
      
      const hasRow745 = sameGroupRows.some(r => parseFloat(r.querySelector(".widthInput").value) === 745);
      
      if (hasRow745) {
        const currentAdj = parseFloat(row.querySelector(".adjustmentInput").value) || 0;
        const currentRem = getRemainderValue(row);
        
        if (direction === 'up') {
          // 620 +ë²„íŠ¼: ì–¸ì œë‚˜ ì‘ë™, 620 1ì•ˆ +1, ë‚˜ë¨¸ì§€ +1
          row.querySelector(".adjustmentInput").value = currentAdj + 1;
          row.querySelector(".remainderInput").value = currentRem + 1;
        } else {
          // 620 -ë²„íŠ¼: ë‚˜ë¨¸ì§€ê°€ >0ì¸ ê²½ìš°ì—ë§Œ ì‘ë™
          if (currentRem <= 0) {
            updateTotals();
            row.isAdjusting = false;
            return;
          }
          
          if (currentAdj <= 0) {
            updateTotals();
            row.isAdjusting = false;
            return;
          }
          row.querySelector(".adjustmentInput").value = currentAdj - 1;
          row.querySelector(".remainderInput").value = Math.max(0, currentRem - 1);
        }
        updateTotals();
        row.isAdjusting = false;
        return;
      }
    }
    
    if (widthVal === 745) {
      const adj745 = parseFloat(row.querySelector(".adjustmentInput").value) || 0;
      if (direction === 'up') {
        row.querySelector(".adjustmentInput").value = adj745 + 5;
      } else {
        if (adj745 <= 0) {
          updateTotals();
          row.isAdjusting = false;
          return;
        }
        row.querySelector(".adjustmentInput").value = adj745 - 5;
      }
      
      const allRows = document.querySelectorAll("#orderTableBody tr");
      const sameGroupRows = Array.from(allRows).filter(row => {
        const rowPhd = row.querySelector(".phdSelect").value;
        const rowLength = parseFloat(row.querySelector(".lengthInput").value) || 0;
        return rowPhd === phdVal && rowLength === lengthVal;
      });
      
      const row620 = sameGroupRows.find(r => parseFloat(r.querySelector(".widthInput").value) === 620);
      if (row620) {
        const adj620 = parseFloat(row620.querySelector(".adjustmentInput").value) || 0;
        const rem620 = getRemainderValue(row620);
        
        if (direction === 'up') {
          if (rem620 > 0) {
            row620.querySelector(".remainderInput").value = Math.max(0, rem620 - 1);
          } else {
            row620.querySelector(".adjustmentInput").value = adj620 + 1;
          }
        } else {
          if (rem620 > 0) {
            row620.querySelector(".remainderInput").value = rem620 + 1;
          } else {
            row620.querySelector(".adjustmentInput").value = Math.max(0, adj620 - 1);
          }
        }
      }
      updateTotals();
      row.isAdjusting = false;
      return;
    }

    // 9ë²ˆ ë£°: 770 ë²„íŠ¼ (620ê³¼ ì—°ë™)
    if (widthVal === 620) {
      const allRows = document.querySelectorAll("#orderTableBody tr");
      const sameGroupRows = Array.from(allRows).filter(row => {
        const rowPhd = row.querySelector(".phdSelect").value;
        const rowLength = parseFloat(row.querySelector(".lengthInput").value) || 0;
        return rowPhd === phdVal && rowLength === lengthVal;
      });
      
      const hasRow770 = sameGroupRows.some(r => parseFloat(r.querySelector(".widthInput").value) === 770);
      
      if (hasRow770) {
        const currentAdj = parseFloat(row.querySelector(".adjustmentInput").value) || 0;
        const currentRem = getRemainderValue(row);
        
        if (direction === 'up') {
          // 620 +ë²„íŠ¼: ì–¸ì œë‚˜ ì‘ë™, 620 1ì•ˆ +1, ë‚˜ë¨¸ì§€ +1
          row.querySelector(".adjustmentInput").value = currentAdj + 1;
          row.querySelector(".remainderInput").value = currentRem + 1;
        } else {
          // 620 -ë²„íŠ¼: ë‚˜ë¨¸ì§€ê°€ >0ì¸ ê²½ìš°ì—ë§Œ ì‘ë™
          if (currentRem <= 0) {
            updateTotals();
            row.isAdjusting = false;
            return;
          }
          
          if (currentAdj <= 0) {
            updateTotals();
            row.isAdjusting = false;
            return;
          }
          row.querySelector(".adjustmentInput").value = currentAdj - 1;
          row.querySelector(".remainderInput").value = Math.max(0, currentRem - 1);
        }
        updateTotals();
        row.isAdjusting = false;
        return;
      }
    }
    
    if (widthVal === 770) {
      const adj770 = parseFloat(row.querySelector(".adjustmentInput").value) || 0;
      if (direction === 'up') {
        row.querySelector(".adjustmentInput").value = adj770 + 4;
      } else {
        if (adj770 <= 0) {
          updateTotals();
          row.isAdjusting = false;
          return;
        }
        row.querySelector(".adjustmentInput").value = adj770 - 4;
      }
      
      const allRows = document.querySelectorAll("#orderTableBody tr");
      const sameGroupRows = Array.from(allRows).filter(row => {
        const rowPhd = row.querySelector(".phdSelect").value;
        const rowLength = parseFloat(row.querySelector(".lengthInput").value) || 0;
        return rowPhd === phdVal && rowLength === lengthVal;
      });
      const row620 = sameGroupRows.find(r => parseFloat(r.querySelector(".widthInput").value) === 620);
      if (row620) {
        const adj620 = parseFloat(row620.querySelector(".adjustmentInput").value) || 0;
        const rem620 = getRemainderValue(row620);
        
        if (direction === 'up') {
          if (rem620 > 1) {
            row620.querySelector(".remainderInput").value = Math.max(0, rem620 - 2);
          } else if (rem620 === 1) {
            row620.querySelector(".remainderInput").value = 0;
            row620.querySelector(".adjustmentInput").value = adj620 + 1;
          } else {
            row620.querySelector(".adjustmentInput").value = adj620 + 2;
          }
        } else {
          if (rem620 > 1) {
            row620.querySelector(".remainderInput").value = rem620 + 2;
          } else if (rem620 === 1) {
            row620.querySelector(".remainderInput").value = rem620 + 2;
          } else {
            row620.querySelector(".adjustmentInput").value = Math.max(0, adj620 - 2);
          }
        }
      }
      updateTotals();
      row.isAdjusting = false;
      return;
    }

    // 620 ê³µí†µ ê°€ë“œ: ë‚˜ë¨¸ì§€ê°€ ê³µë€/0ì´ë©´ -ë²„íŠ¼ ì‘ë™ ê¸ˆì§€
    if (direction === 'down' && widthVal === 620) {
      const remVal = getRemainderValue(row);
      if (!(remVal > 0)) {
        updateTotals();
        row.isAdjusting = false;
        return;
      }
    }
    
    updateTotals();
    
    // ì¡°ì • ì™„ë£Œ í›„ í”Œë˜ê·¸ í•´ì œ
    row.isAdjusting = false;
    return;
  }

  //===================================================
  // ê°™ì€ PHD-Length ê·¸ë£¹ì˜ 1ì•ˆ ê°’ë“¤ ìë™ ì¡°ì •
  //===================================================
  function updateRelatedAdjustments(changedRow) {
    // Optimize ëª¨ë“œì¼ ë•ŒëŠ” ìë™ ì¡°ì • ë¹„í™œì„±í™”
    if (window.isOptimizeMode) {
      return;
    }
    
    // 920 width ë³€ê²½ ì‹œ ìë™ ì¡°ì • ë¹„í™œì„±í™” (ìˆ˜ë™ ì¡°ì •ë§Œ í—ˆìš©)
    const changedWidth = parseFloat(changedRow.querySelector(".widthInput").value) || 0;
    if (changedWidth === 920) {
      return;
    }
    
    const phdVal = changedRow.querySelector(".phdSelect").value;
    const lengthVal = parseFloat(changedRow.querySelector(".lengthInput").value) || 0;
    const changedAdjustment = parseFloat(changedRow.querySelector(".adjustmentInput").value) || 0;
    
    if (!phdVal || lengthVal === 0 || changedWidth === 0) return;
    
    // ê°™ì€ PHD-Length ê·¸ë£¹ì˜ ëª¨ë“  í–‰ ì°¾ê¸°
    const allRows = document.querySelectorAll("#orderTableBody tr");
    const sameGroupRows = Array.from(allRows).filter(row => {
      const rowPhd = row.querySelector(".phdSelect").value;
      const rowLength = parseFloat(row.querySelector(".lengthInput").value) || 0;
      return rowPhd === phdVal && rowLength === lengthVal;
    });
    
    // Widthë³„ 1ì•ˆ ê°’ ì¡°ì • (1ì•ˆ ê°’ì´ ì´ë¯¸ ìˆëŠ” í–‰ë§Œ ì¡°ì •)
    sameGroupRows.forEach(row => {
      const rowWidth = parseFloat(row.querySelector(".widthInput").value) || 0;
      const rowAdjustment = parseFloat(row.querySelector(".adjustmentInput").value) || 0;
      
      if (rowWidth === 0) return;
      
      // 1ì•ˆ ê°’ì´ ì´ë¯¸ ìˆëŠ” í–‰ë§Œ ì¡°ì • (ê³µë€ì¸ í–‰ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
      if (rowAdjustment > 0) {
        // 620, 820, 920 Widthì— ëŒ€í•œ ë¹„ìœ¨ ê·œì¹™ ì ìš©
        if (rowWidth === 620) {
          if (changedWidth === 820) {
            // 820 1ì•ˆì´ ë³€ê²½ë˜ë©´ 620 1ì•ˆ = 820 1ì•ˆê³¼ ë™ì¼
            const newValue = changedAdjustment;
            row.querySelector(".adjustmentInput").value = newValue;
          } else if (changedWidth === 920) {
            // 920 1ì•ˆì´ ë³€ê²½ë˜ë©´ 620 1ì•ˆ = 920 1ì•ˆ / 4
            const newValue = Math.round(changedAdjustment / 4);
            row.querySelector(".adjustmentInput").value = newValue;
          }
        } else if (rowWidth === 820) {
          if (changedWidth === 620) {
            // 620 1ì•ˆì´ ë³€ê²½ë˜ë©´ 820 1ì•ˆ = 620 1ì•ˆê³¼ ë™ì¼
            const newValue = changedAdjustment;
            row.querySelector(".adjustmentInput").value = newValue;
          } else if (changedWidth === 920) {
            // 920 1ì•ˆì´ ë³€ê²½ë˜ë©´ 820 1ì•ˆ = 920 1ì•ˆ * 3/2
            const newValue = Math.round(changedAdjustment * 3 / 2);
            row.querySelector(".adjustmentInput").value = newValue;
          }
        } else if (rowWidth === 920) {
          if (changedWidth === 620) {
            // 620 1ì•ˆì´ ë³€ê²½ë˜ë©´ 920 1ì•ˆ = 620 1ì•ˆ * 4
            const newValue = changedAdjustment * 4;
            row.querySelector(".adjustmentInput").value = newValue;
          } else if (changedWidth === 820) {
            // 820 1ì•ˆì´ ë³€ê²½ë˜ë©´ 920 1ì•ˆ = 820 1ì•ˆ * 2/3
            const newValue = Math.round(changedAdjustment * 2 / 3);
            row.querySelector(".adjustmentInput").value = newValue;
          }
        }
      }
    });
  }

  //===================================================
  // ì´ ìˆ˜ëŸ‰ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
  //===================================================
  function updateTotals() {
    const rows = document.querySelectorAll("#orderTableBody tr");
    let totalKg = 0;
    let totalAdjustmentKg = 0;
    let totalQuantityKg = 0;
    
    // ì„ íƒëœ í–‰ì´ ìˆìœ¼ë©´ ì„ íƒëœ í–‰ë§Œ ê³„ì‚°, ì—†ìœ¼ë©´ ëª¨ë“  í–‰ ê³„ì‚°
    const rowsToCalculate = selectedRows.size > 0 ? Array.from(selectedRows) : rows;
    rowsToCalculate.forEach(row => {
      const kgVal = parseFloat(row.querySelector(".kgInput")?.value) || 0;
      const adjVal = parseFloat(row.querySelector(".adjustmentInput")?.value) || 0;
      const qtyVal = parseFloat(row.querySelector(".quantityOutput")?.value) || 0;
      const phdVal = row.querySelector(".phdSelect")?.value;
      const wVal = parseFloat(row.querySelector(".widthInput")?.value) || 0;
      const lVal = parseFloat(row.querySelector(".lengthInput")?.value) || 0;
      
      totalKg += kgVal;
      
      // Quantity ê°’ì´ ìˆìœ¼ë©´ width * x * 0.0355 * í€€í„°í‹°ë¡œ ê³„ì‚°
      if (qtyVal > 0 && wVal > 0) {
        // Xê°’ ì¶”ì¶œ (ì˜ˆ: "4x" -> 4)
        const xCell = row.querySelector(".xOutput");
        if (xCell && xCell.value) {
          const xValue = parseInt(xCell.value.replace('x', ''));
          if (xValue > 0) {
            const quantityKg = wVal * xValue * 0.0355 * qtyVal;
            totalQuantityKg += quantityKg;
          }
        }
      }
      
      // 1ì•ˆ ê°’ì´ ìˆìœ¼ë©´ width * x * 0.0355 * 1ì•ˆ ìˆ˜ëŸ‰ìœ¼ë¡œ ê³„ì‚°
      if (adjVal > 0 && wVal > 0) {
        // Xê°’ ì¶”ì¶œ (ì˜ˆ: "4x" -> 4)
        const xCell = row.querySelector(".xOutput");
        if (xCell && xCell.value) {
          const xValue = parseInt(xCell.value.replace('x', ''));
          if (xValue > 0) {
            const adjustmentKg = wVal * xValue * 0.0355 * adjVal;
            totalAdjustmentKg += adjustmentKg;
          }
        }
      }
    });
    
    // kgì„ tonìœ¼ë¡œ ë³€í™˜ (1 ton = 1000 kg)
    const totalTon = (totalKg / 1000).toFixed(1);
    const totalAdjustmentTon = (totalAdjustmentKg / 1000).toFixed(1);
    const totalQuantityTon = (totalQuantityKg / 1000).toFixed(1);
    
    
    document.getElementById("totalKg").textContent = `ì´: ${totalTon}t`;
    document.getElementById("totalQuantity").textContent = `ì´: ${totalQuantityTon}t`;
    document.getElementById("totalAdjustment").textContent = `ì´: ${totalAdjustmentTon}t`;
  }

  //===================================================
  // ì´ë©”ì¼ í…ìŠ¤íŠ¸ ìƒì„± ë° í´ë¦½ë³´ë“œ ë³µì‚¬
  //===================================================
  function generateEmailText() {
    const rows = document.querySelectorAll("#orderTableBody tr");
    
    let emailText = "ì•ˆë…•í•˜ì„¸ìš”.\n\n";
    emailText += "ì£¼ë¬¸ ê°ì‚¬í•©ë‹ˆë‹¤.\n";
    emailText += "í­ ë¹„ìœ¨ì„ ê³ ë ¤í•˜ì—¬ í•˜ê¸°ì™€ ê°™ì´ ì£¼ë¬¸í•´ë„ ë ì§€ ê²€í† í•˜ì—¬ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n";
    
    // ì£¼ë¬¸ ë°ì´í„° ìˆ˜ì§‘ ë° ì •ë ¬
    const orderItems = [];
    
    rows.forEach((row, index) => {
      const phdVal = row.querySelector(".phdSelect")?.value;
      const widthVal = parseFloat(row.querySelector(".widthInput")?.value) || 0;
      const lengthVal = parseFloat(row.querySelector(".lengthInput")?.value) || 0;
      const adjustmentVal = parseFloat(row.querySelector(".adjustmentInput")?.value) || 0;
      
      // Convert í–‰ê³¼ Quantity í–‰ í™•ì¸
      const convertVal = parseFloat(row.querySelector("td:nth-child(9) input")?.value) || 0;
      const quantityVal = parseFloat(row.querySelector("td:nth-child(8) input")?.value) || 0;
      
      
      // ìš°ì„ ìˆœìœ„: Convert(adjustment) â†’ Quantity
      // ì»¨ë²„íŠ¸ëœ í–‰ì˜ ê²½ìš° adjustment ê°’ì„ ì‚¬ìš©
      let finalValue = (convertVal > 0) ? convertVal : quantityVal;
      if (finalValue === 0 && adjustmentVal > 0) {
        finalValue = adjustmentVal;
      }
      
      
      // 1ì•ˆ ê°’ì´ ìˆëŠ” í–‰ë§Œ í¬í•¨ (Convert ë˜ëŠ” Quantity ê°’ì´ ìˆì–´ì•¼ í•¨)
      // ì›ë³¸ í–‰ê³¼ ì»¨ë²„íŠ¸ëœ í–‰ ëª¨ë‘ í¬í•¨
      if (phdVal && widthVal > 0 && lengthVal > 0 && finalValue > 0) {
        orderItems.push({
          phd: phdVal,
          width: widthVal,
          length: lengthVal,
          adjustment: finalValue,
          isConverted: row.classList.contains('converted') // ì»¨ë²„íŠ¸ëœ í–‰ì¸ì§€ í‘œì‹œ
        });
      } else {
      }
    });
    
    
    // PHD, Width ìˆœìœ¼ë¡œ ì •ë ¬
    orderItems.sort((a, b) => {
      const phdDiff = parseFloat(a.phd) - parseFloat(b.phd);
      if (phdDiff !== 0) return phdDiff;
      return a.width - b.width;
    });
    
    // ì´ë©”ì¼ í…ìŠ¤íŠ¸ ìƒì„±
    orderItems.forEach(item => {
      emailText += `PHD-${item.phd} x ${item.width}m x ${item.length.toLocaleString()}m : ${item.adjustment}ë¡¤\n`;
    });
    
    emailText += "\nê°ì‚¬í•©ë‹ˆë‹¤";
    
    return emailText;
  }

  //===================================================
  // í´ë¦½ë³´ë“œì— í…ìŠ¤íŠ¸ ë³µì‚¬
  //===================================================
  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch (err) {
      // fallback for older browsers
      if (!document.body) {
        return false;
      }
      
      const textArea = document.createElement("textarea");
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        document.body.removeChild(textArea);
        return true;
      } catch (err) {
        document.body.removeChild(textArea);
        return false;
      }
    }
  }

  //===================================================
  // í–‰ì—ì„œ Quantity ì¬ê³„ì‚°
  //===================================================
  function recalcRow(row) {
    
    const phdVal = row.querySelector(".phdSelect").value;
    const wVal   = parseFloat(row.querySelector(".widthInput").value) || 0;
    const lVal   = parseFloat(row.querySelector(".lengthInput").value) || 0;
    const totalkgVal  = parseFloat(row.querySelector(".kgInput").value) || 0;
    const xOut   = row.querySelector(".xOutput");
    const rlOut  = row.querySelector(".quantityOutput");
    

    // PHDì™€ Lengthë§Œ ìˆìœ¼ë©´ X ê³„ì‚° (KGì€ Quantity ê³„ì‚°ì—ë§Œ í•„ìš”)
    if (!phdVal || lVal===0) {
      xOut.value = "";
      rlOut.value = "";
      return;
    }
    
    // Widthê°€ ì—†ìœ¼ë©´ Xë§Œ ê³„ì‚°í•˜ê³  QuantityëŠ” ë¹„ì›€
    if (wVal===0) {
      const base = phdMapping[phdVal];
      if (!base) {
        xOut.value = "";
        rlOut.value = "";
        return;
      }
      const xValue = lVal / base;
      xOut.value = Math.round(xValue) + "x";
      rlOut.value = "";
      return;
    }
    
    // KGì´ ì—†ìœ¼ë©´ Xë§Œ ê³„ì‚°í•˜ê³  QuantityëŠ” ë¹„ì›€
    if (totalkgVal===0) {
      const base = phdMapping[phdVal];
      if (!base) {
        xOut.value = "";
        rlOut.value = "";
        return;
      }
      const xValue = lVal / base;
      xOut.value = Math.round(xValue) + "x";
      rlOut.value = "";
      return;
    }
    const base = phdMapping[phdVal];
    if (!base) {
      xOut.value = "";
      rlOut.value = "";
      return;
    }

    // X = Length / base (ë’¤ì— x ë¶™ì„)
    const xValue = lVal / base;
    xOut.value = Math.round(xValue) + "x";

    // unitkg = X * (Width * 0.0355)
    const unitkg = xValue * (wVal * 0.0355);
    if (unitkg===0) {
      rlOut.value="";
      return;
    }
    let qty = totalkgVal / unitkg;
    rlOut.value = Math.round(qty);
  }

  //===================================================
  // X ê°’ ìˆ˜ì • ì‹œ ì—°ê²°ëœ ê°’ë“¤ ì—…ë°ì´íŠ¸
  //===================================================
  function updateFromX(row) {
    
    const xInput = row.querySelector(".xOutput");
    let xValue = parseFloat(xInput.value.replace('x', '')) || 0;
    const phdVal = row.querySelector(".phdSelect").value;
    const wVal = parseFloat(row.querySelector(".widthInput").value) || 0;
    const totalkgVal = parseFloat(row.querySelector(".kgInput").value) || 0;
    const lInput = row.querySelector(".lengthInput");
    
    // ë£° 2: X ê°’ì´ ë°”ë€Œì—ˆë‹¤ â†’ Lengthë„ ë”°ë¼ ì—­ìœ¼ë¡œ ê³„ì‚°
    if (xValue > 0 && phdVal) {
      const base = phdMapping[phdVal];
      if (base) {
        const newLength = xValue * base;
        lInput.value = Math.round(newLength);
      }
    }
    const rlOut = row.querySelector(".quantityOutput");

    if (!phdVal || xValue === 0) {
      return;
    }
    
    // Widthë‚˜ KGì´ ì—†ìœ¼ë©´ Quantity ê³„ì‚°í•˜ì§€ ì•ŠìŒ
    if (wVal === 0 || totalkgVal === 0) {
      return;
    }

    const base = phdMapping[phdVal];
    if (!base) {
      return;
    }

    // X = Length / base ì´ë¯€ë¡œ Length = X * base
    const newLength = xValue * base;
    lInput.value = newLength.toFixed(2);

    // Quantity ì¬ê³„ì‚°
    const unitkg = xValue * (wVal * 0.0355);
    if (unitkg === 0) {
      rlOut.value = "";
      return;
    }
    let qty = totalkgVal / unitkg;
    rlOut.value = qty.toFixed(2);
  }



  //===================================================
  // Quantity ê°’ ìˆ˜ì • ì‹œ ì—°ê²°ëœ ê°’ë“¤ ì—…ë°ì´íŠ¸
  //===================================================
  function updateFromQuantity(row) {
    
    const rlInput = row.querySelector(".quantityOutput");
    const qtyValue = parseFloat(rlInput.value) || 0;
    const phdVal = row.querySelector(".phdSelect").value;
    const wVal = parseFloat(row.querySelector(".widthInput").value) || 0;
    const lVal = parseFloat(row.querySelector(".lengthInput").value) || 0;
    const totalkgInput = row.querySelector(".kgInput");
    
    // ë£° 4: Quantityê°€ ë°”ë€Œì—ˆë‹¤ â†’ KG ë³€í™”
    if (qtyValue > 0 && phdVal && wVal > 0 && lVal > 0) {
      const base = phdMapping[phdVal];
      if (base) {
        const xValue = lVal / base;
        const unitkg = xValue * (wVal * 0.0355);
        const newKg = qtyValue * unitkg;
        totalkgInput.value = Math.round(newKg);
      }
    }
    const xOut = row.querySelector(".xOutput");

    if (!phdVal || qtyValue === 0 || lVal === 0) {
      return;
    }
    
    // Widthê°€ ì—†ìœ¼ë©´ KG ì—­ê³„ì‚°í•˜ì§€ ì•ŠìŒ
    if (wVal === 0) {
      return;
    }

    const base = phdMapping[phdVal];
    if (!base) {
      return;
    }

    // X ê°’ì€ ë³€ê²½í•˜ì§€ ì•Šê³  í˜„ì¬ ê°’ ì‚¬ìš© (ë¬´í•œ ë£¨í”„ ë°©ì§€)
    const xValue = parseFloat(xOut.value.replace('x', '')) || 0;
    if (xValue === 0) {
      return;
    }

    // Quantity = Math.ceil(totalkg / unitkg)
    // unitkg = X * (Width * 0.0355)
    const unitkg = xValue * (wVal * 0.0355);
    if (unitkg === 0) {
      return;
    }

    // totalkg = Quantity * unitkg
    const newTotalkg = qtyValue * unitkg;
    totalkgInput.value = newTotalkg.toFixed(2);
  }

  //===================================================
  // í–‰ ì‚­ì œ
  //===================================================
  function deleteRow(row) {
    // 1. í–‰ ì •ë³´ ìˆ˜ì§‘ (ì‚­ì œ ì „ì—)
    const orderId = document.getElementById('orderIdInput').value;
    const phd = row.querySelector('.phdSelect').value;
    const width = row.querySelector('.widthInput').value;
    const length = row.querySelector('.lengthInput').value;
    const adjustment = row.querySelector('.adjustmentInput').value;
    
    // 2. order ID, phd, width, lengthê°€ ëª¨ë‘ ìˆëŠ”ì§€ í™•ì¸
    const hasAllData = orderId && phd && width && length;
    
    if (!hasAllData) {
      // ë°ì´í„°ê°€ ëª¨ë‘ ì—†ëŠ” ê²½ìš° - ê·¸ëƒ¥ í–‰ ì‚­ì œ
      // í™”ë©´ì—ì„œ í–‰ ì œê±°
      row.remove();
      
      // í™”ë©´ í–‰ë²ˆí˜¸ ì—…ë°ì´íŠ¸
      updateRowNumbers();
      
      // í™”ë©´ ì´ë¬´ê²Œ ì—…ë°ì´íŠ¸
      updateTotals();
      return;
    }
    
    // 3. ëª¨ë“  ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° - ì„œë²„ì—ì„œë„ ì‚­ì œ
    const confirmMessage = `ì •ë§ë¡œ ì´ ì•„ì´í…œì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nOrder ID: ${orderId}\nPHD: ${phd}\nWidth: ${width}\nLength: ${length}\nAdjustment: ${adjustment}`;
    
    if (!confirm(confirmMessage)) {
      return; // ì‚¬ìš©ìê°€ ì·¨ì†Œí•˜ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
    }
    
    // 4. ì„œë²„ì—ì„œ í•´ë‹¹ ì•„ì´í…œ ì‚­ì œ (ì„±ê³µí•œ ê²½ìš°ì—ë§Œ í–‰ ì‚­ì œ)
    deleteItemFromServer(phd, width, length, adjustment, row);
  }




  //===================================================
  // baseRow, convertedRow ìƒì„±
  //===================================================
  function createBaseRow() {
    const tmpl = document.getElementById("baseRowTemplate");
    if (!tmpl) {
      return null;
    }
    const row  = tmpl.content.firstElementChild.cloneNode(true);
    return row;
  }
  function createConvertedRow() {
    const tmpl = document.getElementById("convertedRowTemplate");
    const row  = tmpl.content.firstElementChild.cloneNode(true);
    return row;
  }

  //===================================================
  // ê° í–‰ì— ì´ë²¤íŠ¸ + ì‚­ì œë²„íŠ¼ + í‚¤ë³´ë“œ ì´ë™
  //===================================================
  function attachRowEvents(row, isLoading = false) {
    const inputs = row.querySelectorAll("input, select");
    
    // phd, width, length í•„ë“œ í™•ì¸
    const phdSelect = row.querySelector(".phdSelect");
    const widthInput = row.querySelector(".widthInput");
    const lengthInput = row.querySelector(".lengthInput");
    
    
    inputs.forEach(el=>{
      // Xì™€ Quantity í•„ë“œëŠ” íŠ¹ë³„í•œ ì´ë²¤íŠ¸ ì²˜ë¦¬
      if (el.classList.contains("xOutput")) {
        el.addEventListener("input", () => {
          if (!isLoading) { // ëª¨ë“  í–‰ì—ì„œ ìë™ ê³„ì‚°
            updateFromX(row);
            updateTotals();
          }
        });
        el.addEventListener("change", () => {
          if (!isLoading) { // ëª¨ë“  í–‰ì—ì„œ ìë™ ê³„ì‚°
            updateFromX(row);
            updateTotals();
          }
        });
      } else if (el.classList.contains("quantityOutput")) {
        el.addEventListener("input", () => {
          if (!isLoading) { // í•­ìƒ ìë™ ê³„ì‚°
            updateFromQuantity(row);
            updateTotals();
          }
        });
        el.addEventListener("change", () => {
          if (!isLoading) { // í•­ìƒ ìë™ ê³„ì‚°
            updateFromQuantity(row);
            updateTotals();
          }
        });
      } else if (el.classList.contains("adjustmentInput")) {
        // 1ì•ˆ í•„ë“œëŠ” ì´ëŸ‰ ì—…ë°ì´íŠ¸ + ê°™ì€ ê·¸ë£¹ì˜ ë‹¤ë¥¸ Width 1ì•ˆ ê°’ë“¤ ìë™ ì¡°ì •
        el.addEventListener("input", () => {
          if (!isLoading) {
            updateTotals();
            updateRelatedAdjustments(row);
          }
        });
        el.addEventListener("change", () => {
          if (!isLoading) {
            updateTotals();
            updateRelatedAdjustments(row);
          }
        });
      } else if (el.classList.contains("remainderInput")) {
        // ë‚˜ë¨¸ì§€ í•„ë“œëŠ” ì´ëŸ‰ë§Œ ì—…ë°ì´íŠ¸
        el.addEventListener("input", () => {
          if (!isLoading) {
            updateTotals();
          }
        });
        el.addEventListener("change", () => {
          if (!isLoading) {
            updateTotals();
          }
        });
      } else {
        // ë‹¤ë¥¸ í•„ë“œë“¤ì€ ê¸°ì¡´ recalcRow ì‚¬ìš©
        el.addEventListener("input", () => {
          if (!isLoading) { // ëª¨ë“  í–‰ì—ì„œ ìë™ ê³„ì‚°
            recalcRow(row);
            updateTotals();
          }
        });
        el.addEventListener("change", () => {
          if (!isLoading) { // ëª¨ë“  í–‰ì—ì„œ ìë™ ê³„ì‚°
            recalcRow(row);
            updateTotals();
          }
        });
      }
      
      el.addEventListener("keydown", e=>{
        if(e.key==="Enter"||e.key==="ArrowDown"){
          e.preventDefault();
          navigate(row, e.target, "down");
        } else if(e.key==="ArrowUp"){
          e.preventDefault();
          navigate(row, e.target, "up");
        } else if(e.key==="ArrowRight"){
          e.preventDefault();
          navigate(row, e.target, "right");
        } else if(e.key==="ArrowLeft"){
          e.preventDefault();
          navigate(row, e.target, "left");
        }
      });
    });
    // X ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
    const delBtn = row.querySelector(".deleteButton");
    if(delBtn){
      // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆë¡œ ë“±ë¡ (ì¤‘ë³µ ë°©ì§€)
      delBtn.replaceWith(delBtn.cloneNode(true));
      const newDelBtn = row.querySelector(".deleteButton");
      newDelBtn.addEventListener("click", ()=> deleteRow(row));
    }
    
    // S ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
    const sButton = row.querySelector(".s-button");
    if (sButton) {
      // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°)
      sButton.replaceWith(sButton.cloneNode(true));
      // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      const newSButton = row.querySelector(".s-button");
      newSButton.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        handleSButtonClick(newSButton, row);
      });
    }
    
    // ì¡°ì • ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
    const adjustUpBtn = row.querySelector(".adjustUpButton");
    if(adjustUpBtn){
      // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°)
      adjustUpBtn.replaceWith(adjustUpBtn.cloneNode(true));
      // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      const newAdjustUpBtn = row.querySelector(".adjustUpButton");
      newAdjustUpBtn.addEventListener("click", ()=> adjustAdjustmentValue(row, 'up'));
    }
    
    const adjustDownBtn = row.querySelector(".adjustDownButton");
    if(adjustDownBtn){
      // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°)
      adjustDownBtn.replaceWith(adjustDownBtn.cloneNode(true));
      // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      const newAdjustDownBtn = row.querySelector(".adjustDownButton");
      newAdjustDownBtn.addEventListener("click", ()=> adjustAdjustmentValue(row, 'down'));
    }
    
  }


  //===================================================
  // í‚¤ë³´ë“œ ë‚´ë¹„ê²Œì´ì…˜
  //===================================================
  function navigate(currentRow, currentElement, direction) {
    const tbody = currentRow.parentElement;
    const rows  = Array.from(tbody.querySelectorAll("tr"));
    const currentRowIndex = rows.indexOf(currentRow);
    const cells = Array.from(currentRow.children);
    const currentCell     = currentElement.closest("td");
    const currentCellIndex= cells.indexOf(currentCell);
    const totalRows  = rows.length;
    const totalCells = cells.length;

    let newRowIndex  = currentRowIndex;
    let newCellIndex = currentCellIndex;

    if(direction==="down"){
      if(currentRowIndex < totalRows - 1){
        newRowIndex = currentRowIndex + 1;
      } else{
        // ë§¨ ì•„ë˜ => ë§¨ ìœ„
        newRowIndex = 0;
        if(currentCellIndex < totalCells - 1){
          newCellIndex = currentCellIndex + 1;
        }
      }
    }
    else if(direction==="up"){
      if(currentRowIndex > 0){
        newRowIndex = currentRowIndex - 1;
      } else{
        // ë§¨ ìœ„ => ë§¨ ì•„ë˜
        newRowIndex = totalRows - 1;
        if(currentCellIndex > 0){
          newCellIndex = currentCellIndex - 1;
        }
      }
    }
    else if(direction==="right"){
      if(currentCellIndex < totalCells - 1){
        newCellIndex = currentCellIndex + 1;
      }
    }
    else if(direction==="left"){
      if(currentCellIndex > 0){
        newCellIndex = currentCellIndex - 1;
      }
    }

    const targetRow  = rows[newRowIndex];
    if(targetRow){
      const targetCells= Array.from(targetRow.children);
      const targetCell = targetCells[newCellIndex];
      if(targetCell){
        const tInput= targetCell.querySelector("input, select");
        if(tInput){
          tInput.focus();
        }
      }
    }
  }

  //===================================================
  // Sortable (ë“œë˜ê·¸ ì •ë ¬)
  //===================================================
  Sortable.create(document.getElementById("orderTableBody"), {
    animation: 150,
    handle: '.drag-handle',
    onEnd: function(evt) {
      // í–‰ ì´ë™ í›„ í–‰ë²ˆí˜¸ ì—…ë°ì´íŠ¸
      updateRowNumbers();
    }
  });


  //===================================================
  // Email ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  //===================================================
  document.getElementById("emailBtn").addEventListener("click", async () => {
    try {
      const emailText = generateEmailText();
      
      if (emailText === "ì•ˆë…•í•˜ì„¸ìš”.\n\nì£¼ë¬¸ ê°ì‚¬í•©ë‹ˆë‹¤.\ní­ ë¹„ìœ¨ì„ ê³ ë ¤í•˜ì—¬ í•˜ê¸°ì™€ ê°™ì´ ì£¼ë¬¸í•´ë„ ë ì§€ ê²€í† í•˜ì—¬ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n\nê°ì‚¬í•©ë‹ˆë‹¤") {
        alert("ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. 1ì•ˆ ê°’ì´ ì…ë ¥ëœ í–‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        return;
      }
      
      const success = await copyToClipboard(emailText);
      
      if (success) {
        alert('Email ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\në°”ë¡œ ë¶™ì—¬ë„£ê¸°(Ctrl+V)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        
        // ë³µì‚¬ëœ í…ìŠ¤íŠ¸ë¥¼ ì½˜ì†”ì— ì¶œë ¥ (ë””ë²„ê¹…ìš©)
      } else {
        alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      }
    } catch (error) {
      alert("ì´ë©”ì¼ í…ìŠ¤íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  });


  //===================================================
  // PHD + Width ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
  //===================================================
  document.getElementById("sortPHDButton").addEventListener("click", ()=>{
    const tbody = document.getElementById("orderTableBody");
    const rows  = Array.from(tbody.querySelectorAll("tr"));
    rows.sort((a,b)=>{
      // 1ì°¨ ì •ë ¬: PHD ì˜¤ë¦„ì°¨ìˆœ
      const pa = parseFloat(a.querySelector(".phdSelect")?.value || "0");
      const pb = parseFloat(b.querySelector(".phdSelect")?.value || "0");
      if(pa !== pb){
        return pa - pb;
      }
      
      // 2ì°¨ ì •ë ¬: ê°™ì€ PHD ì•ˆì—ì„œ Length ì˜¤ë¦„ì°¨ìˆœ
      const la = parseFloat(a.querySelector(".lengthInput")?.value || "0");
      const lb = parseFloat(b.querySelector(".lengthInput")?.value || "0");
      if(la !== lb){
        return la - lb;
      }
      
      // 3ì°¨ ì •ë ¬: ê°™ì€ PHD Length ì•ˆì—ì„œ Width ì˜¤ë¦„ì°¨ìˆœ
      const wa = parseFloat(a.querySelector(".widthInput")?.value || "0");
      const wb = parseFloat(b.querySelector(".widthInput")?.value || "0");
      return wa - wb;
    });
    rows.forEach(r=>tbody.appendChild(r));
    // í–‰ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
    updateRowNumbers();
  });

  //===================================================
  // Convert ì „ ì›ë³¸í–‰ë“¤ ëª¨ë“  ë°ì´í„° ë°±ì—…
  //===================================================
  function storeOriginalData(){
    const baseRows= document.querySelectorAll("#orderTableBody tr:not(.converted)");
    baseRows.forEach(r=>{
      // ëª¨ë“  í•„ë“œ ë°ì´í„° ë°±ì—…
      r.dataset.origPHD = r.querySelector(".phdSelect").value;
      r.dataset.origWidth = r.querySelector(".widthInput").value;
      r.dataset.origLength = r.querySelector(".lengthInput").value;
      r.dataset.origKg = r.querySelector(".kgInput").value;
      r.dataset.origX = r.querySelector(".xOutput").value;
      r.dataset.origQty = r.querySelector(".quantityOutput").value;
      r.dataset.origAdjustment = r.querySelector(".adjustmentInput").value;
    });
  }

  //===================================================
  // (ë„ìš°ë¯¸ í•¨ìˆ˜) ê°€ì¥ ê°€ê¹Œìš´ 4ì˜ ë°°ìˆ˜ë¥¼ ë§Œë“œëŠ” +x
  //===================================================
  function getPlusToNearestMultipleOf4(n){
    if(n % 4 === 0) return 0;
    let r = n % 4;
    return (4 - r);
  }

  //===================================================
  // (ë„ìš°ë¯¸ í•¨ìˆ˜) .converted ìƒˆ í–‰ ìƒì„± + íŠ¹ì • ìœ„ì¹˜ì— ì‚½ì…
  //===================================================
  function insertConvertedRow(refRow, position, phdVal, widthVal, adjustVal) {
  const newRow = createConvertedRow();

  // (1) íŒŒìƒ í–‰ì— ë“¤ì–´ê°ˆ ê°’ë“¤ ì„¤ì •
  //     - phdëŠ” ê¸°ì¡´ì²˜ëŸ¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ê³ ,
  //     - lengthëŠ” refRow(ì›ë³¸ í–‰)ì—ì„œ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
  newRow.querySelector(".phdSelect").value   = phdVal;
  newRow.querySelector(".widthInput").value  = widthVal;
  newRow.querySelector(".lengthInput").value = refRow.querySelector(".lengthInput")?.value || "";
  newRow.querySelector(".adjustmentInput").value = adjustVal;



  // (3) ì´ë²¤íŠ¸ ë¶€ì°©
  attachRowEvents(newRow);

  // (4) X ì—´ë§Œ ê³„ì‚°í•˜ê³  QuantityëŠ” ë¹„ì›Œë‘ 
  const phdVal_new = newRow.querySelector(".phdSelect").value;
  const wVal_new = parseFloat(newRow.querySelector(".widthInput").value) || 0;
  const lVal_new = parseFloat(newRow.querySelector(".lengthInput").value) || 0;
  const xOut_new = newRow.querySelector(".xOutput");
  const rlOut_new = newRow.querySelector(".quantityOutput");

  // X ê°’ë§Œ ê³„ì‚°
  if (phdVal_new && wVal_new > 0 && lVal_new > 0) {
    const base_new = phdMapping[phdVal_new];
    if (base_new) {
      const xValue_new = lVal_new / base_new;
      xOut_new.value = Math.round(xValue_new) + "x";
    }
  }
  
  // QuantityëŠ” ë¹„ì›Œë‘ 
  rlOut_new.value = "";

  // (5) DOM ë°°ì¹˜
  if(position === "above"){
    refRow.parentNode.insertBefore(newRow, refRow);
  } else {
    // default "below"
    refRow.parentNode.insertBefore(newRow, refRow.nextSibling);
  }
  return newRow;
}

  //===================================================
  // ê³µí†µ í•¨ìˆ˜: ë‚˜ë¨¸ì§€ ê°’ ì²˜ë¦¬ (ê³µë€ì„ 0ìœ¼ë¡œ ì²˜ë¦¬)
  //===================================================
  function getRemainderValue(row) {
    const value = row.querySelector(".remainderInput").value;
    // ê³µë€, null, undefinedëŠ” ëª¨ë‘ 0ìœ¼ë¡œ ì²˜ë¦¬
    if (value === '' || value === null || value === undefined) {
      return 0;
    }
    const parsed = parseFloat(value);
    return isNaN(parsed) ? 0 : parsed;
  }

  //===================================================
  // Convert Orders (ìƒˆ ê·œì¹™ ë°˜ì˜)
  //===================================================
  document.getElementById("convert1Button").addEventListener("click", ()=>{
    // 1) ì›ë³¸í–‰ ëª¨ë“  ë°ì´í„° ë°±ì—…
    storeOriginalData();

    // 2) ê¸°ì¡´ ë³€í™˜í–‰ ì œê±°
    const oldConvs = document.querySelectorAll("#orderTableBody tr.converted");
    oldConvs.forEach(r=> r.remove());

    // 3) (phdVal, lengthVal) ê·¸ë£¹í•‘
    const baseRows = Array.from(document.querySelectorAll("#orderTableBody tr:not(.converted)"));
    const groupMap = new Map();
    baseRows.forEach(row=>{
      const phdVal = row.querySelector(".phdSelect").value;
      const lengthVal = parseFloat(row.querySelector(".lengthInput").value) || 0;
      // â˜… ì—¬ê¸°ê°€ ë¬¸ì œì˜€ë˜ ë¶€ë¶„: ë°±í‹±ìœ¼ë¡œ ìˆ˜ì •
      const groupKey = `${phdVal}-${lengthVal}`;

      if(!groupMap.has(groupKey)){
        groupMap.set(groupKey, []);
      }
      groupMap.get(groupKey).push(row);
    });

    // 4) ê·¸ë£¹ë³„ ê·œì¹™ ì²˜ë¦¬
    groupMap.forEach((rows, groupKey)=>{
      // row620/820/920 ì°¾ê¸°
      const row620 = rows.find(r=> parseFloat(r.querySelector(".widthInput").value)===620);
      const row820 = rows.find(r=> parseFloat(r.querySelector(".widthInput").value)===820);
      const row920 = rows.find(r=> parseFloat(r.querySelector(".widthInput").value)===920);

      const Q_620 = row620 ? parseFloat(row620.querySelector(".quantityOutput").value)||0 : 0;
      const Q_820 = row820 ? parseFloat(row820.querySelector(".quantityOutput").value)||0 : 0;
      const Q_920 = row920 ? parseFloat(row920.querySelector(".quantityOutput").value)||0 : 0;

      // 1ì•ˆ, ë‚˜ë¨¸ì§€ ì´ˆê¸°í™”
      [row620, row820, row920].forEach(r=>{
        if(r){
          r.querySelector(".adjustmentInput").value = "";
          r.querySelector(".remainderInput").value = "";
        }
      });

      // ì•„ë˜ëŠ” ì˜ˆì‹œ ê·œì¹™ ì²˜ë¦¬ ë¡œì§
      function decompose3(num){
        const a = Math.floor(num/3);
        const b = num % 3;
        return [a,b];
      }

      // ë‹¨ì¼ í­ ê·œì¹™ 1, 2, 3,...
      if(row620 && !row820 && !row920){
        row620.querySelector(".adjustmentInput").value = Q_620;
        row620.querySelector(".remainderInput").value = Q_620; // ë‚˜ë¨¸ì§€ì—ë„ ë™ì¼í•œ ê°’ ì„¤ì •
      }
      else if(!row620 && row820 && !row920){
        // 820ë§Œ ìˆëŠ” ê²½ìš° - ìƒˆë¡œìš´ ê·œì¹™
        
        // 1. 820í€€í„°í‹°ë¥¼ +ë§Œìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ 3ì˜ ë°°ìˆ˜ë¥¼ ë§Œë“¤ì–´ì„œ 1ì•ˆ, 2ì•ˆì—ë‹¤ ì ìŒ
        let adjustedQty820 = Q_820;
        while(adjustedQty820 % 3 !== 0) {
          adjustedQty820++;
        }
        row820.querySelector(".adjustmentInput").value = adjustedQty820; // 1ì•ˆ
        
        
        // 2. 620ì„ ì¶”ê°€í•´ì„œ 1ì•ˆì— 820 1ì•ˆì´ë‘ ê°™ì€ ê°’ì„ ë„£ìŒ
        insertConvertedRow(row820,"above", row820.querySelector(".phdSelect").value, 620, adjustedQty820);
        
      }
      else if(!row620 && !row820 && row920){
        // 920ë§Œ ìˆëŠ” ê²½ìš° - ìƒˆë¡œìš´ ê·œì¹™
  
        
        // 1. 920í€€í„°í‹°ë¥¼ +ë§Œìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ 4ì˜ ë°°ìˆ˜ë¥¼ ë§Œë“¤ì–´ì„œ 920 adjustmentì— ì ìŒ
        let adjustedQty920 = Q_920;
        while(adjustedQty920 % 4 !== 0) {
          adjustedQty920++;
        }
        row920.querySelector(".adjustmentInput").value = adjustedQty920;
        

        
        // 2. ìœ„ì— 620í–‰ì„ ë§Œë“¤ì–´ì„œ 620 adjustmentì— 920 adjustment/4ë¥¼ ì ìŒ
        const adjustment620 = adjustedQty920 / 4; // 920 adjustment / 4
        insertConvertedRow(row920,"above", row920.querySelector(".phdSelect").value, 620, adjustment620);
        

      }
      else if(row620 && row820 && !row920){
        // 620ê³¼ 820ë§Œ ìˆëŠ” ê²½ìš° - ìƒˆë¡œìš´ ê·œì¹™
        
        // 1. 820í€€í„°í‹°ë¥¼ +ë§Œìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ 3ì˜ ë°°ìˆ˜ë¥¼ ë§Œë“¤ê³  820 1ì•ˆì— ì ìŒ
        let adjustedQty820 = Q_820;
        while(adjustedQty820 % 3 !== 0) {
          adjustedQty820++;
        }
        row820.querySelector(".adjustmentInput").value = adjustedQty820;
        
        
        // 2. 620í€€í„°í‹°ê°€ 820 1ì•ˆë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì€ ê²½ìš°, 620 1ì•ˆì— 820 1ì•ˆê³¼ ê°™ì€ ìˆ˜ë¥¼ ì ìŒ
        if(Q_620 <= adjustedQty820) {
          row620.querySelector(".adjustmentInput").value = adjustedQty820;
        }
        // 3. 620 í€€í„°í‹°ê°€ 820 1ì•ˆë³´ë‹¤ í° ê²½ìš°, 620 1ì•ˆì— 620 í€€í„°í‹°ë¥¼ ì ê³ , ë‚˜ë¨¸ì§€ì— 620í€€í„°í‹°-820 1ì•ˆ ì„ ì ìŒ
        else {
          row620.querySelector(".adjustmentInput").value = Q_620;
          const remainder = Q_620 - adjustedQty820;
          row620.querySelector(".remainderInput").value = remainder;
        }
      }
      else if(row620 && !row820 && row920){
        // 620ê³¼ 920ë§Œ ìˆëŠ” ê²½ìš° - ë‹¨ìˆœí™”ëœ ê·œì¹™
        
        // 1. 920mmë¥¼ 4ì˜ ë°°ìˆ˜ë¡œ ì˜¬ë¦¼í•˜ì—¬ 1ì•ˆì— ë„£ëŠ”ë‹¤
        let adjustedQty920 = Q_920;
        while(adjustedQty920 % 4 !== 0) {
          adjustedQty920++;
        }
        row920.querySelector(".adjustmentInput").value = adjustedQty920;
        
        const neededQty620 = adjustedQty920 / 4; // 920 1ì•ˆ * 1/4
        
        // 2. 620mm ì²˜ë¦¬
        if(Q_620 <= neededQty620) {
          // 620 í€€í„°í‹°ê°€ 920 1ì•ˆ*1/4ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì€ ê²½ìš°
          row620.querySelector(".adjustmentInput").value = neededQty620;
        } else {
          // 620 í€€í„°í‹°ê°€ 920 1ì•ˆ*1/4ë³´ë‹¤ í° ê²½ìš°
          row620.querySelector(".adjustmentInput").value = Q_620;
          const remainder = Q_620 - neededQty620;
          row620.querySelector(".remainderInput").value = remainder;
        }
      }
      else if(!row620 && row820 && row920){
        // 820ê³¼ 920ë§Œ ìˆëŠ” ê²½ìš° - ìƒˆë¡œìš´ ê·œì¹™

        
        // 1. 820ì— ë§ì¶°ì„œ 820í€€í„°í‹°ë¥¼ +ë§Œìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ 3ì˜ ë°°ìˆ˜ë¡œ ë§Œë“¤ì–´ì„œ 820adjustmentì— ì ìŒ
        let adjustedQty820 = Q_820;
        while(adjustedQty820 % 3 !== 0) {
          adjustedQty820++;
        }
        row820.querySelector(".adjustmentInput").value = adjustedQty820;
        
        const neededQty920 = Math.round(adjustedQty820 * 2 / 3); // 820 adjustment * 2/3
        
        // 2. 920í€€í„°í‹°ê°€ 820adjustment*2/3ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ìœ¼ë©´ 920adjustmentì— 820adjustment*2/3ì„ ì ìŒ
        if(Q_920 <= neededQty920) {
          row920.querySelector(".adjustmentInput").value = neededQty920;
        }
        // 3. 920í€€í„°í‹°ê°€ 820adjustment*2/3ë³´ë‹¤ í¬ë©´
        else {
          
          // 920í€€í„°í‹°-820adjustment*2/3 ê°’ì„ +ë§Œìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ 4ì˜ ë°°ìˆ˜ë¡œ ë§Œë“¤ì–´ì„œ ê·¸ ê°’ì˜ 1/4ê°’ì„ 620í–‰ì„ ë§Œë“¤ì–´ì„œ 620adjustmentì— ì ìŒ
          const remainingQty920 = Q_920 - neededQty920; // 920í€€í„°í‹°-820adjustment*2/3
          let adjustedRemainingQty920 = remainingQty920;
          while(adjustedRemainingQty920 % 4 !== 0) {
            adjustedRemainingQty920++;
          }
          const neededQty620 = adjustedRemainingQty920 / 4; // ê·¸ ê°’ì˜ 1/4ê°’
          
          
          // 620í–‰ ìƒì„±
          insertConvertedRow(row820,"above", row820.querySelector(".phdSelect").value, 620, neededQty620);
          
          // 4. 920adjustmentëŠ” ì¡°ì •ëœ 920 í€€í„°í‹°ë¥¼ ì ìŒ
          const finalQty920 = neededQty920 + adjustedRemainingQty920; // 820adjustment*2/3 + ì¡°ì •ëœ ë‚¨ì€ 920 í€€í„°í‹°
          row920.querySelector(".adjustmentInput").value = finalQty920;
          
        }
        
        
      }
      else if(row620 && row820 && row920){
        // 620, 820, 920 ëª¨ë‘ ìˆëŠ” ê²½ìš° - ìƒˆë¡œìš´ ê·œì¹™
        
        // 1. 820ì— ë§ì¶°ì„œ 820í€€í„°í‹°ë¥¼ +ë§Œìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ 3ì˜ ë°°ìˆ˜ë¡œ ë§Œë“¤ì–´ì„œ 820adjustmentì— ì ìŒ
        let adjustedQty820 = Q_820;
        while(adjustedQty820 % 3 !== 0) {
          adjustedQty820++;
        }
        row820.querySelector(".adjustmentInput").value = adjustedQty820;
        
        const neededQty920 = Math.round(adjustedQty820 * 2 / 3); // 820 adjustment * 2/3
        
        // 2. 920í€€í„°í‹°ê°€ 820adjustment*2/3ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ìœ¼ë©´ 920adjustmentì— 820adjustment*2/3ì„ ì ìŒ
        if(Q_920 <= neededQty920) {
          row920.querySelector(".adjustmentInput").value = neededQty920;
          row620.querySelector(".adjustmentInput").value = Q_620; // 620adjustmentì—ëŠ” 620í€€í„°í‹°ë¥¼ ê·¸ëŒ€ë¡œ ì ìŒ
        }
        // 3. 920í€€í„°í‹°ê°€ 820adjustment*2/3ë³´ë‹¤ í¬ë©´
        else {
          
          // 920í€€í„°í‹°-820adjustment*2/3 ê°’ì„ +ë§Œìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ 4ì˜ ë°°ìˆ˜ë¡œ ë§Œë“¤ì–´ì„œ 920adjustmentëŠ” 820adjustment*2/3+ì¡°ì •ëœ 920 í€€í„°í‹°ë¥¼ ì ìŒ
          const remainingQty920 = Q_920 - neededQty920; // 920í€€í„°í‹°-820adjustment*2/3
          let adjustedRemainingQty920 = remainingQty920;
          while(adjustedRemainingQty920 % 4 !== 0) {
            adjustedRemainingQty920++;
          }
          const finalQty920 = neededQty920 + adjustedRemainingQty920; // 820adjustment*2/3+ì¡°ì •ëœ 920 í€€í„°í‹°
          row920.querySelector(".adjustmentInput").value = finalQty920;
          
          const neededQty620 = adjustedRemainingQty920 / 4; // ì¡°ì •ëœ 920 í€€í„°í‹°/4
          
          // 4. ì¡°ì •ëœ 920 í€€í„°í‹°/4 ì´ 620í€€í„°í‹°ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ì€ê²½ìš°, 620adjustmentì— ì¡°ì •ëœ920í€€í„°í‹°/4ê°’ì„ ì ìŒ
          if(neededQty620 >= Q_620) {
            row620.querySelector(".adjustmentInput").value = neededQty620;
          }
          // 5. ì¡°ì •ëœ920í€€í„°í‹°/4ë³´ë‹¤ 620í€€í„°í‹°ê°€ ë” í° ê²½ìš°, 620adjustmentì— 620í€€í„°í‹°ë¥¼ ê·¸ëŒ€ë¡œ ì ê³  620 ë‚˜ë¨¸ì§€ì— 620í€€í„°í‹°-ì¡°ì •ëœ920í€€í„°í‹°/4 ê°’ì„ ì ìŒ(ì–‘ìˆ˜ì¸ê²½ìš°)
          else {
            row620.querySelector(".adjustmentInput").value = Q_620; // 620adjustmentì— 620í€€í„°í‹°ë¥¼ ê·¸ëŒ€ë¡œ ì ìŒ
            const remainder620 = Math.max(0, Q_620 - neededQty620); // 620í€€í„°í‹°-ì¡°ì •ëœ920í€€í„°í‹°/4 (ì–‘ìˆ˜ì¸ê²½ìš°)
            row620.querySelector(".remainderInput").value = remainder620;
          }
          
        }
      }
    });
    
    // Convert1 ì™„ë£Œ í›„ ì´ëŸ‰ ì—…ë°ì´íŠ¸
    updateTotals();
  });

  //===================================================
  // Convert2 (Convert 2 ë¡œì§)
  //===================================================
  document.getElementById("convert2Button").addEventListener("click", ()=>{

    
    // 1) (phdVal, lengthVal) ê·¸ë£¹í•‘ - .converted í–‰ë„ í¬í•¨
    const baseRows = Array.from(document.querySelectorAll("#orderTableBody tr"));
    const groupMap = new Map();
    baseRows.forEach(row=>{
      const phdVal = row.querySelector(".phdSelect").value;
      const lengthVal = parseFloat(row.querySelector(".lengthInput").value) || 0;
      const groupKey = `${phdVal}-${lengthVal}`;

      if(!groupMap.has(groupKey)){
        groupMap.set(groupKey, []);
      }
      groupMap.get(groupKey).push(row);
    });

    // 2) ê·¸ë£¹ë³„ ê·œì¹™ ì²˜ë¦¬
    groupMap.forEach((rows, groupKey)=>{
      
      
      // 630 í–‰ ì°¾ê¸°
      const row630 = rows.find(r=> parseFloat(r.querySelector(".widthInput").value)===630);
      
      if(row630){
        // Convert2 ê·œì¹™ 1: 630ì€ í€€í„°í‹°ë¥¼ 1ì•ˆì—ë‹¤ê°€ ì ëŠ”ë‹¤
        const Q_630 = parseFloat(row630.querySelector(".quantityOutput").value) || 0;
        row630.querySelector(".adjustmentInput").value = Q_630;
        
      }
      
      // 850 í–‰ ì°¾ê¸°
      const row850 = rows.find(r=> parseFloat(r.querySelector(".widthInput").value)===850);
      
      if(row850){
        // Convert2 ê·œì¹™ 2: 850 í€€í„°í‹°ë¥¼ +ë§Œìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ 5ì˜ ë°°ìˆ˜ë¡œ ë§Œë“¤ì–´ì„œ 850 1ì•ˆì— ì ëŠ”ë‹¤
        let Q_850 = parseFloat(row850.querySelector(".quantityOutput").value) || 0;
        let adjustedQty850 = Q_850;
        while(adjustedQty850 % 5 !== 0) {
          adjustedQty850++;
        }
        row850.querySelector(".adjustmentInput").value = adjustedQty850;
        
      }
      
      // 750 í–‰ ì°¾ê¸°
      const row750 = rows.find(r=> parseFloat(r.querySelector(".widthInput").value)===750);
      
      if(row750){
        // Convert2 ê·œì¹™ 3: 750ì´ ìˆì„ ê²½ìš°, widthë¥¼ ìš°ì„  745ë¡œ ë°”ê¾¸ê³ , +ë§Œìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ 5ì˜ ë°°ìˆ˜ë¡œ ë§Œë“¤ì–´ì„œ 1ì•ˆì— ì ëŠ”ë‹¤
        
        // ì›ë˜ 750ì˜ Quantity ê°’ì„ ë¨¼ì € ì €ì¥
        let Q_750 = parseFloat(row750.querySelector(".quantityOutput").value) || 0;
        
        // Widthë¥¼ 745ë¡œ ë³€ê²½
        row750.querySelector(".widthInput").value = 745;
        
        // Width ë³€ê²½ í›„ Quantity ì¬ê³„ì‚° (ì´ì œ 745 ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë¨)
        recalcRow(row750);
        
        // Quantityë¥¼ ì›ë˜ 750 ê¸°ì¤€ ê°’ìœ¼ë¡œ ë˜ëŒë¦¼
        row750.querySelector(".quantityOutput").value = Q_750;
        
        let adjustedQty750 = Q_750;
        while(adjustedQty750 % 5 !== 0) {
          adjustedQty750++;
        }
        row750.querySelector(".adjustmentInput").value = adjustedQty750;
        
        const neededQty620 = adjustedQty750 / 5; // 750 1ì•ˆ / 5
        
        
        // 620 í–‰ ì°¾ê¸° (.converted í–‰ë„ í¬í•¨)
        const row620 = rows.find(r=> parseFloat(r.querySelector(".widthInput").value)===620);
        
        if(!row620){
          // 1. 620 í–‰ì´ ì—†ì„ ê²½ìš° í•˜ë‚˜ ì¶”ê°€í•´ì„œ 750 1ì•ˆ/5ë¥¼ ì ëŠ”ë‹¤
          const newRow620 = insertConvertedRow(row750, "above", row750.querySelector(".phdSelect").value, 620, neededQty620);

        } else {
          // 620 í–‰ì´ ìˆëŠ” ê²½ìš°
          const currentAdjustment620 = parseFloat(row620.querySelector(".adjustmentInput").value) || 0;
          const currentRemainder620 = getRemainderValue(row620);
          
          if(currentRemainder620 === 0){
            // 2. 620 í–‰ì´ ìˆëŠ” ê²½ìš°, ë‚˜ë¨¸ì§€ê°€ ê³µë€ì¸ ê²½ìš°, 620 1ì•ˆì— ì í˜€ìˆëŠ” ê°’ì— 750 1ì•ˆ/5ë¥¼ ì¶”ê°€í•œë‹¤
            const newAdjustment620 = currentAdjustment620 + neededQty620;
            row620.querySelector(".adjustmentInput").value = newAdjustment620;
            
          } else {
            if(neededQty620 > currentRemainder620){
              // 3. 620 í–‰ì´ ìˆëŠ”ë° ë‚˜ë¨¸ì§€ì— ìˆ«ìê°€ ìˆëŠ”ê²½ìš°, ë‚˜ë¨¸ì§€ë³´ë‹¤ 750 1ì•ˆ/5ê°€ í° ê²½ìš°, 620 1ì•ˆì— ì í˜€ìˆëŠ” ê°’ì—ì„œ ë‚˜ë¨¸ì§€ë¥¼ ë¹¼ê³  750 1ì•ˆ/5ë¥¼ ì¶”ê°€í•œë‹¤
              const newAdjustment620 = currentAdjustment620 - currentRemainder620 + neededQty620;
              row620.querySelector(".adjustmentInput").value = newAdjustment620;
              // ê·¸ë¦¬ê³  620ì˜ ë‚˜ë¨¸ì§€ëŠ” 0ì´ ëœë‹¤
              row620.querySelector(".remainderInput").value = 0;
              
            } else {
              // 4. 620í–‰ì´ ìˆëŠ”ë° ë‚˜ë¨¸ì§€ì— ìˆ«ìê°€ ìˆëŠ”ë°, ë‚˜ë¨¸ì§€ë³´ë‹¤ 750 1ì•ˆ/5ê°€ ì‘ê±°ë‚˜ ê°™ì€ê²½ìš°, 620 1ì•ˆì€ ê·¸ëŒ€ë¡œ ë‘ê³  ë‚˜ë¨¸ì§€ í˜„ì¬ ê°’ì—ì„œ 750 1ì•ˆ/5ë¥¼ ëº€ ê°’ì„ ì ëŠ”ë‹¤
              const newRemainder620 = currentRemainder620 - neededQty620;
              row620.querySelector(".remainderInput").value = newRemainder620;
              
            }
          }
        }
      }
      
      // 770 í–‰ ì°¾ê¸° (ë…ë¦½ì  ì²˜ë¦¬)
      const row770 = rows.find(r=> parseFloat(r.querySelector(".widthInput").value)===770);
      
      if(row770){
        // Convert2 ê·œì¹™ 4: 770ì´ ìˆëŠ” ê²½ìš°
        let Q_770 = parseFloat(row770.querySelector(".quantityOutput").value) || 0;
        let adjustedQty770 = Q_770;
        while(adjustedQty770 % 4 !== 0) {
          adjustedQty770++;
        }
        row770.querySelector(".adjustmentInput").value = adjustedQty770;
        
        const neededQty620 = adjustedQty770 / 2; // 770 1ì•ˆ / 2

        
        // 620 í–‰ ì°¾ê¸° (.converted í–‰ë„ í¬í•¨)
        const row620 = rows.find(r=> parseFloat(r.querySelector(".widthInput").value)===620);
        
        if(!row620){
          // 1. ê°™ì€ phd length ì•ˆì— 770ë§Œ ìˆëŠ” ê²½ìš°, 770 í€€í„°í‹°ë¥¼ +ë§Œìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ 4ì˜ ë°°ìˆ˜ë¥¼ ë§Œë“¤ì–´ì„œ 770 1ì•ˆì— ì ê³ , ìœ„ì— 620 í–‰ì„ ë§Œë“¤ì–´ì„œ 770 1ì•ˆ/2ë¥¼ 1ì•ˆì— ì ëŠ”ë‹¤
          const newRow620 = insertConvertedRow(row770, "above", row770.querySelector(".phdSelect").value, 620, neededQty620);

        } else {
          // 620 í–‰ì´ ìˆëŠ” ê²½ìš°
          const currentAdjustment620 = parseFloat(row620.querySelector(".adjustmentInput").value) || 0;
          const currentRemainder620 = getRemainderValue(row620);
          
          if(currentRemainder620 === 0){
            // 2. ê°™ì€ phd length ì•ˆì— 620ì´ ìˆëŠ”ë° ë‚˜ë¨¸ì§€ê°€ ê³µë€ì¸ ê²½ìš°, 620 1ì•ˆ í˜„ì¬ê°’ì— 770 1ì•ˆ/2ë¥¼ ë”í•œë‹¤
            const newAdjustment620 = currentAdjustment620 + neededQty620;
            row620.querySelector(".adjustmentInput").value = newAdjustment620;

          } else {
            if(currentRemainder620 <= neededQty620){
              // 3. ê°™ì€ phd length ì•ˆì— 620ì´ ìˆëŠ”ë° ë‚˜ë¨¸ì§€ê°€ ìˆê³ , ê·¸ê²Œ 770 1ì•ˆ/2ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì„ ë•Œ 620 1ì•ˆ í˜„ì¬ê°’ì—ì„œ ë‚˜ë¨¸ì§€ë¥¼ ë¹¼ê³  770 1ì•ˆ/2ë¥¼ ë”í•œë‹¤
              const newAdjustment620 = currentAdjustment620 - currentRemainder620 + neededQty620;
              row620.querySelector(".adjustmentInput").value = newAdjustment620;
              // ê·¸ë¦¬ê³  620ì˜ ë‚˜ë¨¸ì§€ëŠ” 0ì´ ëœë‹¤
              row620.querySelector(".remainderInput").value = 0;

            } else {
              // 4. ê°™ì€ phd length ì•ˆì— 620ì´ ìˆëŠ”ë° ë‚˜ë¨¸ì§€ê°€ ìˆê³ , ê·¸ê²Œ 770 1ì•ˆ/2 ë³´ë‹¤ í´ë•Œ, 620 1ì•ˆì€ ë‘ê³  ë‚˜ë¨¸ì§€ì—ì„œ 770 1ì•ˆ/2ì„ ëº€ë‹¤
              const newRemainder620 = currentRemainder620 - neededQty620;
              row620.querySelector(".remainderInput").value = newRemainder620;

            }
          }
        }
      }
    });
    
    // Convert2 ì™„ë£Œ í›„ ì´ëŸ‰ ì—…ë°ì´íŠ¸
    updateTotals();
  });

  
  // ì°¨ì´ ê³„ì‚° í—¬í¼ í•¨ìˆ˜
  function calculateDifference() {
    const rows = document.querySelectorAll("#orderTableBody tr");
    let totalQuantityKg = 0;
    let totalAdjustmentKg = 0;
    
    rows.forEach(row => {
      const qtyVal = parseFloat(row.querySelector(".quantityOutput")?.value) || 0;
      const adjVal = parseFloat(row.querySelector(".adjustmentInput")?.value) || 0;
      const wVal = parseFloat(row.querySelector(".widthInput").value) || 0;
      const xCell = row.querySelector(".xOutput");
      
      if (qtyVal > 0 && wVal > 0 && xCell && xCell.value) {
        const xValue = parseInt(xCell.value.replace('x', ''));
        if (xValue > 0) {
          totalQuantityKg += wVal * xValue * 0.0355 * qtyVal;
        }
      }
      
      if (adjVal > 0 && wVal > 0 && xCell && xCell.value) {
        const xValue = parseInt(xCell.value.replace('x', ''));
        if (xValue > 0) {
          totalAdjustmentKg += wVal * xValue * 0.0355 * adjVal;
        }
      }
    });
    
    return (totalAdjustmentKg / 1000) - (totalQuantityKg / 1000);
  }






  //===================================================
  // Opt1 ë²„íŠ¼ (ì¹´í…Œê³ ë¦¬ë³„ ìµœì í™”)
  //===================================================
  document.getElementById("opt1Button").addEventListener("click", ()=>{
    
    // ì „ì²´ ì°¨ì´ ê³„ì‚° í•¨ìˆ˜ (ì»¨ë²„íŠ¸ì—´ ì´ë¬´ê²Œì™€ kgì—´ ì´ë¬´ê²Œì˜ ì°¨ì´)
    function calculateCurrentDifference() {
      const rows = document.querySelectorAll("#orderTableBody tr");
      let totalAdjustmentKg = 0;
      let totalKg = 0;
      
      rows.forEach(row => {
        const adjVal = parseFloat(row.querySelector(".adjustmentInput")?.value) || 0;
        const kgVal = parseFloat(row.querySelector(".kgInput")?.value) || 0;
        const wVal = parseFloat(row.querySelector(".widthInput").value) || 0;
        const xCell = row.querySelector(".xOutput");
        
        if (adjVal > 0 && wVal > 0 && xCell && xCell.value) {
          const xValue = parseInt(xCell.value.replace('x', ''));
          if (xValue > 0) {
            const adjustmentKg = wVal * xValue * 0.0355 * adjVal;
            totalAdjustmentKg += adjustmentKg;
          }
        }
        
        totalKg += kgVal;
      });
      
      const totalAdjustmentTon = totalAdjustmentKg / 1000;
      const totalKgTon = totalKg / 1000;
      return totalAdjustmentTon - totalKgTon;
    }
    
    // ì¹´í…Œê³ ë¦¬ë³„ ì°¨ì´ ê³„ì‚° í•¨ìˆ˜ (ì»¨ë²„íŠ¸ì—´ ì´ë¬´ê²Œì™€ í€€í„°í‹°ì—´ ì´ë¬´ê²Œì˜ ì°¨ì´)
    function calculateCategoryDifference(rows) {
      let totalAdjustmentKg = 0;
      let totalQuantityKg = 0;
      
      rows.forEach(row => {
        const adjVal = parseFloat(row.querySelector(".adjustmentInput")?.value) || 0;
        const quantityVal = parseFloat(row.querySelector(".quantityOutput")?.value) || 0;
        const wVal = parseFloat(row.querySelector(".widthInput").value) || 0;
        const xCell = row.querySelector(".xOutput");
        
        if (adjVal > 0 && wVal > 0 && xCell && xCell.value) {
          const xValue = parseInt(xCell.value.replace('x', ''));
          if (xValue > 0) {
            const adjustmentKg = wVal * xValue * 0.0355 * adjVal;
            totalAdjustmentKg += adjustmentKg;
          }
        }
        
        if (quantityVal > 0 && wVal > 0 && xCell && xCell.value) {
          const xValue = parseInt(xCell.value.replace('x', ''));
          if (xValue > 0) {
            const quantityKg = wVal * xValue * 0.0355 * quantityVal;
            totalQuantityKg += quantityKg;
          }
        }
      });
      
      const totalAdjustmentTon = totalAdjustmentKg / 1000;
      const totalQuantityTon = totalQuantityKg / 1000;
      return totalAdjustmentTon - totalQuantityTon;
    }
    
    // ì œì™¸í•  í–‰ì¸ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
    function shouldExcludeRow(row, rowIndex) {
      const widthVal = parseFloat(row.querySelector(".widthInput").value) || 0;
      const remainderVal = getRemainderValue(row);
      const phdVal = row.querySelector(".phdSelect").value;
      const lengthVal = parseFloat(row.querySelector(".lengthInput").value) || 0;
      
      // ì¡°ê±´ 1: 620ì—´ì¸ë° ë‚˜ë¨¸ì§€ê°€ ê³µë€ì´ê±°ë‚˜ 0ì¸ í–‰
      if (widthVal === 620 && remainderVal <= 0) {
        return true;
      }
      
      // ì¡°ê±´ 2: ê°™ì€ PHD Length ì•ˆì— 820, 920ì€ ìˆê³  620ì€ ì—†ëŠ” ê²½ìš°ì˜ 920 í–‰
      if (widthVal === 920) {
        const allRows = document.querySelectorAll("#orderTableBody tr");
        const sameGroupRows = Array.from(allRows).filter(r => {
          const rPhd = r.querySelector(".phdSelect").value;
          const rLength = parseFloat(r.querySelector(".lengthInput").value) || 0;
          return rPhd === phdVal && rLength === lengthVal;
        });
        
        const hasRow620 = sameGroupRows.some(r => parseFloat(r.querySelector(".widthInput").value) === 620);
        const hasRow820 = sameGroupRows.some(r => parseFloat(r.querySelector(".widthInput").value) === 820);
        const hasRow920 = sameGroupRows.some(r => parseFloat(r.querySelector(".widthInput").value) === 920);
        
        if (hasRow820 && hasRow920 && !hasRow620) {
          return true;
        }
      }
      
      return false;
    }
    
    // 1. ì „ì²´ ì°¨ì´ í™•ì¸ (ì „ì œ ì¡°ê±´)
    const initialDifference = calculateCurrentDifference();
    if (initialDifference <= 1.5) {
      return;
    }
    
    // 2. ëª¨ë“  í–‰ì„ PHD-Length ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
    const allRows = document.querySelectorAll("#orderTableBody tr");
    const categories = new Map();
    
    allRows.forEach((row, index) => {
      const phdVal = row.querySelector(".phdSelect").value;
      const lengthVal = parseFloat(row.querySelector(".lengthInput").value) || 0;
      const widthVal = parseFloat(row.querySelector(".widthInput").value) || 0;
      
      if (phdVal && lengthVal > 0 && widthVal > 0) {
        const categoryKey = `${phdVal}-${lengthVal}`;
        if (!categories.has(categoryKey)) {
          categories.set(categoryKey, []);
        }
        categories.get(categoryKey).push({row, index});
      }
    });
    
      // 3. ê° ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì²˜ë¦¬
      for (const [categoryKey, categoryRows] of categories) {
        // í˜„ì¬ ì¹´í…Œê³ ë¦¬ì˜ ì°¨ì´ ê³„ì‚°
        let currentDifference = calculateCategoryDifference(categoryRows.map(item => item.row));
        
        if (currentDifference <= 0.5) {
          continue;
        }
      
      // ì¹´í…Œê³ ë¦¬ ë‚´ì—ì„œ ì¡°ì • ê°€ëŠ¥í•œ í–‰ë“¤ ì°¾ê¸°
      const adjustableRows = categoryRows.filter(item => {
        const {row, index} = item;
        return !shouldExcludeRow(row, index);
      });
      
        if (adjustableRows.length === 0) {
          continue;
        }
      
      // ìˆœí™˜ì ìœ¼ë¡œ ê°ì†Œ ë²„íŠ¼ í´ë¦­
      let iterationCount = 0;
      const maxIterations = 100; // ë¬´í•œ ë£¨í”„ ë°©ì§€
      
      while (iterationCount < maxIterations) {
        iterationCount++;
        let found = false;
        
        // ì¡°ì • ê°€ëŠ¥í•œ í–‰ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬
        for (const {row, index} of adjustableRows) {
          const downBtn = row.querySelector(".adjustDownButton");
          if (downBtn && !downBtn.disabled) {
            downBtn.click();
            found = true;
            
            // ì´ëŸ‰ ì—…ë°ì´íŠ¸
            updateTotals();
            
            // ìƒˆë¡œìš´ ì°¨ì´ í™•ì¸
            const newDifference = calculateCategoryDifference(categoryRows.map(item => item.row));
            // ì°¨ì´ê°€ 0.5í†¤ ì´í•˜ê°€ ë˜ë©´ ì¢…ë£Œ
            if (newDifference <= 0.5) {
              found = false; // ë£¨í”„ ì¢…ë£Œë¥¼ ìœ„í•´
              break;
            }
            
            // ì°¨ì´ê°€ ìŒìˆ˜ê°€ ë˜ë©´ ê³¼ë„í•œ ì¡°ì •ì´ë¯€ë¡œ ì¢…ë£Œ
            if (newDifference < 0) {
              found = false; // ë£¨í”„ ì¢…ë£Œë¥¼ ìœ„í•´
              break;
            }
            
            break; // í•œ ë²ˆì— í•˜ë‚˜ì”©ë§Œ ì²˜ë¦¬
          }
        }
        
        if (!found) {
          break;
        }
      }
      
    }
    
  });

  //===================================================
  // Opt2 ë²„íŠ¼
  //===================================================
  document.getElementById("opt2Button").addEventListener("click", ()=>{
    
    // í˜„ì¬ ì „ì²´ ì°¨ì´ ê³„ì‚° í•¨ìˆ˜ (ì»¨ë²„íŠ¸ì—´ ì´ë¬´ê²Œì™€ kgì—´ ì´ë¬´ê²Œì˜ ì°¨ì´)
    function calculateCurrentDifference() {
      const rows = document.querySelectorAll("#orderTableBody tr");
      let totalAdjustmentKg = 0;
      let totalKg = 0;
      
      rows.forEach(row => {
        const adjVal = parseFloat(row.querySelector(".adjustmentInput")?.value) || 0;
        const kgVal = parseFloat(row.querySelector(".kgInput")?.value) || 0;
        const wVal = parseFloat(row.querySelector(".widthInput").value) || 0;
        const xCell = row.querySelector(".xOutput");
        
        if (adjVal > 0 && wVal > 0 && xCell && xCell.value) {
          const xValue = parseInt(xCell.value.replace('x', ''));
          if (xValue > 0) {
            const adjustmentKg = wVal * xValue * 0.0355 * adjVal;
            totalAdjustmentKg += adjustmentKg;
          }
        }
        
        totalKg += kgVal;
      });
      
      const totalAdjustmentTon = totalAdjustmentKg / 1000;
      const totalKgTon = totalKg / 1000;
      return totalAdjustmentTon - totalKgTon;
    }
    
    // ì¹´í…Œê³ ë¦¬ë³„ ì°¨ì´ ê³„ì‚° í•¨ìˆ˜ (ì»¨ë²„íŠ¸ì—´ ì´ë¬´ê²Œì™€ í€€í„°í‹°ì—´ ì´ë¬´ê²Œì˜ ì°¨ì´)
    function calculateCategoryDifference(categoryRows) {
      let categoryAdjustmentKg = 0;
      let categoryQuantityKg = 0;
      
      categoryRows.forEach(({row}) => {
        const adjVal = parseFloat(row.querySelector(".adjustmentInput")?.value) || 0;
        const quantityVal = parseFloat(row.querySelector(".quantityOutput")?.value) || 0;
        const wVal = parseFloat(row.querySelector(".widthInput").value) || 0;
        const xCell = row.querySelector(".xOutput");
        
        if (adjVal > 0 && wVal > 0 && xCell && xCell.value) {
          const xValue = parseInt(xCell.value.replace('x', ''));
          if (xValue > 0) {
            const adjustmentKg = wVal * xValue * 0.0355 * adjVal;
            categoryAdjustmentKg += adjustmentKg;
          }
        }
        
        if (quantityVal > 0 && wVal > 0 && xCell && xCell.value) {
          const xValue = parseInt(xCell.value.replace('x', ''));
          if (xValue > 0) {
            const quantityKg = wVal * xValue * 0.0355 * quantityVal;
            categoryQuantityKg += quantityKg;
          }
        }
      });
      
      const categoryAdjustmentTon = categoryAdjustmentKg / 1000;
      const categoryQuantityTon = categoryQuantityKg / 1000;
      return categoryAdjustmentTon - categoryQuantityTon;
    }
    
    // ì œì™¸í•  í–‰ì¸ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜ (opt2ì™€ ë™ì¼)
    function shouldExcludeRow(row, rowIndex) {
      const widthVal = parseFloat(row.querySelector(".widthInput").value) || 0;
      const remainderVal = getRemainderValue(row);
      const phdVal = row.querySelector(".phdSelect").value;
      const lengthVal = parseFloat(row.querySelector(".lengthInput").value) || 0;
      
      // ì¡°ê±´ 1: 620ì—´ì¸ë° ë‚˜ë¨¸ì§€ê°€ ê³µë€ì´ê±°ë‚˜ 0ì¸ í–‰
      if (widthVal === 620 && remainderVal <= 0) {
        return true;
      }
      
      // ì¡°ê±´ 2: ê°™ì€ PHD Length ì•ˆì— 820, 920ì€ ìˆê³  620ì€ ì—†ëŠ” ê²½ìš°ì˜ 920 í–‰
      if (widthVal === 920) {
        const allRows = document.querySelectorAll("#orderTableBody tr");
        const sameGroupRows = Array.from(allRows).filter(r => {
          const rPhd = r.querySelector(".phdSelect").value;
          const rLength = parseFloat(r.querySelector(".lengthInput").value) || 0;
          return rPhd === phdVal && rLength === lengthVal;
        });
        
        const hasRow620 = sameGroupRows.some(r => parseFloat(r.querySelector(".widthInput").value) === 620);
        const hasRow820 = sameGroupRows.some(r => parseFloat(r.querySelector(".widthInput").value) === 820);
        const hasRow920 = sameGroupRows.some(r => parseFloat(r.querySelector(".widthInput").value) === 920);
        
        if (hasRow820 && hasRow920 && !hasRow620) {
          return true;
        }
      }
      
      return false;
    }
    
    // 1. í˜„ì¬ ì „ì²´ ì°¨ì´ í™•ì¸
    const initialDifference = calculateCurrentDifference();
    if (initialDifference <= 1.5) {
      return;
    }
    
    // 2. ëª¨ë“  í–‰ì„ PHD-Length ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
    const allRows = document.querySelectorAll("#orderTableBody tr");
    const categories = new Map();
    
    allRows.forEach((row, index) => {
      const phdVal = row.querySelector(".phdSelect").value;
      const lengthVal = parseFloat(row.querySelector(".lengthInput").value) || 0;
      const categoryKey = `${phdVal}-${lengthVal}`;
      
      if (!categories.has(categoryKey)) {
        categories.set(categoryKey, []);
      }
      categories.get(categoryKey).push({row, index});
    });
    
    
    // 3. ë©”ì¸ ë£¨í”„: ì „ì²´ ì°¨ì´ê°€ 1.5í†¤ ì´í•˜ê°€ ë  ë•Œê¹Œì§€ ë°˜ë³µ
    while (true) {
      const currentDifference = calculateCurrentDifference();
      if (currentDifference <= 1.5) {
        break;
      }
      
      // 4. ê° ì¹´í…Œê³ ë¦¬ì˜ ì°¨ì´ ê³„ì‚° ë° ì •ë ¬
      const categoryDifferences = [];
      categories.forEach((categoryRows, categoryKey) => {
        const categoryDiff = calculateCategoryDifference(categoryRows);
        categoryDifferences.push({categoryKey, categoryRows, difference: categoryDiff});
      });
      
      // ì°¨ì´ê°€ í° ìˆœì„œë¡œ ì •ë ¬ (ì»¨ë²„íŠ¸ê°€ í€€í„°í‹°ë³´ë‹¤ í° ê²½ìš°ë§Œ)
      categoryDifferences.sort((a, b) => b.difference - a.difference);
      
      // 5. ì°¨ì´ê°€ ê°€ì¥ í° ì¹´í…Œê³ ë¦¬ì—ì„œ ì‘ì—…
      let found = false;
      for (const {categoryKey, categoryRows, difference} of categoryDifferences) {
        if (difference <= 0) {
          continue;
        }
        
        
        // 6. í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ë‚´ì—ì„œ ìˆœì„œëŒ€ë¡œ ê°ì†Œ ë²„íŠ¼ í´ë¦­
        for (const {row, index} of categoryRows) {
          // ì œì™¸ ì¡°ê±´ í™•ì¸
          if (shouldExcludeRow(row, index)) {
            continue;
          }
          
          const downBtn = row.querySelector(".adjustDownButton");
          if (downBtn && !downBtn.disabled) {
            downBtn.click();
            found = true;
            
            // 7. ì¡°ì • í›„ ì „ì²´ ì°¨ì´ ë‹¤ì‹œ í™•ì¸
            const newDifference = calculateCurrentDifference();
            if (newDifference <= 1.5) {
              return;
            }
            
            // 8. ì´ëŸ‰ ì—…ë°ì´íŠ¸
            updateTotals();
            break;
          }
        }
        
        if (found) break;
      }
      
      // ì²˜ë¦¬í•  í–‰ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
      if (!found) {
        break;
      }
    }
    
  });


  //===================================================
  // í–‰ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì „ì—­)
  //===================================================
  function updateRowNumbers() {
    const tbody = document.getElementById("orderTableBody");
    if (!tbody) {
      return;
    }
    
    const rows = tbody.querySelectorAll("tr");
    
    rows.forEach((row, index) => {
      const rowNumberSpan = row.querySelector(".row-number");
      if (rowNumberSpan) {
        rowNumberSpan.textContent = index + 1;
      }
    });
  }

  //===================================================
  // Convert ë²„íŠ¼ (í†µí•© Convert)
  //===================================================
  document.getElementById("convertBtn").addEventListener("click", ()=>{
    console.log("ğŸ”„ Convert ì‹œì‘");
    console.log("ğŸ“‹ Convert1 ì‹œì‘");
    document.getElementById("convert1Button").click();
    
    setTimeout(() => {
      console.log("ğŸ“‹ Convert2 ì‹œì‘");
      document.getElementById("convert2Button").click();
        
      setTimeout(() => {
        console.log("ğŸ“‹ Organize ì‹œì‘");
        document.getElementById("sortPHDButton").click();
        console.log("âœ… Convert ì™„ë£Œ");
      }, 1000);
    }, 1000);
  });

  //===================================================
  // Optimize ë²„íŠ¼ (í†µí•© Optimize)
  //===================================================
  document.getElementById("optimizeBtn").addEventListener("click", ()=>{
    console.log("ğŸ”§ Optimize ì‹œì‘");
    console.log("ğŸ“‹ Opt1 ì‹œì‘");
    
    // Opt1ê³¼ Opt2ë¥¼ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰
    document.getElementById("opt1Button").click();
    
    // Opt1 ì™„ë£Œ í›„ Opt2 ì‹¤í–‰
    setTimeout(() => {
      console.log("ğŸ“‹ Opt2 ì‹œì‘");
      document.getElementById("opt2Button").click();
      console.log("âœ… Optimize ì™„ë£Œ");
    }, 1000);
  });

  // Optimize ëª¨ë“œìš© ì´ëŸ‰ ê³„ì‚° (ìë™ ì¡°ì • ì—†ìŒ)
  function updateTotalsOnly() {
    const rows = document.querySelectorAll("#orderTableBody tr");
    let totalKg = 0;
    let totalAdjustmentKg = 0;
    let totalQuantityKg = 0;
    
    rows.forEach(row => {
      const kgVal = parseFloat(row.querySelector(".kgInput")?.value) || 0;
      const adjVal = parseFloat(row.querySelector(".adjustmentInput")?.value) || 0;
      const qtyVal = parseFloat(row.querySelector(".quantityOutput")?.value) || 0;
      const phdVal = row.querySelector(".phdSelect").value;
      const wVal = parseFloat(row.querySelector(".widthInput")?.value) || 0;
      const lVal = parseFloat(row.querySelector(".lengthInput")?.value) || 0;
      
      totalKg += kgVal;
      
      // Quantity ê°’ì´ ìˆìœ¼ë©´ width * x * 0.0355 * í€€í„°í‹°ë¡œ ê³„ì‚°
      if (qtyVal > 0 && wVal > 0) {
        // Xê°’ ì¶”ì¶œ (ì˜ˆ: "4x" -> 4)
        const xCell = row.querySelector(".xOutput");
        if (xCell && xCell.value) {
          const xValue = parseInt(xCell.value.replace('x', ''));
          if (xValue > 0) {
            const quantityKg = wVal * xValue * 0.0355 * qtyVal;
            totalQuantityKg += quantityKg;
          }
        }
      }
      
      // 1ì•ˆ ê°’ì´ ìˆìœ¼ë©´ width * x * 0.0355 * 1ì•ˆ ìˆ˜ëŸ‰ìœ¼ë¡œ ê³„ì‚°
      if (adjVal > 0 && wVal > 0) {
        // Xê°’ ì¶”ì¶œ (ì˜ˆ: "4x" -> 4)
        const xCell = row.querySelector(".xOutput");
        if (xCell && xCell.value) {
          const xValue = parseInt(xCell.value.replace('x', ''));
          if (xValue > 0) {
            const adjustmentKg = wVal * xValue * 0.0355 * adjVal;
            totalAdjustmentKg += adjustmentKg;
          }
        }
      }
    });
    
    // kgì„ tonìœ¼ë¡œ ë³€í™˜ (1 ton = 1000 kg)
    const totalTon = (totalKg / 1000).toFixed(1);
    const totalAdjustmentTon = (totalAdjustmentKg / 1000).toFixed(1);
    const totalQuantityTon = (totalQuantityKg / 1000).toFixed(1);
    
    document.getElementById("totalKg").textContent = `ì´: ${totalTon}t`;
    document.getElementById("totalQuantity").textContent = `ì´: ${totalQuantityTon}t`;
    document.getElementById("totalAdjustment").textContent = `ì´: ${totalAdjustmentTon}t`;
  }

  // ì „ì—­ ë³€ìˆ˜ë¡œ ì›ë³¸ ë°ì´í„° ì €ì¥ (sessionStorage ëŒ€ì‹ )
  let originalParsedData = null;
  let originalSelectedMode = null;
  let isNewOrderFlag = false;
  let originalFileName = null;

  //===================================================
  // Unconvert (ì›ë³¸ ë³µì›)
  //===================================================
  document.getElementById("unconvertButton").addEventListener("click", ()=>{
    // ì „ì—­ ë³€ìˆ˜ì—ì„œ ì›ë³¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    if(!originalParsedData){
      return;
    }

    const exportData = originalParsedData;

    // exportDataì—ì„œ orderData ì¶”ì¶œ
    let arr = [];
    if (exportData.orderData && Array.isArray(exportData.orderData)) {
      arr = exportData.orderData;
    } else if (Array.isArray(exportData)) {
      // ê¸°ì¡´ í˜•ì‹ í˜¸í™˜ì„± ìœ ì§€
      arr = exportData;
    } else {
      return;
    }


    // ë³€í™˜í–‰ ì œê±°
    const convs = document.querySelectorAll("#orderTableBody tr.converted");
    convs.forEach(r=>r.remove());

    // ì›ë³¸í–‰ë“¤ì„ ì „ì—­ ë³€ìˆ˜ì˜ ì›ë³¸ ë°ì´í„°ë¡œ ë³µì›
    const baseRows = document.querySelectorAll("#orderTableBody tr:not(.converted)");
    baseRows.forEach((row, index) => {
      if(arr[index]) {
        const item = arr[index];
        row.querySelector(".phdSelect").value = item.phd || "";
        row.querySelector(".widthInput").value = item.width || "";
        row.querySelector(".lengthInput").value = item.length || "";
        row.querySelector(".kgInput").value = item.kg || ""; // kg í•„ë“œ ì‚¬ìš©
        row.querySelector(".adjustmentInput").value = ""; // 1ì•ˆ ì´ˆê¸°í™”
        row.querySelector(".remainderInput").value = ""; // remainder ì´ˆê¸°í™”
        
        // Xì™€ ReelQ ì¬ê³„ì‚° (í€€í„°í‹° ê°’ì€ ì›ë³¸ ê·¸ëŒ€ë¡œ ìœ ì§€)
        const phdVal = row.querySelector(".phdSelect").value;
        const wVal = parseFloat(row.querySelector(".widthInput").value) || 0;
        const lVal = parseFloat(row.querySelector(".lengthInput").value) || 0;
        const xOut = row.querySelector(".xOutput");
        
        // Xë§Œ ì¬ê³„ì‚°í•˜ê³  QuantityëŠ” ì›ë³¸ ê°’ ìœ ì§€
        if (phdVal && lVal > 0) {
          const base = phdMapping[phdVal];
          if (base) {
            const xValue = lVal / base;
            xOut.value = Math.round(xValue) + "x";
          }
        }
        
        // QuantityëŠ” ì›ë³¸ ë°ì´í„°ì—ì„œ ê°€ì ¸ì˜¨ ê°’ ê·¸ëŒ€ë¡œ ìœ ì§€ (ì¬ê³„ì‚°í•˜ì§€ ì•ŠìŒ)
        // row.querySelector(".quantityOutput").valueëŠ” ì›ë³¸ ë°ì´í„°ì˜ kg ê°’ì´ ì´ë¯¸ ì„¤ì •ë¨
      }
    });
    
    
    // ì¶”ê°€ë¡œ ëª¨ë“  í–‰ì˜ 1ì•ˆ, ë‚˜ë¨¸ì§€ë¥¼ í•œ ë²ˆ ë” ì´ˆê¸°í™”
    const allRowsAfterRestore = document.querySelectorAll("#orderTableBody tr");
    allRowsAfterRestore.forEach(row => {
      row.querySelector(".adjustmentInput").value = "";
      row.querySelector(".remainderInput").value = "";
    });
    
    // Unconvert ì™„ë£Œ í›„ ì´ëŸ‰ ì—…ë°ì´íŠ¸
    updateTotals();
  });


  // ===================================================
  // Update ë²„íŠ¼ í´ë¦­ ì‹œ ìƒˆ ì£¼ë¬¸ ì‹œì‘
  // ===================================================
  function startNewOrder() {
    
    // í˜„ì¬ í…Œì´ë¸” ë°ì´í„° ì´ˆê¸°í™”
    const tbody = document.getElementById("orderTableBody");
    tbody.innerHTML = ''; // ê¸°ì¡´ í–‰ë“¤ ëª¨ë‘ ì œê±°
    
    // Order IDì™€ Date í•„ë“œ ì´ˆê¸°í™”
    const orderIdInput = document.getElementById('orderIdInput');
    const orderDateInput = document.getElementById('orderDateInput');
    const warehouseInput = document.getElementById('warehouseInput');
    if (orderIdInput) orderIdInput.value = '';
    if (orderDateInput) orderDateInput.value = '';
    if (warehouseInput) warehouseInput.value = '';
    
    
    
    // ì´í•© ì´ˆê¸°í™”
    updateTotals();
    
    // ìƒˆ ì£¼ë¬¸ í”Œë˜ê·¸ ì„¤ì •
    isNewOrderFlag = true;
    originalFileName = null; // originalFileName ì´ˆê¸°í™”
    
    location.href = 'orderupdate.html';
  }




  // ===================================================
  // S ë²„íŠ¼ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ ë° í•¨ìˆ˜
  // ===================================================
  let selectedRows = new Set(); // ì„ íƒëœ í–‰ë“¤ì„ ì¶”ì í•˜ëŠ” Set

  function handleSButtonClick(button, row) {
    const isSelected = button.classList.contains('selected');
    
    if (isSelected) {
      button.classList.remove('selected');
      selectedRows.delete(row);
    } else {
      button.classList.add('selected');
      selectedRows.add(row);
    }
    
    // ê°•ì œë¡œ ìŠ¤íƒ€ì¼ ì ìš©
    if (button.classList.contains('selected')) {
      button.style.backgroundColor = '#007bff';
      button.style.color = 'white';
      button.style.borderColor = '#007bff';
    } else {
      button.style.backgroundColor = '#fff';
      button.style.color = '#000';
      button.style.borderColor = '#ccc';
    }
    
    updateTotals();
  }

  // ===================================================
  // DOMContentLoaded: isNewOrder í”Œë˜ê·¸ì— ë”°ë¼ ì´ˆê¸°í™” ê²°ì •
  // ===================================================
  window.addEventListener('DOMContentLoaded', ()=>{
    // orderupdate.htmlì—ì„œ sessionStorageë¡œ ì „ë‹¬ëœ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ë³µì‚¬
    // (orderupdate.htmlì€ ì—¬ì „íˆ sessionStorageë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ í˜¸í™˜ì„± ìœ ì§€)
    try {
      const savedData = sessionStorage.getItem('parsedData');
      const savedMode = sessionStorage.getItem('selectedMode');
      const savedIsNewOrder = sessionStorage.getItem('isNewOrder');
      
      if (savedData) {
        originalParsedData = JSON.parse(savedData);
      }
      if (savedMode) {
        originalSelectedMode = savedMode;
      }
      if (savedIsNewOrder === 'true') {
        isNewOrderFlag = true;
      }
    } catch (e) {
      // sessionStorage ì½ê¸° ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
    }
    
    // isNewOrder í”Œë˜ê·¸ í™•ì¸
    const tbody = document.getElementById("orderTableBody");
    
    if (isNewOrderFlag) {
      // ìƒˆ ì£¼ë¬¸ ì‹œì‘: ë¹ˆ í…Œì´ë¸”ë¡œ ì‹œì‘
      tbody.innerHTML = ''; // ê¸°ì¡´ í–‰ë“¤ ëª¨ë‘ ì œê±°
      isNewOrderFlag = false; // í”Œë˜ê·¸ ì œê±°
      originalFileName = null; // originalFileName ì´ˆê¸°í™”
      
      // Order IDì™€ Date í•„ë“œ ì´ˆê¸°í™”
      const orderIdInput = document.getElementById('orderIdInput');
      const orderDateInput = document.getElementById('orderDateInput');
      const warehouseInput = document.getElementById('warehouseInput');
      if (orderIdInput) orderIdInput.value = '';
      if (orderDateInput) orderDateInput.value = '';
      if (warehouseInput) warehouseInput.value = '';
      
      
    } else {
      // ê¸°ì¡´ ì‘ì—… ê³„ì†: orderupdate.htmlì—ì„œ Exportí•œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
      
      // ì „ì—­ ë³€ìˆ˜ì—ì„œ Exportëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
      if (originalParsedData && originalSelectedMode) {
        
        try {
          const exportData = originalParsedData;
          const savedMode = originalSelectedMode;
          
          // Order IDì™€ Date ì„¤ì •
          if (exportData.orderId) {
            const orderIdInput = document.getElementById('orderIdInput');
            if (orderIdInput) orderIdInput.value = exportData.orderId;
          }
          if (exportData.orderDate) {
            const orderDateInput = document.getElementById('orderDateInput');
            if (orderDateInput) orderDateInput.value = exportData.orderDate;
          }
          if (exportData.expectedDate) {
            const warehouseInput = document.getElementById('warehouseInput');
            if (warehouseInput) warehouseInput.value = exportData.expectedDate;
          }
          
          // ëª¨ë“œ ì„¤ì • (Exportëœ ëª¨ë“œì— ë”°ë¼ ë²„íŠ¼ í™œì„±í™”)
          if (savedMode) {
            const ntBtn = document.getElementById('ntBtn');
            const smbBtn = document.getElementById('smbBtn');
            const smcBtn = document.getElementById('smcBtn');
            
            // ëª¨ë“  ëª¨ë“œ ë²„íŠ¼ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
            if (ntBtn) ntBtn.classList.remove('selected');
            if (smbBtn) smbBtn.classList.remove('selected');
            if (smcBtn) smcBtn.classList.remove('selected');
            
            // í•´ë‹¹ ëª¨ë“œ ë²„íŠ¼ì— selected í´ë˜ìŠ¤ ì¶”ê°€
            if (savedMode === 'NT' && ntBtn) {
              ntBtn.classList.add('selected');
              selectedMode = 'NT';
            } else if (savedMode === 'SM-B' && smbBtn) {
              smbBtn.classList.add('selected');
              selectedMode = 'SM-B';
            } else if (savedMode === 'SM-C' && smcBtn) {
              smcBtn.classList.add('selected');
              selectedMode = 'SM-C';
            }
            
          }
          
          // í…Œì´ë¸”ì— ë°ì´í„° ì¶”ê°€
          if (exportData.orderData && Array.isArray(exportData.orderData)) {
            
            exportData.orderData.forEach((item, index) => {
              const row = createBaseRow();
              
              // input ìš”ì†Œë“¤ì„ ì°¾ì•„ì„œ ê°’ ì„¤ì •
              const phdSelect = row.querySelector('.phdSelect');
              const widthInput = row.querySelector('.widthInput');
              const lengthInput = row.querySelector('.lengthInput');
              const xOutput = row.querySelector('.xOutput');
              const kgInput = row.querySelector('.kgInput');
              const quantityOutput = row.querySelector('.quantityOutput');
              
              // ë°ì´í„° ì±„ìš°ê¸°
              if (phdSelect) phdSelect.value = item.phd || '';
              if (widthInput) widthInput.value = item.width || '';
              if (lengthInput) lengthInput.value = item.length || '';
              if (kgInput) kgInput.value = item.kg || ''; // KGì— kg ê°’
              
              attachRowEvents(row, true); // isLoading = trueë¡œ ì„¤ì •í•˜ì—¬ ìë™ convert ë°©ì§€
              tbody.appendChild(row);
            });
            
            
            // Export ë°ì´í„° ë¡œë“œ ì™„ë£Œ í›„ ëª¨ë“  í–‰ì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë‹¤ì‹œ ë“±ë¡í•˜ì—¬ ìë™ ê³„ì‚° í™œì„±í™”
            const allRows = document.querySelectorAll("#orderTableBody tr");
            allRows.forEach(row => {
              attachRowEvents(row, false); // isLoading = falseë¡œ ì„¤ì •í•˜ì—¬ ìë™ ê³„ì‚° í™œì„±í™”
              // ê°•ì œë¡œ Xì™€ Quantity ê³„ì‚° ì‹¤í–‰
              recalcRow(row);
            });
          }
          
        } catch (error) {
        }
      } else {
      }
    }
    
    // ë¦¬í”„ë ˆì‹œì¸ì§€ í™•ì¸ (ë’¤ë¡œê°€ê¸°ê°€ ì•„ë‹Œ ê²½ìš°)
    const isRefresh = !window.performance.navigation || window.performance.navigation.type === 1;
    
    if (isRefresh) {
      // ë¦¬í”„ë ˆì‹œ ì‹œì—ëŠ” ì €ì¥ëœ ë°ì´í„° ì œê±°í•˜ê³  ë¹ˆ í…Œì´ë¸”ë¡œ ì´ˆê¸°í™”
      originalParsedData = null;
      originalSelectedMode = null;
      isNewOrderFlag = false;
      originalFileName = null;
      
      // í…Œì´ë¸” ì´ˆê¸°í™”
      const tbody = document.getElementById("orderTableBody");
      tbody.innerHTML = '';
      
      // Order IDì™€ Date í•„ë“œ ì´ˆê¸°í™”
      const orderIdInput = document.getElementById('orderIdInput');
      const orderDateInput = document.getElementById('orderDateInput');
      const warehouseInput = document.getElementById('warehouseInput');
      if (orderIdInput) orderIdInput.value = '';
      if (orderDateInput) orderDateInput.value = '';
      if (warehouseInput) warehouseInput.value = '';
      
      
      // ì´ëŸ‰ ì´ˆê¸°í™”
      updateTotals();
    }
    
    // ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡
    const openBtn = document.getElementById("openServerBtn");
    
    if (openBtn) {
      openBtn.addEventListener("click", () => {
        const modal = document.getElementById("serverFileModal");
        const modeFilter = document.getElementById("modeFilter");
        if (modal) {
          modal.style.display = "block";
          // ë“œë¡­ë‹¤ìš´ ê¸°ë³¸ê°’ì„ 'all'ë¡œ ì„¤ì •
          if (modeFilter) {
            modeFilter.value = 'all';
          }
          loadServerFileList();
        } else {
        }
      });
    } else {
    }
    
    // ì„œë²„ íŒŒì¼ ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ ë“±ë¡
    const closeServerBtn = document.querySelector(".close-server");
    if (closeServerBtn) {
      closeServerBtn.addEventListener("click", () => {
        document.getElementById("serverFileModal").style.display = "none";
      });
    }

    // ëª¨ë“œ í•„í„° ë³€ê²½ ì´ë²¤íŠ¸ ë“±ë¡
    const modeFilter = document.getElementById("modeFilter");
    if (modeFilter) {
      modeFilter.addEventListener("change", () => {
        loadServerFileList();
      });
    }
    
    // ì„œë²„ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.addEventListener("click", (event) => {
      const modal = document.getElementById("serverFileModal");
      if (event.target === modal) {
        modal.style.display = "none";
      }
    });
    
    // í–‰ ë²ˆí˜¸ ì´ˆê¸° ì—…ë°ì´íŠ¸
    setTimeout(() => {
      updateRowNumbers();
    }, 100);
    
    // ê¸°ì¡´ í–‰ë“¤ì— S ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    const existingRows = tbody.querySelectorAll('tr');
    existingRows.forEach(row => {
      const sButton = row.querySelector('.s-button');
      if (sButton) {
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        sButton.replaceWith(sButton.cloneNode(true));
        // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        const newSButton = row.querySelector('.s-button');
        newSButton.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          handleSButtonClick(newSButton, row);
        });
      }
    });
    
    // + ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    const addRowButton = document.getElementById("addRowButton");
    if (addRowButton) {
      addRowButton.addEventListener("click", function() {
        const newRow = createBaseRow();
        if (newRow) {
          const tbody = document.getElementById("orderTableBody");
          tbody.appendChild(newRow);
          attachRowEvents(newRow);
          updateTotals();
          // í–‰ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ (ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ DOMì´ ì™„ì „íˆ ì—…ë°ì´íŠ¸ëœ í›„ ì‹¤í–‰)
          setTimeout(() => {
            updateRowNumbers();
          }, 50);
        }
      });
    }
    
  });


  //===================================================
  // í™•ì¥/ì¶•ì†Œ ë²„íŠ¼ ê¸°ëŠ¥
  //===================================================
  document.getElementById("expandButton").addEventListener("click", () => {
    const detailArea = document.getElementById("detailButtonArea");
    const expandBtn = document.getElementById("expandButton");
    
    if (detailArea.style.display === "none") {
      // í™•ì¥
      detailArea.style.display = "block";
      expandBtn.classList.add("expanded");
      expandBtn.textContent = "â–²";
    } else {
      // ì¶•ì†Œ
      detailArea.style.display = "none";
      expandBtn.classList.remove("expanded");
      expandBtn.textContent = "â–¼";
    }
  });

  //===================================================
  // ê³µí†µ í•¨ìˆ˜: Order IDì™€ Date í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
  //===================================================
  function getOrderFields() {
    const orderIdInput = document.getElementById("orderIdInput");
    const orderDateInput = document.getElementById("orderDateInput");
    const warehouseInput = document.getElementById("warehouseInput");
    
    const orderId = orderIdInput ? orderIdInput.value.trim() : '';
    const orderDate = orderDateInput ? orderDateInput.value.trim() : '';
    const expectedDate = warehouseInput ? warehouseInput.value.trim() : '';
    
    return { orderId, orderDate, expectedDate };
  }

  //===================================================
  // Save ë²„íŠ¼ ê¸°ëŠ¥ - ë°”ë¡œ ì €ì¥
  //===================================================
  document.getElementById("saveBtn").addEventListener("click", async () => {
    
    // Order IDì™€ Date í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
    const { orderId, orderDate, expectedDate } = getOrderFields();
    
    if (!orderId || !orderDate) {
      alert("Order IDì™€ Dateë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    
    // í˜„ì¬ ì„ íƒëœ ëª¨ë“œ í™•ì¸
    const currentMode = document.querySelector('.mode-btn.selected')?.textContent || 'NT';
    
    // í…Œì´ë¸” ë°ì´í„° ìˆ˜ì§‘
    const allRows = document.querySelectorAll('#orderTableBody tr');
    const items = [];
    
    allRows.forEach((row, index) => {
      const phdVal = row.querySelector('.phdSelect')?.value;
      const widthVal = row.querySelector('.widthInput')?.value;
      const lengthVal = row.querySelector('.lengthInput')?.value;
      const xVal = row.querySelector('.xOutput')?.value;
      const kgVal = row.querySelector('.kgInput')?.value;
      const quantityVal = row.querySelector('.quantityOutput')?.value;
      const adjustmentVal = row.querySelector('.adjustmentInput')?.value;
      
      // ëª¨ë“  í–‰ì„ itemsì— ì¶”ê°€ (ë¹ˆ í–‰ì´ì–´ë„ í¬í•¨)
      items.push({
        rowNumber: index + 1,
        phd: phdVal || '',
        width: widthVal || '',
        length: lengthVal || '',
        x: xVal || '',
        kg: kgVal || '',
        quantity: quantityVal || '',
        adjustment: adjustmentVal || ''
      });
    });
    
    // ì„œë²„ì— ì €ì¥
    try {
      const response = await fetch('/api/saveOrder', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          mode: currentMode,
          orderId: orderId,
          orderDate: orderDate,
          expectedDate: expectedDate,
          items: items
        })
      });
      
      if (response.ok) {
        // ì €ì¥ëœ í•­ëª©ë“¤ì„ ì˜ˆì˜ê²Œ í‘œì‹œ
        let alertMessage = `âœ… ì €ì¥ ì™„ë£Œ!\n\n`;
        alertMessage += `â€¢ Mode: ${currentMode}\n`;
        alertMessage += `â€¢ Order ID: ${orderId}\n`;
        alertMessage += `â€¢ Date: ${orderDate}\n`;
        alertMessage += `â€¢ Expected Date: ${expectedDate}\n`;
        alertMessage += `â€¢ Items: ${items.length}ê°œ\n`;
        alertMessage += `  - PHD, Width, Length, X, KG, Quantity, Adjustment\n\n`;
        
        alert(alertMessage);
        
        // ì›ë³¸ íŒŒì¼ëª… ì €ì¥
        originalFileName = orderId;
      } else {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
    } catch (error) {
      alert(`âŒ ì„œë²„ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
    }
  });

  //===================================================
  // ì„œë²„ì—ì„œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥
  //===================================================
  
  // orderData.json êµ¬ì¡° ì²˜ë¦¬ ê³µí†µ í•¨ìˆ˜
  function normalizeOrderDataStructure(orderData) {
    if (orderData && orderData.files && Array.isArray(orderData.files)) {
      // {files: [...]} êµ¬ì¡°
      return orderData.files;
    } else if (Array.isArray(orderData)) {
      // ì§ì ‘ ë°°ì—´ êµ¬ì¡° [...]
      return orderData;
    }
    return [];
  }
  
  // ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ í´ë¦­ - DOMContentLoaded ë‚´ë¶€ë¡œ ì´ë™


  // ì„œë²„ íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadServerFileList() {
    const fileListDiv = document.getElementById("serverFileList");
    const modeFilter = document.getElementById("modeFilter");
    
    if (!fileListDiv) {
      return;
    }
    
    fileListDiv.innerHTML = "<p>ì„œë²„ì—ì„œ íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";
    
    try {
      // orderData.json íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
      const orderDataResponse = await fetch('/api/orders');
      
      let orderDataFiles = [];
      if (orderDataResponse.ok) {
        const orderData = await orderDataResponse.json();
        
        // ê³µí†µ í•¨ìˆ˜ë¡œ êµ¬ì¡° ì •ê·œí™”
        const files = normalizeOrderDataStructure(orderData);
        
        if (files.length > 0) {
          orderDataFiles = files.map(file => ({
            mode: file.mode,
            orderId: file.orderId,
            orderNo: file.orderNo,
            orderDate: file.orderDate,
            expectedDate: file.expectedDate,
            items: file.items || []
          }));
        }
      } else {
      }
      
      // orderData.json íŒŒì¼ë§Œ ì‚¬ìš©
      let fileList = [...orderDataFiles];
      
      // ë¹ˆ ê°ì²´ë‚˜ ì˜ëª»ëœ ë°ì´í„° í•„í„°ë§
      fileList = fileList.filter(file => {
        if (!file || typeof file !== 'object') return false;
        const orderId = file.orderId || '';
        const mode = file.mode || '';
        return orderId && orderId.trim() !== '' && mode && mode !== 'undefined';
      });
      
      
      // ëª¨ë“œ í•„í„° ì ìš© (ëª¨ë‹¬ì´ ì²˜ìŒ ì—´ë¦´ ë•ŒëŠ” ì „ì²´ í‘œì‹œ)
      const selectedMode = modeFilter && modeFilter.value ? modeFilter.value : 'all';
      if (selectedMode !== 'all') {
        fileList = fileList.filter(file => file.mode === selectedMode);
      }
      
      
      if (fileList.length === 0) {
        const modeText = selectedMode === 'all' ? '' : ` (${selectedMode} ëª¨ë“œ)`;
        fileListDiv.innerHTML = `<p>ì €ì¥ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤${modeText}.</p>`;
        return;
      }
      
      // Date ìˆœìœ¼ë¡œ ì •ë ¬ (ë” ì¼ì°í•œ ë‚ ì§œê°€ ì•„ë˜ë¡œ)
      fileList.sort((a, b) => {
        // orderDateê°€ ìˆëŠ” íŒŒì¼ë“¤ë§Œ ì •ë ¬, ì—†ëŠ” íŒŒì¼ë“¤ì€ ë§¨ ì•„ë˜ë¡œ
        const getDateForSorting = (file) => {
          if (file.orderDate) {
            // orderDate í˜•ì‹ì— ë”°ë¼ íŒŒì‹± (ì˜ˆ: "2025.02.13" â†’ "2025-02-13")
            const dateStr = file.orderDate.replace(/\./g, '-');
            return new Date(dateStr);
          }
          return null; // orderDateê°€ ì—†ìœ¼ë©´ null ë°˜í™˜
        };
        
        const dateA = getDateForSorting(a);
        const dateB = getDateForSorting(b);
        
        // orderDateê°€ ì—†ëŠ” íŒŒì¼ë“¤ì„ ë§¨ ì•„ë˜ë¡œ
        if (!dateA && !dateB) return 0; // ë‘˜ ë‹¤ orderDateê°€ ì—†ìœ¼ë©´ ìˆœì„œ ìœ ì§€
        if (!dateA) return 1; // aê°€ orderDateê°€ ì—†ìœ¼ë©´ ì•„ë˜ë¡œ
        if (!dateB) return -1; // bê°€ orderDateê°€ ì—†ìœ¼ë©´ ì•„ë˜ë¡œ
        
        // ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ë” ì¼ì°í•œ ë‚ ì§œê°€ ì•„ë˜ë¡œ)
        return dateA - dateB;
      });
      
      
      // íŒŒì¼ ëª©ë¡ì„ í…Œì´ë¸” í˜•íƒœë¡œ í‘œì‹œ (NT.htmlê³¼ ë™ì¼í•œ êµ¬ì¡°)
      let html = '<table id="serverFileTable" style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 14px;">';
      html += '<thead><tr>';
      html += '<th style="background-color: #f5f5f5; padding: 8px 4px; border: 1px solid #ddd; text-align: center; font-weight: bold; width: 25%;">OrderId</th>';
      html += '<th style="background-color: #f5f5f5; padding: 8px 4px; border: 1px solid #ddd; text-align: center; font-weight: bold; width: 25%;">OrderNo</th>';
      html += '<th style="background-color: #f5f5f5; padding: 8px 4px; border: 1px solid #ddd; text-align: center; font-weight: bold; width: 15%;">ëª¨ë“œ</th>';
      html += '<th style="background-color: #f5f5f5; padding: 8px 4px; border: 1px solid #ddd; text-align: center; font-weight: bold; width: 15%;">ë°ì´í„° ìˆ˜</th>';
      html += '<th style="background-color: #f5f5f5; padding: 8px 4px; border: 1px solid #ddd; text-align: center; font-weight: bold; width: 20%;">ì‘ì—…</th>';
      html += '</tr></thead><tbody>';
      
      fileList.forEach(file => {
        const orderNo = file.orderNo || 'ì—†ìŒ';
        const orderId = file.orderId || '';
        html += `<tr>`;
        html += `<td style="padding: 6px 4px; border: 1px solid #ddd; text-align: center; font-size: 13px;">${orderId}</td>`;
        html += `<td style="padding: 6px 4px; border: 1px solid #ddd; text-align: center; font-size: 13px;">${orderNo}</td>`;
        html += `<td style="padding: 6px 4px; border: 1px solid #ddd; text-align: center; font-size: 13px;">${file.mode}</td>`;
        html += `<td style="padding: 6px 4px; border: 1px solid #ddd; text-align: center; font-size: 13px;">${file.items ? file.items.length : 0}ê°œ</td>`;
        html += `<td style="padding: 6px 4px; border: 1px solid #ddd; text-align: center; font-size: 13px;">`;
        html += `<button class="top-menu-btn" onclick="loadServerFile('${orderId}')" style="padding: 3px 6px; margin: 0 2px; border: 1px solid #ccc; border-radius: 3px; background: #fff; cursor: pointer; font-size: 10px; min-width: 50px; height: 24px; line-height: 1.2;">Select</button>`;
        html += `<button class="top-menu-btn" onclick="deleteServerFile('${orderId}')" style="padding: 3px 6px; margin: 0 2px; border: 1px solid #ccc; border-radius: 3px; background: #fff; cursor: pointer; font-size: 10px; min-width: 50px; height: 24px; line-height: 1.2;">Delete</button>`;
        html += `</td></tr>`;
      });
      
      html += '</tbody></table>';
      fileListDiv.innerHTML = html;
      
    } catch (error) {
      fileListDiv.innerHTML = `<p style='color: red;'>ì„œë²„ì—ì„œ íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>ì—ëŸ¬: ${error.message}</p>`;
    }
  }

  // íŒŒì¼ ë°ì´í„°ë¥¼ í…Œì´ë¸”ì— ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
  function loadFileData(data) {
    
    // í˜„ì¬ í…Œì´ë¸” ì´ˆê¸°í™”
    const tbody = document.getElementById("orderTableBody");
    tbody.innerHTML = "";
    
    // ëª¨ë“œ ì„¤ì •
    if (data.mode) {
      if (data.mode === "NT") {
        document.getElementById("ntBtn").click();
      } else if (data.mode === "SM-B") {
        document.getElementById("smbBtn").click();
      } else if (data.mode === "SM-C") {
        document.getElementById("smcBtn").click();
      }
    }
    

    
    // orderId í•„ë“œ í™•ì¸ (ì—†ìœ¼ë©´ ê³µë€)
    const orderIdValue = data.orderId;
    if (orderIdValue) {
      const orderIdInput = document.getElementById('orderIdInput');
      if (orderIdInput) {
        orderIdInput.value = orderIdValue;
      } else {
      }
    }
    
    // orderDate í•„ë“œ í™•ì¸ (ì—†ìœ¼ë©´ ê³µë€)
    const orderDateValue = data.orderDate;
    if (orderDateValue) {
      const orderDateInput = document.getElementById('orderDateInput');
      if (orderDateInput) {
        orderDateInput.value = orderDateValue;
      } else {
      }
    }
    
    
    // expectedDate í•„ë“œ í™•ì¸ (ë¹ˆ ë¬¸ìì—´ì´ì–´ë„ ì„¤ì •)
    const expectedDateValue = data.expectedDate || '';
    
    const warehouseInput = document.getElementById('warehouseInput');
    if (warehouseInput) {
      warehouseInput.value = expectedDateValue;
    } else {
    }
    
    
    // ì›ë³¸ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ë³µì› (Unconvertìš©)
    if (data.originalData) {
      originalParsedData = {
        orderData: data.originalData,
        orderId: data.orderId || "",
        orderDate: data.orderDate || ""
      };
    } else {
    }
    
    
    // í˜„ì¬ ë°ì´í„°ë¡œ í…Œì´ë¸” ë³µì›
    if (data.items && data.items.length > 0) {
      data.items.forEach((rowData, index) => {
        const row = createBaseRow();
        
        // ë°ì´í„° ì„¤ì •
        if (rowData.phd !== undefined) row.querySelector(".phdSelect").value = rowData.phd;
        if (rowData.width !== undefined) row.querySelector(".widthInput").value = rowData.width;
        if (rowData.length !== undefined) row.querySelector(".lengthInput").value = rowData.length;
        if (rowData.kg !== undefined) row.querySelector(".kgInput").value = rowData.kg;
        if (rowData.x !== undefined) row.querySelector(".xOutput").value = rowData.x;
        if (rowData.quantity !== undefined) row.querySelector(".quantityOutput").value = rowData.quantity;
        if (rowData.adjustment !== undefined) row.querySelector(".adjustmentInput").value = rowData.adjustment;
        if (rowData.remainder !== undefined) row.querySelector(".remainderInput").value = rowData.remainder;
        
        
        attachRowEvents(row, true); // isLoading = trueë¡œ ì„¤ì •í•˜ì—¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¹„í™œì„±í™”
        // recalcRow(row); // ë¶ˆëŸ¬ì˜¬ ë•ŒëŠ” ì¬ê³„ì‚°í•˜ì§€ ì•ŠìŒ (ì €ì¥ëœ ì›ë³¸ ê°’ ìœ ì§€)
        tbody.appendChild(row);
      });
      
      
      // í–‰ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
      updateRowNumbers();
      
      // ì„œë²„ íŒŒì¼ ë¡œë“œ ì™„ë£Œ í›„ ëª¨ë“  í–‰ì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë‹¤ì‹œ ë“±ë¡í•˜ì—¬ ìë™ ê³„ì‚° í™œì„±í™”
      const allRows = document.querySelectorAll("#orderTableBody tr");
      allRows.forEach(row => {
        attachRowEvents(row, false); // isLoading = falseë¡œ ì„¤ì •í•˜ì—¬ ìë™ ê³„ì‚° í™œì„±í™”
      });
    }
    
    // ì´ëŸ‰ ì—…ë°ì´íŠ¸
    updateTotals();
    
  }

  // ì„œë²„ì—ì„œ íŠ¹ì • íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadServerFile(orderId) {
    try {
      
      // orderData.jsonì—ì„œ ì£¼ë¬¸ì„ ì°¾ëŠ” ê²½ìš°
      try {
        // orderData.json íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        const orderDataResponse = await fetch('/api/orders');
        if (orderDataResponse.ok) {
          const orderData = await orderDataResponse.json();
          
          // ê³µí†µ í•¨ìˆ˜ë¡œ êµ¬ì¡° ì •ê·œí™”
          const files = normalizeOrderDataStructure(orderData);
          const targetFile = files.find(file => file.orderId === orderId);
          
          if (targetFile) {
            // loadFileData í•¨ìˆ˜ ì‚¬ìš©
            loadFileData(targetFile);
            
            // ì›ë³¸ íŒŒì¼ëª… ì €ì¥ (ë®ì–´ì“°ê¸° ê¸°ëŠ¥ì„ ìœ„í•´)
            originalFileName = orderId;
            
            // ëª¨ë‹¬ ë‹«ê¸°
            document.getElementById("serverFileModal").style.display = "none";
            return;
          }
        }
      } catch (error) {
      }
      
      // ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° (fallback)
      const response = await fetch(`/api/orders?orderId=${orderId}`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      // loadFileData í•¨ìˆ˜ ì‚¬ìš©
      loadFileData(data);
      
      // ì›ë³¸ íŒŒì¼ëª… ì €ì¥ (ë®ì–´ì“°ê¸° ê¸°ëŠ¥ì„ ìœ„í•´)
      sessionStorage.setItem('originalFileName', orderId);
      
      // ëª¨ë‹¬ ë‹«ê¸°
      document.getElementById("serverFileModal").style.display = "none";
      
    } catch (error) {
      alert('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  //===================================================
  // ì„œë²„ì—ì„œ ì•„ì´í…œ ì‚­ì œ í•¨ìˆ˜
  //===================================================
  async function deleteItemFromServer(phd, width, length, adjustment, row) {
    try {
      // í˜„ì¬ í™”ë©´ì˜ Order ID ê°€ì ¸ì˜¤ê¸°
      const currentOrderId = document.getElementById('orderIdInput').value;
      
      console.log('í˜„ì¬ ì£¼ë¬¸ ID:', currentOrderId);
      console.log('ì‚­ì œí•  ì•„ì´í…œ:', { phd, width, length, adjustment });
      
      if (!currentOrderId) {
        alert('í˜„ì¬ ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ì„œë²„ì— ì‚­ì œ ìš”ì²­
      const response = await fetch('/api/deleteItem', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          orderId: currentOrderId,
          phd: phd,
          width: width,
          length: length,
          adjustment: adjustment
        })
      });
      
      console.log('ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
      
      const responseData = await response.json();
      console.log('ì„œë²„ ì‘ë‹µ ë°ì´í„°:', responseData);
      
      if (response.ok && responseData.success) {
        console.log('ì•„ì´í…œì´ ì„œë²„ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        // ì„œë²„ ì‚­ì œ ì„±ê³µ ì‹œì—ë§Œ í™”ë©´ì—ì„œ í–‰ ì œê±°
        if (row) {
          row.remove();
          
          // í™”ë©´ í–‰ë²ˆí˜¸ ì—…ë°ì´íŠ¸
          updateRowNumbers();
          
          // í™”ë©´ ì´ë¬´ê²Œ ì—…ë°ì´íŠ¸
          updateTotals();
        }
        
        // ì‚­ì œ í›„ rowNumber ë™ê¸°í™”
        await syncRowNumbersWithServer();
        
        // ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì‘ì—… ì¤‘ì¸ ë‚´ìš© ìœ ì§€
      } else {
        console.error('ì•„ì´í…œ ì‚­ì œ ì‹¤íŒ¨:', responseData);
        alert('ì•„ì´í…œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (responseData.message || 'ì„œë²„ì—ì„œ ì•„ì´í…œì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
        // ì‚­ì œ ì‹¤íŒ¨ ì‹œ í–‰ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
      }
    } catch (error) {
      console.error('ì•„ì´í…œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
      alert('ì•„ì´í…œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      // ì˜¤ë¥˜ ë°œìƒ ì‹œ í–‰ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
    }
  }

  //===================================================
  // ì„œë²„ì˜ rowNumberë¥¼ í™”ë©´ ë²ˆí˜¸ì™€ ë™ê¸°í™”
  //===================================================
  async function syncRowNumbersWithServer() {
    try {
      const currentOrderId = document.getElementById('orderIdInput').value;
      
      if (!currentOrderId) {
        console.log('í˜„ì¬ ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // í™”ë©´ì˜ í–‰ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì½ì–´ì„œ rowNumber ë§¤í•‘ ë°ì´í„° ìƒì„±
      const rows = document.querySelectorAll("#orderTableBody tr");
      const rowData = [];
      
      rows.forEach((row, index) => {
        const phd = row.querySelector('.phdSelect').value;
        const width = row.querySelector('.widthInput').value;
        const length = row.querySelector('.lengthInput').value;
        
        rowData.push({
          phd: phd,
          width: width,
          length: length,
          newRowNumber: index + 1  // í™”ë©´ ë²ˆí˜¸ (1, 2, 3...)
        });
      });
      
      console.log('rowNumber ë™ê¸°í™” ë°ì´í„°:', rowData);
      
      // ì„œë²„ì— rowNumber ë™ê¸°í™” ìš”ì²­
      const response = await fetch('/api/syncRowNumbers', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          orderId: currentOrderId,
          rowData: rowData
        })
      });
      
      const responseData = await response.json();
      
      if (response.ok && responseData.success) {
        console.log('rowNumber ë™ê¸°í™” ì™„ë£Œ');
      } else {
        console.error('rowNumber ë™ê¸°í™” ì‹¤íŒ¨:', responseData);
      }
    } catch (error) {
      console.error('rowNumber ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
    }
  }




  //===================================================
  // íŒŒì¼ ì‚­ì œ ê¸°ëŠ¥
  //===================================================
  
  // ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ë‹«ê¸°
  document.querySelector(".close-delete").addEventListener("click", () => {
    document.getElementById("deleteConfirmModal").style.display = "none";
  });

  // ì‚­ì œ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
  window.addEventListener("click", (event) => {
    const modal = document.getElementById("deleteConfirmModal");
    if (event.target === modal) {
      modal.style.display = "none";
    }
  });

  // ì‚­ì œ ì·¨ì†Œ ë²„íŠ¼
  document.getElementById("cancelDeleteBtn").addEventListener("click", () => {
    document.getElementById("deleteConfirmModal").style.display = "none";
  });

  // ì„œë²„ì—ì„œ íŒŒì¼ ì‚­ì œí•˜ê¸°
  async function deleteServerFile(orderId) {
    try {
      let fileData = null;
      
      // orderData.jsonì—ì„œ ì£¼ë¬¸ ì •ë³´ ì°¾ê¸°
      try {
        const orderDataResponse = await fetch('/api/orders');
        if (orderDataResponse.ok) {
          const orderData = await orderDataResponse.json();
          const files = normalizeOrderDataStructure(orderData);
          const targetFile = files.find(file => file.orderId === orderId);
          if (targetFile) {
            fileData = targetFile;
          }
        }
      } catch (error) {
      }
      
      // orderData.jsonì—ì„œ ì°¾ì§€ ëª»í•œ ê²½ìš° ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ì‹œë„
      if (!fileData) {
        const response = await fetch(`/api/orders?orderId=${orderId}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        fileData = await response.json();
      }
      
      // ì‚­ì œ í™•ì¸ ëª¨ë‹¬ì— íŒŒì¼ ì •ë³´ í‘œì‹œ
      document.getElementById('deleteFileName').textContent = orderId;
      const deleteFileInfo = document.getElementById('deleteFileInfo');
      deleteFileInfo.innerHTML = `
        <div><strong>ëª¨ë“œ:</strong> ${fileData.mode || 'N/A'}</div>
        <div><strong>Order ID:</strong> ${fileData.orderId || 'N/A'}</div>
        <div><strong>Order Date:</strong> ${fileData.orderDate || 'N/A'}</div>
        <div><strong>ë°ì´í„° í–‰ ìˆ˜:</strong> ${fileData.items ? fileData.items.length : 0}ê°œ</div>
      `;
      
      // ëª¨ë‹¬ ì—´ê¸°
      document.getElementById("deleteConfirmModal").style.display = "block";
      
      // ì‚­ì œ í™•ì¸ ë²„íŠ¼ì— orderId ì €ì¥
      document.getElementById("confirmDeleteBtn").setAttribute('data-orderId', orderId);
      
    } catch (error) {
      alert('íŒŒì¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ì‚­ì œ í™•ì¸ ë²„íŠ¼
  document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
    const orderId = document.getElementById("confirmDeleteBtn").getAttribute('data-orderId');
    
    if (!orderId) {
      alert('ì‚­ì œí•  ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    try {
      
      const response = await fetch(`/api/orders?orderId=${orderId}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      
      // ëª¨ë‹¬ ë‹«ê¸°
      document.getElementById("deleteConfirmModal").style.display = "none";
      
      // íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      loadServerFileList();
      
      alert(`ì£¼ë¬¸ "${orderId}"ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
      
    } catch (error) {
      alert('ì£¼ë¬¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  });

</script>
</body>
</html>



