<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Swift</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      color: #000;
      line-height: 1.5;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      margin: 0;
      padding: 0;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: -1;
    }
    /* ë©”ì¸ í˜ì´ì§€ ì»¨í…Œì´ë„ˆ */
    .page-container {
      max-width: 800px;
      margin: 15px auto;
      padding: 0;
    }
    
    .page {
      width: 210mm; /* A4 ë„ˆë¹„ */
      height: 297mm; /* A4 ë†’ì´ ê³ ì • */
      margin: 0 auto 20px auto;
      padding: 10mm 25mm 25mm 25mm; /* ìƒë‹¨ë§Œ 10mmë¡œ ì¤„ì„ */
      box-sizing: border-box;
      background: #fff;
      position: relative;
      overflow: visible; /* ë„˜ì¹˜ëŠ” ë‚´ìš© í‘œì‹œ */
    }
    
    /* ë‘ ë²ˆì§¸ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
    #page2 {
      border: 1px solid #ddd;
      margin-top: 20px;
    }
    
    /* í˜ì´ì§€ ë¶„í•  ê´€ë ¨ í´ë˜ìŠ¤ */
    .visible {
      display: block;
      visibility: visible;
      opacity: 1;
    }
    
    .hidden {
      display: none;
      visibility: hidden;
      opacity: 0;
    }
    .header, .footer {
      text-align: center;
    }
    .header p, .footer p {
      margin: 2px 0;
    }
    .logo {
      display: block;
      width: 100%;
      height: auto;
      margin-bottom: 10px;
    }
    .order-details {
      margin-top: 20px;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      border-bottom: 2px solid #000;
      padding-bottom: 10px;
      margin-bottom: 10px;
      font-weight: bold;
      font-size: 1.1rem;
    }
    /* ì™¼ìª½/ì˜¤ë¥¸ìª½ ì˜ì—­ì— input ì‚¬ìš© */
    .order-header .left, .order-header .right {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .order-header .left input,
    .order-header .right input {
      font-size: 1rem;
      width: 140px;
      padding: 4px 4px;
      height: 24px;
    }
    .order-body {
      margin-top: 20px;
    }
    .order-body table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    /* í…Œì´ë¸” í—¤ë” ì…€ ìŠ¤íƒ€ì¼ */
    .order-body table thead th {
      border: 1px solid #000;
      background-color: #f0f0f0;
      padding: 5px;
      text-align: center;
      font-size: 0.95rem;
      line-height: 1.5;
      height: 30px;
      min-height: 30px;
      max-height: 30px;
      box-sizing: border-box;
      word-wrap: break-word;
      white-space: normal;
    }
    
    /* í…Œì´ë¸” ì—´ ë„ˆë¹„ í´ë˜ìŠ¤ */
    .col-ekno { width: 38px; min-width: 38px; max-width: 38px; }
    .col-empty { width: 15px; min-width: 15px; max-width: 15px; }
    .col-invoice { width: 38px; min-width: 38px; max-width: 38px; }
    .col-billing { width: 32px; min-width: 32px; max-width: 32px; }
    .col-due { width: 32px; min-width: 32px; max-width: 32px; }
    .col-euro { width: 30px; min-width: 30px; max-width: 30px; }
    .col-dollar { width: 30px; min-width: 30px; max-width: 30px; }
    
    /* Exchange Rate ìŠ¤íƒ€ì¼ */
    .exchange-rate-container {
      text-align: right;
      margin-top: 10px;
    }
    
    .exchange-rate-label {
      font-weight: bold;
      margin-right: 10px;
    }
    
    .exchange-rate-input {
      width: 100px;
      height: 33px;
      text-align: center;
      border: 1px solid #ccc;
      padding: 2px;
      box-sizing: border-box;
    }
    /* í…Œì´ë¸” ë³¸ë¬¸ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    .order-body table tbody tr:not(.total-row) {
      height: 30px;
      min-height: 30px;
      max-height: 30px;
    }
    
    .order-body table tbody td:not(.total-row td) {
      padding: 5px;
      line-height: 1.5;
      vertical-align: middle;
      font-size: 0.9rem;
      border: 1px solid #000;
      text-align: center;
      height: 30px;
      min-height: 30px;
      max-height: 30px;
      box-sizing: border-box;
    }
    
    /* ì¹´í…Œê³ ë¦¬ í–‰ ê°•ì œ ë†’ì´ ì„¤ì • (í—¤ë”ì™€ ë™ì¼) */
    .category1-row {
      height: 33px;
      min-height: 33px;
      max-height: 33px;
    }
    
    .category2-row {
      height: auto;
      min-height: 33px;
      max-height: none;
    }
    
    .category1-row td {
      height: 33px ;
      min-height: 33px ;
      max-height: 33px ;
      padding: 5px ;
      line-height: 1.5 ;
      vertical-align: middle ;
      border: 1px solid #000 ;
      text-align: center ;
      font-size: 0.9rem ;
      box-sizing: border-box ;
    }
    
    .category2-row td {
      height: auto ;
      min-height: 33px ;
      max-height: none ;
      padding: 5px ;
      line-height: 1.5 ;
      vertical-align: middle ;
      border: 1px solid #000 ;
      text-align: center ;
      font-size: 0.9rem ;
      box-sizing: border-box ;
    }
    
    .category1-row input, .category1-row select {
      height: 23px ;
      line-height: 1.5 ;
      padding: 0 ;
      margin: 0 ;
      border: none ;
      background: transparent ;
      font-size: inherit ;
      width: 100% ;
      text-align: center ;
      text-align-last: center ;
      -webkit-text-align-last: center ;
      -moz-text-align-last: center ;
      box-sizing: border-box ;
    }
    
    .category2-row input, .category2-row select {
      height: auto ;
      min-height: 23px ;
      max-height: none ;
      line-height: 1.5 ;
      padding: 0 ;
      margin: 0 ;
      border: none ;
      background: transparent ;
      font-size: inherit ;
      width: 100% ;
      text-align: center ;
      text-align-last: center ;
      -webkit-text-align-last: center ;
      -moz-text-align-last: center ;
      box-sizing: border-box ;
    }
    
    /* Over Payment íŠ¹ë³„ ìŠ¤íƒ€ì¼ */
    .category2-row td[colspan="2"] {
      height: auto ;
      min-height: 60px ;
      max-height: none ;
      vertical-align: top ;
    }
    
    .category2-row td[colspan="2"] input {
      height: auto ;
      min-height: 50px ;
      max-height: none ;
      white-space: pre-line ;
      line-height: 1.2 ;
      font-size: 0.7rem ;
    }

    /* Total í–‰ ìŠ¤íƒ€ì¼ */
    .total-row {
      height: 33px ;
      min-height: 33px ;
      max-height: 33px ;
    }

    .total-row td {
      height: 33px ;
      min-height: 33px ;
      max-height: 33px ;
      padding: 5px ;
      line-height: 1.5 ;
      vertical-align: middle ;
      border: 1px solid #000 ;
      text-align: center ;
      font-size: 0.9rem ;
      box-sizing: border-box ;
    }

    .total-row input {
      height: 23px ;
      line-height: 1.5 ;
      padding: 0 ;
      margin: 0 ;
      border: none ;
      background: transparent ;
      text-align: center ;
      font-weight: bold ;
      font-size: inherit ;
      color: inherit ;
      outline: none ;
      box-sizing: border-box ;
    }

    /* Save2 ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .save2-selected {
      background: #000 !important;
      color: #fff !important;
      border-color: #000 !important;
    }
    
    /* ë” ê°•ë ¥í•œ ì„ íƒì */
    button#save2Btn.save2-selected {
      background: #000 !important;
      color: #fff !important;
      border-color: #000 !important;
    }
    /* í•˜ë‹¨ ì •ë³´ ìŠ¤íƒ€ì¼ */
    .notes, .remarks {
      font-size: 0.95rem;
      margin-top: 5px;
      margin-bottom: 0;
    }
    .notes p {
      margin: 0;
      line-height: 1.2;
    }
    .remarks ul {
      list-style-type: disc;
      margin: 0 0 0 20px;
      padding-left: 0;
      line-height: 1.2;
    }
    .remarks ul ul {
      margin-left: 20px;
      margin-top: 0;
      margin-bottom: 0;
    }
    .apply-btn {
      display: inline-block;
      margin-top: 10px;
      padding: 6px 12px;
      font-size: 0.95rem;
      cursor: pointer;
      border: 1px solid #444;
      background: #f7f7f7;
    }

    /* í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ ì „ì²´ */
    .bottom-buttons {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      padding: 15px;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    /* í™•ì¥ ì†ì¡ì´ (ì„œë ì†ì¡ì´ì²˜ëŸ¼ ìœ„ìª½ì— íŠ€ì–´ë‚˜ì˜´) */
    .expand-handle {
      position: absolute;
      top: -15px;
      left: 20px;
      z-index: 10;
    }

    /* í™•ì¥/ì¶•ì†Œ ë²„íŠ¼ */
    .expand-btn {
      font-size: 0.8rem;
      padding: 4px 12px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #f8f8f8;
      color: #666;
      border-radius: 8px 8px 0 0;
      min-width: 40px;
      height: 20px;
      line-height: 1;
      transition: all 0.2s ease;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
    }

    .expand-btn:hover {
      background: #e8e8e8;
      border-color: #999;
      box-shadow: 0 -3px 6px rgba(0,0,0,0.15);
    }

    .expand-btn.expanded {
      transform: rotate(180deg);
      background: #e0e0e0;
    }

    /* ê¸°ë³¸ ë²„íŠ¼ ê·¸ë£¹ ë ˆì´ì•„ì›ƒ */
    .main-button-group {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
    }
    
    .left-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .right-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .main-button-group button {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
      transition: all 0.2s ease;
    }
    
    .main-button-group button:hover {
      background: #f0f0f0;
    }

    /* ìƒì„¸ ë²„íŠ¼ ì˜ì—­ */
    .detail-button-area {
      margin-top: 10px;
      padding: 12px;
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      animation: slideDown 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .current-rows-info {
      width: 100%;
      max-width: 800px;
    }
    
    .current-rows-info h4 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 1rem;
    }
    
    .rows-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
      padding: 10px;
      margin-bottom: 10px;
    }
    
    .row-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }
    
    .row-item:last-child {
      border-bottom: none;
    }
    
    .row-info {
      flex: 1;
      font-size: 0.9rem;
    }
    
    .row-actions {
      display: flex;
      gap: 5px;
    }

    .row-actions button {
      padding: 2px 6px;
      font-size: 0.8rem;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
      border-radius: 3px;
    }
    
    .row-actions button:hover {
      background: #e0e0e0;
    }
    
    .rows-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    
    .action-btn {
      padding: 6px 12px;
      font-size: 0.9rem;
      border: 1px solid #666;
      background: #f7f7f7;
      cursor: pointer;
      border-radius: 4px;
    }
    
    .action-btn:hover {
      background: #e8e8e8;
    }
    

    .detail-button-area button {
      margin: 0;
    }


    /* PDF ë²„íŠ¼ - Email ë²„íŠ¼ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼ */
    #pdfBtn {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
      transition: all 0.2s ease;
    }

    #pdfBtn:hover {
      background: #f0f0f0;
      border-color: #999;
    }

    /* Open ë²„íŠ¼ ìŠ¤íƒ€ì¼ (Save ë²„íŠ¼ê³¼ ë™ì¼) */
    #openBtn {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
      transition: all 0.2s ease;
    }

    #openBtn:hover {
      background: #f0f0f0;
      border-color: #999;
    }

    /* í…Œì´ë¸” í•˜ë‹¨ ì—¬ë°± (ê³ ì • ë²„íŠ¼ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡) */
    .page {
      margin-bottom: 120px;
    }

    /* ëª¨ë‹¬ ì°½ ìŠ¤íƒ€ì¼ - order.htmlê³¼ ë™ì¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 0;
      border: 1px solid #888;
      width: 500px;
      max-height: 90vh;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 15px 20px;
      background-color: #f8f8f8;
      border-bottom: 1px solid #ddd;
      border-radius: 5px 5px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      color: #333;
    }

    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .close:hover {
      color: #000;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 15px 20px;
      background-color: #f8f8f8;
      border-top: 1px solid #ddd;
      border-radius: 0 0 5px 5px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* ëª¨ë‹¬ ë‚´ë¶€ ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
    .modal button:hover {
      background: #f0f0f0 ;
      border-color: #999 ;
    }

    /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    #swiftOrderTable {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 14px;
    }
    #swiftOrderTable th {
      background-color: #f5f5f5;
      padding: 8px 4px;
      border: 1px solid #ddd;
      text-align: center;
      font-weight: bold;
      width: 25%;
    }
    #swiftOrderTable th:nth-child(4) {
      width: 15%;
    }
    #swiftOrderTable th:nth-child(5) {
      width: 20%;
    }
    #swiftOrderTable td {
      padding: 6px 4px;
      border: 1px solid #ddd;
      text-align: center;
      font-size: 13px;
    }
    
    .top-menu-btn {
      padding: 3px 6px;
      margin: 0 2px;
      border: 1px solid #ccc;
      border-radius: 3px;
      background: #fff;
      cursor: pointer;
      font-size: 10px;
      min-width: 50px;
      height: 24px;
      line-height: 1.2;
    }
    .top-menu-btn:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body>
  <div id="pageContainer">
    <!-- ì²« ë²ˆì§¸ í˜ì´ì§€ -->
    <div class="page" id="page1">
      <!-- í—¤ë” -->
      <div class="header">
        <img src="images/NTorderlogo.png" alt="Order Logo" class="logo">
      <p>MESSRS : Treofan Germany GmbH &amp; CO. KG</p>
        <p>Ms. Nicole Hennes</p>
      </div>

      <!-- ì£¼ë¬¸ ìƒì„¸ ë‚´ìš© -->
      <div class="order-details">
        <div class="order-header">
          <div class="left">
            DATE :
            <input type="text" id="orderDateInput" autocomplete="off" />
          </div>
          <div class="right">
            Total Amount :
            <input type="text" id="totalAmountInput" autocomplete="off" />
          </div>
        </div>

        <!-- ì£¼ë¬¸ ë‚´ì—­ í…Œì´ë¸” -->
        <div class="order-body">
          <table>
            <thead>
              <tr>
                <th class="col-ekno">EK-NO</th>
                <th class="col-empty"></th>
                <th class="col-invoice">Invoice No</th>
                <th class="col-billing">Billing Date</th>
                <th class="col-due">Due Date</th>
                <th class="col-euro">â‚¬</th>
                <th class="col-dollar">$</th>
              </tr>
            </thead>
            <tbody id="orderTbody">
            </tbody>
          </table>
        </div>
        
        <!-- Exchange Rate í•„ë“œ -->
        <div class="exchange-rate-container">
          <label class="exchange-rate-label">Exchange Rate (â‚¬ : $):</label>
          <input type="text" id="exchangeRateInput" class="exchange-rate-input" placeholder="1.00" />
        </div>
    </div>
  </div>

  <script>
    // í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
    async function initializePage() {
      // Order Dateì™€ Total Amount ì´ˆê¸°í™”
      const orderDateInput = document.getElementById('orderDateInput');
      const totalAmountInput = document.getElementById('totalAmountInput');
      
      if (orderDateInput) {
        // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ DD.MM.YYYY í˜•ì‹ìœ¼ë¡œ ì„¤ì •
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const todayString = `${day}.${month}.${year}`;
        orderDateInput.value = todayString;
      }
      
      if (totalAmountInput) {
        totalAmountInput.value = '';
      }
      
      // ì¹´í…Œê³ ë¦¬ 1ì˜ 1í–‰ ìë™ ë¡œë“œ (ìš°ì„  ì‹¤í–‰)
      await addCategory1Row();
      
    }

    // ë‚ ì§œ ë¬¸ìì—´ì„ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜ (ìµœì í™”ë¨)
    function parseDateString(dateStr) {
      if (!dateStr) return null;
      
      // ì£¼ë¡œ ì‚¬ìš©ë˜ëŠ” í˜•ì‹ë§Œ ì§€ì› (DD.MM.YYYY, YYYY-MM-DD)
      const ddMmYyyy = /^(\d{2})\.(\d{2})\.(\d{4})$/;
      const yyyyMmDd = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
      
      let match = dateStr.match(ddMmYyyy);
        if (match) {
        const day = parseInt(match[1]);
        const month = parseInt(match[2]) - 1;
        const year = parseInt(match[3]);
        return new Date(year, month, day);
      }
      
      match = dateStr.match(yyyyMmDd);
      if (match) {
        const year = parseInt(match[1]);
        const month = parseInt(match[2]) - 1;
        const day = parseInt(match[3]);
        return new Date(year, month, day);
      }
      
      return null;
    }

    // ì„¸ ê°œì˜ ë‚ ì§œ ì¤‘ ê°€ì¥ ì˜¤ë˜ëœ ë‚ ì§œë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ (ìµœì í™”ë¨)
    function getOldestDate(dndate, pidate, invoicedate) {
      let oldestDate = null;
      
      // ê° ë‚ ì§œë¥¼ íŒŒì‹±í•˜ì—¬ ê°€ì¥ ì˜¤ë˜ëœ ë‚ ì§œ ì°¾ê¸° (í•œ ë²ˆì— ì²˜ë¦¬)
      [dndate, pidate, invoicedate].forEach(dateStr => {
        if (dateStr) {
          const parsedDate = parseDateString(dateStr);
          if (parsedDate && (!oldestDate || parsedDate < oldestDate)) {
            oldestDate = parsedDate;
          }
        }
      });
      
      return oldestDate;
    }

    // creditnote.jsonì—ì„œ creditnoteno ëª©ë¡ì„ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜ (ìµœì í™”ë¨)
    async function loadCreditNoteNumbers() {
      try {
        const response = await fetch('/api/creditnote');
        const creditNoteData = await response.json();
        
        // creditnoteno ëª©ë¡ ì¶”ì¶œ (isused: trueì¸ í•­ëª© ì œì™¸) - í•œ ë²ˆì— ì²˜ë¦¬
        return creditNoteData
          .filter(item => item['c/nno'] && !item.isused)
          .map(item => item['c/nno']);
      } catch (error) {
        return [];
      }
    }

    // ì¹´í…Œê³ ë¦¬ 2ì˜ 7ì—´ ê°’ì„ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜ (ìµœì í™”ë¨)
    function calculateCategory2Price(row) {
      const commissionInput = row.querySelector('td:nth-child(6) input');
      const priceInput = row.querySelector('td:nth-child(7) input');
      const exchangeRateInput = document.getElementById('exchangeRateInput');
      const categorySelect = row.querySelector('td:nth-child(1) select');
      
      // ê³„ì‚° ë¶ˆê°€ëŠ¥í•œ ì¡°ê±´ë“¤ ì²´í¬ (í•œ ë²ˆì— ì²˜ë¦¬)
      if (!commissionInput || !priceInput || !exchangeRateInput) return;
      if (priceInput.getAttribute('data-fixed-value') === 'true') return;
      if (categorySelect && ['Over Payment', 'Less Payment'].includes(categorySelect.value)) return;
      
      // ê³„ì‚° ì‹¤í–‰
        const commission = parseFloat(commissionInput.value) || 0;
        const exchangeRate = parseFloat(exchangeRateInput.value) || 1;
        const calculatedPrice = commission * exchangeRate * -1;
        
        priceInput.value = calculatedPrice.toFixed(2);
      calculateTotal();
    }

    // creditnotenoì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜ (ì¹´í…Œê³ ë¦¬ 2ìš©)
    async function loadCreditNoteData(creditNoteNo, dateInput, commissionInput) {
      try {
        const response = await fetch('/api/creditnote');
        const creditNoteData = await response.json();
        
        // creditnotenoê°€ ì¼ì¹˜í•˜ëŠ” í•­ëª© ì°¾ê¸°
        const foundItem = creditNoteData.find(item => item['c/nno'] === creditNoteNo);
        
        if (!foundItem) {
          // í•­ëª©ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ì´ˆê¸°í™”
          if (dateInput) dateInput.value = '';
          if (commissionInput) commissionInput.value = '';
          return;
        }
        
        // 4ì—´: c/ndate ë¡œë“œ
        if (dateInput) {
          dateInput.value = foundItem['c/ndate'] || '';
        }
        
        if (!commissionInput) return;
        
            const row = commissionInput.closest('tr');
        if (!row) return;
        
              const priceInput = row.querySelector('td:nth-child(7) input');
        const exchangeRateInput = document.getElementById('exchangeRateInput');
        
        // c/neuroê°€ ìˆëŠ” ê²½ìš°: 6ì—´ì— ë¡œë“œ, 7ì—´ì— *í™˜ìœ¨*-1 ê³„ì‚°
        if (foundItem['c/neuro']) {
          commissionInput.value = foundItem['c/neuro'];
          if (priceInput && exchangeRateInput) {
            const euroValue = parseFloat(foundItem['c/neuro']) || 0;
            const exchangeRate = parseFloat(exchangeRateInput.value) || 1;
            priceInput.value = (euroValue * exchangeRate * -1).toFixed(2);
            priceInput.removeAttribute('data-fixed-value'); // í™˜ìœ¨ ë³€ê²½ ì‹œ ì¬ê³„ì‚° í—ˆìš©
          }
        }
        // c/ndollarê°€ ìˆëŠ” ê²½ìš°: 7ì—´ì— *-1í•˜ì—¬ ë¡œë“œ
        else if (foundItem['c/ndollar']) {
          commissionInput.value = '';
              if (priceInput) {
            const dollarValue = parseFloat(foundItem['c/ndollar']) || 0;
                priceInput.value = (dollarValue * -1).toFixed(2);
            priceInput.setAttribute('data-fixed-value', 'true'); // í™˜ìœ¨ ë³€ê²½ ì‹œ ì¬ê³„ì‚° ë°©ì§€
              }
            }
        // ë‘˜ ë‹¤ ì—†ëŠ” ê²½ìš°
        else {
            commissionInput.value = '';
          if (priceInput) {
            priceInput.value = '';
            priceInput.removeAttribute('data-fixed-value');
          }
        }
        
      } catch (error) {
        if (dateInput) dateInput.value = '';
        if (commissionInput) commissionInput.value = '';
      }
    }


    // Less Payment ë²ˆí˜¸ ë¡œë“œ í•¨ìˆ˜ (isused: true ì œì™¸)
    async function loadLpNumbers(selectElement) {
      try {
        const response = await fetch('/api/creditnote');
        const creditNoteData = await response.json();
        
        // í•„í„°ë§ê³¼ ì¤‘ë³µ ì œê±°ë¥¼ í•œ ë²ˆì— ì²˜ë¦¬
        const uniqueLpNumbers = [...new Set(
          creditNoteData
            .filter(item => item['l/pno'] && !item.isused)
            .map(item => item['l/pno'])
        )].sort();
        
        // ê¸°ì¡´ ì˜µì…˜ë“¤ ì œê±° (Choose ì œì™¸)
        while (selectElement.children.length > 1) {
          selectElement.removeChild(selectElement.lastChild);
        }
        
        // ì˜µì…˜ë“¤ ì¶”ê°€
        uniqueLpNumbers.forEach(lpno => {
          const option = document.createElement('option');
          option.value = lpno;
          option.textContent = lpno;
          selectElement.appendChild(option);
        });
        
      } catch (error) {
      }
    }

    // Less Payment ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    async function loadLpData(lpno, dateInput, priceInput) {
      try {
        const response = await fetch('/api/creditnote');
        const creditNoteData = await response.json();
        
        const foundItem = creditNoteData.find(item => item['l/pno'] === lpno);
        
        if (foundItem) {
          // ë‚ ì§œ ì„¤ì •
          if (dateInput) {
            dateInput.value = foundItem['l/pdate'] || '';
          }
          
          // ê°€ê²© ì„¤ì • (l/pdollar ê°’ì„ ê·¸ëŒ€ë¡œ ë¡œë“œ)
          if (priceInput) {
            const dollarValue = foundItem['l/pdollar'];
            if (dollarValue) {
              const numericValue = parseFloat(dollarValue);
              priceInput.value = !isNaN(numericValue) ? numericValue.toString() : '';
            } else {
              priceInput.value = '';
            }
            calculateTotal();
          }
        } else {
          // ë°ì´í„°ê°€ ì—†ì„ ë•Œ ì´ˆê¸°í™”
          if (dateInput) dateInput.value = '';
          if (priceInput) priceInput.value = '';
        }
        
      } catch (error) {
        if (dateInput) dateInput.value = '';
        if (priceInput) priceInput.value = '';
      }
    }

    // Over Payment ë²ˆí˜¸ ë¡œë“œ í•¨ìˆ˜ (isused: true ì œì™¸)
    async function loadOverPaymentNumbers(selectElement) {
      try {
        const response = await fetch('/api/creditnote');
        const creditNoteData = await response.json();
        
        const uniqueOpNumbers = [...new Set(
          creditNoteData
            .filter(item => item['o/pno'] && !item.isused)
            .map(item => item['o/pno'])
        )].sort();
        
        while (selectElement.children.length > 1) {
          selectElement.removeChild(selectElement.lastChild);
        }
        
        uniqueOpNumbers.forEach(opno => {
          const option = document.createElement('option');
          option.value = opno;
          option.textContent = opno;
          selectElement.appendChild(option);
        });
        
      } catch (error) {
      }
    }

    // Over Payment ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (í†µí•©)
    async function loadOverPaymentData(opno, dateInput, priceInput, multiplyByMinusOne = false) {
      try {
        const response = await fetch('/api/creditnote');
        const creditNoteData = await response.json();
        
        const foundItem = creditNoteData.find(item => item['o/pno'] === opno);
        
        if (foundItem) {
        if (dateInput) {
            dateInput.value = foundItem['o/pdate'] || '';
          }
          
          if (priceInput) {
            const dollarValue = foundItem['o/pdollar'];
            if (dollarValue) {
              const numericValue = parseFloat(dollarValue);
              if (!isNaN(numericValue)) {
                priceInput.value = multiplyByMinusOne ? (numericValue * -1).toString() : numericValue.toString();
              } else {
                priceInput.value = '';
              }
            } else {
              priceInput.value = '';
            }
            calculateTotal();
          }
        } else {
          if (dateInput) dateInput.value = '';
          if (priceInput) priceInput.value = '';
        }
        
      } catch (error) {
        if (dateInput) dateInput.value = '';
        if (priceInput) priceInput.value = '';
      }
    }

    // deliveryNo ë“œëë‹¤ìš´ ìƒì„± í•¨ìˆ˜
    async function createDeliveryDropdown() {
      try {
        const response = await fetch('orderData.json');
        const orderData = await response.json();
        
        const deliveryGroups = {};
        orderData.forEach(order => {
          if (order.items?.length) {
            order.items.forEach(item => {
              if (item.deliveryNo) {
                if (!deliveryGroups[item.deliveryNo]) {
                  deliveryGroups[item.deliveryNo] = [];
                }
                deliveryGroups[item.deliveryNo].push(item);
              }
            });
          }
        });
        
        const sortedDeliveryNos = Object.keys(deliveryGroups).sort((a, b) => {
          const aFirstItem = deliveryGroups[a][0];
          const bFirstItem = deliveryGroups[b][0];
          
          const aOldestDate = getOldestDate(aFirstItem['d/ndate'], aFirstItem['p/idate'], aFirstItem['invoicedate']);
          const bOldestDate = getOldestDate(bFirstItem['d/ndate'], bFirstItem['p/idate'], bFirstItem['invoicedate']);
          
          if (aOldestDate && bOldestDate) {
            return bOldestDate.getTime() - aOldestDate.getTime();
          } else if (aOldestDate) return -1;
          else if (bOldestDate) return 1;
          else {
            const aNum = parseInt(a.replace('EK-', '')) || 0;
            const bNum = parseInt(b.replace('EK-', '')) || 0;
            return bNum - aNum;
          }
        });
        
        
        const options = sortedDeliveryNos.map(deliveryNo => 
          `<option value="${deliveryNo}">${deliveryNo}</option>`
        ).join('');
        
        return `<select style="width: 100%; border: none; background: transparent; font-size: inherit; color: inherit; outline: none; appearance: none; -webkit-appearance: none; -moz-appearance: none; cursor: pointer; text-align: center; text-align-last: center;"><option value="" style="text-align: center;">Choose</option>${options}</select>`;
        
      } catch (error) {
        return '<select style="width: 100%; border: none; background: transparent;"><option value="">ë¡œë“œ ì‹¤íŒ¨</option></select>';
      }
    }

    // Total í–‰ ìƒì„± í•¨ìˆ˜
    function createTotalRow() {
      const row = document.createElement('tr');
      row.className = 'total-row';
      row.style.height = '33px';
      
      // ê³µí†µ ìŠ¤íƒ€ì¼ ì„¤ì •
      const commonCellStyle = {
        height: '33px',
        padding: '5px',
        lineHeight: '1.5',
        boxSizing: 'border-box',
        backgroundColor: '#f0f0f0'
      };
      
      // ì…€ ìƒì„± í—¬í¼ í•¨ìˆ˜
      const createCell = (width, text = '', isTotal = false) => {
        const cell = document.createElement('td');
        Object.assign(cell.style, commonCellStyle, { width });
        if (isTotal) {
          cell.style.textAlign = 'center';
          cell.style.fontWeight = 'bold';
        }
        if (text) cell.textContent = text;
        return cell;
      };
      
      // 1ì—´: Total
      const cell1 = createCell('40px', 'Total', true);
      
      // 2-6ì—´: ë¹ˆ ì…€ë“¤
      const emptyCells = [
        createCell('15px'),
        createCell('35px'),
        createCell('25px'),
        createCell('25px'),
        createCell('25px')
      ];
      
      // 7ì—´: í•©ê³„ ì…ë ¥ í•„ë“œ
      const cell7 = createCell('30px', '', true);
      const totalInput = document.createElement('input');
      Object.assign(totalInput.style, {
        width: '100%',
        border: 'none',
        background: 'transparent',
        textAlign: 'center',
        fontWeight: 'bold'
      });
      totalInput.type = 'text';
      totalInput.readOnly = true;
      totalInput.value = '0';
      totalInput.id = 'totalAmount';
      cell7.appendChild(totalInput);
      
      // ëª¨ë“  ì…€ì„ í–‰ì— ì¶”ê°€
      row.appendChild(cell1);
      emptyCells.forEach(cell => row.appendChild(cell));
      row.appendChild(cell7);
      
      // í—¤ë”ì™€ ë™ì¼í•œ ë†’ì´ë¡œ ì„¤ì •
        const headerCell = document.querySelector('.order-body table thead th');
        const headerHeight = headerCell ? headerCell.offsetHeight : 33;
        
      // ê³µí†µ ìŠ¤íƒ€ì¼ ì„¤ì •
      const setRowHeight = (element, height) => {
        element.style.height = `${height}px`;
        element.style.minHeight = `${height}px`;
        element.style.maxHeight = `${height}px`;
      };
      
      // í–‰ ë†’ì´ ì„¤ì •
      setRowHeight(row, headerHeight);
      
      // ì…€ ë†’ì´ ì„¤ì •
        const cells = row.querySelectorAll('td');
        cells.forEach(cell => {
        setRowHeight(cell, headerHeight);
          
        // ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ì„¤ì •
          const inputs = cell.querySelectorAll('input');
          inputs.forEach(input => {
          input.style.height = `${headerHeight - 10}px`;
          input.style.textAlign = 'center';
          input.style.fontWeight = 'bold';
          input.style.padding = '0';
          input.style.margin = '0';
          });
        });
      
      return row;
    }

    // í•©ê³„ ê³„ì‚° í•¨ìˆ˜ (2% discount í¬í•¨)
    function calculateTotal() {
      const tbody = document.getElementById('orderTbody');
      
      // ì¹´í…Œê³ ë¦¬1, ì¹´í…Œê³ ë¦¬2, 2% discount í–‰ì˜ ëª¨ë“  7ì—´ ê°’ë“¤ì„ í•©ì‚°
      const allRows = tbody.querySelectorAll('tr:not(.total-row)');
      let total = 0;
      
      allRows.forEach(row => {
        const priceInput = row.querySelector('td:nth-child(7) input');
        let value = 0;
        
        if (priceInput) {
          value = parseFloat(priceInput.value) || 0;
        } else {
          // inputì´ ì—†ëŠ” ê²½ìš° (2% discount í–‰ ë“±) í…ìŠ¤íŠ¸ ë‚´ìš©ì—ì„œ ìˆ«ì ì¶”ì¶œ
          const priceCell = row.querySelector('td:nth-child(7)');
          if (priceCell && priceCell.textContent.trim()) {
            value = parseFloat(priceCell.textContent.trim()) || 0;
          }
        }
        
        total += value;
      });
      
      // ê²°ê³¼ê°’ í¬ë§·íŒ…
      const formattedTotal = total.toFixed(2);
      
      // Total í–‰ê³¼ Total Amount í•„ë“œì— ê²°ê³¼ ì„¤ì •
      const totalInput = document.getElementById('totalAmount');
      const totalAmountInput = document.getElementById('totalAmountInput');
      
      if (totalInput) totalInput.value = formattedTotal;
      if (totalAmountInput) totalAmountInput.value = formattedTotal;
    }

    // ì¹´í…Œê³ ë¦¬ 1 í–‰ ì¶”ê°€ í•¨ìˆ˜
    async function addCategory1Row() {
      const tbody = document.getElementById('orderTbody');
      const row = document.createElement('tr');
      row.className = 'category1-row';
      
      // deliveryNo ë“œëë‹¤ìš´ ìƒì„±
      const deliveryDropdown = await createDeliveryDropdown();
      
         row.innerHTML = `
           <td style="width: 38px; min-width: 38px; max-width: 38px; word-wrap: break-word; white-space: normal;">${deliveryDropdown}</td>
           <td style="width: 10px; min-width: 10px; max-width: 10px; word-wrap: break-word; white-space: normal;"><input type="text" style="width: 100%; border: none; background: transparent; font-size: inherit; color: inherit; outline: none; text-align: center;" /></td>
        <td style="width: 38px; min-width: 38px; max-width: 38px; word-wrap: break-word; white-space: normal;"><select style="width: 100%; border: none; background: transparent; font-size: inherit; color: inherit; outline: none; appearance: none; -webkit-appearance: none; -moz-appearance: none; cursor: pointer; text-align: center; text-align-last: center;" class="pino-select"><option value="" style="text-align: center;">Choose</option></select></td>
        <td style="width: 30px; min-width: 30px; max-width: 30px; word-wrap: break-word; white-space: normal;"><input type="text" style="width: 100%; border: none; background: transparent; text-align: center;" /></td>
        <td style="width: 30px; min-width: 30px; max-width: 30px; word-wrap: break-word; white-space: normal;"><input type="text" style="width: 100%; border: none; background: transparent; text-align: center;" /></td>
        <td style="width: 30px; min-width: 30px; max-width: 30px; word-wrap: break-word; white-space: normal;"><input type="text" style="width: 100%; border: none; background: transparent; text-align: center;" /></td>
        <td style="width: 38px; min-width: 38px; max-width: 38px; word-wrap: break-word; white-space: normal;"><input type="text" style="width: 100%; border: none; background: transparent; text-align: center;" /></td>
      `;
      
      // Total í–‰ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì œê±°
      const existingTotalRow = tbody.querySelector('.total-row');
      if (existingTotalRow) {
        existingTotalRow.remove();
      }
      
      // ì¹´í…Œê³ ë¦¬ 1 í–‰ë“¤ì„ ì°¾ì•„ì„œ ë§ˆì§€ë§‰ ì¹´í…Œê³ ë¦¬ 1 í–‰ ë‹¤ìŒì— ì‚½ì…
      const category1Rows = tbody.querySelectorAll('.category1-row');
      if (category1Rows.length > 0) {
        // ë§ˆì§€ë§‰ ì¹´í…Œê³ ë¦¬ 1 í–‰ ë‹¤ìŒì— ì‚½ì…
        const lastCategory1Row = category1Rows[category1Rows.length - 1];
        lastCategory1Row.insertAdjacentElement('afterend', row);
      } else {
        // ì¹´í…Œê³ ë¦¬ 1 í–‰ì´ ì—†ìœ¼ë©´ ë§¨ ì•„ë˜ì— ì¶”ê°€
         tbody.appendChild(row);
      }
      
      // ì¹´í…Œê³ ë¦¬1 subtotal í–‰ ì¶”ê°€
      addCategory1SubtotalRow();
      
      // Total í–‰ì„ ë§ˆì§€ë§‰ì— ì¶”ê°€ (í•œ ë²ˆë§Œ)
      if (!tbody.querySelector('.total-row')) {
        const totalRow = createTotalRow();
        tbody.appendChild(totalRow);
      }
      
        // DOM ìš”ì†Œë“¤ í•œ ë²ˆì— ì¿¼ë¦¬
      const deliverySelect = row.querySelector('td:nth-child(1) select');
      const pinoSelect = row.querySelector('.pino-select');
      const corpInput = row.querySelector('td:nth-child(2) input');
      const dateInput = row.querySelector('td:nth-child(4) input');
      const priceInput = row.querySelector('td:nth-child(7) input');
      
      if (deliverySelect && pinoSelect) {
        // deliveryNo ì„ íƒ ì‹œ í†µí•© ì´ë²¤íŠ¸ ì²˜ë¦¬
        deliverySelect.addEventListener('change', async function() {
          const selectedDeliveryNo = this.value;
          
          // p/ino ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
          if (selectedDeliveryNo) {
            await updatePinoDropdown(selectedDeliveryNo, pinoSelect);
            // deliveryNoì— í•´ë‹¹í•˜ëŠ” mode ì •ë³´ ë¡œë“œ
            if (corpInput) {
              loadModeForDeliveryNo(selectedDeliveryNo, corpInput);
            }
          } else {
            // deliveryNoê°€ ì„ íƒë˜ì§€ ì•Šìœ¼ë©´ p/ino ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
            pinoSelect.innerHTML = '<option value="" style="text-align: center;">Choose</option>';
          }
          
          // ì¹´í…Œê³ ë¦¬1 subtotal ì—…ë°ì´íŠ¸ (2% discount ì¬ê³„ì‚°)
          addCategory1SubtotalRow();
          
          // í† íƒˆ ì¬ê³„ì‚°
          calculateTotal();
        });
        
        // p/ino ì„ íƒ ì‹œ ë‚ ì§œì™€ ê°€ê²© ë¡œë“œ
        pinoSelect.addEventListener('change', async function() {
          const selectedPino = this.value;
          const selectedDeliveryNo = deliverySelect.value;
          
          if (selectedPino && selectedDeliveryNo) {
            await loadPinoData(selectedDeliveryNo, selectedPino, row);
          } else {
            // p/inoê°€ ì„ íƒë˜ì§€ ì•Šìœ¼ë©´ 4ì—´ê³¼ 7ì—´ ì´ˆê¸°í™”
            if (dateInput) dateInput.value = '';
            if (priceInput) priceInput.value = '';
          }
          
          // ì¹´í…Œê³ ë¦¬1 subtotal ì—…ë°ì´íŠ¸ (2% discount ì¬ê³„ì‚°)
          addCategory1SubtotalRow();
          
          // í† íƒˆ ì¬ê³„ì‚°
          calculateTotal();
          
          // ì¹´í…Œê³ ë¦¬ 1ì˜ ì²« ë²ˆì§¸ í–‰ì—ì„œë§Œ save/save2 ë²„íŠ¼ ìƒíƒœ ë³€ê²½
          const category1Rows = document.querySelectorAll('.category1-row');
          const isFirstCategory1Row = category1Rows.length > 0 && row === category1Rows[0];
          
          if (isFirstCategory1Row) {
            console.log('ğŸ” ì²« ë²ˆì§¸ ì¹´í…Œê³ ë¦¬1 í–‰ì—ì„œ p/ino ì„ íƒë¨');
            console.log('  - selectedPino:', selectedPino);
            console.log('  - row:', row);
            
            const save2Btn = document.getElementById('save2Btn');
            const saveBtn = document.getElementById('saveBtn');
            
            if (selectedPino && save2Btn && saveBtn) {
              // p/ino2 ê°’ë“¤ í™•ì¸ (ì‹¤ì œ ë°ì´í„°ì—ì„œ p/ino2 í•„ë“œ ê°’ë“¤)
              const pino2Values = ['8993014165', '8993013490']; // ì‹¤ì œ p/ino2 ê°’ë“¤
              
              if (pino2Values.includes(selectedPino)) {
                console.log('âœ… p/ino2 ì„ íƒë¨ - Save2 ë²„íŠ¼ í™œì„±í™”, Save ë²„íŠ¼ ë¹„í™œì„±í™”');
                // Save2 ë²„íŠ¼ í™œì„±í™” (ê²€ì •ìƒ‰)
                save2Btn.classList.add('save2-selected');
                save2Btn.style.backgroundColor = '#000';
                save2Btn.style.color = '#fff';
                save2Btn.style.borderColor = '#000';
                save2Btn.disabled = false;
                save2Btn.style.opacity = '1';
                save2Btn.style.cursor = 'pointer';
                
                // Save ë²„íŠ¼ ë¹„í™œì„±í™”
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.5';
                saveBtn.style.cursor = 'not-allowed';
                saveBtn.classList.remove('save2-selected');
                saveBtn.style.backgroundColor = '';
                saveBtn.style.color = '';
                saveBtn.style.borderColor = '';
              } else {
                console.log('âŒ ì¼ë°˜ p/ino ì„ íƒë¨ - Save ë²„íŠ¼ í™œì„±í™”, Save2 ë²„íŠ¼ ë¹„í™œì„±í™”');
                // Save ë²„íŠ¼ í™œì„±í™” (ê¸°ë³¸ ìƒíƒœ)
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
                saveBtn.style.cursor = 'pointer';
                saveBtn.classList.remove('save2-selected');
                saveBtn.style.backgroundColor = '';
                saveBtn.style.color = '';
                saveBtn.style.borderColor = '';
                
                // Save2 ë²„íŠ¼ ë¹„í™œì„±í™” (ê¸°ë³¸ ìƒíƒœ)
                save2Btn.classList.remove('save2-selected');
                save2Btn.style.backgroundColor = '';
                save2Btn.style.color = '';
                save2Btn.style.borderColor = '';
                save2Btn.disabled = false;
                save2Btn.style.opacity = '1';
                save2Btn.style.cursor = 'pointer';
              }
            }
          }
        });
      }
      
      // í•©ê³„ ê³„ì‚°
      calculateTotal();
      
      // í—¤ë”ì™€ ë™ì¼í•œ ë†’ì´ë¡œ ì„¤ì •
        const headerCell = document.querySelector('.order-body table thead th');
        const headerHeight = headerCell ? headerCell.offsetHeight : 33;
        
      // ê³µí†µ ìŠ¤íƒ€ì¼ ì„¤ì •
      const setRowHeight = (element, height) => {
        element.style.height = `${height}px`;
        element.style.minHeight = `${height}px`;
        element.style.maxHeight = `${height}px`;
      };
      
      // í–‰ ë†’ì´ ì„¤ì •
      setRowHeight(row, headerHeight);
      
      // ì…€ ë†’ì´ ì„¤ì •
        const cells = row.querySelectorAll('td');
        cells.forEach(cell => {
        setRowHeight(cell, headerHeight);
          
        // ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ì„¤ì •
          const inputs = cell.querySelectorAll('input, select');
          inputs.forEach(input => {
          input.style.height = `${headerHeight - 10}px`;
          input.style.textAlign = 'center';
          input.style.textAlignLast = 'center';
          input.style.padding = '0';
          input.style.margin = '0';
          });
        });
        
        // 7ì—´ ê°€ê²© ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        if (priceInput) {
          priceInput.addEventListener('input', function() {
            // ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ê°’ì„ ë³€ê²½í•˜ë©´ ê³ ì • í”Œë˜ê·¸ ì œê±°
            priceInput.removeAttribute('data-fixed-value');
            calculateTotal();
            // ì¹´í…Œê³ ë¦¬1 subtotal ì—…ë°ì´íŠ¸
            addCategory1SubtotalRow();
          });
          priceInput.addEventListener('change', function() {
            // ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ê°’ì„ ë³€ê²½í•˜ë©´ ê³ ì • í”Œë˜ê·¸ ì œê±°
            priceInput.removeAttribute('data-fixed-value');
            calculateTotal();
            // ì¹´í…Œê³ ë¦¬1 subtotal ì—…ë°ì´íŠ¸
            addCategory1SubtotalRow();
          });
        }
         
       }

        // deliveryNoì— í•´ë‹¹í•˜ëŠ” modeì™€ invoice ì •ë³´ë¥¼ ì°¾ì•„ì„œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    async function loadModeForDeliveryNo(deliveryNo, corpInput) {
      try {
        const response = await fetch('orderData.json');
        const orderData = await response.json();
        
        // deliveryNoê°€ ì¼ì¹˜í•˜ëŠ” orderë¥¼ ì°¾ê¸°
        let foundData = null;
        
        for (const order of orderData) {
          if (order.items?.length) {
            const matchingItem = order.items.find(item => item.deliveryNo === deliveryNo);
            if (matchingItem) {
              const hasPino = matchingItem['p/ino']?.trim();
              foundData = {
                mode: order.mode,
                invoice: hasPino ? matchingItem['p/ino'] : matchingItem.invoiceno || '',
                date: hasPino ? matchingItem['p/idate'] || '' : matchingItem.invoicedate || '',
                dueDate: hasPino ? '' : matchingItem.invoicedue || '',
                price: hasPino ? matchingItem['p/iprice'] || '' : matchingItem.invoiceprice || '',
                hasPino: !!hasPino
              };
                break;
              }
          }
        }
        
        if (foundData) {
          // NTëŠ” NTë¡œ, SM-B/SM-CëŠ” SMìœ¼ë¡œ í‘œì‹œ
          const displayMode = (foundData.mode === 'SM-B' || foundData.mode === 'SM-C') ? 'SM' : foundData.mode;
          corpInput.value = displayMode;
          
          // DOM ìš”ì†Œë“¤ í•œ ë²ˆì— ì¿¼ë¦¬
          const currentRow = corpInput.closest('tr');
          const invoiceSelect = currentRow.querySelector('.pino-select');
          const dateInput = currentRow.querySelector('td:nth-child(4) input');
          const dueDateInput = currentRow.querySelector('td:nth-child(5) input');
          const priceInput = currentRow.querySelector('td:nth-child(7) input');
          
          // 3ì—´ì— invoice ì •ë³´ ì„¤ì •
          if (invoiceSelect && foundData.invoice?.trim()) {
            // ê¸°ì¡´ ì˜µì…˜ í™•ì¸ ë° ì¶”ê°€
            const existingOption = [...invoiceSelect.options].find(opt => opt.value === foundData.invoice);
              if (!existingOption) {
                const newOption = document.createElement('option');
              newOption.value = foundData.invoice;
              newOption.textContent = foundData.invoice;
                invoiceSelect.appendChild(newOption);
              }
            invoiceSelect.value = foundData.invoice;
          }
          
          // 4-7ì—´ ë°ì´í„° ì„¤ì •
          if (dateInput) dateInput.value = foundData.date;
          if (dueDateInput) dueDateInput.value = foundData.dueDate;
          if (priceInput) {
            priceInput.value = foundData.price;
            calculateTotal();
          }
          
          // í—¤ë” ë™ì  ë³€ê²½ (1í–‰ì—ì„œë§Œ)
          const tbody = document.getElementById('orderTbody');
          const isFirstRow = currentRow === tbody.querySelector('tr:not(.total-row)');
          
          if (isFirstRow) {
            const headerCell = document.querySelector('.order-body table thead th:nth-child(3)');
            if (headerCell) {
              headerCell.textContent = foundData.hasPino ? 'Proforma Invoice No' : 'Invoice No';
            }
          }
        } else {
          corpInput.value = '';
        }
        
      } catch (error) {
        corpInput.value = '';
      }
      }
      
      // ì¹´í…Œê³ ë¦¬ 2 í–‰ ì´ˆê¸°í™” í•¨ìˆ˜
      function resetCategory2Row(row) {
        // 3ì—´ ë“œëë‹¤ìš´ ì´ˆê¸°í™”
        const creditNoteSelect = row.querySelector('td:nth-child(3) select');
        if (creditNoteSelect) {
          creditNoteSelect.value = '';
          // ê¸°ì¡´ ì˜µì…˜ë“¤ ì œê±° (Choose ì œì™¸)
          while (creditNoteSelect.children.length > 1) {
            creditNoteSelect.removeChild(creditNoteSelect.lastChild);
          }
        }
        
        // 4ì—´ ë‚ ì§œ ì…ë ¥ ì´ˆê¸°í™”
        const dateInput = row.querySelector('td:nth-child(4) input');
        if (dateInput) dateInput.value = '';
        
        // 5ì—´ê³¼ 6ì—´ ë³µì› (Less Payment/Over Paymentì—ì„œ ë³€ê²½ëœ ê²½ìš°)
        const dueDateCell = row.querySelector('td:nth-child(5)');
        const commissionCell = row.querySelector('td:nth-child(6)');
        
        if (dueDateCell && commissionCell) {
          // colspan ì œê±°
          dueDateCell.removeAttribute('colspan');
          
          // ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
          Object.assign(dueDateCell.style, {
            width: '30px',
            minWidth: '30px',
            maxWidth: '30px',
            height: 'auto',
            minHeight: '33px',
            verticalAlign: 'top'
          });
          
          // 6ì—´ ë‹¤ì‹œ í‘œì‹œ
          commissionCell.style.display = '';
          
        }
        
        // 6ì—´ ìˆ˜ìˆ˜ë£Œ ì…ë ¥ ì´ˆê¸°í™”
        const commissionInput = row.querySelector('td:nth-child(6) input');
        if (commissionInput) commissionInput.value = '';
        
        // 7ì—´ ê°€ê²© ì…ë ¥ ì´ˆê¸°í™”
        const priceInput = row.querySelector('td:nth-child(7) input');
        if (priceInput) {
          priceInput.value = '';
          priceInput.removeAttribute('data-fixed-value');
        }
      }
      
      // ì…€ ë³µì› í•¨ìˆ˜
      function restoreCells(dueDateCell, commissionCell) {
        // 5ì—´ ì›ë˜ëŒ€ë¡œ ë³µì›
        dueDateCell.removeAttribute('colspan');
        Object.assign(dueDateCell.style, {
          width: '30px',
          minWidth: '30px',
          maxWidth: '30px',
          height: '33px',
          minHeight: '33px',
          verticalAlign: 'middle'
        });
        
        // 6ì—´ ë‹¤ì‹œ í‘œì‹œ
        commissionCell.style.display = '';
        
        // 5ì—´ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        const existingDiv = dueDateCell.querySelector('div');
        const existingInput = dueDateCell.querySelector('input');
        
        if (existingDiv) {
          const newInput = document.createElement('input');
          newInput.type = 'text';
          newInput.value = '';
          Object.assign(newInput.style, {
            width: '100%',
            border: 'none',
            background: 'transparent',
            textAlign: 'center',
            fontSize: 'inherit',
            height: '23px',
            minHeight: '23px',
            resize: 'none'
          });
          
          existingDiv.remove();
          dueDateCell.appendChild(newInput);
        } else if (existingInput) {
          existingInput.value = '';
          existingInput.readOnly = false;
          Object.assign(existingInput.style, {
            fontWeight: 'normal',
            fontSize: 'inherit',
            lineHeight: 'inherit',
            whiteSpace: 'normal',
            height: '23px',
            minHeight: '23px',
            resize: 'none'
          });
        }
      }
      
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” í•¨ìˆ˜
      function clearInputFields(row) {
        const inputs = [
          row.querySelector('td:nth-child(4) input'),
          row.querySelector('td:nth-child(6) input'),
          row.querySelector('td:nth-child(7) input')
        ];
        
        inputs.forEach(input => {
          if (input) input.value = '';
        });
      }
      
      // ê³µí†µ ì…€ í•©ì¹˜ê¸° í•¨ìˆ˜
      function mergeCellsWithText(row, text) {
        const dueDateCell = row.querySelector('td:nth-child(5)');
        const commissionCell = row.querySelector('td:nth-child(6)');
        
        if (!dueDateCell || !commissionCell) return;
        
        // 5ì—´ê³¼ 6ì—´ì„ í•©ì¹˜ê¸° (colspan=2)
        dueDateCell.setAttribute('colspan', '2');
        Object.assign(dueDateCell.style, {
          width: '60px',
          minWidth: '60px',
          maxWidth: '60px',
          height: 'auto',
          minHeight: '33px',
          verticalAlign: 'top'
        });
        commissionCell.style.display = 'none';
        
        // 5ì—´ì— í…ìŠ¤íŠ¸ í‘œì‹œ
        const dueDateInput = dueDateCell.querySelector('input');
        if (dueDateInput) {
          const div = document.createElement('div');
          div.innerHTML = text;
          Object.assign(div.style, {
            textAlign: 'center',
            fontWeight: 'normal',
            fontSize: 'inherit',
            lineHeight: '1.2',
            height: 'auto',
            minHeight: '50px',
            width: '100%',
            border: 'none',
            background: 'transparent',
            outline: 'none',
            padding: '10px 0',
            margin: '0',
            boxSizing: 'border-box',
            fontFamily: 'inherit',
            color: 'inherit',
            verticalAlign: 'middle',
            display: 'block'
          });
          
          dueDateInput.remove();
          dueDateCell.appendChild(div);
          
          Object.assign(dueDateCell.style, {
            height: 'auto',
            minHeight: '60px',
            maxHeight: 'none'
          });
      }
    }

    // ì¹´í…Œê³ ë¦¬ 1 subtotal í–‰ ì¶”ê°€ í•¨ìˆ˜
    function addCategory1SubtotalRow() {
      const tbody = document.getElementById('orderTbody');
      
      // ê¸°ì¡´ subtotal í–‰ ì œê±°
      const existingSubtotalRow = tbody.querySelector('.category1-subtotal-row');
      if (existingSubtotalRow) {
        existingSubtotalRow.remove();
      }
      
      // ì¹´í…Œê³ ë¦¬ 1 í–‰ë“¤ ì°¾ê¸°
      const category1Rows = tbody.querySelectorAll('.category1-row');
      if (category1Rows.length === 0) return;
      
      // subtotal ê³„ì‚° (2% í• ì¸ ì ìš©)
      let totalPrice = 0;
      category1Rows.forEach(row => {
        const priceInput = row.querySelector('td:nth-child(7) input');
        const price = parseFloat(priceInput?.value) || 0;
        totalPrice += price;
      });
      
      // 2% í• ì¸ ì ìš©í•˜ì—¬ ìŒìˆ˜ë¡œ í‘œì‹œ
      const discountedAmount = -(totalPrice * 0.02);
      
      // subtotal í–‰ ìƒì„± (total í–‰ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼)
      const subtotalRow = document.createElement('tr');
      subtotalRow.className = 'category1-subtotal-row';
      subtotalRow.style.height = '33px';
      
      // ê³µí†µ ìŠ¤íƒ€ì¼ ì„¤ì • (total í–‰ê³¼ ë™ì¼)
      const commonCellStyle = {
        height: '33px',
        padding: '5px',
        lineHeight: '1.5',
        boxSizing: 'border-box',
        backgroundColor: '#f0f0f0'
      };
      
      subtotalRow.innerHTML = `
        <td style="width: 38px; min-width: 38px; max-width: 38px; height: 33px; min-height: 33px; max-height: 33px; padding: 5px; line-height: 1.5; vertical-align: middle; border: 1px solid #000; text-align: center; font-size: 0.9rem; box-sizing: border-box; background-color: #f0f0f0; font-weight: bold;">2% discount</td>
        <td style="width: 10px; min-width: 10px; max-width: 10px; height: 33px; min-height: 33px; max-height: 33px; padding: 5px; line-height: 1.5; vertical-align: middle; border: 1px solid #000; text-align: center; font-size: 0.9rem; box-sizing: border-box; background-color: #f0f0f0;"></td>
        <td style="width: 38px; min-width: 38px; max-width: 38px; height: 33px; min-height: 33px; max-height: 33px; padding: 5px; line-height: 1.5; vertical-align: middle; border: 1px solid #000; text-align: center; font-size: 0.9rem; box-sizing: border-box; background-color: #f0f0f0;"></td>
        <td style="width: 30px; min-width: 30px; max-width: 30px; height: 33px; min-height: 33px; max-height: 33px; padding: 5px; line-height: 1.5; vertical-align: middle; border: 1px solid #000; text-align: center; font-size: 0.9rem; box-sizing: border-box; background-color: #f0f0f0;"></td>
        <td style="width: 30px; min-width: 30px; max-width: 30px; height: 33px; min-height: 33px; max-height: 33px; padding: 5px; line-height: 1.5; vertical-align: middle; border: 1px solid #000; text-align: center; font-size: 0.9rem; box-sizing: border-box; background-color: #f0f0f0;"></td>
        <td style="width: 30px; min-width: 30px; max-width: 30px; height: 33px; min-height: 33px; max-height: 33px; padding: 5px; line-height: 1.5; vertical-align: middle; border: 1px solid #000; text-align: center; font-size: 0.9rem; box-sizing: border-box; background-color: #f0f0f0;"></td>
        <td style="width: 38px; min-width: 38px; max-width: 38px; height: 33px; min-height: 33px; max-height: 33px; padding: 5px; line-height: 1.5; vertical-align: middle; border: 1px solid #000; text-align: center; font-size: 0.9rem; box-sizing: border-box; background-color: #f0f0f0; font-weight: bold;">${discountedAmount.toFixed(2)}</td>
      `;
      
      // ë§ˆì§€ë§‰ ì¹´í…Œê³ ë¦¬ 1 í–‰ ë‹¤ìŒì— ì‚½ì…
      const lastCategory1Row = category1Rows[category1Rows.length - 1];
      lastCategory1Row.insertAdjacentElement('afterend', subtotalRow);
    }

    // ì¹´í…Œê³ ë¦¬ 2 í–‰ ì¶”ê°€ í•¨ìˆ˜ (ì¹´í…Œê³ ë¦¬ 1 í–‰ ì•„ë˜ì— ë°°ì¹˜)
    function addCategory2Row() {
      const tbody = document.getElementById('orderTbody');
      const row = document.createElement('tr');
      row.className = 'category2-row';
      
      row.innerHTML = `
        <td style="width: 38px; min-width: 38px; max-width: 38px; word-wrap: break-word; white-space: normal;">
          <select style="width: 100%; border: none; background: transparent; font-size: inherit; color: inherit; outline: none; appearance: none; -webkit-appearance: none; -moz-appearance: none; cursor: pointer; text-align: center; text-align-last: center;">
            <option value="" style="text-align: center;">Choose</option>
            <option value="Less Payment">Less Payment</option>
            <option value="Over Payment">Over Payment</option>
            <option value="Credit Note">Credit Note</option>
          </select>
        </td>
        <td style="width: 10px; min-width: 10px; max-width: 10px; word-wrap: break-word; white-space: normal;"><input type="text" style="width: 100%; border: none; background: transparent; text-align: center;" /></td>
        <td style="width: 38px; min-width: 38px; max-width: 38px; word-wrap: break-word; white-space: normal;">
          <select style="width: 100%; border: none; background: transparent; font-size: inherit; color: inherit; outline: none; appearance: none; -webkit-appearance: none; -moz-appearance: none; cursor: pointer; text-align: center; text-align-last: center;">
            <option value="" style="text-align: center;">Choose</option>
          </select>
        </td>
        <td style="width: 30px; min-width: 30px; max-width: 30px; word-wrap: break-word; white-space: normal;">
          <input type="text" style="width: 100%; border: none; background: transparent; text-align: center;" />
        </td>
        <td style="width: 30px; min-width: 30px; max-width: 30px; word-wrap: break-word; white-space: normal;"><input type="text" style="width: 100%; border: none; background: transparent; text-align: center;" /></td>
        <td style="width: 30px; min-width: 30px; max-width: 30px; word-wrap: break-word; white-space: normal;"><input type="text" style="width: 100%; border: none; background: transparent; text-align: center;" /></td>
        <td style="width: 38px; min-width: 38px; max-width: 38px; word-wrap: break-word; white-space: normal;"><input type="text" style="width: 100%; border: none; background: transparent; text-align: center;" /></td>
      `;
      
      // Total í–‰ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì œê±°
      const existingTotalRow = tbody.querySelector('.total-row');
      if (existingTotalRow) {
        existingTotalRow.remove();
      }
      
      // ì¹´í…Œê³ ë¦¬ 2 í–‰ ì‚½ì… ë° Total í–‰ ê´€ë¦¬ í†µí•©
      const category2Rows = tbody.querySelectorAll('.category2-row');
      
      if (category2Rows.length > 0) {
        // ë§ˆì§€ë§‰ ì¹´í…Œê³ ë¦¬ 2 í–‰ ë‹¤ìŒì— ì‚½ì…
        category2Rows[category2Rows.length - 1].insertAdjacentElement('afterend', row);
      } else {
        // ì¹´í…Œê³ ë¦¬ 2 í–‰ì´ ì—†ìœ¼ë©´ ë§¨ ì•„ë˜ì— ì¶”ê°€
        tbody.appendChild(row);
      }
      
      // Total í–‰ ì¬ì¶”ê°€ (ì œê±°í–ˆìœ¼ë¯€ë¡œ í•­ìƒ ì¶”ê°€)
      tbody.appendChild(createTotalRow());
      
      // í•©ê³„ ê³„ì‚°
      calculateTotal();
      
      // í—¤ë”ì™€ ë™ì¼í•œ ë†’ì´ë¡œ ì„¤ì •
        const headerCell = document.querySelector('.order-body table thead th');
        const headerHeight = headerCell ? headerCell.offsetHeight : 33;
      const inputHeight = headerHeight - 10;
      
      // ê³µí†µ ìŠ¤íƒ€ì¼ ì„¤ì •
      const setRowHeight = (element, height) => {
        element.style.height = `${height}px`;
        element.style.minHeight = `${height}px`;
        element.style.maxHeight = `${height}px`;
      };
      
      // ì…ë ¥ í•„ë“œ ê³µí†µ ìŠ¤íƒ€ì¼
      const setInputStyle = (input) => {
        input.style.height = `${inputHeight}px`;
        input.style.textAlign = 'center';
        input.style.textAlignLast = 'center';
        input.style.padding = '0';
        input.style.margin = '0';
      };
      
      // í–‰ ë†’ì´ ì„¤ì •
      setRowHeight(row, headerHeight);
      
      // ì…€ ë†’ì´ ë° ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ì„¤ì •
        const cells = row.querySelectorAll('td');
        cells.forEach(cell => {
        setRowHeight(cell, headerHeight);
        cell.querySelectorAll('input, select').forEach(setInputStyle);
      });
      
      // DOM ìš”ì†Œë“¤ í•œ ë²ˆì— ì¿¼ë¦¬
        const commissionInput = row.querySelector('td:nth-child(6) input');
      const priceInput = row.querySelector('td:nth-child(7) input');
      
      // 6ì—´ ìˆ˜ìˆ˜ë£Œ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (commissionInput) {
        ['input', 'change'].forEach(eventType => {
          commissionInput.addEventListener(eventType, () => calculateCategory2Price(row));
        });
      }
      
      // 7ì—´ ê°€ê²© ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (priceInput) {
        const handlePriceChange = () => {
            priceInput.removeAttribute('data-fixed-value');
            calculateTotal();
        };
        ['input', 'change'].forEach(eventType => {
          priceInput.addEventListener(eventType, function() {
            handlePriceChange();
            // ì¹´í…Œê³ ë¦¬1 subtotal ì—…ë°ì´íŠ¸
            addCategory1SubtotalRow();
          });
        });
      }
        
      // 1ì—´ ë“œëë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const typeSelect = row.querySelector('td:nth-child(1) select');
        if (typeSelect) {
          typeSelect.addEventListener('change', async function() {
            const selectedType = this.value;
            const creditNoteSelect = row.querySelector('td:nth-child(3) select');
          
          // ëª¨ë“  ì—´ ì´ˆê¸°í™”
          resetCategory2Row(row);
            
            if (selectedType === 'Credit Note' && creditNoteSelect) {
              // creditnoteno ëª©ë¡ ë¡œë“œ
              const creditNoteNumbers = await loadCreditNoteNumbers();
              
              // ê¸°ì¡´ ì˜µì…˜ë“¤ ì œê±° (Choose ì œì™¸)
              while (creditNoteSelect.children.length > 1) {
                creditNoteSelect.removeChild(creditNoteSelect.lastChild);
              }
              
              // creditnoteno ì˜µì…˜ë“¤ ì¶”ê°€
              creditNoteNumbers.forEach(creditNoteNo => {
                const option = document.createElement('option');
                option.value = creditNoteNo;
                option.textContent = creditNoteNo;
                creditNoteSelect.appendChild(option);
              });
              
            // 3ì—´ ë“œëë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
              creditNoteSelect.addEventListener('change', async function() {
                const selectedCreditNoteNo = this.value;
                const dateInput = row.querySelector('td:nth-child(4) input');
                const commissionInput = row.querySelector('td:nth-child(6) input');
                
                if (selectedCreditNoteNo && (dateInput || commissionInput)) {
                  await loadCreditNoteData(selectedCreditNoteNo, dateInput, commissionInput);
                } else {
                  if (dateInput) dateInput.value = '';
                  if (commissionInput) commissionInput.value = '';
                }
              });
              
            } else if (selectedType === 'Less Payment') {
              // Less Payment ì„ íƒ ì‹œ 5ì—´ê³¼ 6ì—´ì„ í•©ì¹˜ê¸°
              mergeCellsWithText(row, 'The outstanding balance<br>from the previous remittance');
              
              // Less Payment ì„ íƒ ì‹œ 3ì—´ì— l/pno ë¡œë“œ
              if (creditNoteSelect) {
                creditNoteSelect.value = '';
                // ê¸°ì¡´ ì˜µì…˜ë“¤ ì œê±° (Choose ì œì™¸)
                while (creditNoteSelect.children.length > 1) {
                  creditNoteSelect.removeChild(creditNoteSelect.lastChild);
                }
                
                // l/pno ë¡œë“œ
                await loadLpNumbers(creditNoteSelect);
                
                // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆë¡œ ë“±ë¡ (Less Paymentìš©)
                creditNoteSelect.removeEventListener('change', creditNoteSelect.lessPaymentHandler);
                creditNoteSelect.lessPaymentHandler = async function() {
                  const selectedLpno = this.value;
                  const dateInput = row.querySelector('td:nth-child(4) input');
                  const priceInput = row.querySelector('td:nth-child(7) input');
                  
                  
                  if (selectedLpno) {
                    // 4ì—´ì— l/pdate ë¡œë“œí•˜ê³  7ì—´ì— l/pdollar ì§ì ‘ ë¡œë“œ
                    await loadLpData(selectedLpno, dateInput, priceInput);
                  } else {
                    if (dateInput) dateInput.value = '';
                    if (priceInput) priceInput.value = '';
                  }
                };
                creditNoteSelect.addEventListener('change', creditNoteSelect.lessPaymentHandler);
              }
              
            } else if (selectedType === 'Over Payment') {
              // Over Payment ì„ íƒ ì‹œ 5ì—´ê³¼ 6ì—´ì„ í•©ì¹˜ê¸°
              mergeCellsWithText(row, 'Proforma Invoice was<br>higher than Invoice');
              
              // Over Payment ì„ íƒ ì‹œ 3ì—´ì— o/pno ë¡œë“œ
              if (creditNoteSelect) {
                creditNoteSelect.value = '';
                // ê¸°ì¡´ ì˜µì…˜ë“¤ ì œê±° (Choose ì œì™¸)
                while (creditNoteSelect.children.length > 1) {
                  creditNoteSelect.removeChild(creditNoteSelect.lastChild);
                }
                
                // o/pno ë¡œë“œ
                await loadOverPaymentNumbers(creditNoteSelect);
                
                // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆë¡œ ë“±ë¡ (Over Paymentìš©)
                creditNoteSelect.removeEventListener('change', creditNoteSelect.overPaymentHandler);
                creditNoteSelect.overPaymentHandler = async function() {
                  const selectedOpno = this.value;
                  const dateInput = row.querySelector('td:nth-child(4) input');
                  const priceInput = row.querySelector('td:nth-child(7) input');
                  
                  if (selectedOpno) {
                    await loadOverPaymentData(selectedOpno, dateInput, priceInput, true);
                  } else {
                    if (dateInput) dateInput.value = '';
                    if (priceInput) priceInput.value = '';
                  }
                };
                creditNoteSelect.addEventListener('change', creditNoteSelect.overPaymentHandler);
              }
            } else {
              // Choose ì„ íƒ ì‹œ 5-6ì—´ ì›ë˜ëŒ€ë¡œ ë³µì› (Less Paymentë‚˜ Over Paymentê°€ ì•„ë‹Œ ê²½ìš°ë§Œ)
              const dueDateCell = row.querySelector('td:nth-child(5)');
              const commissionCell = row.querySelector('td:nth-child(6)');
              
              // í˜„ì¬ ì„ íƒëœ íƒ€ì…ì´ Less Paymentë‚˜ Over Paymentê°€ ì•„ë‹Œ ê²½ìš°ë§Œ ë³µì›
              const currentType = typeSelect.value;
              if (currentType !== 'Less Payment' && currentType !== 'Over Payment' && dueDateCell && commissionCell) {
                restoreCells(dueDateCell, commissionCell);
              }
              
              // Choose ì„ íƒ ì‹œ ì´ˆê¸°í™”
              if (creditNoteSelect) {
                creditNoteSelect.value = '';
                while (creditNoteSelect.children.length > 1) {
                  creditNoteSelect.removeChild(creditNoteSelect.lastChild);
                }
                clearInputFields(row);
              }
            }
          });
        }
      
      // í–‰ ì¶”ê°€ í›„ í˜„ì¬ í–‰ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      displayCurrentRows();
    }

    // í˜„ì¬ ì¶”ê°€ëœ í–‰ë“¤ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function displayCurrentRows() {
      const currentRowsList = document.getElementById('currentRowsList');
      if (!currentRowsList) return;
      
      const category2Rows = document.querySelectorAll('.category2-row');
      
      if (category2Rows.length === 0) {
        currentRowsList.innerHTML = '<div class="row-item"><div class="row-info">ì¶”ê°€ëœ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>';
        return;
      }
      
      const rowsHtml = Array.from(category2Rows).map((row, index) => {
          const typeSelect = row.querySelector('td:nth-child(1) select');
          const itemSelect = row.querySelector('td:nth-child(3) select');
        
        const type = typeSelect?.value || '';
        const item = itemSelect?.value || '';
        
        // Less Paymentì™€ Over Paymentì˜ ê²½ìš° 5ì—´ì— ìˆëŠ” ë¬¸êµ¬ë¥¼ ê°€ì ¸ì˜¤ê¸°
        let currentText = '';
        if (type === 'Less Payment' || type === 'Over Payment') {
          const mergedCell = row.querySelector('td[colspan="2"]');
          if (mergedCell) {
            const textDiv = mergedCell.querySelector('div');
            currentText = textDiv?.textContent.trim() || '';
          }
        } else {
          // Credit Noteì˜ ê²½ìš° ê¸°ì¡´ ë¡œì§
          const amountDiv = row.querySelector('td:nth-child(5) div');
          currentText = amountDiv?.textContent.trim() || '';
        }
        
        const displayText = [type, item, currentText].filter(Boolean).join(' - ');
        
        return `
            <div class="row-item" id="row-item-${index}">
            <div class="row-info">${index + 1}. ${displayText}</div>
              <div class="row-actions">
                <button onclick="editRowText(${index})" class="edit-btn">ìˆ˜ì •</button>
                <button onclick="deleteRow(${index})" class="delete-btn">ì‚­ì œ</button>
              </div>
            </div>
          `;
      }).join('');
      
      currentRowsList.innerHTML = rowsHtml;
    }
    
    // í–‰ ìˆ˜ì • í•¨ìˆ˜
    function editRow(index) {
      const row = document.querySelectorAll('.category2-row')[index];
      if (!row) return;
      
      row.scrollIntoView({ behavior: 'smooth', block: 'center' });
      row.style.backgroundColor = '#ffffcc';
      setTimeout(() => row.style.backgroundColor = '', 2000);
    }
    
    // í…ìŠ¤íŠ¸ í¸ì§‘ í•¨ìˆ˜
    function editRowText(index) {
      const row = document.querySelectorAll('.category2-row')[index];
      const amountDiv = row?.querySelector('td:nth-child(5) div');
      
      if (!amountDiv) return;
      
      const currentText = amountDiv.textContent.trim();
      const newText = prompt('í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”:', currentText);
      
      if (newText !== null && newText !== currentText) {
        amountDiv.innerHTML = newText.replace(/\n/g, '<br>');
        displayCurrentRows();
      }
    }
    
    // í–‰ ì‚­ì œ í•¨ìˆ˜
    function deleteRow(index) {
      const row = document.querySelectorAll('.category2-row')[index];
      if (row) {
        row.remove();
        displayCurrentRows();
      }
    }
    
     // ëª¨ë“  í–‰ ì‚­ì œ í•¨ìˆ˜ (2% discount í–‰ ì œì™¸)
     function clearAllRows() {
       // category2-rowë§Œ ì‚­ì œ (2% discount í–‰ì€ category1-subtotal-rowì´ë¯€ë¡œ ì œì™¸ë¨)
       document.querySelectorAll('.category2-row').forEach(row => row.remove());
       displayCurrentRows();
     }
     
     // 2% discount í–‰ë§Œ ì œê±°í•˜ëŠ” í•¨ìˆ˜
     function removeDiscountRows() {
       const discountRows = Array.from(document.querySelectorAll('tr')).filter(row => 
         row.querySelector('td:nth-child(1)')?.textContent?.includes('2% discount') ||
         row.querySelector('td:nth-child(2)')?.textContent?.includes('2% discount')
       );
       
       discountRows.forEach(row => row.remove());
       displayCurrentRows();
       
       console.log(`âœ… ${discountRows.length}ê°œì˜ 2% discount í–‰ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
     }
    
    // ëª¨ë‘ ì ìš© í•¨ìˆ˜ - ê¸°ì¡´ (+)Add ë²„íŠ¼ì„ ì‚¬ìš©í•´ì„œ í–‰ ì¶”ê°€ (2% discount í–‰ ì œì™¸)
    async function applyAllItems() {
      try {
        // ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ 2 í–‰ë§Œ ì‚­ì œ (2% discount í–‰ì€ category1-subtotal-rowì´ë¯€ë¡œ ì œì™¸ë¨)
        document.querySelectorAll('.category2-row').forEach(row => row.remove());
        
        // Credit Note ë°ì´í„° ë¡œë“œ
        const response = await fetch('/api/creditnote');
        const creditNoteData = await response.json();
        
        // ì‚¬ìš© ê°€ëŠ¥í•œ í•­ëª©ë“¤ ìˆ˜ì§‘ (ë‹¨ì¼ ë£¨í”„ë¡œ í†µí•©)
        const availableItems = creditNoteData
          .filter(item => !item.isused)
          .flatMap(item => [
            ...(item['l/pno'] ? [{ type: 'Less Payment', no: item['l/pno'] }] : []),
            ...(item['o/pno'] ? [{ type: 'Over Payment', no: item['o/pno'] }] : []),
            ...(item['c/nno'] ? [{ type: 'Credit Note', no: item['c/nno'] }] : [])
          ])
          .sort((a, b) => {
          const typeOrder = { 'Less Payment': 1, 'Over Payment': 2, 'Credit Note': 3 };
          return typeOrder[a.type] - typeOrder[b.type];
        });
        
        // ê° í•­ëª©ì— ëŒ€í•´ í–‰ ì¶”ê°€
        for (const item of availableItems) {
          document.getElementById('addCategory2Btn').click();
          
          // DOM ì—…ë°ì´íŠ¸ ëŒ€ê¸°
          await new Promise(resolve => setTimeout(resolve, 50));
          
          const category2Rows = document.querySelectorAll('.category2-row');
          const newRow = category2Rows[category2Rows.length - 1];
          
          if (newRow) {
            const typeSelect = newRow.querySelector('td:nth-child(1) select');
            const itemSelect = newRow.querySelector('td:nth-child(3) select');
            
            if (typeSelect && itemSelect) {
              typeSelect.value = item.type;
              typeSelect.dispatchEvent(new Event('change'));
              
              await new Promise(resolve => setTimeout(resolve, 100));
              
                itemSelect.value = item.no;
                itemSelect.dispatchEvent(new Event('change'));
            }
          }
        }
        
        // ì •ë ¬ ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (2% discount í–‰ì€ organizeTableì—ì„œ ë³´ì¡´ë¨)
        organizeTable();
        displayCurrentRows();
        
      } catch (error) {
      }
    }
    
    

    // í…Œì´ë¸” ì •ë ¬ í•¨ìˆ˜
    function organizeTable() {
      const tbody = document.getElementById('orderTbody');
      const rows = Array.from(tbody.querySelectorAll('tr:not(.total-row):not(.category1-subtotal-row)'));
      
      // 2% discount í–‰ ë³´ì¡´ (ì œì™¸í•˜ì§€ ì•ŠìŒ)
      const discountRows = Array.from(tbody.querySelectorAll('tr.category1-subtotal-row'));
      
      // ìˆ«ì ì¶”ì¶œ í—¬í¼ í•¨ìˆ˜
      const extractNumber = (value, prefix = '') => {
        const cleanValue = prefix ? value.replace(prefix, '') : value;
        return parseInt(cleanValue.replace(/[^\d]/g, '')) || 0;
      };
      
      // í–‰ ë¶„ë¥˜ ë° ì •ë ¬
      const category1Rows = rows.filter(row => row.classList.contains('category1-row'))
        .sort((a, b) => {
          const [aSelect, bSelect] = [a, b].map(row => row.querySelector('td:nth-child(1) select'));
        if (!aSelect || !bSelect) return 0;
          return extractNumber(bSelect.value, 'EK-') - extractNumber(aSelect.value, 'EK-');
        });
      
      const category2Rows = rows.filter(row => row.classList.contains('category2-row'))
        .sort((a, b) => {
          const [aSelect, bSelect] = [a, b].map(row => row.querySelector('td:nth-child(1) select'));
        if (!aSelect || !bSelect) return 0;
        
          const [aValue, bValue] = [aSelect.value, bSelect.value];
          const typeOrder = { 'Less Payment': 1, 'Over Payment': 2, 'Credit Note': 3 };
          const typeDiff = typeOrder[aValue] - typeOrder[bValue];
          
          if (typeDiff !== 0) return typeDiff;
          
          const [aItemSelect, bItemSelect] = [a, b].map(row => row.querySelector('td:nth-child(3) select'));
          if (aItemSelect && bItemSelect) {
            return extractNumber(aItemSelect.value) - extractNumber(bItemSelect.value);
          }
        return 0;
      });
      
      // DOM ì¬êµ¬ì„± (2% discount í–‰ ë³´ì¡´)
      const totalRow = tbody.querySelector('.total-row');
      rows.forEach(row => row.remove());
      
      // category1 í–‰ë“¤ ì¶”ê°€ í›„, ê° category1 ê·¸ë£¹ ë’¤ì— í•´ë‹¹í•˜ëŠ” discount í–‰ ì¶”ê°€
      category1Rows.forEach((category1Row, index) => {
        tbody.appendChild(category1Row);
        
        // ë§ˆì§€ë§‰ category1 í–‰ ë’¤ì— discount í–‰ ì¶”ê°€
        if (index === category1Rows.length - 1 && discountRows.length > 0) {
          discountRows.forEach(discountRow => {
            category1Row.insertAdjacentElement('afterend', discountRow);
          });
        }
      });
      
      // category2 í–‰ë“¤ ì¶”ê°€
      category2Rows.forEach(row => tbody.appendChild(row));
      
      if (totalRow) tbody.appendChild(totalRow);
      
      displayCurrentRows();
    }


    // ê³µí†µ Swift ë°ì´í„° ì €ì¥ í•¨ìˆ˜ (ì¹´í…Œê³ ë¦¬ë³„ API í˜¸ì¶œ)
    async function saveSwiftDataCommon(fields) {
      try {
        const swiftDate = document.getElementById('orderDateInput').value;
        const swiftAmount = document.getElementById('totalAmountInput').value;
        
        if (!swiftDate || !swiftAmount) {
          alert('Dateì™€ Total Amountë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        const deliveryNos = Array.from(document.querySelectorAll('.category1-row'))
          .map(row => row.querySelector('td:nth-child(1) select')?.value)
          .filter(Boolean);
        
        if (deliveryNos.length === 0) {
          alert('ì¹´í…Œê³ ë¦¬ 1 í–‰ì—ì„œ deliveryNoë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // ê° deliveryNoë³„ë¡œ ëª¨ë“  ì£¼ë¬¸ ì—…ë°ì´íŠ¸ (shipmentarchive ë°©ì‹)
        let totalUpdated = 0;
        let totalSkipped = 0;
        let hasError = false;
        
        for (const deliveryNo of deliveryNos) {
          console.log(`[SWIFT] ${deliveryNo} ì²˜ë¦¬ ì‹œì‘`);
          
          // 1. deliveryNoë¡œ ëª¨ë“  ì£¼ë¬¸ ì°¾ê¸°
          const allOrdersResponse = await fetch('/api/orders');
          const allOrders = await allOrdersResponse.json();
          
          // 2. deliveryNoê°€ í¬í•¨ëœ ëª¨ë“  ì£¼ë¬¸ ì°¾ê¸°
          const matchingOrders = allOrders.filter(order => 
            order.items && order.items.some(item => item.deliveryNo === deliveryNo)
          );
          
          console.log(`[SWIFT] ${deliveryNo} ë§¤ì¹­ ì£¼ë¬¸: ${matchingOrders.length}ê°œ`);
          
          // 3. ê° ì£¼ë¬¸ë³„ë¡œ ê°œë³„ ì—…ë°ì´íŠ¸
          for (const order of matchingOrders) {
            try {
              const response = await fetch('/api/updateOrder', {
          method: 'POST',
                headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
                  searchOrderBy: 'orderNo',
                  orderNo: order.orderNo,
                  searchMethod: 'deliveryNo',
                  items: [{
                    deliveryNo: deliveryNo,
                    [fields.date]: swiftDate,
                    [fields.amount]: swiftAmount
                  }],
                  itemUpdateFields: [fields.date, fields.amount]
          })
        });
        
              if (response.ok) {
                const result = await response.json();
                totalUpdated += result.updatedItems || 0;
                totalSkipped += result.skippedItems || 0;
                console.log(`[SWIFT] ${order.orderNo} ì—…ë°ì´íŠ¸ ì„±ê³µ: ${result.updatedItems}ê°œ ì•„ì´í…œ`);
        } else {
                console.error(`[SWIFT] ${order.orderNo} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, response.status);
                hasError = true;
        }
      } catch (error) {
              console.error(`[SWIFT] ${order.orderNo} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
              hasError = true;
            }
          }
        }
        
        // 4. ê²°ê³¼ í‘œì‹œ
        if (totalUpdated > 0) {
          alert(`${fields.name} ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${totalUpdated}ê°œ${totalSkipped > 0 ? `, ê±´ë„ˆë›´ ì•„ì´í…œ: ${totalSkipped}ê°œ` : ''}`);
        } else if (hasError) {
          alert(`ì¼ë¶€ ${fields.name} ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${totalUpdated}ê°œ, ê±´ë„ˆë›´ ì•„ì´í…œ: ${totalSkipped}ê°œ`);
        } else {
          alert(`${fields.name} ì—…ë°ì´íŠ¸í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
        }
        
      } catch (error) {
        console.error(`[SWIFT] ${fields.name} ì €ì¥ ì‹¤íŒ¨:`, error);
        alert(`${fields.name} ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
      }
    }

    // Save ë²„íŠ¼ ê¸°ëŠ¥: Swift ë°ì´í„°ë¥¼ orderData.jsonì— ì €ì¥
    async function saveSwiftData() {
      await saveSwiftDataCommon({
        name: 'Swift',
        date: 'swiftdate',
        amount: 'swiftamount'
      });
    }

    // Save2 ë²„íŠ¼ ê¸°ëŠ¥: Swift ë°ì´í„°ë¥¼ orderData.jsonì— ì €ì¥ (swiftdate2, swiftamount2)
    async function saveSwiftData2() {
      await saveSwiftDataCommon({
        name: 'Swift2',
        date: 'swiftdate2',
        amount: 'swiftamount2'
      });
    }

    // Used ë²„íŠ¼ ê¸°ëŠ¥: Category 2ì˜ c/nnoì™€ o/pnoë¥¼ creditnote.jsonì—ì„œ isused: trueë¡œ ì €ì¥
    async function markItemsAsUsed() {
      try {
        const category2Rows = document.querySelectorAll('.category2-row');
        const itemsToMark = [];
        
        // ê° Category 2 í–‰ì—ì„œ c/nno, o/pno, l/pno ì¶”ì¶œ
        category2Rows.forEach(row => {
          const typeSelect = row.querySelector('td:nth-child(1) select');
          if (!typeSelect?.value) return;
          
            const type = typeSelect.value;
            const allSelects = row.querySelectorAll('select');
            
          for (let i = 1; i < allSelects.length; i++) {
              const select = allSelects[i];
            if (select.value && !['Less Payment', 'Credit Note', 'Over Payment'].includes(select.value)) {
              const typeMap = {
                'Credit Note': 'c/nno',
                'Over Payment': 'o/pno', 
                'Less Payment': 'l/pno'
              };
              
              if (typeMap[type]) {
                itemsToMark.push({ type: typeMap[type], value: select.value });
              }
                break;
            }
          }
        });
        
        if (itemsToMark.length === 0) {
          alert('ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” Credit Note, Over Payment, ë˜ëŠ” Less Paymentê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        // ê° í•­ëª©ì„ ë³‘ë ¬ë¡œ ì²˜ë¦¬
        const updatePromises = itemsToMark.map(async (item) => {
          try {
            const response = await fetch('/api/creditnote', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                action: 'updateField',
                identifier: item.value,
                field: 'isused',
                value: true
              })
            });
            
            return response.ok ? 1 : 0;
          } catch (error) {
            return 0;
          }
        });
        
        const results = await Promise.all(updatePromises);
        const updatedCount = results.reduce((sum, count) => sum + count, 0);
        
        if (updatedCount > 0) {
          alert(`${updatedCount}ê°œì˜ í•­ëª©ì´ ì‚¬ìš©ë¨ìœ¼ë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } else {
          alert('ì—…ë°ì´íŠ¸í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
        }
        
      } catch (error) {
        alert('Used ê¸°ëŠ¥ ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    // PDF ìƒì„± í•¨ìˆ˜ (A4 í˜ì´ì§€ ë‹¨ìœ„)
    async function generatePDF() {
      const buttonBox = document.querySelector('.main-button-group');
      const originalDisplay = buttonBox?.style.display;
        
      try {
        const orderDate = document.getElementById('orderDateInput').value;
        if (!orderDate) {
          alert('Dateë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        // ë²„íŠ¼ ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
        if (buttonBox) buttonBox.style.display = 'none';

        const page = document.getElementById('page1');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });

        // html2canvasë¡œ í˜ì´ì§€ ìº¡ì²˜
          const canvas = await html2canvas(page, {
            scale: 1.5,
            useCORS: true,
            letterRendering: true,
            allowTaint: true,
            backgroundColor: '#ffffff',
            width: page.offsetWidth,
            height: page.offsetHeight,
            scrollX: 0,
            scrollY: 0
          });

        // A4 ë¹„ìœ¨ì— ë§ê²Œ ì´ë¯¸ì§€ í¬ê¸° ê³„ì‚°
          const canvasAspectRatio = canvas.width / canvas.height;
          const a4AspectRatio = 210 / 297;
          
        const isWider = canvasAspectRatio > a4AspectRatio;
        const imgWidth = isWider ? 210 : 297 * canvasAspectRatio;
        const imgHeight = isWider ? 210 / canvasAspectRatio : 297;
        const x = isWider ? 0 : (210 - imgWidth) / 2;
        const y = isWider ? (297 - imgHeight) / 2 : 0;
        
        // PDFì— ì´ë¯¸ì§€ ì¶”ê°€
        const imgData = canvas.toDataURL('image/png', 0.95);
          doc.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight, undefined, 'FAST');
          
        // íŒŒì¼ëª… ê²°ì •
        const corpInput = document.querySelector('.category1-row td:nth-child(2) input');
        const corpValue = corpInput?.value?.trim();
        const fileName = corpValue === 'NT' ? `ELTRO_Swift_${orderDate}` :
                        corpValue === 'SM' ? `SM_Swift_${orderDate}` :
                        `Swift_${orderDate}`;
        
        doc.save(`${fileName}.pdf`);
        
      } catch (error) {
        alert('PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      } finally {
        // ë²„íŠ¼ ë°•ìŠ¤ ë³µì›
        if (buttonBox) buttonBox.style.display = originalDisplay || '';
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ë° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.addEventListener('DOMContentLoaded', function() {
      initializePage();
      
      // ì´ˆê¸° Total í–‰ ì¶”ê°€
      const tbody = document.getElementById('orderTbody');
      tbody.appendChild(createTotalRow());
      calculateTotal();
      
      // Exchange Rate ì…ë ¥ í•„ë“œ ì„¤ì •
      const exchangeRateInput = document.getElementById('exchangeRateInput');
      if (exchangeRateInput) {
          const table7thColumn = document.querySelector('.order-body table thead th:nth-child(7)');
          if (table7thColumn) {
            const columnWidth = table7thColumn.offsetWidth;
          Object.assign(exchangeRateInput.style, {
            width: `${columnWidth}px`,
            minWidth: `${columnWidth}px`,
            maxWidth: `${columnWidth}px`
          });
        }
        
        exchangeRateInput.addEventListener('input', () => {
          document.querySelectorAll('.category2-row').forEach(calculateCategory2Price);
        });
      }
      
      // í™˜ìœ¨ ë¡œë“œ í•¨ìˆ˜
      async function loadExchangeRate(selectedDate) {
        if (!selectedDate?.trim()) return;
        
        // ë‚ ì§œ í˜•ì‹ ë³€í™˜ ë° ê²€ì¦ (DD.MM.YYYY -> YYYY-MM-DD)
        let formattedDate;
        if (selectedDate.includes('.')) {
          const parts = selectedDate.split('.');
          if (parts.length === 3) {
            const [day, month, year] = parts;
            formattedDate = `${year}-${month}-${day}`;
          } else {
          return;
          }
        } else {
          formattedDate = selectedDate;
        }
        
        if (!/^\d{4}-\d{2}-\d{2}$/.test(formattedDate)) return;
          
          const exchangeRateInput = document.getElementById('exchangeRateInput');
        if (!exchangeRateInput) return;
        
        // í™˜ìœ¨ ì„¤ì • ë° ì¬ê³„ì‚° ê³µí†µ í•¨ìˆ˜
        const setRateAndRecalculate = (rate) => {
          const roundedRate = Math.ceil(rate * 100) / 100;
          exchangeRateInput.value = roundedRate.toFixed(2);
          document.querySelectorAll('.category2-row').forEach(calculateCategory2Price);
        };
        
        try {
          // API í˜¸ì¶œ ì‹œë„
            const apiUrl = `https://api.exchangeratesapi.io/${formattedDate}?base=EUR&symbols=USD&access_key=f6ab89bba805dc150972c7410a6d9b5d`;
            const response = await fetch(apiUrl);
            
            if (response.ok) {
              const data = await response.json();
            const rate = data.rates?.USD || data.USD || data.result?.USD;
              if (rate) {
              setRateAndRecalculate(rate);
                return;
              }
          }
              
              // ëŒ€ì•ˆ: ìµœì‹  í™˜ìœ¨ API
          const latestResponse = await fetch('https://api.exchangerate-api.com/v4/latest/EUR');
              if (latestResponse.ok) {
                const latestData = await latestResponse.json();
            setRateAndRecalculate(latestData.rates.USD);
                return;
          }
          
        } catch (error) {
        }
        
        // ê¸°ë³¸ í™˜ìœ¨ ì‚¬ìš©
        setRateAndRecalculate(1.0856);
      }
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      const eventHandlers = {
        expandButton: () => {
        const detailArea = document.getElementById("detailButtonArea");
        const expandBtn = document.getElementById("expandButton");
          const isExpanded = detailArea.style.display !== "none";
          
          detailArea.style.display = isExpanded ? "none" : "flex";
          expandBtn.classList.toggle("expanded", !isExpanded);
          expandBtn.textContent = isExpanded ? "â–¼" : "â–²";
          if (!isExpanded) displayCurrentRows();
        },
        organizeBtn: organizeTable,
        pdfBtn: generatePDF,
        usedBtn: async (event) => {
        event.preventDefault();
        event.stopPropagation();
        await markItemsAsUsed();
        },
        saveBtn: saveSwiftData,
        save2Btn: saveSwiftData2,
        homeBtn: () => window.location.href = 'eltrokorea9.html',
          exchangeBtn: async () => {
            const orderDateInput = document.getElementById('orderDateInput');
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const defaultDate = `${day}.${month}.${year}`;
            const date = orderDateInput?.value || defaultDate;
            await loadExchangeRate(date);
          },
        refreshRowsBtn: removeDiscountRows,
        clearRowsBtn: clearAllRows,
        applyAllBtn: applyAllItems,
        addCategory1Btn: addCategory1Row,
        addCategory2Btn: addCategory2Row
      };

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      Object.entries(eventHandlers).forEach(([id, handler]) => {
        const element = document.getElementById(id);
        if (element) element.addEventListener("click", handler);
      });


    });
  </script>

  <!-- jQuery for AJAX -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- PDF ìƒì„±ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


  <!-- í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ -->
  <div class="bottom-buttons">
    <!-- í™•ì¥/ì¶•ì†Œ ë²„íŠ¼ (ì„œë ì†ì¡ì´ì²˜ëŸ¼ ìœ„ìª½ì— íŠ€ì–´ë‚˜ì˜´) -->
    <div class="expand-handle">
      <button id="expandButton" type="button" class="expand-btn">â–¼</button>
    </div>
    
         <!-- ê¸°ë³¸ ë²„íŠ¼ ì˜ì—­ (í•­ìƒ ë³´ì„) -->
     <div class="main-button-group">
       <div class="left-buttons">
         <button id="homeBtn">Home</button>
         <button id="addCategory1Btn">(+)Add</button>
         <button id="addCategory2Btn">(-)Add</button>
         <button id="organizeBtn">Organize</button>
         <button id="exchangeBtn">â‚¬:$</button>
       </div>
       <div class="right-buttons">
         <button id="pdfBtn">PDF</button>
         <button id="usedBtn">Used</button>
         <button id="saveBtn">Save</button>
         <button id="save2Btn">Save2</button>
       </div>
     </div>
    
    <!-- í™•ì¥ ê°€ëŠ¥í•œ ìƒì„¸ ë²„íŠ¼ ì˜ì—­ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€) -->
    <div id="detailButtonArea" class="detail-button-area" style="display: none;">
      <div class="current-rows-info">
        <div id="currentRowsList" class="rows-list">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  í–‰ ëª©ë¡ -->
        </div>
        <div class="rows-actions">
          <button id="refreshRowsBtn" class="action-btn">2% ì œê±°</button>
          <button id="clearRowsBtn" class="action-btn">ëª¨ë‘ ì‚­ì œ</button>
          <button id="applyAllBtn" class="action-btn">ëª¨ë‘ ì ìš©</button>
        </div>
      </div>
    </div>
  </div>
    
    <script>
    // ê³µí†µ orderData ë¡œë“œ í•¨ìˆ˜
    let cachedOrderData = null;
    async function getOrderData() {
      if (!cachedOrderData) {
        const response = await fetch('orderData.json');
        cachedOrderData = await response.json();
      }
      return cachedOrderData;
    }

    // p/ino ì„ íƒì— ë”°ë¼ ë‚ ì§œì™€ ê°€ê²© ë¡œë“œ í•¨ìˆ˜
    async function loadPinoData(deliveryNo, pino, row) {
      try {
        const orderData = await getOrderData();
        
        // í•´ë‹¹ deliveryNoë¥¼ ê°€ì§„ ì•„ì´í…œ ì°¾ê¸°
        const foundItem = orderData
          .flatMap(order => order.items || [])
          .find(item => item.deliveryNo === deliveryNo && 
                      (pino === item['p/ino'] || pino === item['p/ino2']));
        
        if (foundItem) {
          const isPino2 = pino === foundItem['p/ino2'];
          const foundDate = isPino2 ? foundItem['p/idate2'] : foundItem['p/idate'];
          const foundPrice = isPino2 ? foundItem['p/iprice2'] : foundItem['p/iprice'];
        
        // 4ì—´(ë‚ ì§œ)ê³¼ 7ì—´(ê°€ê²©)ì— ê°’ ì„¤ì •
        const dateInput = row.querySelector('td:nth-child(4) input');
        const priceInput = row.querySelector('td:nth-child(7) input');
        
          if (dateInput) dateInput.value = foundDate || '';
        if (priceInput) {
            priceInput.value = foundPrice || '';
          calculateTotal();
          }
        }
        
      } catch (error) {
      }
    }

    // deliveryNoì— ë”°ë¼ p/ino ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    async function updatePinoDropdown(deliveryNo, pinoSelect) {
      try {
        const orderData = await getOrderData();
        
        // í•´ë‹¹ deliveryNoë¥¼ ê°€ì§„ ì²« ë²ˆì§¸ ì•„ì´í…œ ì°¾ê¸°
        const foundItem = orderData
          .flatMap(order => order.items || [])
          .find(item => item.deliveryNo === deliveryNo);
        
        const pino = foundItem?.['p/ino'] || '';
        const pino2 = foundItem?.['p/ino2'] || '';
        
        // ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì—…ë°ì´íŠ¸
        pinoSelect.innerHTML = '<option value="" style="text-align: center;">Choose</option>';
        
        [pino, pino2].filter(Boolean).forEach((pinoValue, index) => {
          const option = document.createElement('option');
          option.value = pinoValue;
          option.textContent = pinoValue;
          option.style.textAlign = 'center';
          if (index === 0) option.selected = true; // ì²« ë²ˆì§¸ p/inoë¥¼ ê¸°ë³¸ ì„ íƒ
          pinoSelect.appendChild(option);
        });
        
        // p/inoê°€ ê¸°ë³¸ ì„ íƒëœ ê²½ìš° ìë™ìœ¼ë¡œ ë‚ ì§œì™€ ê°€ê²© ë¡œë“œ
        if (pino) {
          const row = pinoSelect.closest('tr');
          if (row) {
            await loadPinoData(deliveryNo, pino, row);
            
            // ìë™ ë¡œë“œëœ p/inoì— ëŒ€í•´ì„œë„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const category1Rows = document.querySelectorAll('.category1-row');
            const isFirstCategory1Row = category1Rows.length > 0 && row === category1Rows[0];
            
            if (isFirstCategory1Row) {
              console.log('ğŸ” ìë™ ë¡œë“œëœ p/inoë¡œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸');
              console.log('  - auto-loaded pino:', pino);
              console.log('  - row:', row);
              
              const save2Btn = document.getElementById('save2Btn');
              const saveBtn = document.getElementById('saveBtn');
              
              if (pino && save2Btn && saveBtn) {
                // p/ino2 ê°’ë“¤ í™•ì¸ (ì‹¤ì œ ë°ì´í„°ì—ì„œ p/ino2 í•„ë“œ ê°’ë“¤)
                const pino2Values = ['8993014165', '8993013490']; // ì‹¤ì œ p/ino2 ê°’ë“¤
                
                if (pino2Values.includes(pino)) {
                  console.log('âœ… ìë™ ë¡œë“œëœ p/ino2 - Save2 ë²„íŠ¼ í™œì„±í™”, Save ë²„íŠ¼ ë¹„í™œì„±í™”');
                  // Save2 ë²„íŠ¼ í™œì„±í™” (ê²€ì •ìƒ‰)
                  save2Btn.classList.add('save2-selected');
                  save2Btn.style.backgroundColor = '#000';
                  save2Btn.style.color = '#fff';
                  save2Btn.style.borderColor = '#000';
                  save2Btn.disabled = false;
                  save2Btn.style.opacity = '1';
                  save2Btn.style.cursor = 'pointer';
                  
                  // Save ë²„íŠ¼ ë¹„í™œì„±í™”
                  saveBtn.disabled = true;
                  saveBtn.style.opacity = '0.5';
                  saveBtn.style.cursor = 'not-allowed';
                  saveBtn.classList.remove('save2-selected');
                  saveBtn.style.backgroundColor = '';
                  saveBtn.style.color = '';
                  saveBtn.style.borderColor = '';
                } else {
                  console.log('âŒ ìë™ ë¡œë“œëœ ì¼ë°˜ p/ino - Save ë²„íŠ¼ í™œì„±í™”, Save2 ë²„íŠ¼ ë¹„í™œì„±í™”');
                  // Save ë²„íŠ¼ í™œì„±í™” (ê¸°ë³¸ ìƒíƒœ)
                  saveBtn.disabled = false;
                  saveBtn.style.opacity = '1';
                  saveBtn.style.cursor = 'pointer';
                  saveBtn.classList.remove('save2-selected');
                  saveBtn.style.backgroundColor = '';
                  saveBtn.style.color = '';
                  saveBtn.style.borderColor = '';
                  
                  // Save2 ë²„íŠ¼ ë¹„í™œì„±í™” (ê¸°ë³¸ ìƒíƒœ)
                  save2Btn.classList.remove('save2-selected');
                  save2Btn.style.backgroundColor = '';
                  save2Btn.style.color = '';
                  save2Btn.style.borderColor = '';
                  save2Btn.disabled = false;
                  save2Btn.style.opacity = '1';
                  save2Btn.style.cursor = 'pointer';
                }
              }
            }
          }
        }
        
      } catch (error) {
        pinoSelect.innerHTML = '<option value="" style="text-align: center;">Choose</option>';
      }
    }
    </script>

</body>
</html>
