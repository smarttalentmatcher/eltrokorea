<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Shipment Update</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      color: #000;
      line-height: 1.5;
      position: relative;
      height: 100vh;
      overflow: hidden; /* ë°”ê¹¥ìª½ ìŠ¤í¬ë¡¤ ì œê±° */
      box-sizing: border-box;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: -1;
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 5px;
      box-sizing: border-box;
      height: calc(100vh - 40px); /* ì „ì²´ ë†’ì´ì—ì„œ íŒ¨ë”© ì œì™¸ */
      display: flex;
      flex-direction: column;
    }
    h1 {
      text-align: center;
      margin: 0;
      padding-bottom: 10px;
    }
    .top-menu {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .left-menu {
      display: flex;
      gap: 3px;
    }
    .right-menu {
      display: flex;
      gap: 3px;
    }
    .top-menu-btn {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
    }
    .top-menu-btn:hover {
      background: #f0f0f0;
      border-color: #999;
    }
    .top-menu-btn.doc-btn.selected {
      background: black !important;
      color: white !important;
      border-color: black !important;
    }
    .top-menu-btn.doc-btn {
      background: #fff;
      color: #000;
      border-color: #ccc;
    }
    .top-menu-btn.doc-btn:hover {
      background: #f0f0f0;
      border-color: #999;
    }
    /* ëª¨ë“  ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ - Exportì™€ ë™ì¼ */
    button:not(.add-single-btn):not(.refresh-btn):not(.deleteButton) {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
      transition: all 0.2s ease;
    }

    button:hover {
      background: #f0f0f0;
      border-color: #999;
    }

    #priceBtn {
      background: #e8f4fd;
      border-color: #4a90e2;
      color: #2c5aa0;
      height: 30px;
      width: 80px;
      box-sizing: border-box;
    }

    #priceBtn:hover {
      background: #d1e7f7;
    }


    /* Order Header ìŠ¤íƒ€ì¼ */
    .order-header {
      display: flex;
      justify-content: space-between;
      padding-top: 10px;
      margin-top: 10px;
      font-weight: bold;
      font-size: 1.1rem;
    }
    /* ì™¼ìª½/ì¤‘ì•™/ì˜¤ë¥¸ìª½/Due ì˜ì—­ì— input ì‚¬ìš© */
    .order-header .left, .order-header .center, .order-header .right, .order-header .due {
      display: flex;
      align-items: center;
      gap: 5px;
      flex: 1;
      justify-content: center;
    }
    .order-header .left input,
    .order-header .center input,
    .order-header .right input,
    .order-header .due input {
      font-size: 1rem;
      width: 120px;
      padding: 4px 4px;
      height: 24px;
    }

    /* í–‰ ì¶”ê°€ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
    .row-control {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 3px;
      margin: 10px 0 20px 0;
    }


    .row-control button:not(.add-single-btn):not(.refresh-btn) {
      height: 30px;
      width: 80px;
      box-sizing: border-box;
    }

    /* ìˆ«ì ì…ë ¥ ë²„íŠ¼ ìŠ¤íƒ€ì¼ - ADD ë²„íŠ¼ê³¼ ë™ì¼ */
    .number-input-btn {
      width: 80px;
      height: 30px;
      padding: 5px 10px;
      margin: 0 3px;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      text-align: center;
      font-size: 0.9rem;
      line-height: 1.2;
      box-sizing: border-box;
      appearance: textfield; /* í‘œì¤€ ì†ì„± */
      -moz-appearance: textfield; /* Firefoxì—ì„œ ìŠ¤í”¼ë„ˆ ì œê±° */
    }

    .number-input-btn::-webkit-outer-spin-button,
    .number-input-btn::-webkit-inner-spin-button {
      -webkit-appearance: none; /* Chrome, Safariì—ì„œ ìŠ¤í”¼ë„ˆ ì œê±° */
      margin: 0;
    }

    .number-input-btn:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .add-single-btn {
      font-size: 0.9rem;
      padding: 5px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      width: 30px;
      height: 30px;
      min-width: 30px;
      max-width: 30px;
      line-height: 1.2;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .add-single-btn:hover {
      background: #f0f0f0;
      border-color: #999;
    }

    .refresh-btn {
      font-size: 0.9rem;
      padding: 5px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      width: 30px;
      height: 30px;
      min-width: 30px;
      max-width: 30px;
      line-height: 1.2;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .refresh-btn:hover {
      background: #f0f0f0;
      border-color: #999;
    }


    /* í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    .table-container {
      margin: 20px 0;
      border: 1px solid #e0e0e0;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 5px;
      flex: 1; /* ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì‚¬ìš© */
      display: flex;
      flex-direction: column;
      min-height: 0; /* flex ì•„ì´í…œì´ ì¶•ì†Œë  ìˆ˜ ìˆë„ë¡ */
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      table-layout: fixed;
    }
    
    /* í…Œì´ë¸” ë°”ë”” ìŠ¤í¬ë¡¤ ì˜ì—­ */
    .table-scroll-area {
      flex: 1;
      overflow-y: auto;
      overflow-x: auto;
      min-height: 0; /* flex ì•„ì´í…œì´ ì¶•ì†Œë  ìˆ˜ ìˆë„ë¡ */
    }
    
    /* í…Œì´ë¸” ë°”ë”” í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    #shipmentTableBodyTable {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      table-layout: fixed;
    }
    
    /* í…Œì´ë¸” ë°”ë””ì˜ ì—´ í­ì„ í—¤ë”ì™€ ë™ì¼í•˜ê²Œ ì„¤ì • */
    #shipmentTableBodyTable td:nth-child(1) { width: 60px; }
    #shipmentTableBodyTable td:nth-child(2) { width: 60px; }
    #shipmentTableBodyTable td:nth-child(3) { width: 110px; }
    #shipmentTableBodyTable td:nth-child(4) { width: 60px; }
    #shipmentTableBodyTable td:nth-child(5) { width: 110px; }
    #shipmentTableBodyTable td:nth-child(6) { width: 60px; }
    #shipmentTableBodyTable td:nth-child(7) { width: 60px; }
    #shipmentTableBodyTable td:nth-child(8) { width: 100px; }
    #shipmentTableBodyTable td:nth-child(9) { width: 100px; }
    #shipmentTableBodyTable td:nth-child(10) { width: 60px; }
    
    .table-container {
      overflow: hidden; /* ì»¨í…Œì´ë„ˆ ìì²´ëŠ” ìŠ¤í¬ë¡¤ ì—†ìŒ */
      max-width: 100%;
    }

    thead th {
      border: 1px solid #e0e0e0;
      background-color: #f0f0f0;
      padding: 5px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    /* í…Œì´ë¸” ë°”ë””ì˜ í–‰ì€ í…Œë‘ë¦¬ ì—†ìŒ */
    #shipmentTableBody {
      background: #fff;
    }
    
    #shipmentTableBody tr {
      height: 40px;
      display: table-row;
    }
    
    #shipmentTableBody tr td {
      border: none;
      text-align: center;
      vertical-align: middle;
      padding: 5px;
      background: #fff;
      height: 40px;
    }

    /* ê° ì—´ì„ ê°œë³„ì ìœ¼ë¡œ ì„¤ì • */
    /* ì—´ í­ ì„¤ì • - í…Œì´ë¸” í—¤ë”ì™€ ë°”ë”” ëª¨ë‘ ì ìš© */
    th:nth-child(1), #shipmentTableBody tr td:nth-child(1) {
      width: 60px; /* Drag + Select */
    }

    /* 1ì—´ í—¤ë” í…Œë‘ë¦¬ ì—°í•˜ê²Œ */
    .drag-select-header {
      border: 1px solid #e0e0e0;
    }
    
    th:nth-child(2), #shipmentTableBody tr td:nth-child(2) {
      width: 70px; /* Mode - í•œ ë²ˆ ë” ì¦ê°€ */
    }
    
    th:nth-child(3), #shipmentTableBody tr td:nth-child(3) {
      width: 120px; /* Order No - í•œ ë²ˆ ë” ì¦ê°€ */
    }
    
    th:nth-child(4), #shipmentTableBody tr td:nth-child(4) {
      width: 70px; /* Item No - í•œ ë²ˆ ë” ì¦ê°€ */
    }
    
    th:nth-child(5), #shipmentTableBody tr td:nth-child(5) {
      width: 120px; /* Item - í•œ ë²ˆ ë” ì¦ê°€ */
    }
    
    th:nth-child(6), #shipmentTableBody tr td:nth-child(6) {
      width: 60px; /* ì£¼ë¬¸R */
    }
    
    th:nth-child(7), #shipmentTableBody tr td:nth-child(7) {
      width: 60px; /* ì„ ì R */
    }
    
    th:nth-child(8), #shipmentTableBody tr td:nth-child(8) {
      width: 100px; /* ProducedKG */
    }
    
    th:nth-child(9), #shipmentTableBody tr td:nth-child(9) {
      width: 100px; /* DeliveredKG */
    }
    
    th:nth-child(10), #shipmentTableBody tr td:nth-child(10) {
      width: 60px; /* U/P */
    }

    /* ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    .modeDropdown, .orderDropdown, .itemDropdown {
      width: 100%;
      max-width: 100%;
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 3px;
      background: #fff;
      color: #000;
      font-size: 1rem;
      height: 28px;
      box-sizing: border-box;
    }

    .modeDropdown:focus, .orderDropdown:focus, .itemDropdown:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    /* Item ì •ë³´ ì…€ ìŠ¤íƒ€ì¼ */
    .itemInfoCell {
      text-align: left;
      font-size: 1rem;
      color: #333;
      padding: 5px 8px;
    }

    /* ì…ë ¥ í•„ë“œ í°íŠ¸ í¬ê¸° í†µì¼ ë° ìŠ¤í”¼ë„ˆ ì œê±° */
    .remainingRInput {
      font-size: 1rem;
      appearance: textfield; /* í‘œì¤€ ì†ì„± */
      -moz-appearance: textfield; /* Firefoxì—ì„œ ìŠ¤í”¼ë„ˆ ì œê±° */
    }
    
    .remainingRInput::-webkit-outer-spin-button,
    .remainingRInput::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Partial Box ìŠ¤íƒ€ì¼ (ADD ë²„íŠ¼ê³¼ ë™ì¼í•œ í¬ê¸°) */
    .partialInput {
      width: 80px;
      height: 30px;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      font-size: 1rem;
      box-sizing: border-box;
      text-align: center;
      appearance: textfield; /* í‘œì¤€ ì†ì„± */
      -moz-appearance: textfield; /* Firefoxì—ì„œ ìŠ¤í”¼ë„ˆ ì œê±° */
    }

    .partialInput::-webkit-outer-spin-button,
    .partialInput::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* ì£¼ë¬¸R Box ìŠ¤íƒ€ì¼ (ì½ê¸° ì „ìš©) */
    .orderRInput {
      width: 100%;
      height: 30px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      color: #000;
      border-radius: 3px;
      font-size: 1rem;
      box-sizing: border-box;
      text-align: center;
      appearance: textfield; /* í‘œì¤€ ì†ì„± */
      -moz-appearance: textfield; /* Firefoxì—ì„œ ìŠ¤í”¼ë„ˆ ì œê±° */
    }

    .orderRInput::-webkit-outer-spin-button,
    .orderRInput::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* ì„ ì R Box ìŠ¤íƒ€ì¼ */
    .partialRInput {
      width: 100%;
      height: 30px;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      font-size: 1rem;
      box-sizing: border-box;
      text-align: center;
      appearance: textfield; /* í‘œì¤€ ì†ì„± */
      -moz-appearance: textfield; /* Firefoxì—ì„œ ìŠ¤í”¼ë„ˆ ì œê±° */
    }

    .partialRInput::-webkit-outer-spin-button,
    .partialRInput::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* ProducedKG Box ìŠ¤íƒ€ì¼ (ì½ê¸° ì „ìš©) */
    .producedKGInput {
      width: 100%;
      height: 30px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      color: #000;
      border-radius: 3px;
      font-size: 1rem;
      box-sizing: border-box;
      text-align: center;
      appearance: textfield; /* í‘œì¤€ ì†ì„± */
      -moz-appearance: textfield; /* Firefoxì—ì„œ ìŠ¤í”¼ë„ˆ ì œê±° */
    }

    .producedKGInput::-webkit-outer-spin-button,
    .producedKGInput::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* DeliveredKG Box ìŠ¤íƒ€ì¼ */
    .deliveredKGInput {
      width: 100%;
      height: 30px;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      font-size: 1rem;
      box-sizing: border-box;
      text-align: center;
      appearance: textfield; /* í‘œì¤€ ì†ì„± */
      -moz-appearance: textfield; /* Firefoxì—ì„œ ìŠ¤í”¼ë„ˆ ì œê±° */
    }

    .deliveredKGInput::-webkit-outer-spin-button,
    .deliveredKGInput::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* ì„ ì Rê³¼ ì£¼ë¬¸Rì´ ë‹¤ë¥¼ ë•Œ ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬ */
    .partialRInput.mismatch {
      border: 2px solid #dc3545;
      background-color: #fff5f5;
      box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.25);
    }

    .deliveredKGInput.mismatch {
      border: 2px solid #dc3545;
      background-color: #fff5f5;
      box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.25);
    }

    /* U/P Box ìŠ¤íƒ€ì¼ */
    .upInput {
      width: 100%;
      height: 30px;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      font-size: 1rem;
      box-sizing: border-box;
      text-align: center;
      appearance: textfield; /* í‘œì¤€ ì†ì„± */
      -moz-appearance: textfield; /* Firefoxì—ì„œ ìŠ¤í”¼ë„ˆ ì œê±° */
    }

    .upInput::-webkit-outer-spin-button,
    .upInput::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }


    /* Drag + Select í—¤ë” */
    .drag-select-header {
      background-color: #f0f0f0;
      padding: 5px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    /* Organize ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #organizeButton {
      font-size: 0.7rem;
      padding: 2px 4px;
      margin: 0;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 2px;
      min-width: 50px;
      height: 18px;
      line-height: 1;
      display: block;
      margin: 0 auto;
    }

    #organizeButton:hover {
      background: #f0f0f0;
      border-color: #999;
    }

    /* Drag + Select ì…€ */
    .drag-select-cell {
      padding: 2px;
      text-align: center;
      vertical-align: middle;
    }

    .select-buttons {
      display: flex;
      flex-direction: column;
      gap: 2px;
      justify-content: center;
    }

    .select-row {
      display: flex;
      gap: 2px;
      justify-content: center;
    }

    .deleteButton {
      font-size: 0.75rem;
      padding: 1px 3px;
      cursor: pointer;
      margin: 0;
      display: inline-block;
      width: 22px;
      height: 18px;
      min-width: 22px;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 2px;
    }

    .drag-handle {
      width: 22px;
      cursor: move;
      font-size: 1rem;
      text-align: center;
      user-select: none;
    }

    .drag-handle:hover {
      background-color: #e0e0e0;
    }

    .dragging {
      opacity: 0.5;
      background-color: #f0f0f0;
    }

    .drag-over {
      border-top: 2px solid #007bff;
    }


    /* 1ì—´ í—¤ë”ì˜ organize ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #sortPHDButton {
      font-size: 0.7rem;
      padding: 2px 4px;
      margin: 0;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 2px;
      min-width: 50px;
      height: 18px;
      line-height: 1;
      display: block;
      margin: 0 auto;
    }

    #sortPHDButton:hover {
      background: #f0f0f0;
      border-color: #999;
    }

    /* í…Œì´ë¸” ë‚´ë¶€ ì…ë ¥ í•„ë“œë§Œ border none ì ìš© */
    #shipmentTableBody input[type="number"], 
    #shipmentTableBody input[type="text"], 
    #shipmentTableBody select {
      width: 100%;
      max-width: 100%;
      padding: 4px;
      border: none;
      text-align: center;
      background: transparent;
    }

    #shipmentTableBody input[type="number"]:focus, 
    #shipmentTableBody input[type="text"]:focus, 
    #shipmentTableBody select:focus {
      outline: 1px solid #007bff;
      background: #fff;
    }

    tbody tr td input {
      width: 100%;
      border: none;
      text-align: center;
      padding: 2px;
    }

    tbody tr td input:focus {
      outline: 1px solid #007bff;
    }

    /* ëª¨ë‹¬ ì°½ ìŠ¤íƒ€ì¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 0;
      border: 1px solid #888;
      width: 500px; /* ëª¨ë‹¬ ê°€ë¡œ ê¸¸ì´ ì ˆëŒ€ê°’ìœ¼ë¡œ ê³ ì • */
      max-width: 500px; /* ëª¨ë‹¬ ê°€ë¡œ ê¸¸ì´ ì ˆëŒ€ê°’ìœ¼ë¡œ ê³ ì • */
      max-height: 90vh;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 15px 20px;
      background-color: #f8f8f8;
      border-bottom: 1px solid #ddd;
      border-radius: 5px 5px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      color: #333;
    }

    .close-server {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .close-server:hover {
      color: #000;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 15px 20px;
      background-color: #f8f8f8;
      border-top: 1px solid #ddd;
      border-radius: 0 0 5px 5px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* ëª¨ë‹¬ ë‚´ë¶€ ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
    .modal button:hover {
      background: #f0f0f0;
    }


    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .action-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* í…Œì´ë¸” í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ì˜ì—­ */
    .table-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 15px 20px;
      background: #f9f9f9;
      border-top: 1px solid #e0e0e0;
      border-radius: 0 0 5px 5px;
      margin-top: auto;
    }

    .control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .control-row.first-row {
      justify-content: center;
    }

    .control-row.second-row {
      justify-content: space-between;
      position: relative;
    }

    .total-info {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .button-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .right-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .total-display {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .total-display span {
      font-size: 0.9rem;
      color: #333;
    }

    .total-input {
      width: 80px;
      height: 30px;
      border: 1px solid #ccc;
      background: #f5f5f5; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
      color: #000;
      border-radius: 3px;
      font-size: 0.9rem;
      text-align: center;
      padding: 2px 5px;
    }

    /* Invoice Price Inputë§Œ í°ìƒ‰ ë°°ê²½ */
    #invoicePriceInput {
      background: #ffffff !important;
    }

    .center-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .right-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .second-row {
      justify-content: center;
    }

  </style>
</head>
<body>
<div class="page">
  <h1>Shipment Update</h1>

  <div class="top-menu">
    <!-- ì™¼ìª½: Shipment -->
    <div class="left-menu">
      <button type="button" onclick="location.href='shipment.html'" class="top-menu-btn">Shipment</button>
      <button id="openServerBtn" class="top-menu-btn">Open</button>
    </div>
    <!-- ì˜¤ë¥¸ìª½: D/N, P/I, P/I2, Invoice -->
    <div class="right-menu">
      <button id="dnBtn" class="top-menu-btn doc-btn selected">D/N</button>
      <button id="piBtn" class="top-menu-btn doc-btn">P/I</button>
      <button id="pi2Btn" class="top-menu-btn doc-btn">P/I2</button>
      <button id="invoiceBtn" class="top-menu-btn doc-btn">Invoice</button>
    </div>
  </div>

  <!-- Delivery No, TF NO, Date, Due ì…ë ¥ ì˜ì—­ -->
  <div class="order-header">
    <div class="left">
      <span style="font-size: 15px !important;">DELIVERY NO :</span>
      <input type="text" id="deliveryNoInput" autocomplete="off" />
    </div>
    <div class="center">
      <span style="font-size: 15px !important;">TF NO :</span>
      <input type="text" id="tfNoInput" autocomplete="off" />
    </div>
    <div class="right">
      <span style="font-size: 15px !important;">DATE :</span>
      <input type="text" id="orderDateInput" autocomplete="off" />
    </div>
    <div class="due">
      <span style="font-size: 15px !important;">Due :</span>
      <input type="text" id="dueInput" autocomplete="off" />
    </div>
  </div>

  <!-- í…Œì´ë¸” ì˜ì—­ -->
  <div class="table-container">
    <!-- í…Œì´ë¸” í—¤ë” (ê³ ì •) -->
    <table id="shipmentTable">
      <thead>
        <tr>
          <!-- Drag + Select (í•©ì³ì§„ ì—´) -->
          <th class="drag-select-header">
            <button id="organizeButton" type="button">organize</button>
          </th>
          <!-- Mode -->
          <th>Mode</th>
          <!-- Order No -->
          <th>Order No</th>
          <!-- Item No -->
          <th>Item No</th>
          <!-- Item -->
          <th>Item</th>
          <!-- ì£¼ë¬¸R -->
          <th>ì£¼ë¬¸R</th>
          <!-- ì„ ì R -->
          <th>ì„ ì R</th>
          <!-- ProducedKG -->
          <th>ProducedKG</th>
          <!-- DeliveredKG -->
          <th>DeliveredKG</th>
          <!-- U/P -->
          <th>U/P</th>
        </tr>
      </thead>
    </table>
    
    <!-- í…Œì´ë¸” ë°”ë”” ìŠ¤í¬ë¡¤ ì˜ì—­ -->
    <div class="table-scroll-area">
      <table id="shipmentTableBodyTable">
        <tbody id="shipmentTableBody">
          <!-- í–‰ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </tbody>
      </table>
    </div>
    
    <!-- í…Œì´ë¸” í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ì˜ì—­ -->
    <div class="table-controls">
      <!-- ì²« ë²ˆì§¸ ì¤„: Total ì •ë³´ë“¤ -->
      <div class="control-row first-row">
        <div class="total-info">
          <div class="total-display">
            <span>Total Reel :</span>
            <input type="text" id="totalReelInput" class="total-input" readonly />
          </div>
          <div class="total-display">
            <span>Total KG :</span>
            <input type="text" id="totalKGInput" class="total-input" readonly />
          </div>
          <div class="total-display">
            <span>Total Price :</span>
            <input type="text" id="totalPriceInput" class="total-input" readonly />
          </div>
          <div class="total-display">
            <span>P/I Price :</span>
            <input type="text" id="piPriceInput" class="total-input" readonly />
          </div>
          <div class="total-display">
            <span>Invoice Price :</span>
            <input type="text" id="invoicePriceInput" class="total-input" placeholder="Empty" />
          </div>
        </div>
      </div>
      
      <!-- ë‘ ë²ˆì§¸ ì¤„: ë²„íŠ¼ë“¤ -->
      <div class="control-row second-row">
        <div class="button-group">
          <button id="addSingleBtn" class="add-single-btn">+</button>
          <button id="refreshBtn" class="refresh-btn">â†»</button>
          <input type="number" id="rowCountInput" class="number-input-btn" placeholder="1" min="1" max="100" value="1" />
          <button id="addRowsBtn">ADD</button>
        </div>
        <div class="center-actions">
          <button id="exportBtn">Export</button>
          <button id="convertBtn">Simple</button>
        </div>
        <div class="right-actions">
          <button id="priceBtn">Price</button>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ì„œë²„ íŒŒì¼ ëª¨ë‹¬ -->
<div id="serverFileModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</h3>
      <span class="close-server">&times;</span>
    </div>
    <div class="modal-body">
      <div style="margin-bottom: 15px;">
        <select id="modeFilter" style="width: 67px; padding: 6px 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
          <option value="all">ì „ì²´</option>
          <option value="NT">NT</option>
          <option value="SM">SM</option>
        </select>
      </div>
      <div id="serverFileList">
      </div>
    </div>
    <div class="modal-footer">
    </div>
  </div>
</div>

<!-- SortableJS (ë“œë˜ê·¸ ì •ë ¬) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<script>
  let globalParsedData = [];
  let selectedDoc = "D/N";

  // DELIVERY NO ë³€ê²½ í•¸ë“¤ëŸ¬ (ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬)
  function handleDeliveryNoChange() {
    calculatePiPrice();
  }

  // Delivery No, TF NO, Date ì´ˆê¸°í™” í•¨ìˆ˜
  function initializeOrderFields() {
    const deliveryNoInput = document.getElementById("deliveryNoInput");
    const tfNoInput = document.getElementById("tfNoInput");
    const orderDateInput = document.getElementById("orderDateInput");
    
    if (deliveryNoInput) {
      deliveryNoInput.value = '';
      
      // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆë¡œ ë“±ë¡ (ì¤‘ë³µ ë°©ì§€)
      deliveryNoInput.removeEventListener('input', handleDeliveryNoChange);
      deliveryNoInput.addEventListener('input', handleDeliveryNoChange);
    }
    
    if (tfNoInput) {
      tfNoInput.value = '';
    }
    
    if (orderDateInput) {
      orderDateInput.value = '';
    }
  }

  // deliveryNoì—ì„œ D/Nê³¼ P/I ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
  async function loadDeliveryInfo(deliveryNo) {
    try {
      const response = await fetch('/api/orders');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const allOrders = await response.json();
      
      // í•´ë‹¹ deliveryNoë¥¼ ê°€ì§„ ì•„ì´í…œë“¤ì—ì„œ D/N, P/I, P/I2, Invoice ì •ë³´ ì°¾ê¸°
      let d_nno = '', d_ndate = '', p_ino = '', p_idate = '', p_ino2 = '', p_idate2 = '', p_iprice2 = '', invoiceno = '', invoicedate = '', p_iprice = '', invoiceprice = '', invoicedue = '';
      
      for (const order of allOrders) {
        if (order.items && order.items.length > 0) {
          for (const item of order.items) {
            if ((item.deliveryno || item.deliveryNo) === deliveryNo) {
              // D/N ì •ë³´ ìˆ˜ì§‘ (ì²« ë²ˆì§¸ ë°œê²¬ëœ ê²ƒë§Œ)
              if (item['d/nno'] && item['d/ndate'] && !d_nno) {
                d_nno = item['d/nno'];
                d_ndate = item['d/ndate'];
              }
              // P/I ì •ë³´ ìˆ˜ì§‘ (ì²« ë²ˆì§¸ ë°œê²¬ëœ ê²ƒë§Œ)
              if (!p_ino) {
                p_ino = item['p/ino'] || '';
                p_idate = item['p/idate'] || '';
                p_iprice = item['p/iprice'] || '';
              }
              // P/I2 ì •ë³´ ìˆ˜ì§‘ (ì²« ë²ˆì§¸ ë°œê²¬ëœ ê²ƒë§Œ)
              if (!p_ino2) {
                p_ino2 = item['p/ino2'] || '';
                p_idate2 = item['p/idate2'] || '';
                p_iprice2 = item['p/iprice2'] || '';
              }
              // Invoice ì •ë³´ ìˆ˜ì§‘ (ì²« ë²ˆì§¸ ë°œê²¬ëœ ê²ƒë§Œ)
              if (item.invoiceno && item.invoicedate && !invoiceno) {
                invoiceno = item.invoiceno;
                invoicedate = item.invoicedate;
              }
              if (!invoiceprice) {
                invoiceprice = item.invoiceprice || '';
              }
              if (!invoicedue) {
                invoicedue = item.invoicedue || '';
              }
              
              // ì²« ë²ˆì§¸ ì•„ì´í…œì˜ ì •ë³´ë¥¼ ëª¨ë‘ ìˆ˜ì§‘í–ˆìœ¼ë©´ ë£¨í”„ ì¢…ë£Œ
              if (d_nno && p_ino && p_ino2 && invoiceno) {
                break;
              }
            }
          }
        }
      }
      
      return { d_nno, d_ndate, p_ino, p_idate, p_ino2, p_idate2, p_iprice2, invoiceno, invoicedate, p_iprice, invoiceprice, invoicedue };
    } catch (error) {
      return { d_nno: '', d_ndate: '', p_ino: '', p_idate: '', p_ino2: '', p_idate2: '', p_iprice2: '', invoiceno: '', invoicedate: '', p_iprice: '', invoiceprice: '', invoicedue: '' };
    }
  }


  // doc ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ í•¨ìˆ˜
  function setupDocButtons() {
    const buttons = [
      { id: 'dnBtn', mode: 'D/N', dataKey: 'd_nno', dateKey: 'd_ndate', priceKey: '' },
      { id: 'piBtn', mode: 'P/I', dataKey: 'p_ino', dateKey: 'p_idate', priceKey: 'p_iprice' },
      { id: 'pi2Btn', mode: 'P/I2', dataKey: 'p_ino2', dateKey: 'p_idate2', priceKey: 'p_iprice2' },
      { id: 'invoiceBtn', mode: 'Invoice', dataKey: 'invoiceno', dateKey: 'invoicedate', priceKey: 'invoicedue' }
    ];

    buttons.forEach(button => {
      const btn = document.getElementById(button.id);
      if (btn) {
        btn.addEventListener("click", () => {
          selectedDoc = button.mode;
          updateButtonSelection(buttons, button.id);
          
          // ëª¨ë“œë³„ placeholder ì„¤ì •
          const dueInput = document.getElementById('dueInput');
          const invoicePriceInput = document.getElementById('invoicePriceInput');
          
          if (button.mode === 'P/I' || button.mode === 'P/I2') {
            dueInput.placeholder = 'P/I Price';
            invoicePriceInput.placeholder = 'Empty';
          } else if (button.mode === 'D/N') {
            dueInput.placeholder = 'Empty';
            invoicePriceInput.placeholder = 'Empty';
          } else if (button.mode === 'Invoice') {
            dueInput.placeholder = 'Invoice Due Date';
            invoicePriceInput.placeholder = 'Input';
          } else {
            dueInput.placeholder = '';
            invoicePriceInput.placeholder = 'Empty';
          }
          
          loadDeliveryData(button);
        });
      }
    });
  }

  // ë²„íŠ¼ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateButtonSelection(buttons, activeId) {
    buttons.forEach(btn => {
      const element = document.getElementById(btn.id);
      if (element) {
        element.classList.toggle("selected", btn.id === activeId);
      }
    });
  }

  // ë°°ì†¡ ì •ë³´ ë¡œë“œ í•¨ìˆ˜
  function loadDeliveryData(button) {
    const deliveryNo = document.getElementById('deliveryNoInput').value.trim();
    if (deliveryNo) {
      loadDeliveryInfo(deliveryNo).then(info => {
        document.getElementById('tfNoInput').value = info[button.dataKey] || '';
        document.getElementById('orderDateInput').value = info[button.dateKey] || '';
        document.getElementById('dueInput').value = button.priceKey ? (info[button.priceKey] || '') : '';
        calculatePiPrice();
        document.getElementById('invoicePriceInput').value = info.invoiceprice || '';
      });
    }
  }

  // Price ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
  async function loadPriceData() {
    try {
      const response = await fetch("/api/price");
      const data = await response.json();
      return data; // ì „ì²´ priceData ë°˜í™˜
    } catch (error) {
      // console.error("[ERROR] loadPriceData fail:", error);
      return {};
    }
  }


  // Price ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ í•¨ìˆ˜
  function setupPriceButton() {
    const priceBtn = document.getElementById("priceBtn");
    if (!priceBtn) return;
    
    priceBtn.addEventListener("click", async () => {
      try {
        // P/I ëª¨ë“œì—ì„œë§Œ ì‘ë™
        if (selectedDoc !== "P/I") {
          alert("Price ë²„íŠ¼ì€ P/I ëª¨ë“œì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          return;
        }
        
        // Price ë°ì´í„° ë¡œë“œ
        const priceData = await loadPriceData();
        
        // Dateì—ì„œ ë…„ì›” ì¶”ì¶œ (DD.MM.YYYY í˜•ì‹)
        const dateInput = document.getElementById('orderDateInput').value.trim();
        const [day, month, year] = dateInput.split('.');
        
        if (!day || !month || !year) {
          alert("Date í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. DD.MM.YYYY í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }
        
        // ì›” í˜•ì‹ ì •ê·œí™” (02 â†’ 2)
        const normalizedMonth = parseInt(month).toString();
        
        // í…Œì´ë¸”ì˜ ê° í–‰ì—ì„œ ëª¨ë“œì™€ PHD ì¶”ì¶œí•˜ì—¬ ê°€ê²© ì ìš©
        const rows = document.querySelectorAll("#shipmentTableBody tr");
        console.log(`[Price] ì²˜ë¦¬í•  í–‰ ìˆ˜: ${rows.length}, ë…„ë„: ${year}, ì›”: ${normalizedMonth}`);
        
        rows.forEach((row, index) => {
          const tds = row.querySelectorAll("td");
          if (tds.length < 10) return;
          
          // ëª¨ë“œ ì¶”ì¶œ (Mode ì—´ì—ì„œ)
          const modeSelect = tds[1].querySelector('.modeDropdown');
          const mode = modeSelect ? modeSelect.value : '';
          
          // ëª¨ë“œ ë§¤í•‘: NT â†’ EK, SM-B/SM-C â†’ SM
          const priceMode = mode === 'NT' ? 'EK' : (mode.startsWith('SM') ? 'SM' : mode);
          console.log(`[Price] í–‰ ${index}: ì›ë³¸ ëª¨ë“œ=${mode}, ê°€ê²© ëª¨ë“œ=${priceMode}`);
          
          // PHD ì¶”ì¶œ (Item ì—´ì—ì„œ) - PHD-6.0(620)6x í˜•ì‹
          const itemText = tds[4].textContent.trim();
          const phdMatch = itemText.match(/PHD-([\d.]+)\(/);
          if (!phdMatch) {
            console.log(`[Price] í–‰ ${index}: PHD ì¶”ì¶œ ì‹¤íŒ¨ - ${itemText}`);
            return;
          }
          
          const phd = parseFloat(phdMatch[1]);
          console.log(`[Price] í–‰ ${index}: PHD=${phd}, ëª¨ë“œ=${mode}`);
          
          // ê°€ê²© ë°ì´í„°ì—ì„œ ì°¾ê¸° (ì •ê·œí™”ëœ ì›” ì‚¬ìš©)
          console.log(`[Price] í–‰ ${index}: priceData êµ¬ì¡° í™•ì¸`, {
            priceMode,
            year,
            normalizedMonth,
            hasPriceMode: !!priceData[priceMode],
            hasYear: !!priceData[priceMode]?.[year],
            hasMonth: !!priceData[priceMode]?.[year]?.[normalizedMonth]
          });
          
          let yearData = priceData[priceMode]?.[year]?.[normalizedMonth];
          if (!yearData) {
            console.log(`[Price] í–‰ ${index}: ${priceMode} ${year}ë…„ ${normalizedMonth}ì›” ë°ì´í„° ì—†ìŒ`);
            return;
          }
          
          const priceInfo = yearData.find(item => parseFloat(item.phd) === phd);
          if (!priceInfo) {
            console.log(`[Price] í–‰ ${index}: PHD ${phd}ì— í•´ë‹¹í•˜ëŠ” ê°€ê²© ì •ë³´ ì—†ìŒ`);
            return;
          }
          
          // U/P ì—´ì— ê°€ê²© ì„¤ì •
          const upInput = tds[9].querySelector('.upInput');
          if (upInput) {
            upInput.value = parseFloat(priceInfo.price).toFixed(2);
            console.log(`[Price] í–‰ ${index}: U/Pì— ${priceInfo.price} ì ìš© ì™„ë£Œ`);
            
            // U/P ê°’ ë³€ê²½ í›„ total price ì¬ê³„ì‚°ì„ ìœ„í•´ input ì´ë²¤íŠ¸ ë°œìƒ
            upInput.dispatchEvent(new Event('input', { bubbles: true }));
          } else {
            console.log(`[Price] í–‰ ${index}: U/P ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
          }
        });
        
        // ê°€ê²© ì ìš© ì™„ë£Œ
      } catch (error) {
        alert("ê°€ê²© ì ìš©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
      }
    });
  }

  // ========================================
  // EXPORT
  // ========================================
  // Export ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ í•¨ìˆ˜
  function setupExportButton() {
    const exportBtn = document.getElementById("exportBtn");
    if (!exportBtn) {
      return;
    }
    
    exportBtn.addEventListener("click", async () => {
      try {
       
        // D/N ë˜ëŠ” P/I ëª¨ë“œì—ì„œë§Œ Export ê°€ëŠ¥
        if (selectedDoc !== "D/N" && selectedDoc !== "P/I") {
          const modeMessages = {
            "Invoice": "Invoice ëª¨ë“œì—ì„œëŠ” Export ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Simple ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.",
            "P/I2": "P/I2 ëª¨ë“œì—ì„œëŠ” Export ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Simple ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”."
          };
          
          alert(modeMessages[selectedDoc] || 'ExportëŠ” D/N ë˜ëŠ” P/I ëª¨ë“œì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          return;
        }
        
        // í—¤ë” ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
        const deliveryNo = document.getElementById('deliveryNoInput').value;
        const tfNo = document.getElementById('tfNoInput').value;
        const orderDate = document.getElementById('orderDateInput').value;
        const dueValue = document.getElementById('dueInput').value;
        
        if (!deliveryNo) {
          alert('DELIVERY NOë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // í…Œì´ë¸” ë°ì´í„° ìˆ˜ì§‘
        const tableRows = document.querySelectorAll('#shipmentTableBody tr');
        const exportData = [];
        
        tableRows.forEach(row => {
          const modeDropdown = row.querySelector('.modeDropdown');
          const orderDropdown = row.querySelector('.orderDropdown');
          const itemDropdown = row.querySelector('.itemDropdown');
          const partialRInput = row.querySelector('.partialRInput');
          const deliveredKGInput = row.querySelector('.deliveredKGInput');
          const upInput = row.querySelector('.upInput');
          
          const mode = modeDropdown?.value || '';
          const orderNo = orderDropdown?.value || '';
          const itemNo = itemDropdown?.value || '';
          const partialR = partialRInput?.value || '';
          const deliveredKG = deliveredKGInput?.value || '';
          const up = upInput?.value || '';
          
          const exportItem = {
            mode,
            orderNo,
            itemNo,
            deliveredR: partialR,
            deliveredkg: deliveredKG,
            "U/P": up
          };
          
          exportData.push(exportItem);
        });
        
        if (exportData.length === 0) {
          alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í…Œì´ë¸”ì— ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // ========================================
        // Export ì²˜ë¦¬: orderNoë³„ ì¹´í…Œê³ ë¼ì´ì¦ˆ
        // ========================================
        const isDnMode = selectedDoc === "D/N";
        
        // 1. exportDataë¥¼ orderNoë³„ë¡œ ì¹´í…Œê³ ë¼ì´ì¦ˆ
        const orderGroups = {};
        exportData.forEach((item) => {
          const orderNo = item.orderNo;
          if (orderNo && orderNo.trim() !== '') {  // ë¹ˆ ê°’ ì œì™¸
            if (!orderGroups[orderNo]) {
              orderGroups[orderNo] = [];
            }
            orderGroups[orderNo].push(item);
          }
        });
        
        console.log(`ğŸ“‹ ì£¼ë¬¸ë³„ ê·¸ë£¹í™” ì™„ë£Œ: ${Object.keys(orderGroups).length}ê°œ ì£¼ë¬¸`);
        
        // 2. ê° ì£¼ë¬¸ë³„ë¡œ API í˜¸ì¶œ
        let totalUpdated = 0;
        let totalErrors = 0;
        
        for (const [orderNo, items] of Object.entries(orderGroups)) {
          console.log(`ğŸ“ ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘: ${orderNo} (${items.length}ê°œ ì•„ì´í…œ)`);
          
          try {
            if (isDnMode) {
              // D/N ëª¨ë“œ: /api/updateOrderë¡œ ê¸°ì¡´ ì£¼ë¬¸ì˜ ì•„ì´í…œë“¤ ì—…ë°ì´íŠ¸
              const response = await fetch('/api/updateOrder', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  searchOrderBy: 'orderNo',           // orderNoë¡œ ì£¼ë¬¸ ê²€ìƒ‰
                  orderNo: orderNo,                   // ì£¼ë¬¸ ê²€ìƒ‰ìš© orderNo
                  searchMethod: 'itemNo',             // itemNoë¡œ ì•„ì´í…œ ê²€ìƒ‰
                  items: items.map(item => ({
                    itemNo: item.itemNo,              // ì•„ì´í…œ ë²ˆí˜¸
                    deliveryNo: deliveryNo,           // deliveryNo ì¶”ê°€
                    'd/nno': tfNo,                    // D/N ë²ˆí˜¸ ì¶”ê°€
                    'd/ndate': orderDate,             // D/N ë‚ ì§œ ì¶”ê°€
                    deliveredR: item.deliveredR,      // ì„ ì R
                    deliveredkg: item.deliveredkg     // ì„ ì KG
                  })),
                  itemUpdateFields: ['deliveryNo', 'd/nno', 'd/ndate', 'deliveredR', 'deliveredkg']  // ì—…ë°ì´íŠ¸í•  í•„ë“œë“¤
                })
              });
              
              const result = await response.json();
              if (result.error) {
                console.error(`D/N Export ì‹¤íŒ¨ (${orderNo}): ${result.error}`);
                totalErrors++;
              } else {
                totalUpdated += items.length;
              }
            } else {
              // P/I ëª¨ë“œ: /api/updateOrderë¡œ ê¸°ì¡´ ì£¼ë¬¸ì˜ ì•„ì´í…œë“¤ ì—…ë°ì´íŠ¸
              const response = await fetch('/api/updateOrder', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  searchOrderBy: 'orderNo',           // orderNoë¡œ ì£¼ë¬¸ ê²€ìƒ‰
                  orderNo: orderNo,                   // ì£¼ë¬¸ ê²€ìƒ‰ìš© orderNo
                  searchMethod: 'itemNo',             // itemNoë¡œ ì•„ì´í…œ ê²€ìƒ‰
                  items: items.map(item => ({
                    itemNo: item.itemNo,              // ì•„ì´í…œ ë²ˆí˜¸
                    deliveryNo: deliveryNo,           // deliveryNo ì¶”ê°€
                    'p/ino': tfNo,                    // P/I ë²ˆí˜¸ ì¶”ê°€
                    'p/idate': orderDate,             // P/I ë‚ ì§œ ì¶”ê°€
                    'p/iprice': dueValue,             // P/I ê°€ê²© ì¶”ê°€
                    deliveredR: item.deliveredR,      // ì„ ì R
                    deliveredkg: item.deliveredkg,    // ì„ ì KG
                    'U/P': item['U/P']                // U/P
                  })),
                  itemUpdateFields: ['deliveryNo', 'p/ino', 'p/idate', 'p/iprice', 'deliveredR', 'deliveredkg', 'U/P']  // ì—…ë°ì´íŠ¸í•  í•„ë“œë“¤
                })
              });
              
              const result = await response.json();
              if (result.error) {
                console.error(`P/I Export ì‹¤íŒ¨ (${orderNo}): ${result.error}`);
                totalErrors++;
              } else {
                totalUpdated += items.length;
              }
            }
          } catch (error) {
            console.error(`ì£¼ë¬¸ ${orderNo} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:`, error);
            totalErrors++;
          }
        }
        
        // 3. ê²°ê³¼ í™•ì¸
        if (totalErrors > 0) {
          alert(`${isDnMode ? "D/N" : "P/I"} Export ì¤‘ ${totalErrors}ê°œ ì£¼ë¬¸ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
          return;
        }
        
        // Export ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        let message = `${isDnMode ? "D/N" : "P/I"} Exportê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${totalUpdated}ê°œ`;
        
        if (isDnMode) {
          message += `\nì—…ë°ì´íŠ¸ í•­ëª©: deliveryNo, d/nno, d/ndate, deliveredR, deliveredkg`;
        } else {
          message += `\nì—…ë°ì´íŠ¸ í•­ëª©: deliveryNo, p/ino, p/idate, p/iprice, deliveredR, deliveredkg, U/P`;
        }
        
        alert(message);
        
    
        // Export ì„±ê³µ - shipment.htmlë¡œ ì´ë™
        window.location.href = 'shipment.html';
        
      } catch (error) {
   
        alert(`Export ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
      }
    });
  }

  // ========================================
  // SIMPLE ê¸°ëŠ¥ - deliveryNoì˜ ëª¨ë“  ì•„ì´í…œ ì¼ê´„ ì—…ë°ì´íŠ¸
  // ========================================
  // Simple ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ í•¨ìˆ˜
  function setupSimpleButton() {
    const simpleBtn = document.getElementById("convertBtn");
    if (!simpleBtn) {
      return;
    }
    
    simpleBtn.addEventListener("click", async () => {
      // ê³µí†µ ë³€ìˆ˜ ì„ ì–¸
      const deliveryNo = document.getElementById('deliveryNoInput').value.trim();
      const tfNo = document.getElementById('tfNoInput').value.trim();
      const orderDate = document.getElementById('orderDateInput').value.trim();
      const dueValue = document.getElementById('dueInput').value;
      
      // ì…ë ¥ê°’ ê²€ì¦ - ëª¨ë“  ëª¨ë“œì—ì„œ deliveryNoë§Œ í•„ìˆ˜
      if (!deliveryNo) {
        alert("DELIVERY NOë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      // ëª¨ë“œ ê²€ì¦
      if (!["D/N", "P/I", "P/I2", "Invoice"].includes(selectedDoc)) {
        alert("D/N, P/I, P/I2 ë˜ëŠ” Invoice ëª¨ë“œì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
      }
      
      try {
        let response;
        
        // ========================================
        // D/N ëª¨ë“œ Simple ì²˜ë¦¬ (ëª¨ë“  ì£¼ë¬¸ ì—…ë°ì´íŠ¸)
        // ========================================
        if (selectedDoc === "D/N") {
          // ì…ë ¥ê°’ ì²˜ë¦¬: ê³µë€ì´ë©´ ê³µë€ìœ¼ë¡œ, ê°’ì´ ìˆìœ¼ë©´ ê·¸ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
          const dnno = tfNo.trim() || '';
          const dndate = orderDate.trim() || '';
          
          // 1. deliveryNoë¡œ ëª¨ë“  ì£¼ë¬¸ ì°¾ê¸°
          const allOrdersResponse = await fetch('/api/orders');
          const allOrders = await allOrdersResponse.json();
          
          // 2. deliveryNoê°€ í¬í•¨ëœ ëª¨ë“  ì£¼ë¬¸ ì°¾ê¸°
          const matchingOrders = allOrders.filter(order => 
            order.items && order.items.some(item => item.deliveryNo === deliveryNo)
          );
          
          console.log(`[D/N Simple] ${deliveryNo} ë§¤ì¹­ ì£¼ë¬¸: ${matchingOrders.length}ê°œ`);
          
          // 3. ê° ì£¼ë¬¸ë³„ë¡œ ê°œë³„ ì—…ë°ì´íŠ¸
          let totalUpdated = 0;
          let totalSkipped = 0;
          
          for (const order of matchingOrders) {
            try {
              const response = await fetch('/api/updateOrder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  searchOrderBy: 'orderNo',
                  orderNo: order.orderNo,
                  searchMethod: 'deliveryNo',
                  items: [{
                    deliveryNo: deliveryNo,
                    'd/nno': dnno,
                    'd/ndate': dndate
                  }],
                  itemUpdateFields: ['d/nno', 'd/ndate']
                })
              });
              
              if (response.ok) {
                const result = await response.json();
                totalUpdated += result.updatedItems || 0;
                totalSkipped += result.skippedItems || 0;
              }
            } catch (error) {
              console.error(`[D/N Simple] ì£¼ë¬¸ ${order.orderNo} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
            }
          }
          
          // 4. ê°€ìƒ ì‘ë‹µ ê°ì²´ ìƒì„±
          response = {
            ok: true,
            json: () => Promise.resolve({
              message: 'D/N Simple completed',
              updatedItems: totalUpdated,
              skippedItems: totalSkipped
            })
          };
        } 
        
        // ========================================
        // P/I ëª¨ë“œ Simple ì²˜ë¦¬ (ëª¨ë“  ì£¼ë¬¸ ì—…ë°ì´íŠ¸)
        // ========================================
        else if (selectedDoc === "P/I") {
          // ì…ë ¥ê°’ ì²˜ë¦¬: ê³µë€ì´ë©´ ê³µë€ìœ¼ë¡œ, ê°’ì´ ìˆìœ¼ë©´ ê·¸ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
          const pino = tfNo.trim() || '';
          const pidate = orderDate.trim() || '';
          const piprice = dueValue.trim() || '';
          
          // 1. deliveryNoë¡œ ëª¨ë“  ì£¼ë¬¸ ì°¾ê¸°
          const allOrdersResponse = await fetch('/api/orders');
          const allOrders = await allOrdersResponse.json();
          
          // 2. deliveryNoê°€ í¬í•¨ëœ ëª¨ë“  ì£¼ë¬¸ ì°¾ê¸°
          const matchingOrders = allOrders.filter(order => 
            order.items && order.items.some(item => item.deliveryNo === deliveryNo)
          );
          
          console.log(`[P/I Simple] ${deliveryNo} ë§¤ì¹­ ì£¼ë¬¸: ${matchingOrders.length}ê°œ`);
          
          // 3. ê° ì£¼ë¬¸ë³„ë¡œ ê°œë³„ ì—…ë°ì´íŠ¸
          let totalUpdated = 0;
          let totalSkipped = 0;
          
          for (const order of matchingOrders) {
            try {
              const response = await fetch('/api/updateOrder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  searchOrderBy: 'orderNo',
                  orderNo: order.orderNo,
                  searchMethod: 'deliveryNo',
                  items: [{
                    deliveryNo: deliveryNo,
                    'p/ino': pino,
                    'p/idate': pidate,
                    'p/iprice': piprice
                  }],
                  itemUpdateFields: ['p/ino', 'p/idate', 'p/iprice']
                })
              });
              
              if (response.ok) {
                const result = await response.json();
                totalUpdated += result.updatedItems || 0;
                totalSkipped += result.skippedItems || 0;
              }
            } catch (error) {
              console.error(`[P/I Simple] ì£¼ë¬¸ ${order.orderNo} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
            }
          }
          
          // 4. ê°€ìƒ ì‘ë‹µ ê°ì²´ ìƒì„±
          response = {
            ok: true,
            json: () => Promise.resolve({
              message: 'P/I Simple completed',
              updatedItems: totalUpdated,
              skippedItems: totalSkipped
            })
          };
        } 
        
        // ========================================
        // P/I2 ëª¨ë“œ Simple ì²˜ë¦¬ (ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë‚˜ëˆ„ì–´ì„œ API í˜¸ì¶œ)
        // ========================================
        else if (selectedDoc === "P/I2") {
          // ì…ë ¥ê°’ ì²˜ë¦¬: ê³µë€ì´ë©´ ê³µë€ìœ¼ë¡œ, ê°’ì´ ìˆìœ¼ë©´ ê·¸ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
          const pino2 = tfNo.trim() || '';
          const pidate2 = orderDate.trim() || '';
          const piprice2 = dueValue.trim() || '';
          
          // 1. deliveryNoë¡œ ëª¨ë“  ì£¼ë¬¸ ì°¾ê¸°
          const allOrdersResponse = await fetch('/api/orders');
          const allOrders = await allOrdersResponse.json();
          
          // 2. deliveryNoê°€ í¬í•¨ëœ ëª¨ë“  ì£¼ë¬¸ ì°¾ê¸°
          const matchingOrders = allOrders.filter(order => 
            order.items && order.items.some(item => item.deliveryNo === deliveryNo)
          );
          
          console.log(`[P/I2 Simple] ${deliveryNo} ë§¤ì¹­ ì£¼ë¬¸: ${matchingOrders.length}ê°œ`);
          
          // 3. ê° ì£¼ë¬¸ë³„ë¡œ ê°œë³„ ì—…ë°ì´íŠ¸
          let totalUpdated = 0;
          let totalSkipped = 0;
          
          for (const order of matchingOrders) {
            try {
              const response = await fetch('/api/updateOrder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  searchOrderBy: 'orderNo',
                  orderNo: order.orderNo,
                  searchMethod: 'deliveryNo',
                  items: [{
                    deliveryNo: deliveryNo,
                    'p/ino2': pino2,
                    'p/idate2': pidate2,
                    'p/iprice2': piprice2
                  }],
                  itemUpdateFields: ['p/ino2', 'p/idate2', 'p/iprice2']
                })
              });
              
              if (response.ok) {
                const result = await response.json();
                totalUpdated += result.updatedItems || 0;
                totalSkipped += result.skippedItems || 0;
              }
            } catch (error) {
              console.error(`[P/I2 Simple] ì£¼ë¬¸ ${order.orderNo} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
            }
          }
          
          // 4. ê°€ìƒ ì‘ë‹µ ê°ì²´ ìƒì„±
          response = {
            ok: true,
            json: () => Promise.resolve({
              message: 'P/I2 Simple completed',
              updatedItems: totalUpdated,
              skippedItems: totalSkipped
            })
          };
        } 
        
        // ========================================
        // Invoice ëª¨ë“œ Simple ì²˜ë¦¬ (ëª¨ë“  ì£¼ë¬¸ ì—…ë°ì´íŠ¸)
        // ========================================
        else if (selectedDoc === "Invoice") {
          // ì…ë ¥ê°’ ì²˜ë¦¬: ê³µë€ì´ë©´ ê³µë€ìœ¼ë¡œ, ê°’ì´ ìˆìœ¼ë©´ ê·¸ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
          const invoicePriceInput = document.getElementById('invoicePriceInput');
          const invoicePrice = invoicePriceInput ? invoicePriceInput.value : '';
          
          const invoiceno = tfNo.trim() || '';
          const invoicedate = orderDate.trim() || '';
          const invoicedue = dueValue.trim() || '';
          const invoiceprice = invoicePrice.trim() || '';
          
          // 1. deliveryNoë¡œ ëª¨ë“  ì£¼ë¬¸ ì°¾ê¸°
          const allOrdersResponse = await fetch('/api/orders');
          const allOrders = await allOrdersResponse.json();
          
          // 2. deliveryNoê°€ í¬í•¨ëœ ëª¨ë“  ì£¼ë¬¸ ì°¾ê¸°
          const matchingOrders = allOrders.filter(order => 
            order.items && order.items.some(item => item.deliveryNo === deliveryNo)
          );
          
          console.log(`[Invoice Simple] ${deliveryNo} ë§¤ì¹­ ì£¼ë¬¸: ${matchingOrders.length}ê°œ`);
          
          // 3. ê° ì£¼ë¬¸ë³„ë¡œ ê°œë³„ ì—…ë°ì´íŠ¸
          let totalUpdated = 0;
          let totalSkipped = 0;
          
          for (const order of matchingOrders) {
            try {
              const response = await fetch('/api/updateOrder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  searchOrderBy: 'orderNo',
                  orderNo: order.orderNo,
                  searchMethod: 'deliveryNo',
                  items: [{
                    deliveryNo: deliveryNo,
                    'invoiceno': invoiceno,
                    'invoicedate': invoicedate,
                    'invoicedue': invoicedue,
                    'invoiceprice': invoiceprice
                  }],
                  itemUpdateFields: ['invoiceno', 'invoicedate', 'invoicedue', 'invoiceprice']
                })
              });
              
              if (response.ok) {
                const result = await response.json();
                totalUpdated += result.updatedItems || 0;
                totalSkipped += result.skippedItems || 0;
              }
            } catch (error) {
              console.error(`[Invoice Simple] ì£¼ë¬¸ ${order.orderNo} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
            }
          }
          
          // 4. ê°€ìƒ ì‘ë‹µ ê°ì²´ ìƒì„±
          response = {
            ok: true,
            json: () => Promise.resolve({
              message: 'Invoice Simple completed',
              updatedItems: totalUpdated,
              skippedItems: totalSkipped
            })
          };
        }
        
        if (response.ok) {
          const result = await response.json();
          
          // Simple ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
          let message = `${selectedDoc} Simpleì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${result.updatedItems}ê°œ`;
          
          if (result.skippedItems > 0) {
            message += `\në§¤ì¹­ë˜ì§€ ì•Šì€ ì•„ì´í…œ: ${result.skippedItems}ê°œ`;
          }
          
          // ëª¨ë“œë³„ ì—…ë°ì´íŠ¸ í•­ëª© í‘œì‹œ
          if (selectedDoc === "D/N") {
            message += `\nì—…ë°ì´íŠ¸ í•­ëª©: d/nno, d/ndate`;
          } else if (selectedDoc === "P/I") {
            message += `\nì—…ë°ì´íŠ¸ í•­ëª©: p/ino, p/idate, p/iprice`;
          } else if (selectedDoc === "P/I2") {
            message += `\nì—…ë°ì´íŠ¸ í•­ëª©: p/ino2, p/idate2, p/iprice2`;
          } else if (selectedDoc === "Invoice") {
            message += `\nì—…ë°ì´íŠ¸ í•­ëª©: invoiceno, invoicedate, invoicedue, invoiceprice`;
          }
          
          alert(message);
          
          // ë°ì´í„° ì €ì¥ (ì…ë ¥ í•„ë“œëŠ” ìœ ì§€)
          
          // shipment.htmlë¡œ ì´ë™
          window.location.href = 'shipment.html';
        } else {
          const errorText = await response.text();
          let errorMessage = 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          
          try {
            const error = JSON.parse(errorText);
            errorMessage = error.message || errorMessage;
          } catch (e) {
            errorMessage = errorText || errorMessage;
          }
          
          alert(`${selectedDoc} Simple ì‹¤íŒ¨: ${errorMessage}`);
        }
      } catch (error) {
        alert('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });
  }

  // í–‰ ì¶”ê°€ ê¸°ëŠ¥
  function addRows(count = null) {
    const rowCountInput = document.getElementById("rowCountInput");
    const tableBody = document.getElementById("shipmentTableBody");
    
    if (!tableBody) {
      return;
    }
    
    let rowCount;
    if (count !== null) {
      rowCount = count;
    } else {
      rowCount = parseInt(rowCountInput.value) || 1;
      
      if (rowCount < 1 || rowCount > 100) {
        alert("1ë¶€í„° 100ê¹Œì§€ì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
    }
    
    // ìƒˆë¡œ ì…ë ¥í•œ ìˆ«ìë§Œí¼ í–‰ ì¶”ê°€
    for (let i = 0; i < rowCount; i++) {
      const newRow = createTableRow();
      tableBody.appendChild(newRow);
    }
    
    // ìƒˆë¡œ ì¶”ê°€ëœ í–‰ë“¤ì— ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì„¤ì •
    setupDragHandles();
  }

  // í…Œì´ë¸” í–‰ ìƒì„± í•¨ìˆ˜
  function createTableRow() {
    const row = document.createElement("tr");
    
    // í˜„ì¬ í–‰ ë²ˆí˜¸ ê³„ì‚°
    const currentRowCount = document.getElementById("shipmentTableBody").children.length;
    const rowNumber = currentRowCount + 1;
    
    row.innerHTML = `
      <!-- 1: Drag + Select (í•©ì³ì§„ ì—´) -->
      <td class="drag-select-cell">
        <div class="select-buttons">
          <div class="select-row">
            <div class="drag-handle">â˜°</div>
            <button class="deleteButton" type="button">X</button>
          </div>
        </div>
      </td>
      <!-- 2: Mode -->
      <td>
        <select class="modeDropdown">
          <option value=""></option>
          <option value="NT">NT</option>
          <option value="SM">SM</option>
        </select>
      </td>
      <!-- 3: Order No -->
      <td>
        <select class="orderDropdown">
          <option value=""></option>
        </select>
      </td>
      <!-- 4: Item No -->
      <td>
        <select class="itemDropdown">
          <option value=""></option>
        </select>
      </td>
      <!-- 5: Item -->
      <td class="itemInfoCell"></td>
      <!-- 6: ì£¼ë¬¸R -->
      <td><input type="number" class="orderRInput" placeholder="" step="0.01" readonly /></td>
      <!-- 7: ì„ ì R -->
      <td>
        <input type="number" class="partialRInput" placeholder="" step="0.01" />
      </td>
      <!-- 8: ProducedKG -->
      <td><input type="number" class="producedKGInput" placeholder="" step="0.01" readonly /></td>
      <!-- 9: DeliveredKG -->
      <td>
        <input type="number" class="deliveredKGInput" placeholder="" step="0.01" />
      </td>
      <!-- 10: U/P -->
        <td>
          <input type="number" class="upInput" placeholder="" step="0.01" />
      </td>
    `;
    
    // ì—‘ìŠ¤ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    const deleteButton = row.querySelector('.deleteButton');
    deleteButton.addEventListener('click', function() {
      deleteItemRecord(row);
    });


    
    // ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í†µí•© ì„¤ì •
    setupDropdownEventListeners(row);
    
    // ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    setupRowInputEventListeners(row);
    
    return row;
  }

  // ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í†µí•© í•¨ìˆ˜
  function setupDropdownEventListeners(row) {
    // Mode ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì´ë²¤íŠ¸
    const modeDropdown = row.querySelector('.modeDropdown');
    modeDropdown.addEventListener('change', function() {
      const selectedMode = this.value;
      const currentRow = this.closest('tr');
      
      // í˜„ì¬ í–‰ë¶€í„° ì•„ë˜ í–‰ë“¤ì˜ ëª¨ë“œë¥¼ ë™ì¼í•˜ê²Œ ì„¤ì • (ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±° ì—†ì´)
      updateRowsBelow(currentRow, 'mode', selectedMode, false);
      
      // Order No ëª©ë¡ ì—…ë°ì´íŠ¸ (í˜„ì¬ í–‰ë¶€í„° ì•„ë˜ í–‰ë“¤ë§Œ, í•œ ë²ˆë§Œ í˜¸ì¶œ)
      if (selectedMode) {
        updateOrderDropdown(selectedMode, currentRow);
      }
    });
    
    // Order No ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì´ë²¤íŠ¸
    const orderDropdown = row.querySelector('.orderDropdown');
    orderDropdown.addEventListener('change', async function() {
      const selectedOrderNo = this.value;
      if (selectedOrderNo) {
        const currentRow = this.closest('tr');
        
        // í˜„ì¬ í–‰ë¶€í„° ì•„ë˜ í–‰ë“¤ì˜ Order Noë¥¼ ë™ì¼í•˜ê²Œ ì„¤ì •
        updateRowsBelow(currentRow, 'orderNo', selectedOrderNo);
        
        // í˜„ì¬ í–‰ë¶€í„° ì•„ë˜ í–‰ë“¤ì˜ Item No ì—…ë°ì´íŠ¸ (í•œ ë²ˆì˜ API í˜¸ì¶œë¡œ ìµœì í™”)
        const rowsBelow = getRowsBelow(currentRow);
        if (rowsBelow.length > 0) {
          try {
            // í•œ ë²ˆë§Œ API í˜¸ì¶œ
            const response = await fetch(`/api/orders`);
            const orders = await response.json();
            const orderData = orders.find(order => order.orderNo === selectedOrderNo);
            
            if (orderData) {
              // ê° í–‰ì— ëŒ€í•´ Item No ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ (API í˜¸ì¶œ ì—†ì´)
              for (const targetRow of rowsBelow) {
                const targetOrderDropdown = targetRow.querySelector('.orderDropdown');
                if (targetOrderDropdown && targetOrderDropdown.value === selectedOrderNo) {
                  await updateItemDropdownForRowWithData(targetRow, orderData);
                }
              }
            }
          } catch (error) {
            console.error('Item No ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
          }
        }
      }
    });
    
    // Item No ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì´ë²¤íŠ¸
    const itemDropdown = row.querySelector('.itemDropdown');
    itemDropdown.addEventListener('change', async function() {
      const selectedItemNo = this.value;
      if (selectedItemNo) {
        const orderNo = row.querySelector('.orderDropdown').value;
        if (orderNo) {
          try {
            const response = await fetch(`/api/orders`);
            const orders = await response.json();
            const orderData = orders.find(order => order.orderNo === orderNo);
            
            if (orderData && orderData.items) {
              const selectedItem = orderData.items.find(item => item.itemNo === selectedItemNo);
              if (selectedItem) {
                updateItemInfo(row, selectedItem);
              }
            }
          } catch (error) {
            // ì—ëŸ¬ ì²˜ë¦¬
          }
        }
      }
    });
  }
  
  // ì•„ë˜ í–‰ë“¤ ì—…ë°ì´íŠ¸ ê³µí†µ í•¨ìˆ˜
  function updateRowsBelow(currentRow, type, value, triggerEvent = false) {
        const allRows = Array.from(document.querySelectorAll('#shipmentTableBody tr'));
        const currentRowIndex = allRows.indexOf(currentRow);
        
    for (let i = currentRowIndex; i < allRows.length; i++) {
      const targetRow = allRows[i];
      const dropdown = targetRow.querySelector(`.${type === 'mode' ? 'modeDropdown' : 'orderDropdown'}`);
      if (dropdown) {
        dropdown.value = value;
        // triggerEventê°€ trueì¼ ë•Œë§Œ change ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±° (ê¸°ë³¸ê°’ì€ falseë¡œ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€)
        if (triggerEvent && type === 'mode' && value) {
          dropdown.dispatchEvent(new Event('change', { bubbles: true }));
        }
      }
    }
  }

  // í˜„ì¬ í–‰ë¶€í„° ì•„ë˜ í–‰ë“¤ ë°˜í™˜ í•¨ìˆ˜
  function getRowsBelow(currentRow) {
    const allRows = Array.from(document.querySelectorAll('#shipmentTableBody tr'));
    const currentRowIndex = allRows.indexOf(currentRow);
    return allRows.slice(currentRowIndex);
  }

  // í–‰ ë²ˆí˜¸ ì¬ì •ë ¬ í•¨ìˆ˜
  function updateRowNumbers() {
    const rows = document.querySelectorAll('#shipmentTableBody tr');
    rows.forEach((row, index) => {
      const noCell = row.querySelector('td:nth-child(2)');
      if (noCell) {
        noCell.textContent = index + 1;
      }
    });
  }

  // Order No ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  async function updateOrderDropdown(selectedMode, startRow = null) {
    try {
      const response = await fetch(`/api/orders`);
      const orders = await response.json();
      
      // isProductionComplete: trueì´ê³  completeê°€ trueê°€ ì•„ë‹Œ ì•„ì´í…œì´ ìˆëŠ” ì£¼ë¬¸ë“¤ í•„í„°ë§
      const availableOrders = orders.filter(order => {
        // ëª¨ë“œ ë§¤ì¹­: ì£¼ë¬¸ ë ˆë²¨ì—ì„œ order.modeë¡œ ì§ì ‘ ë¹„êµ
        // SM ì„ íƒ ì‹œ SM-B, SM-C ëª¨ë‘ í¬í•¨
        let modeMatches = false;
        if (selectedMode === 'SM') {
          modeMatches = order.mode === 'SM-B' || order.mode === 'SM-C';
        } else {
          modeMatches = order.mode === selectedMode;
        }
        
        return modeMatches && order.items?.some(item => 
          item.isProductionComplete === true && item.complete !== true
        );
      });
      
      // Order No ì •ë ¬ (ë…„ë„ â†’ ë²ˆí˜¸ ìˆœ)
      availableOrders.sort((a, b) => {
        const aParts = a.orderNo.split('-');
        const bParts = b.orderNo.split('-');
        
        if (aParts.length >= 3 && bParts.length >= 3) {
          const aYear = parseInt(aParts[1]) || 0;
          const bYear = parseInt(bParts[1]) || 0;
          if (aYear !== bYear) return aYear - bYear;
          
          const aNum = parseInt(aParts[2]) || 0;
          const bNum = parseInt(bParts[2]) || 0;
          return aNum - bNum;
        }
        
        return a.orderNo.localeCompare(b.orderNo);
      });
      
      // Order No ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ (startRowê°€ ìˆìœ¼ë©´ í•´ë‹¹ í–‰ë¶€í„° ì•„ë˜ë§Œ, ì—†ìœ¼ë©´ ëª¨ë“  í–‰)
      let targetDropdowns;
      if (startRow) {
        // startRowë¶€í„° ì•„ë˜ í–‰ë“¤ë§Œ
        const allRows = Array.from(document.querySelectorAll('#shipmentTableBody tr'));
        const startRowIndex = allRows.indexOf(startRow);
        const rowsBelow = allRows.slice(startRowIndex);
        targetDropdowns = rowsBelow.map(row => row.querySelector('.orderDropdown')).filter(dropdown => dropdown);
      } else {
        // ëª¨ë“  í–‰
        targetDropdowns = document.querySelectorAll('.orderDropdown');
      }
      
      targetDropdowns.forEach(dropdown => {
        if (!dropdown) return;
        
        // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ë¹ˆ ì˜µì…˜ ì œì™¸)
        while (dropdown.children.length > 1) {
          dropdown.removeChild(dropdown.lastChild);
        }
        
        // ìƒˆ ì˜µì…˜ ì¶”ê°€
        availableOrders.forEach(order => {
          const option = document.createElement('option');
          option.value = order.orderNo;
          option.textContent = order.orderNo;
          dropdown.appendChild(option);
        });
      });
      
      
    } catch (error) {
      console.error('Order No ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
    }
  }

  // íŠ¹ì • í–‰ì˜ Item No ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (orderDataë¥¼ ì§ì ‘ ë°›ëŠ” ë²„ì „, API í˜¸ì¶œ ì—†ìŒ)
  function updateItemDropdownForRowWithData(row, orderData, targetItemNo = null) {
    if (!orderData) return;
    
    // isProductionComplete: true ë˜ëŠ” productionì—ì„œ ìƒì‚°ì— ì²´í¬ëœ ì•„ì´í…œì´ê³  completeê°€ trueê°€ ì•„ë‹Œ ì•„ì´í…œë“¤ë§Œ í•„í„°ë§
    const availableItems = orderData.items
      ? orderData.items.filter(item => {
          // completeê°€ trueì¸ ì•„ì´í…œì€ ì œì™¸
          if (item.complete === true) return false;
          
          // isProductionCompleteê°€ trueì¸ ì•„ì´í…œ
          if (item.isProductionComplete === true) return true;
          
          // productionì—ì„œ ìƒì‚°ì— ì²´í¬ëœ ì•„ì´í…œ (90% ì´ìƒ ìƒì‚° ì™„ë£Œ)
          const orderWeight = parseFloat(item.tfkg) || 0;
          const producedkgStr = item.producedkg || '';
          const producedWeight = (producedkgStr === '000.' || producedkgStr === '0.0' || producedkgStr === '0') ? 0 : parseFloat(producedkgStr) || 0;
          
          if (orderWeight > 0 && producedWeight > 0 && producedWeight >= orderWeight * 0.9) return true;
          
          return false;
        }).sort((a, b) => (parseInt(a.itemNo) || 0) - (parseInt(b.itemNo) || 0))
      : [];
    
    const itemDropdown = row.querySelector('.itemDropdown');
    if (!itemDropdown) return;
    
    // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ë¹ˆ ì˜µì…˜ ì œì™¸)
    while (itemDropdown.children.length > 1) {
      itemDropdown.removeChild(itemDropdown.lastChild);
    }
    
    // ìƒˆ ì˜µì…˜ ì¶”ê°€
    availableItems.forEach(item => {
      const option = document.createElement('option');
      option.value = item.itemNo;
      option.textContent = item.itemNo;
      itemDropdown.appendChild(option);
    });
    
    // ì•„ì´í…œ ì„ íƒ ë° ì •ë³´ ì—…ë°ì´íŠ¸ (targetItemNoê°€ ìˆì„ ë•Œë§Œ)
    if (availableItems.length > 0 && targetItemNo) {
      const selectedItem = availableItems.find(item => item.itemNo === targetItemNo);
      if (selectedItem) {
        itemDropdown.value = selectedItem.itemNo;
        updateItemInfo(row, selectedItem);
      }
    }
  }

  // ì•„ì´í…œ ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (5ì—´ì— í‘œì‹œ)
  function updateItemInfo(row, item) {
    if (!item) return;
    
    const itemCell = row.querySelector('td:nth-child(5)'); // 5ë²ˆì§¸ ì—´ (Item)
    if (itemCell) {
      // production.htmlê³¼ ë™ì¼í•œ í˜•ì‹: PHD-6.0(620)6x
      const itemInfo = `PHD-${item.phd}(${item.width})${item.x}`;
      itemCell.textContent = itemInfo;
    }
      
      // ì£¼ë¬¸R ê³„ì‚° ë° ì—…ë°ì´íŠ¸
      updateOrderR(row, item);
      
    // ì„ ì R ê°’ ì„¤ì • (deliveredRì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì£¼ë¬¸R ê°’ ì‚¬ìš©)
      const partialRInput = row.querySelector('.partialRInput');
    if (partialRInput) {
      if (item.deliveredR) {
        partialRInput.value = item.deliveredR;
      } else if (item.adjustment) {
        // deliveredRì´ ì—†ìœ¼ë©´ ì£¼ë¬¸R(adjustment) ê°’ì„ ì„ ì Rë¡œ ì„¤ì •
        partialRInput.value = item.adjustment;
      } else {
        partialRInput.value = '';
      }
      }
      
      // ProducedKG ê°’ ì„¤ì •
      const producedKGInput = row.querySelector('.producedKGInput');
      if (producedKGInput && item.producedkg) {
        producedKGInput.value = item.producedkg;
      }
      
      // DeliveredKG ê°’ ì„¤ì • (0.0ì´ë©´ producedkg ê°’ ì‚¬ìš©)
      const deliveredKGInput = row.querySelector('.deliveredKGInput');
      if (deliveredKGInput) {
        if (item.deliveredkg && parseFloat(item.deliveredkg) !== 0.0) {
          deliveredKGInput.value = item.deliveredkg;
        } else if (item.producedkg) {
          deliveredKGInput.value = item.producedkg;
      } else {
        deliveredKGInput.value = '';
        }
      }
      
      // U/P ê°’ ì„¤ì •
      const upInput = row.querySelector('.upInput');
      if (upInput) {
        if (item['U/P']) {
        upInput.value = item['U/P'];
        } else {
          upInput.value = ''; // U/P ê°’ì´ ì—†ìœ¼ë©´ ê³µë€ìœ¼ë¡œ ì„¤ì •
      }
    }
    
    // ì„ ì Rê³¼ ì£¼ë¬¸R ë¹„êµí•˜ì—¬ ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬ í‘œì‹œ
    checkPartialRMatch();
    
    // Total ì—…ë°ì´íŠ¸
    updateTotal();
  }

  // ì£¼ë¬¸R ê³„ì‚° ë° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateOrderR(row, item) {
    if (!item) return;
    
    const orderRInput = row.querySelector('.orderRInput');
    
    if (orderRInput) {
      // adjustment ê°’ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê³µë€
      if (item.adjustment) {
        const orderR = parseFloat(item.adjustment);
        orderRInput.value = isNaN(orderR) ? '' : orderR.toString();
        } else {
        orderRInput.value = '';
      }
      
    }
  }

  // ========================================
  // ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬ í‘œì‹œ ê¸°ëŠ¥ (ì„ ì R â‰  ì£¼ë¬¸R ê²€ì¦)
  // ========================================
  // ì„ ì Rê³¼ ì£¼ë¬¸R ë¹„êµ í•¨ìˆ˜ (ìµœì í™”ë¨)
  function checkPartialRMatch() {
    // totalCacheë¥¼ í™œìš©í•˜ì—¬ ì´ë¯¸ ì¿¼ë¦¬ëœ ìš”ì†Œë“¤ ì‚¬ìš©
    if (!totalCache.partialRInputs || !totalCache.deliveredKGInputs) {
      return; // ìºì‹œê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
    }
    
    // partialRInputê³¼ deliveredKGInputì„ ìˆœíšŒí•˜ë©´ì„œ í•´ë‹¹ í–‰ì˜ ë‹¤ë¥¸ ìš”ì†Œë“¤ ì°¾ê¸°
    totalCache.partialRInputs.forEach((partialRInput, index) => {
      const row = partialRInput.closest('tr');
      if (!row) return;
      
      const orderRInput = row.querySelector('.orderRInput');
      const producedKGInput = row.querySelector('.producedKGInput');
      const deliveredKGInput = totalCache.deliveredKGInputs[index];
      
      if (orderRInput && producedKGInput && deliveredKGInput) {
        const orderR = parseFloat(orderRInput.value) || 0;
        const partialR = parseFloat(partialRInput.value) || 0;
        const producedKG = parseFloat(producedKGInput.value) || 0;
        const deliveredKG = parseFloat(deliveredKGInput.value) || 0;
        
        // ì¡°ê±´: ì„ ì R â‰  ì£¼ë¬¸R AND DeliveredKG â‰ˆ ProducedKG (Â±10% ë²”ìœ„)
        const isDeliveredKGCloseToProducedKG = deliveredKG >= (producedKG * 0.9) && deliveredKG <= (producedKG * 1.1);
        const shouldHighlight = (orderR !== partialR) && isDeliveredKGCloseToProducedKG;
        
        if (shouldHighlight) {
          // ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬ í‘œì‹œ (mismatch í´ë˜ìŠ¤ ì¶”ê°€)
          partialRInput.classList.add('mismatch');
          deliveredKGInput.classList.add('mismatch');
        } else {
          // ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬ ì œê±° (mismatch í´ë˜ìŠ¤ ì œê±°)
          partialRInput.classList.remove('mismatch');
          deliveredKGInput.classList.remove('mismatch');
        }
      }
    });
  }

  // debounce í•¨ìˆ˜ (ì„±ëŠ¥ ìµœì í™”)
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // debounced í•¨ìˆ˜ë“¤ ìƒì„±
  const debouncedUpdateTotal = debounce(updateTotal, 100);
  const debouncedCheckPartialRMatch = debounce(checkPartialRMatch, 50);

  // ê°œë³„ í–‰ì˜ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • í•¨ìˆ˜ (ìµœì í™”ë¨)
  function setupRowInputEventListeners(row) {
    // DeliveredKG ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const deliveredKGInput = row.querySelector('.deliveredKGInput');
    if (deliveredKGInput) {
      deliveredKGInput.addEventListener('input', function() {
        debouncedCheckPartialRMatch(); // ì„ ì R â‰  ì£¼ë¬¸R ê²€ì¦ ë° ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬ í‘œì‹œ
        debouncedUpdateTotal(); // í•˜ë‹¨ Total ê°’ ìë™ ì¬ê³„ì‚°
      });
    }

    // ì„ ì R ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const partialRInput = row.querySelector('.partialRInput');
    if (partialRInput) {
      partialRInput.addEventListener('input', function() {
        debouncedCheckPartialRMatch(); // ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬ ì²´í¬
        debouncedUpdateTotal(); // í•˜ë‹¨ Total ê°’ ìë™ ì¬ê³„ì‚°
      });
    }

    // U/P ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const upInput = row.querySelector('.upInput');
    if (upInput) {
      upInput.addEventListener('input', function() {
        debouncedUpdateTotal(); // í•˜ë‹¨ Total Price ìë™ ì¬ê³„ì‚°
      });
    }
  }

  // ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬ í‘œì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ í•¨ìˆ˜ (ìµœì í™”ë¨)
  function setupMismatchEventListeners() {
    // ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ. setupRowInputEventListenersë¡œ ëŒ€ì²´ë¨.
    // ì¤‘ë³µ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì œê±°ë¨.
  }

  // Total ê³„ì‚° í•¨ìˆ˜ (ìµœì í™”ë¨)
  let totalCache = {
    partialRInputs: null,
    deliveredKGInputs: null,
    upInputs: null,
    totalReelInput: null,
    totalKGInput: null,
    totalPriceInput: null,
    lastRowCount: 0
  };

  function updateTotal() {
    const currentRowCount = document.querySelectorAll('#shipmentTableBody tr').length;
    
    // í–‰ ìˆ˜ê°€ ë³€ê²½ë˜ì—ˆê±°ë‚˜ ìºì‹œê°€ ì—†ìœ¼ë©´ DOM ìš”ì†Œ ë‹¤ì‹œ ì¿¼ë¦¬
    if (currentRowCount !== totalCache.lastRowCount || !totalCache.partialRInputs) {
      totalCache.partialRInputs = document.querySelectorAll('.partialRInput');
      totalCache.deliveredKGInputs = document.querySelectorAll('.deliveredKGInput');
      totalCache.upInputs = document.querySelectorAll('.upInput');
      totalCache.totalReelInput = document.getElementById('totalReelInput');
      totalCache.totalKGInput = document.getElementById('totalKGInput');
      totalCache.totalPriceInput = document.getElementById('totalPriceInput');
      totalCache.lastRowCount = currentRowCount;
    }
    
    let totalReel = 0;
    let totalKG = 0;
    let totalPrice = 0;
    
    // ì„ ì R í•©ê³„ ê³„ì‚°
    totalCache.partialRInputs.forEach((input) => {
      const value = parseFloat(input.value) || 0;
      totalReel += value;
    });
    
    // DeliveredKG í•©ê³„ ê³„ì‚°
    totalCache.deliveredKGInputs.forEach((input) => {
      const value = parseFloat(input.value) || 0;
      totalKG += value;
    });
    
    // Total Price ê³„ì‚°: deliveredKG * U/Pì˜ ì´í•©
    for (let i = 0; i < Math.min(totalCache.deliveredKGInputs.length, totalCache.upInputs.length); i++) {
      const deliveredKG = parseFloat(totalCache.deliveredKGInputs[i].value) || 0;
      const up = parseFloat(totalCache.upInputs[i].value) || 0;
      totalPrice += deliveredKG * up;
    }
    
    // í•˜ë‹¨ Total í•„ë“œì— ê°’ ì„¤ì •
    if (totalCache.totalReelInput) {
      totalCache.totalReelInput.value = Math.round(totalReel).toString();
    }
    if (totalCache.totalKGInput) {
      totalCache.totalKGInput.value = totalKG.toFixed(3);
    }
    if (totalCache.totalPriceInput) {
      totalCache.totalPriceInput.value = totalPrice.toFixed(2);
    }
  }


  // í…Œì´ë¸” ì •ë ¬ í•¨ìˆ˜ (Order No â†’ Item No ìˆœ)
  function organizeTable() {
    const tableBody = document.getElementById('shipmentTableBody');
    if (!tableBody) return;
    
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    
    // ê° í–‰ì˜ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ì—¬ ì •ë ¬
    const rowData = rows.map(row => {
      const orderDropdown = row.querySelector('.orderDropdown');
      const itemDropdown = row.querySelector('.itemDropdown');
      
      const orderNo = orderDropdown ? orderDropdown.value : '';
      const itemNo = itemDropdown ? itemDropdown.value : '';
      
      // Order Noì—ì„œ ë…„ë„ì™€ ë²ˆí˜¸ ì¶”ì¶œ (ì˜ˆ: EK-2025-01 â†’ {year: 2025, num: 1})
      let orderYear = 0;
      let orderNum = 0;
      if (orderNo) {
        const parts = orderNo.split('-');
        if (parts.length >= 3) {
          orderYear = parseInt(parts[1]) || 0;  // ë…„ë„
          orderNum = parseInt(parts[2]) || 0;   // ë²ˆí˜¸
        }
      }
      
      // Item Noì—ì„œ ìˆ«ì ë¶€ë¶„ ì¶”ì¶œ (ì˜ˆ: 0001 â†’ 1, 0002 â†’ 2)
      const itemNum = parseInt(itemNo) || 0;
      
      return {
        row: row,
        orderNo: orderNo,
        itemNo: itemNo,
        orderYear: orderYear,
        orderNum: orderNum,
        itemNum: itemNum
      };
    });
    
    // ì •ë ¬: ë…„ë„ ìˆœ â†’ Order No ë²ˆí˜¸ ìˆœ â†’ Item No ìˆœ
    rowData.sort((a, b) => {
      if (a.orderYear !== b.orderYear) return a.orderYear - b.orderYear;
      if (a.orderNum !== b.orderNum) return a.orderNum - b.orderNum;
      return a.itemNum - b.itemNum;
    });
    
    // í…Œì´ë¸” ë°”ë”” ì´ˆê¸°í™” í›„ ì •ë ¬ëœ ìˆœì„œë¡œ í–‰ë“¤ì„ ë‹¤ì‹œ ì¶”ê°€
    tableBody.innerHTML = '';
    rowData.forEach(data => {
      tableBody.appendChild(data.row);
    });
  }


  // ADD ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ í•¨ìˆ˜
  function setupAddRowsButton() {
    const addRowsBtn = document.getElementById("addRowsBtn");
    if (!addRowsBtn) return;
    
    addRowsBtn.addEventListener("click", function() {
      const rowCountInput = document.getElementById("rowCountInput");
      const count = parseInt(rowCountInput.value) || 1;
      addRows(count);
    });
  }

  // + ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ í•¨ìˆ˜
  function setupAddSingleButton() {
    const addSingleBtn = document.getElementById("addSingleBtn");
    if (!addSingleBtn) return;
    
    addSingleBtn.addEventListener("click", () => {
      addRows(1); // 1í–‰ ì¶”ê°€
    });
  }

  function setupRefreshButton() {
    const refreshBtn = document.getElementById("refreshBtn");
    if (!refreshBtn) {
      // console.error("[ë¦¬í”„ë ˆì‹œ ë²„íŠ¼] refreshBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
      return;
    }
    
    refreshBtn.addEventListener("click", () => {
      // í˜„ì¬ í™”ë©´ì˜ ëª¨ë“  ì•„ì´í…œ í–‰ë“¤ì„ ì§€ì›€
      const tableBody = document.getElementById("shipmentTableBody");
      if (tableBody) {
        tableBody.innerHTML = '';
      }
    });
  }


  // P/I PRICE ìë™ ê³„ì‚° í•¨ìˆ˜ (ì²« ë²ˆì§¸ ì•„ì´í…œì˜ p/iprice + p/iprice2)
  function calculatePiPrice() {
    const deliveryNo = document.getElementById('deliveryNoInput').value.trim();
    if (!deliveryNo) {
      document.getElementById('piPriceInput').value = '0';
      return;
    }
    
    fetch('/api/orders')
      .then(response => response.json())
      .then(data => {
        // ëª¨ë“  ì£¼ë¬¸ì—ì„œ í•´ë‹¹ deliveryNoë¥¼ ê°€ì§„ ì²« ë²ˆì§¸ ì•„ì´í…œ ì°¾ê¸°
        for (const order of data) {
          if (order.items && Array.isArray(order.items)) {
            const firstItem = order.items.find(item => (item.deliveryno || item.deliveryNo) === deliveryNo);
            if (firstItem) {
              const piPrice = parseFloat(firstItem['p/iprice']) || 0;
              const piPrice2 = parseFloat(firstItem['p/iprice2']) || 0;
              const totalPiPrice = piPrice + piPrice2;
              document.getElementById('piPriceInput').value = totalPiPrice.toFixed(2);
              return;
            }
          }
        }
        document.getElementById('piPriceInput').value = '0';
      })
      .catch(error => {
        document.getElementById('piPriceInput').value = '0';
      });
  }



  // ========================================
  // OPEN ë²„íŠ¼ ê¸°ëŠ¥ - deliveryNo ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  // ========================================

  // ì„œë²„ íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ (ê°„ì†Œí™”)
  async function loadServerFileList() {
    const fileListDiv = document.getElementById("serverFileList");
    const modeFilter = document.getElementById("modeFilter");
    if (!fileListDiv) return;
    
    // ë¡œë”© ë©”ì‹œì§€ ì œê±° - ë°”ë¡œ ë¡œë“œ ì‹œì‘
    
    try {
      const response = await fetch('/api/orders');
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      
      const allFiles = await response.json();
      
      // ëª¨ë“œ í•„í„° ì ìš©
      const selectedMode = modeFilter && modeFilter.value ? modeFilter.value : 'all';
      
      // deliveryNoë³„ë¡œ ê·¸ë£¹í™” (ìµœì í™”ë¨)
      const deliveryGroups = {};
      allFiles.forEach(order => {
        if (order.items && order.items.length > 0) {
          order.items.forEach(item => {
            // deliveryNo ë˜ëŠ” deliveryNo ë‘˜ ë‹¤ í™•ì¸
            const deliveryValue = item.deliveryno || item.deliveryNo;
            if (deliveryValue && deliveryValue.trim() !== '') {
              const deliveryKey = deliveryValue;
              
              // ëª¨ë“œ í•„í„°ë§: ì²« ë²ˆì§¸ ì•„ì´í…œì˜ ì£¼ë¬¸ ë ˆë²¨ modeë¡œ ë§¤ì¹˜
      if (selectedMode !== 'all') {
                // ì´ë¯¸ ì²˜ë¦¬ëœ deliveryNoë©´ ëª¨ë“œ í™•ì¸ í›„ ìŠ¤í‚µ
                if (deliveryGroups[deliveryKey]) {
                  // ëª¨ë“œê°€ ì¼ì¹˜í•˜ë©´ ì¹´ìš´íŠ¸ ì¦ê°€, ì•„ë‹ˆë©´ ìŠ¤í‚µ
                  if (deliveryGroups[deliveryKey].orderMode === selectedMode) {
                    deliveryGroups[deliveryKey].itemCount++;
                  }
                  return;
                }
                
                // ì²« ë²ˆì§¸ ì•„ì´í…œì´ë¯€ë¡œ ì£¼ë¬¸ì˜ mode í™•ì¸
                // SM ì„ íƒ ì‹œ SM-B, SM-C ëª¨ë‘ í¬í•¨
                let modeMatches = false;
                if (selectedMode === 'SM') {
                  modeMatches = order.mode === 'SM-B' || order.mode === 'SM-C';
                } else {
                  modeMatches = order.mode === selectedMode;
                }
                
                if (!modeMatches) {
                  return; // ëª¨ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ìŠ¤í‚µ
                }
              } else {
                // ì´ë¯¸ ì²˜ë¦¬ëœ deliveryNoë©´ ìŠ¤í‚µ (ì²« ë²ˆì§¸ ì•„ì´í…œë§Œ ì²˜ë¦¬)
                if (deliveryGroups[deliveryKey]) {
                  deliveryGroups[deliveryKey].itemCount++;
                  return;
                }
              }
              
              // ì²« ë²ˆì§¸ ì•„ì´í…œë§Œ ìƒì„¸ ì •ë³´ ìˆ˜ì§‘
          deliveryGroups[deliveryKey] = {
                deliveryNo: deliveryKey,
                orderMode: order.mode, // ì£¼ë¬¸ ë ˆë²¨ mode ì €ì¥
                itemCount: 1,
                hasDN: false,
                hasPI: false,
                hasPI2: false,
                hasInvoice: false,
                // D/N ì •ë³´
                dnno: '',
                dndate: '',
                // P/I ì •ë³´
                pino: '',
                pidate: '',
                piprice: '',
                // P/I2 ì •ë³´
                pino2: '',
                pidate2: '',
                piprice2: '',
                // Invoice ì •ë³´
                invoiceno: '',
                invoicedate: '',
                invoicedue: '',
                invoiceprice: ''
              };
              
              // D/N ì •ë³´ ìˆ˜ì§‘ (ê°œë³„ì ìœ¼ë¡œ ìˆëŠ” ê²ƒë§Œ)
              if (item['d/nno']) {
                deliveryGroups[deliveryKey].hasDN = true;
                deliveryGroups[deliveryKey].dnno = item['d/nno'];
              }
              if (item['d/ndate']) {
                deliveryGroups[deliveryKey].hasDN = true;
                deliveryGroups[deliveryKey].dndate = item['d/ndate'];
              }
              
              // P/I ì •ë³´ ìˆ˜ì§‘ (ê°œë³„ì ìœ¼ë¡œ ìˆëŠ” ê²ƒë§Œ)
              if (item['p/ino']) {
                deliveryGroups[deliveryKey].hasPI = true;
                deliveryGroups[deliveryKey].pino = item['p/ino'];
              }
              if (item['p/idate']) {
                deliveryGroups[deliveryKey].hasPI = true;
                deliveryGroups[deliveryKey].pidate = item['p/idate'];
              }
              if (item['p/iprice']) {
                deliveryGroups[deliveryKey].hasPI = true;
                deliveryGroups[deliveryKey].piprice = item['p/iprice'];
              }
              
              // P/I2 ì •ë³´ ìˆ˜ì§‘ (ê°œë³„ì ìœ¼ë¡œ ìˆëŠ” ê²ƒë§Œ)
              if (item['p/ino2']) {
                deliveryGroups[deliveryKey].hasPI2 = true;
                deliveryGroups[deliveryKey].pino2 = item['p/ino2'];
              }
              if (item['p/idate2']) {
                deliveryGroups[deliveryKey].hasPI2 = true;
                deliveryGroups[deliveryKey].pidate2 = item['p/idate2'];
              }
              if (item['p/iprice2']) {
                deliveryGroups[deliveryKey].hasPI2 = true;
                deliveryGroups[deliveryKey].piprice2 = item['p/iprice2'];
              }
              
              // Invoice ì •ë³´ ìˆ˜ì§‘ (ê°œë³„ì ìœ¼ë¡œ ìˆëŠ” ê²ƒë§Œ)
              if (item['invoiceno']) {
                deliveryGroups[deliveryKey].hasInvoice = true;
                deliveryGroups[deliveryKey].invoiceno = item['invoiceno'];
              }
              if (item['invoicedate']) {
                deliveryGroups[deliveryKey].hasInvoice = true;
                deliveryGroups[deliveryKey].invoicedate = item['invoicedate'];
              }
              if (item['invoicedue']) {
                deliveryGroups[deliveryKey].hasInvoice = true;
                deliveryGroups[deliveryKey].invoicedue = item['invoicedue'];
              }
              if (item['invoiceprice']) {
                deliveryGroups[deliveryKey].hasInvoice = true;
                deliveryGroups[deliveryKey].invoiceprice = item['invoiceprice'];
              }
            }
          });
        }
      });
      
      if (Object.keys(deliveryGroups).length === 0) {
        const modeText = selectedMode === 'all' ? '' : ` (${selectedMode} ëª¨ë“œ)`;
        fileListDiv.innerHTML = `<p>deliveryNoê°€ ìˆëŠ” ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤${modeText}.</p>`;
        return;
      }
      
      // deliveryNo ì •ë ¬ (ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬)
      const sortedDeliveryNos = sortDeliveryNosByDate(deliveryGroups);
      
      // ìƒì„¸í•œ í…Œì´ë¸” ìƒì„± (íƒ€ì´íŠ¸í•œ í­)
      let html = '<table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px;">';
      html += '<thead><tr>';
      html += '<th style="background-color: #f5f5f5; padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; width: 55px;">Delivery No</th>';
      html += '<th style="background-color: #f5f5f5; padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; width: 55px;">D/N</th>';
      html += '<th style="background-color: #f5f5f5; padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; width: 55px;">P/I</th>';
      html += '<th style="background-color: #f5f5f5; padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; width: 55px;">P/I2</th>';
      html += '<th style="background-color: #f5f5f5; padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; width: 55px;">Invoice</th>';
      html += '<th style="background-color: #f5f5f5; padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; width: 30px;">ê°œìˆ˜</th>';
      html += '<th style="background-color: #f5f5f5; padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; width: 55px;">Select</th>';
      html += '</tr></thead><tbody>';
      
      sortedDeliveryNos.forEach(deliveryNo => {
        const group = deliveryGroups[deliveryNo];
        html += `<tr>`;
        html += `<td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-size: 11px; vertical-align: top;">${group.deliveryNo}</td>`;
        
        // D/N ì»¬ëŸ¼ (2ì¤„)
        html += `<td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-size: 10px; vertical-align: top;">`;
        if (group.hasDN) {
          html += `${group.dnno || ''}<br>`;
          html += `${group.dndate || ''}`;
        }
        html += `</td>`;
        
        // P/I ì»¬ëŸ¼ (3ì¤„)
        html += `<td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-size: 10px; vertical-align: top;">`;
        if (group.hasPI) {
          html += `${group.pino || ''}<br>`;
          html += `${group.pidate || ''}<br>`;
          html += `${group.piprice || ''}`;
        }
        html += `</td>`;
        
        // P/I2 ì»¬ëŸ¼ (3ì¤„)
        html += `<td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-size: 10px; vertical-align: top;">`;
        if (group.hasPI2) {
          html += `${group.pino2 || ''}<br>`;
          html += `${group.pidate2 || ''}<br>`;
          html += `${group.piprice2 || ''}`;
        }
        html += `</td>`;
        
        // Invoice ì»¬ëŸ¼ (4ì¤„)
        html += `<td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-size: 10px; vertical-align: top;">`;
        if (group.hasInvoice) {
          html += `${group.invoiceno || ''}<br>`;
          html += `${group.invoicedate || ''}<br>`;
          html += `${group.invoicedue || ''}<br>`;
          html += `${group.invoiceprice || ''}`;
        }
        html += `</td>`;
        
        html += `<td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-size: 11px; vertical-align: top;">${group.itemCount}ê°œ</td>`;
        html += `<td style="padding: 6px; border: 1px solid #ddd; text-align: center; vertical-align: top;">`;
        html += `<button class="top-menu-btn" onclick="selectDeliveryNo('${group.deliveryNo}')" style="padding: 3px 6px; margin: 0 2px; border: 1px solid #ccc; border-radius: 3px; background: #fff; cursor: pointer; font-size: 10px; min-width: 50px; height: 24px; line-height: 1.2;">Select</button>`;
        html += `<button class="top-menu-btn" onclick="deleteDeliveryNo('${group.deliveryNo}')" style="padding: 3px 6px; margin: 0 2px; border: 1px solid #ccc; border-radius: 3px; background: #fff; cursor: pointer; font-size: 10px; min-width: 50px; height: 24px; line-height: 1.2;">Delete</button>`;
        html += `</td></tr>`;
      });
      
      html += '</tbody></table>';
      fileListDiv.innerHTML = html;
      
      } catch (error) {
      fileListDiv.innerHTML = `<p style='color: red;'>ì„œë²„ì—ì„œ íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>ì—ëŸ¬: ${error.message}</p>`;
    }
  }

  // deliveryNo ì„ íƒ í•¨ìˆ˜ (ê°„ì†Œí™”)
  async function selectDeliveryNo(deliveryNo) {
    // ì…ë ¥ í•„ë“œì— deliveryNo ì„¤ì •
    document.getElementById('deliveryNoInput').value = deliveryNo;
    
    // ëª¨ë‹¬ ë‹«ê¸°
    document.getElementById('serverFileModal').style.display = 'none';
    
    // ëª¨ë“œë¥¼ D/Nìœ¼ë¡œ ë³€ê²½
    const dnButton = document.getElementById('dnBtn');
    if (dnButton) {
      dnButton.click(); // D/N ë²„íŠ¼ í´ë¦­í•˜ì—¬ ëª¨ë“œ ë³€ê²½
    }
    
    // í•´ë‹¹ deliveryNoì˜ ì•„ì´í…œë“¤ì„ ì°¾ì•„ì„œ í…Œì´ë¸”ì— ë¡œë“œ
    try {
      const response = await fetch('/api/orders');
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      
      const allOrders = await response.json();
      const matchingItems = [];
      
      // í•´ë‹¹ deliveryNoë¥¼ ê°€ì§„ ëª¨ë“  ì•„ì´í…œ ì°¾ê¸°
      for (const order of allOrders) {
        if (order.items && order.items.length > 0) {
          for (const item of order.items) {
            if ((item.deliveryno || item.deliveryNo) === deliveryNo) {
              matchingItems.push({
                ...item,
                orderNo: order.orderNo,
                mode: order.mode || 'NT'
              });
            }
          }
        }
      }
      
      if (matchingItems.length > 0) {
        // D/N ì •ë³´ë¥¼ í—¤ë” í•„ë“œì— ë¡œë“œ
        const firstItem = matchingItems[0];
        if (firstItem['d/nno'] && firstItem['d/ndate']) {
          document.getElementById('tfNoInput').value = firstItem['d/nno'];
          document.getElementById('orderDateInput').value = firstItem['d/ndate'];
        }
        
        await fillTableWithDeliveryData(matchingItems, deliveryNo);
    } else {
        alert(`deliveryNo '${deliveryNo}'ì— í•´ë‹¹í•˜ëŠ” ì•„ì´í…œì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
      }
    } catch (error) {
      alert(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
    }
  }

  // deliveryNo ì‚­ì œ í•¨ìˆ˜ (deliveryNo í¬í•¨ ê·¸ ì´í›„ ëª¨ë“  ë°ì´í„° ì‚­ì œ)
  async function deleteDeliveryNo(deliveryNo) {
    if (!confirm(`deliveryNo '${deliveryNo}'ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
      return;
    }
    
    try {
      // ìƒˆë¡œìš´ /api/deletedeliveryNo API ì‚¬ìš©
      const response = await fetch('/api/deletedeliveryNo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          deliveryNo: deliveryNo
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      
      if (result.success) {
        alert(`deliveryNo '${deliveryNo}'ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\nì‚­ì œëœ ì•„ì´í…œ: ${result.updatedCount}ê°œ`);
        // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
        loadServerFileList();
    } else {
        alert(`ì‚­ì œ ì‹¤íŒ¨: ${result.message}`);
      }
    } catch (error) {
      alert(`ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
    }
  }

  // deliveryNo ë°ì´í„°ë¡œ í…Œì´ë¸” ì±„ìš°ê¸° í•¨ìˆ˜
  async function fillTableWithDeliveryData(items, targetDeliveryNo) {
    // console.log("[fillTableWithDeliveryData] í…Œì´ë¸” ì±„ìš°ê¸° ì‹œì‘:", items, "Target deliveryNo:", targetDeliveryNo);
    
    const tableBody = document.getElementById('shipmentTableBody');
    if (!tableBody) {
      // console.error("[fillTableWithDeliveryData] shipmentTableBodyë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
      return;
    }
    
    // ê¸°ì¡´ í…Œì´ë¸” ë‚´ìš© ì´ˆê¸°í™”
    tableBody.innerHTML = '';
    
    
    // ê° ì•„ì´í…œì— ëŒ€í•´ í–‰ ìƒì„± (createTableRow í•¨ìˆ˜ ì¬ì‚¬ìš©)
    for (let index = 0; index < items.length; index++) {
      const item = items[index];
      const row = createTableRow();
      
      // ì•„ì´í…œ ë°ì´í„°ë¡œ í–‰ ì±„ìš°ê¸°
      const modeSelect = row.querySelector('.modeDropdown');
      const orderNoSelect = row.querySelector('.orderDropdown');
      const itemNoSelect = row.querySelector('.itemDropdown');
      const itemInfoCell = row.querySelector('.itemInfoCell');
      const orderRInput = row.querySelector('.orderRInput');
      const partialRInput = row.querySelector('.partialRInput');
      const producedKGInput = row.querySelector('.producedKGInput');
      const deliveredKGInput = row.querySelector('.deliveredKGInput');
      const upInput = row.querySelector('.upInput');
      
      // ë“œë¡­ë‹¤ìš´ ê°’ ì €ì¥ (ì˜µì…˜ ë¡œë“œ í›„ ì„¤ì •)
      const displayMode = (item.mode === 'SM-B' || item.mode === 'SM-C') ? 'SM' : (item.mode || '');
      row.dataset.mode = displayMode;
      row.dataset.orderNo = item.orderNo || '';
      row.dataset.itemNo = item.itemNo || '';
      
      
      tableBody.appendChild(row);
    }
    
    // ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì¼ê´„ ë¡œë“œ
    setTimeout(async () => {
      const allRows = document.querySelectorAll('#shipmentTableBody tr');
      const uniqueModes = new Set();
      const uniqueOrderNos = new Set();
      
      // ëª¨ë“  í–‰ì—ì„œ ê³ ìœ í•œ Modeì™€ Order No ìˆ˜ì§‘
      allRows.forEach(row => {
        const modeSelect = row.querySelector('.modeDropdown');
        const orderNoSelect = row.querySelector('.orderDropdown');
        if (modeSelect && modeSelect.value) {
          uniqueModes.add(modeSelect.value);
        }
        if (orderNoSelect && orderNoSelect.value) {
          uniqueOrderNos.add(orderNoSelect.value);
        }
      });
      
      // ê° Modeì— ëŒ€í•´ Order No ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
      for (const mode of uniqueModes) {
        await updateOrderDropdown(mode);
      }
      
      // ê° Order Noì— ëŒ€í•´ Item No ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
      for (const orderNo of uniqueOrderNos) {
        const rowsWithOrderNo = Array.from(allRows).filter(row => {
          const orderNoSelect = row.querySelector('.orderDropdown');
          return orderNoSelect && orderNoSelect.value === orderNo;
        });
        
        for (const row of rowsWithOrderNo) {
          await updateItemDropdownForRow(row, orderNo);
        }
      }
      
      // ë“œë¡­ë‹¤ìš´ ê°’ ì„¤ì • (ì˜µì…˜ ë¡œë“œ í›„)
      allRows.forEach((row) => {
        const modeSelect = row.querySelector('.modeDropdown');
        
        if (modeSelect && row.dataset.mode) {
          modeSelect.value = row.dataset.mode;
          // Mode change ì´ë²¤íŠ¸ ìˆ˜ë™ íŠ¸ë¦¬ê±° (Order No ë“œë¡­ë‹¤ìš´ ë¡œë“œ)
          modeSelect.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
      
      // ì ì‹œ ëŒ€ê¸° í›„ Order Noì™€ Item No ì„¤ì •
      setTimeout(() => {
        allRows.forEach((row) => {
          const orderNoSelect = row.querySelector('.orderDropdown');
          
          if (orderNoSelect && row.dataset.orderNo) {
            orderNoSelect.value = row.dataset.orderNo;
            // Order No change ì´ë²¤íŠ¸ ìˆ˜ë™ íŠ¸ë¦¬ê±° (Item No ë“œë¡­ë‹¤ìš´ ë¡œë“œ)
            orderNoSelect.dispatchEvent(new Event('change', { bubbles: true }));
          }
        });
        
        // ë‹¤ì‹œ ì ì‹œ ëŒ€ê¸° í›„ Item No ì„¤ì •
        setTimeout(() => {
          allRows.forEach((row) => {
            const itemNoSelect = row.querySelector('.itemDropdown');
            
            if (itemNoSelect && row.dataset.itemNo) {
              itemNoSelect.value = row.dataset.itemNo;
            }
          });
        }, 200);
      }, 200);
      
      // ëª¨ë“  í–‰ì˜ ì•„ì´í…œ ì •ë³´ ì—…ë°ì´íŠ¸
      for (let i = 0; i < items.length && i < allRows.length; i++) {
      const item = items[i];
        const row = allRows[i];
        updateItemInfo(row, item);
      }
    }, 100);
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
    setupDragHandles();
    
    // Total ì—…ë°ì´íŠ¸
    updateTotal();
  }

  // Organize ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ í•¨ìˆ˜
  function setupOrganizeButton() {
    const organizeBtn = document.getElementById("organizeButton");
    if (organizeBtn) {
      organizeBtn.addEventListener("click", function() {
        organizeTable();
      });
    }
  }

  // Drag & Drop ê¸°ëŠ¥ (SortableJS ì‚¬ìš©)
  function setupDragHandles() {
    if (typeof Sortable !== 'undefined') {
      Sortable.create(document.getElementById("shipmentTableBody"), {
        animation: 150,
        handle: '.drag-handle',
        onEnd: function(evt) {
          updateTotal();
        }
      });
    }
  }

  // Open ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ í•¨ìˆ˜
  function setupOpenButton() {
    const openBtn = document.getElementById("openServerBtn");
    const modal = document.getElementById("serverFileModal");
    const closeBtn = document.querySelector(".close-server");
    const modeFilter = document.getElementById("modeFilter");
    
    if (!openBtn || !modal || !closeBtn) {
      // console.error("[OPEN] í•„ìš”í•œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
      return;
    }
    
    // Open ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    openBtn.addEventListener("click", () => {
      // console.log("[OPEN] ì„œë²„ íŒŒì¼ ëª¨ë‹¬ ì—´ê¸°");
      modal.style.display = "block";
      // ë“œë¡­ë‹¤ìš´ ê¸°ë³¸ê°’ì„ 'all'ë¡œ ì„¤ì •
      if (modeFilter) {
        modeFilter.value = 'all';
      }
      loadServerFileList();
    });
    
    // ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    closeBtn.addEventListener("click", () => {
      // console.log("[OPEN] ëª¨ë‹¬ ë‹«ê¸°");
      modal.style.display = "none";
    });
    
    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.addEventListener("click", (event) => {
      if (event.target === modal) {
        modal.style.display = "none";
      }
    });
    
    // ëª¨ë“œ í•„í„° ë³€ê²½ ì´ë²¤íŠ¸ ë“±ë¡
    if (modeFilter) {
      modeFilter.addEventListener("change", () => {
        // console.log("[FILTER] ëª¨ë“œ í•„í„° ë³€ê²½:", modeFilter.value);
        loadServerFileList();
      });
    }
  }

  // ========================================
  // Delivery No ì •ë ¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ (shipment.htmlê³¼ ë™ì¼)
  // ========================================
  
  // DD.MM.YYYY í˜•ì‹ì˜ ë‚ ì§œ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜
  function parseDateString(dateString) {
    if (!dateString) return null;
    
    const parts = dateString.split('.');
    if (parts.length >= 3) {
      const day = parseInt(parts[0]);
      const month = parseInt(parts[1]) - 1; // JavaScript ì›”ì€ 0ë¶€í„° ì‹œì‘
      const year = parseInt(parts[2]);
      return new Date(year, month, day);
    }
    
    return null;
  }
  
  // ì•„ì´í…œì—ì„œ ê°€ì¥ ì˜¤ë˜ëœ ë‚ ì§œ(Date ê°ì²´)ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
  function getOldestDateFromItem(item) {
    const dates = [];
    
    // ê° ë‚ ì§œë¥¼ íŒŒì‹±í•˜ì—¬ Date ê°ì²´ë¡œ ë³€í™˜
    if (item['d/ndate']) {
      const parsedDate = parseDateString(item['d/ndate']);
      if (parsedDate && parsedDate.getTime() > 0) dates.push(parsedDate);
    }
    if (item['p/idate']) {
      const parsedDate = parseDateString(item['p/idate']);
      if (parsedDate && parsedDate.getTime() > 0) dates.push(parsedDate);
    }
    if (item['p/i2date']) {
      const parsedDate = parseDateString(item['p/i2date']);
      if (parsedDate && parsedDate.getTime() > 0) dates.push(parsedDate);
    }
    if (item['invoicedate']) {
      const parsedDate = parseDateString(item['invoicedate']);
      if (parsedDate && parsedDate.getTime() > 0) dates.push(parsedDate);
    }
    
    // ë‚ ì§œê°€ ì—†ìœ¼ë©´ null ë°˜í™˜
    if (dates.length === 0) return null;
    
    // ê°€ì¥ ì˜¤ë˜ëœ ë‚ ì§œ ë°˜í™˜
    return dates.reduce((oldest, current) => {
      return current < oldest ? current : oldest;
    });
  }
  
  // Delivery Noë¥¼ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ëŠ” í•¨ìˆ˜ (shipmentupdate.html êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì •)
  function sortDeliveryNosByDate(deliveryGroups) {
    return Object.keys(deliveryGroups).sort((a, b) => {
      const aGroup = deliveryGroups[a];
      const bGroup = deliveryGroups[b];
      
      // shipmentupdate.htmlì˜ deliveryGroups êµ¬ì¡°ì— ë§ê²Œ ë‚ ì§œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const aItem = {
        'd/ndate': aGroup.dndate,
        'p/idate': aGroup.pidate,
        'p/i2date': aGroup.pidate2,
        'invoicedate': aGroup.invoicedate
      };
      
      const bItem = {
        'd/ndate': bGroup.dndate,
        'p/idate': bGroup.pidate,
        'p/i2date': bGroup.pidate2,
        'invoicedate': bGroup.invoicedate
      };
      
      // ê° delivery groupì˜ ê°€ì¥ ì˜¤ë˜ëœ ë‚ ì§œ ì°¾ê¸°
      const aOldestDate = getOldestDateFromItem(aItem);
      const bOldestDate = getOldestDateFromItem(bItem);
      
      // ê°€ì¥ ì˜¤ë˜ëœ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ìµœì‹ ì´ ìœ„ë¡œ)
      if (aOldestDate && bOldestDate) {
        return bOldestDate.getTime() - aOldestDate.getTime();
      } else if (aOldestDate) {
        return -1; // aê°€ ë‚ ì§œê°€ ìˆìœ¼ë©´ aê°€ ìœ„ë¡œ
      } else if (bOldestDate) {
        return 1; // bê°€ ë‚ ì§œê°€ ìˆìœ¼ë©´ bê°€ ìœ„ë¡œ
      } else {
        // ë‘˜ ë‹¤ ë‚ ì§œê°€ ì—†ìœ¼ë©´ EK-ë²ˆí˜¸ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
        const aNum = parseInt(a.replace('EK-', '')) || 0;
        const bNum = parseInt(b.replace('EK-', '')) || 0;
        return bNum - aNum;
      }
    });
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', async function() {
    // Delivery Noì™€ Date ì´ˆê¸°í™”
      initializeOrderFields();
    
    // ê¸°ë³¸ ëª¨ë“œ(D/N) placeholder ì„¤ì •
    document.getElementById('dueInput').placeholder = 'Empty';
    document.getElementById('invoicePriceInput').placeholder = 'Empty';
    
    // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    setupDocButtons();
    setupSimpleButton();
    setupPriceButton();
    setupOrganizeButton();
    setupDragHandles();
    setupExportButton();
    setupAddRowsButton();
    setupAddSingleButton();
    setupRefreshButton();
    setupOpenButton();
    
    
  });

  // ê°œë³„ ì•„ì´í…œ ê¸°ë¡ ì‚­ì œ í•¨ìˆ˜
  async function deleteItemRecord(row) {
    // Order Noì™€ Item No ê°€ì ¸ì˜¤ê¸°
    const orderNoSelect = row.querySelector('.orderDropdown');
    const itemNoSelect = row.querySelector('.itemDropdown');
    
    const orderNo = orderNoSelect ? orderNoSelect.value : '';
    const itemNo = itemNoSelect ? itemNoSelect.value : '';
    
    // Order Noì™€ Item Noê°€ ëª¨ë‘ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° - ê·¸ëƒ¥ í–‰ ì‚­ì œ
    if (!orderNo || !itemNo) {
      row.remove();
      updateTotal();
      return;
    }
    
    // Order Noì™€ Item Noê°€ ëª¨ë‘ ìˆëŠ” ê²½ìš° - API í˜¸ì¶œí•˜ì—¬ ë°ì´í„° ì‚­ì œ
    if (!confirm(`ì •ë§ë¡œ ì´ ì•„ì´í…œì˜ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì£¼ë¬¸ë²ˆí˜¸: ${orderNo}\nì•„ì´í…œë²ˆí˜¸: ${itemNo}\n\nì‚­ì œë  ì •ë³´:\n- Delivery No\n- D/N ì •ë³´\n- P/I ì •ë³´\n- Invoice ì •ë³´\n- ì„ ì R, DeliveredKG ë“±`)) {
      return;
    }
    
    try {
      const response = await fetch('/api/deletedeliveryNo', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          orderNo: orderNo,
          itemNo: itemNo
        })
      });

      const result = await response.json();

      if (result.success) {
        alert(`ì•„ì´í…œ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\nì£¼ë¬¸ë²ˆí˜¸: ${orderNo}\nì•„ì´í…œë²ˆí˜¸: ${itemNo}`);
        
        // í–‰ ì™„ì „íˆ ì‚­ì œ
        row.remove();
        
        // Total ì—…ë°ì´íŠ¸
        updateTotal();
      } else {
        alert(`ì‚­ì œ ì‹¤íŒ¨: ${result.message}`);
      }
    } catch (error) {
      alert('ì•„ì´í…œ ê¸°ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      console.error('Delete error:', error);
    }
  }

</script>
</body>
</html>


