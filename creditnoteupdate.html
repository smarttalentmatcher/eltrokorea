<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Credit Note Update</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      color: #000;
      line-height: 1.5;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: -1;
    }
    .page {
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border: 1px solid #ccc;
      box-sizing: border-box;
      position: relative;
      z-index: 1;
    }
    h1 {
      text-align: center;
      margin: 0;
      padding-bottom: 10px;
    }
    .top-menu {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .left-menu {
      display: flex;
      gap: 3px;
    }
    .right-menu {
      display: flex;
      gap: 3px;
    }
    .top-menu-btn {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
    }
    .top-menu-btn:hover {
      background: #f0f0f0;
      border-color: #999;
    }
    .top-menu-btn.doc-btn.selected {
      background: black;
      color: white;
      border-color: black;
    }
    .top-menu-btn.doc-btn {
      background: #fff;
      color: #000;
      border-color: #ccc;
    }
    .top-menu-btn.doc-btn:hover {
      background: #f0f0f0;
      border-color: #999;
    }
    .flex-container {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      gap: 20px;
      margin-top: 20px;
    }
    .box {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    textarea {
      width: 100%;
      height: 300px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 1rem;
      padding: 15px;
      margin-bottom: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      resize: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
      white-space: pre;
      word-wrap: break-word;
    }
    textarea:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 2px 12px rgba(0,123,255,0.2);
    }
    /* 모든 버튼 기본 스타일 - Export와 동일 */
    button {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
      transition: all 0.2s ease;
    }

    button:hover {
      background: #f0f0f0;
      border-color: #999;
    }

    .button-area {
      text-align: center;
      margin-top: 10px;
    }

    #outputArea[readonly] {
      background-color: #f9f9f9;
      color: #444;
    }
    /* Order Header 스타일 */
    .order-header {
      display: flex;
      justify-content: space-between;
      padding-top: 10px;
      margin-top: 10px;
      font-weight: bold;
      font-size: 1.1rem;
    }
    /* 왼쪽/중앙/오른쪽/Due 영역에 input 사용 */
    .order-header .left, .order-header .center, .order-header .right, .order-header .due {
      display: flex;
      align-items: center;
      gap: 5px;
      flex: 1;
      justify-content: center;
    }
    .order-header .left input,
    .order-header .center input,
    .order-header .right input,
    .order-header .due input {
      font-size: 1rem;
      width: 120px;
      padding: 4px 4px;
      height: 24px;
    }
    
    /* 모달 창 스타일 */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 0;
      border: 1px solid #888;
      width: 520px;
      max-width: 90%;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 15px 20px;
      background-color: #f8f8f8;
      border-bottom: 1px solid #ddd;
      border-radius: 5px 5px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      color: #333;
    }

    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: #000;
    }

    .close-delete-creditnote {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close-delete-creditnote:hover {
      color: #000;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 15px 20px;
      background-color: #f8f8f8;
      border-top: 1px solid #ddd;
      border-radius: 0 0 5px 5px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* 모달 내부 버튼 호버 효과 */
    .modal button:hover {
      background: #f0f0f0;
      border-color: #999;
    }
  </style>
</head>
<body>
<div class="page">
  <h1>Credit Note Update</h1>

  <div class="top-menu">
    <!-- 왼쪽: Credit Note, Open -->
    <div class="left-menu">
      <button type="button" onclick="location.href='creditnote.html'" class="top-menu-btn">Credit Note</button>
      <button type="button" id="openBtn" class="top-menu-btn">Open</button>
    </div>
    <!-- 오른쪽: C/N, O/P, L/P -->
    <div class="right-menu">
      <button id="cnBtn" class="top-menu-btn doc-btn selected">C/N</button>
      <button id="opBtn" class="top-menu-btn doc-btn">O/P</button>
      <button id="lpBtn" class="top-menu-btn doc-btn">L/P</button>
    </div>
  </div>

  <!-- CreditNote No, Date, Amount 입력 영역 -->
  <div class="order-header">
    <div class="left">
      <span style="font-size: 15px !important;">NO :</span>
      <input type="text" id="orderNoInput" autocomplete="off" />
    </div>
    <div class="center">
      <span style="font-size: 15px !important;">DATE :</span>
      <input type="text" id="orderDateInput" autocomplete="off" />
    </div>
    <div class="right">
      <span style="font-size: 15px !important;">€ :</span>
      <input type="text" id="amountInput" autocomplete="off" />
    </div>
    <div class="due">
      <span style="font-size: 15px !important;">$ :</span>
      <input type="text" id="dollarAmountInput" autocomplete="off" />
    </div>
  </div>

  <div class="flex-container">
    <div class="box">
      <textarea id="inputArea" placeholder=""></textarea>
    </div>
    <div class="box">
      <textarea id="outputArea" readonly placeholder=""></textarea>
    </div>
  </div>

  <div class="button-area">
    <button id="organizeBtn">Organize</button>
    <button id="convertBtn">Convert</button>
    <button id="exportBtn">Export</button>
    <button id="simpleBtn">Simple</button>
  </div>
</div>

<script>
  let globalParsedData = [];
  let selectedDoc = "C/N";

  // CreditNote No, Date, Amount 초기화 함수
  function initializeOrderFields() {
    if (sessionStorage.getItem("creditnoteInputData")) return;
    
    const inputIds = ["orderNoInput", "orderDateInput", "amountInput", "dollarAmountInput"];
    inputIds.forEach(id => {
      const input = document.getElementById(id);
      if (input) input.value = '';
    });
  }

  // placeholder 업데이트 함수
  function updatePlaceholder() {
    const inputArea = document.getElementById("inputArea");
    const amountInput = document.getElementById("amountInput");
    
    let inputAreaPlaceholder;
    if (selectedDoc === "C/N") {
      inputAreaPlaceholder = "C/N모드만 사용\n\n전체선택: Ctrl+A\n복사: Ctrl+C\n여기에 붙여넣기: Ctrl+V";
    } else if (selectedDoc === "O/P" || selectedDoc === "L/P") {
      inputAreaPlaceholder = "Empty";
    } else {
      inputAreaPlaceholder = "C/N모드만 사용\n\n전체선택: Ctrl+A\n복사: Ctrl+C\n여기에 붙여넣기: Ctrl+V";
    }
    
    if (inputArea) {
      inputArea.placeholder = inputAreaPlaceholder;
    }
    
    // O/P와 L/P 모드일 때 유로 입력 필드에 "Empty" placeholder 설정
    if (amountInput) {
      if (selectedDoc === "O/P" || selectedDoc === "L/P") {
        amountInput.placeholder = "Empty";
      } else {
        amountInput.placeholder = "";
      }
    }
  }

  // doc 버튼 이벤트 리스너 등록 함수
  function setupDocButtons() {
    const buttons = [
      { id: 'cnBtn', mode: 'C/N' },
      { id: 'opBtn', mode: 'O/P' },
      { id: 'lpBtn', mode: 'L/P' }
    ];
    
    buttons.forEach(({ id, mode }) => {
      const button = document.getElementById(id);
      if (button) {
        button.addEventListener('click', () => {
          selectedDoc = mode;
        updateDocButtonStates();
          updatePlaceholder();
          saveInputData();
        });
      }
    });
  }

  // Convert 버튼 이벤트 리스너 등록 함수
  function setupConvertButton() {
    const convertBtn = document.getElementById("convertBtn");
    if (!convertBtn) {
      console.error("[CONVERT] Convert 버튼을 찾을 수 없습니다!");
      return;
    }
    
    convertBtn.addEventListener("click", function() {
      convertData();
    });
  }
  
  // Convert 데이터 처리 함수
  function convertData() {
    // C/N 모드에서만 Convert 허용
    if (selectedDoc !== "C/N") {
      alert(`${selectedDoc} 모드에서는 Convert가 지원되지 않습니다. C/N 모드에서만 Convert를 사용할 수 있습니다.`);
      return;
    }
    
    const inputArea = document.getElementById("inputArea");
    if (!inputArea) {
      alert("입력 영역을 찾을 수 없습니다.");
      return;
    }
    
    const currentText = inputArea.value;
    if (!currentText.trim()) {
      alert("처리할 데이터가 없습니다.");
      return;
    }
    
    // 줄바꿈을 기준으로 각 줄을 분리
    const lines = currentText.split('\n').map(line => line.trim()).filter(line => line);
    
    let output = "";
    
    // NUINTEK 행들 처리
    const nuintekLines = lines.filter(line => line.includes('NUINTEK EUROPE SRL'));
    let nttotalcommission = 0;
    
    if (nuintekLines.length > 0) {
      output += "company - NT\n";
      
      // NUINTEK 행들의 마지막 열 값 총합 계산
      for (const line of nuintekLines) {
        const columns = line.split('\t');
        const lastColumn = columns[columns.length - 1];
        const cleanValue = lastColumn.replace(/,/g, '');
        const value = parseFloat(cleanValue) || 0;
        nttotalcommission += value;
      }
      
      output += `nttotalcommission - ${nttotalcommission.toFixed(2)}\n\n`;
    }
    
    // SUNGMOON 행들 처리
    const sungmoonLines = lines.filter(line => line.includes('SUNGMOON ELECTRONICS CO., LTD'));
    let smtotalcommission = 0;
    
    if (sungmoonLines.length > 0) {
      output += "company - SM\n";
      
      // 4열(인덱스 3) 기준으로 그룹화
      const invoiceGroups = {};
      for (const line of sungmoonLines) {
        const columns = line.split('\t');
        const invoiceNo = columns[3] || ''; // 4열 값
        
        if (!invoiceGroups[invoiceNo]) {
          invoiceGroups[invoiceNo] = [];
        }
        invoiceGroups[invoiceNo].push(line);
      }
      
      // 각 invoiceno별로 처리
      let invoiceCount = 1;
      
      for (const [invoiceNo, groupLines] of Object.entries(invoiceGroups)) {
        output += `invoiceno${invoiceCount} - ${invoiceNo}\n`;
        
        // 해당 invoiceno의 마지막 열 값 총합 계산
        let smCommission = 0;
        for (const line of groupLines) {
          const columns = line.split('\t');
          const lastColumn = columns[columns.length - 1];
          const cleanValue = lastColumn.replace(/,/g, '');
          const value = parseFloat(cleanValue) || 0;
          smCommission += value;
        }
        
        output += `smcommission${invoiceCount} - ${smCommission.toFixed(2)}\n`;
        smtotalcommission += smCommission;
        invoiceCount++;
      }
      
      output += `\nsmtotalcommission - ${smtotalcommission.toFixed(2)}\n`;
    }
    
    // totalcommission 계산: nttotalcommission + smtotalcommission
    const totalcommission = nttotalcommission + smtotalcommission;
    output += `\ntotalcommission - ${totalcommission.toFixed(2)}\n`;
    
    // 결과를 출력 영역에 설정
    const outputArea = document.getElementById("outputArea");
    if (outputArea) {
      outputArea.value = output;
    }
    
    // 전역 변수에 저장 (Export 시 사용)
    globalParsedData = [{ converted: true, output: output }];
  }

  // Organize 버튼 이벤트 리스너 등록 함수
  function setupOrganizeButton() {
    const organizeBtn = document.getElementById("organizeBtn");
    if (!organizeBtn) {
      return;
    }
    
    organizeBtn.addEventListener("click", function() {
      organizeData();
    });
  }

  // Organize 데이터 처리 함수
  function organizeData() {
    // C/N 모드에서만 Organize 허용
    if (selectedDoc !== "C/N") {
      alert(`${selectedDoc} 모드에서는 Organize가 지원되지 않습니다. C/N 모드에서만 Organize를 사용할 수 있습니다.`);
      return;
    }
    
    const inputArea = document.getElementById("inputArea");
    if (!inputArea) {
      alert("입력 영역을 찾을 수 없습니다.");
      return;
    }
    
    const currentText = inputArea.value;
    if (!currentText.trim()) {
      alert("처리할 데이터가 없습니다.");
      return;
    }
    
    // 줄바꿈을 기준으로 각 줄을 분리
    const lines = currentText.split('\n');
    const processedLines = [];
    
    // 삭제할 헤더들 정의
    const headersToRemove = [
      'Customer', 'Account', 'End User', 'Division', 'Material', 'Filmtyp',
      'Width mm', 'Net Weight kg', 'Invoice Value €', 'Sales Organisation',
      'Order Number', 'Invoice Number', 'Invoice Date', 'Film Family',
      'Country', 'Customer Order Number', 'Unit', 'Commission EUR/kg',
      'Commission EUR', 'mm"', 'kg"', 'Value €"', 'Organisation"',
      'Number"', 'Date"', 'Family"', 'Order Number"', 'EUR"'
    ];
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();
      
      // 헤더 행인지 확인
      const isHeader = headersToRemove.some(header => 
        line === header || 
        line.includes(header) || 
        line.startsWith('Customer') || 
        line.startsWith('Filmtyp')
      );
      
      // 헤더가 아니면 유지
      if (!isHeader) {
        // 탭으로 구분된 데이터인지 확인
        if (line.includes('\t')) {
          const columns = line.split('\t');
          
          // 필요한 열만 추출 (1, 6, 8, 12, 18, 19번째 열)
          const keepColumns = [1, 6, 8, 12, 18, 19];
          const processedColumns = [];
          
          for (let j = 0; j < keepColumns.length; j++) {
            const columnIndex = keepColumns[j] - 1; // 0-based로 변환
            if (columnIndex < columns.length) {
              processedColumns.push(columns[columnIndex]);
          } else {
              processedColumns.push(''); // 열이 없으면 빈 값
            }
          }
          
          const processedLine = processedColumns.join('\t');
          processedLines.push(processedLine);
          } else {
          // 탭으로 구분되지 않은 일반 텍스트는 그대로 유지
          processedLines.push(lines[i]);
        }
      }
    }
    
    // Total로 시작하는 행들 삭제
    const filteredLines = processedLines.filter(line => {
      const trimmedLine = line.trim();
      return !trimmedLine.startsWith('Total');
    });
      
    // 1열 기준으로 그룹화하고 각 그룹 내에서 4열(숫자) 기준으로 정렬
    const sortedLines = sortByGroups(filteredLines);
    
    // 결과를 입력 영역에 설정
    inputArea.value = sortedLines.join('\n');
    
    // 포커스 설정
    inputArea.focus();
  }

  // 1열 기준으로 그룹화하고 각 그룹 내에서 4열(숫자) 기준으로 정렬하는 함수
  function sortByGroups(lines) {
    // 1열 기준으로 그룹화
    const groups = {};
    
    for (const line of lines) {
      if (line.includes('\t')) {
        const columns = line.split('\t');
        const firstColumn = columns[0] || ''; // 1열 값
        
        if (!groups[firstColumn]) {
          groups[firstColumn] = [];
        }
        groups[firstColumn].push(line);
      } else {
        // 탭으로 구분되지 않은 경우 별도 처리
        if (!groups['_other']) {
          groups['_other'] = [];
        }
        groups['_other'].push(line);
      }
    }
    
    // 각 그룹 내에서 4열(숫자) 기준으로 정렬
    const sortedGroups = {};
    for (const [groupKey, groupLines] of Object.entries(groups)) {
      sortedGroups[groupKey] = groupLines.sort((a, b) => {
        // 탭으로 구분된 데이터인지 확인
        if (a.includes('\t') && b.includes('\t')) {
          const aColumns = a.split('\t');
          const bColumns = b.split('\t');
          
          // 4열(인덱스 3)의 숫자 값 비교
          const aValue = parseFloat(aColumns[3]) || 0;
          const bValue = parseFloat(bColumns[3]) || 0;
          
          return aValue - bValue; // 작은 숫자가 먼저 오도록
        }
        
        // 탭으로 구분되지 않은 경우 원래 순서 유지
        return 0;
      });
    }
    
    // 정렬된 그룹들을 하나의 배열로 합치기 (1열 순서대로)
    const result = [];
    const groupKeys = Object.keys(sortedGroups).sort();
    
    for (const groupKey of groupKeys) {
      result.push(...sortedGroups[groupKey]);
    }
    
    return result;
  }


  // Export 버튼 이벤트 리스너 등록 함수
  function setupExportButton() {
    const exportBtn = document.getElementById("exportBtn");
    if (!exportBtn) {
        return;
      }
      
    exportBtn.addEventListener("click", function() {
      exportCreditNoteData();
    });
  }

  // Simple 버튼 이벤트 리스너 등록 함수
  function setupSimpleButton() {
    const simpleBtn = document.getElementById("simpleBtn");
    if (!simpleBtn) {
        return;
      }
      
    simpleBtn.addEventListener("click", function() {
      simpleCreditNoteData();
    });
  }

  // Credit Note 데이터 Export 함수
  async function exportCreditNoteData() {
    try {
      // DOC 모드 확인 - C/N 모드에서만 Export 허용
      if (selectedDoc !== "C/N") {
        alert(`${selectedDoc} 모드에서는 Export가 지원되지 않습니다. C/N 모드에서만 Export를 사용할 수 있습니다.`);
        return;
      }
      
      // 1. 입력값 가져오기
      const creditNoteNo = document.getElementById("orderNoInput").value.trim();
      const creditNoteDate = document.getElementById("orderDateInput").value.trim();
      const euro = document.getElementById("amountInput").value.trim();
      const dollar = document.getElementById("dollarAmountInput").value.trim();
      const outputArea = document.getElementById("outputArea");
      
      if (!creditNoteNo) {
        alert("CreditNote No를 입력해주세요.");
      return;
    }
    
      if (!creditNoteDate) {
        alert("Date를 입력해주세요.");
        return;
      }
      
      if (!outputArea || !outputArea.value.trim()) {
        alert("Convert된 데이터가 없습니다. 먼저 Convert 버튼을 눌러주세요.");
        return;
      }
      
      // 2. Convert된 데이터 파싱 (JSON 형태인지 텍스트 형태인지 확인)
      let convertData;
      try {
        // JSON 형태인 경우 (Select로 불러온 데이터)
        convertData = JSON.parse(outputArea.value);
      } catch (e) {
        // 텍스트 형태인 경우 (Convert 버튼으로 생성된 데이터)
        convertData = parseConvertData(outputArea.value);
      }
      
      // 3. Credit Note 객체 생성 (4개 필드 모두 포함)
      const creditNoteData = {
        "c/nno": creditNoteNo,
        "c/ndate": creditNoteDate,
        "c/neuro": euro,
        "c/ndollar": dollar,
        data: convertData
      };
      
      // 4. 서버에 저장 (서버에서 기존 데이터와 병합)
      await saveCreditNoteToServer(creditNoteData);
      
      alert(`Credit Note 데이터가 성공적으로 저장되었습니다!`);
      
      // 5. creditnote.html로 이동
      window.location.href = 'creditnote.html';
      
    } catch (error) {
      console.error("Export 중 오류:", error);
      alert("Export 중 오류가 발생했습니다: " + error.message);
    }
  }

  // Simple Credit Note 데이터 처리 함수
  async function simpleCreditNoteData() {
    try {
      // 1. 입력값 가져오기
      const creditNoteNo = document.getElementById("orderNoInput").value.trim();
      const creditNoteDate = document.getElementById("orderDateInput").value.trim();
      const euro = document.getElementById("amountInput").value.trim();
      const dollar = document.getElementById("dollarAmountInput").value.trim();
      
      if (!creditNoteNo) {
        alert("CreditNote No를 입력해주세요.");
        return;
      }
      
      if (!creditNoteDate) {
        alert("Date를 입력해주세요.");
        return;
      }
      
      // Euro 값은 선택사항 (빈 값 허용)
      
      // 2. DOC 모드에 따른 다른 처리
      let simpleCreditNoteData;
      
      if (selectedDoc === "C/N") {
        // C/N 모드: 4개 필드 저장 (추가 필드 없음)
        simpleCreditNoteData = {
          "c/nno": creditNoteNo,
          "c/ndate": creditNoteDate,
          "c/neuro": euro,
          "c/ndollar": dollar
        };
      } else if (selectedDoc === "O/P") {
        // O/P 모드: Over Payment 데이터 생성 (o/peuro 제외)
        simpleCreditNoteData = {
          "o/pno": creditNoteNo,
          "o/pdate": creditNoteDate,
          "o/pdollar": dollar
        };
      } else if (selectedDoc === "L/P") {
        // L/P 모드: Less Payment 데이터 생성 (l/peuro 제외)
        simpleCreditNoteData = {
          "l/pno": creditNoteNo,
          "l/pdate": creditNoteDate,
          "l/pdollar": dollar
        };
      } else {
        alert(`지원되지 않는 모드입니다: ${selectedDoc}`);
        return;
      }
      
      // 3. 서버에 저장
      await saveCreditNoteToServer(simpleCreditNoteData);
      
      const modeText = selectedDoc === "C/N" ? "Credit Note" : 
                      selectedDoc === "O/P" ? "Over Payment" : 
                      selectedDoc === "L/P" ? "Less Payment" : "데이터";
      
      alert(`Simple ${modeText} 데이터가 성공적으로 저장되었습니다!`);
      
      // 4. creditnote.html로 이동
      window.location.href = 'creditnote.html';
      
    } catch (error) {
      console.error("Simple Export 중 오류:", error);
      alert("Simple Export 중 오류가 발생했습니다: " + error.message);
    }
  }


  // creditnote 데이터를 서버에 저장하는 함수
  async function saveCreditNoteToServer(creditNoteData) {
    try {
      const response = await fetch('/api/creditnote', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(creditNoteData)
      });
      
      if (response.ok) {
        const result = await response.json();
        console.log('creditnote 데이터 저장 성공:', result);
        return result;
      } else {
        throw new Error(`서버 저장 실패: ${response.status}`);
      }
    } catch (error) {
      console.error('creditnote 데이터 저장 실패:', error);
      throw error;
    }
  }

  // Convert된 데이터 파싱 함수
  function parseConvertData(convertText) {
    const lines = convertText.split('\n').map(line => line.trim()).filter(line => line);
    const data = {};
    let currentCompany = null;
    
    for (const line of lines) {
      if (line.includes(' - ')) {
        const [key, value] = line.split(' - ');
        
        // company 필드 처리
        if (key === 'company') {
          currentCompany = value;
          // company 필드는 저장하지 않음 (별도 처리)
          continue;
        }
        
        // sum은 저장하지 않음
        if (key !== 'sum') {
          // NT 관련 데이터인지 확인
          if (currentCompany === 'NT' && key.includes('nt')) {
            data[key] = value;
          }
          // SM 관련 데이터인지 확인
          else if (currentCompany === 'SM' && (key.includes('sm') || key.includes('invoice'))) {
            data[key] = value;
          }
          // 공통 데이터 (totalcommission 등)
          else if (key === 'totalcommission' || key === 'smtotalcommission' || key === 'nttotalcommission') {
            data[key] = value;
          }
        }
      }
    }
    
    return data;
  }

  
  // 1열 기준으로 그룹화하고 각 그룹 내에서 4열(숫자) 기준으로 정렬하는 함수
  function sortByGroups(lines) {
    // 1열 기준으로 그룹화
    const groups = {};
    
    for (const line of lines) {
      if (line.includes('\t')) {
        const columns = line.split('\t');
        const firstColumn = columns[0] || ''; // 1열 값
        
        if (!groups[firstColumn]) {
          groups[firstColumn] = [];
        }
        groups[firstColumn].push(line);
        } else {
        // 탭으로 구분되지 않은 경우 별도 처리
        if (!groups['_other']) {
          groups['_other'] = [];
        }
        groups['_other'].push(line);
      }
    }
    
    // 각 그룹 내에서 4열(숫자) 기준으로 정렬
    const sortedGroups = {};
    for (const [groupKey, groupLines] of Object.entries(groups)) {
      sortedGroups[groupKey] = groupLines.sort((a, b) => {
        // 탭으로 구분된 데이터인지 확인
        if (a.includes('\t') && b.includes('\t')) {
          const aColumns = a.split('\t');
          const bColumns = b.split('\t');
          
          // 4열(인덱스 3)의 숫자 값 비교
          const aValue = parseFloat(aColumns[3]) || 0;
          const bValue = parseFloat(bColumns[3]) || 0;
          
          return aValue - bValue; // 작은 숫자가 먼저 오도록
        }
        
        // 탭으로 구분되지 않은 경우 원래 순서 유지
        return 0;
      });
    }
    
    // 정렬된 그룹들을 하나의 배열로 합치기 (1열 순서대로)
    const result = [];
    const groupKeys = Object.keys(sortedGroups).sort();
    
    for (const groupKey of groupKeys) {
      result.push(...sortedGroups[groupKey]);
    }
    
    return result;
  }

  // 입력값 저장 함수
  function saveInputData() {
    if (window.isRestoring) return;
    
      const inputData = {
      inputArea: document.getElementById("inputArea")?.value || "",
      outputArea: document.getElementById("outputArea")?.value || "",
      orderNo: document.getElementById("orderNoInput")?.value || "",
      orderDate: document.getElementById("orderDateInput")?.value || "",
      euro: document.getElementById("amountInput")?.value || "",
      dollar: document.getElementById("dollarAmountInput")?.value || "",
        selectedDoc: selectedDoc
      };
      
    try {
      sessionStorage.setItem("creditnoteInputData", JSON.stringify(inputData));
    } catch (error) {
      console.error("데이터 저장 중 오류:", error);
    }
  }
  
  // 입력값 복원 함수
  function restoreInputData() {
    const savedData = sessionStorage.getItem("creditnoteInputData");
    if (!savedData) return;
    
      try {
        const inputData = JSON.parse(savedData);
      window.isRestoring = true;
        
        setTimeout(() => {
        const elements = {
          inputArea: document.getElementById("inputArea"),
          outputArea: document.getElementById("outputArea"),
          orderNoInput: document.getElementById("orderNoInput"),
          orderDateInput: document.getElementById("orderDateInput"),
          amountInput: document.getElementById("amountInput"),
          dollarAmountInput: document.getElementById("dollarAmountInput")
        };
        
        if (elements.inputArea && inputData.inputArea) elements.inputArea.value = inputData.inputArea;
        if (elements.outputArea && inputData.outputArea) elements.outputArea.value = inputData.outputArea;
        if (elements.orderNoInput && inputData.orderNo) elements.orderNoInput.value = inputData.orderNo;
        if (elements.orderDateInput && inputData.orderDate) elements.orderDateInput.value = inputData.orderDate;
        if (elements.amountInput && inputData.euro) elements.amountInput.value = inputData.euro;
        if (elements.dollarAmountInput && inputData.dollar) elements.dollarAmountInput.value = inputData.dollar;
        
        if (inputData.selectedDoc) {
          selectedDoc = inputData.selectedDoc;
          updateDocButtonStates();
          updatePlaceholder();
        }
        
        setTimeout(() => window.isRestoring = false, 200);
      }, 100);
      
    } catch (error) {
      console.error("데이터 복원 중 오류:", error);
    }
  }
  
  // 자동 저장 이벤트 리스너 설정
  function setupAutoSave() {
    const inputIds = ["inputArea", "outputArea", "orderNoInput", "orderDateInput", "amountInput", "dollarAmountInput"];
    
    inputIds.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('input', saveInputData);
      }
    });
  }
  
  // DOC 버튼 상태 업데이트 함수
  function updateDocButtonStates() {
    const cnBtn = document.getElementById("cnBtn");
    const opBtn = document.getElementById("opBtn");
    const lpBtn = document.getElementById("lpBtn");
    
    // 모든 버튼에서 selected 클래스 제거
    if (cnBtn) cnBtn.classList.remove("selected");
    if (opBtn) opBtn.classList.remove("selected");
    if (lpBtn) lpBtn.classList.remove("selected");
    
    // 선택된 모드에 따라 해당 버튼에 selected 클래스 추가
    if (selectedDoc === "C/N" && cnBtn) {
      cnBtn.classList.add("selected");
    } else if (selectedDoc === "O/P" && opBtn) {
      opBtn.classList.add("selected");
    } else if (selectedDoc === "L/P" && lpBtn) {
      lpBtn.classList.add("selected");
    }
  }


  // Open 버튼 이벤트 리스너
  document.getElementById("openBtn").addEventListener("click", async () => {
    console.log("[OPEN] Credit Note 모달 열기");
    const modal = document.getElementById("deleteCreditNoteModal");
    if (modal) {
      modal.style.display = "block";
      await loadCreditNoteDataForDelete();
    }
  });
  
  // 모달 닫기 함수
  function closeDeleteModal() {
    document.getElementById("deleteCreditNoteModal").style.display = "none";
  }
  
  // 모달 닫기 이벤트 리스너 (이벤트 위임 사용)
  document.addEventListener("click", (event) => {
    const modal = document.getElementById("deleteCreditNoteModal");
    
    // 모달 외부 클릭 시 닫기
    if (event.target === modal) {
      modal.style.display = "none";
    }
    
    // 닫기 버튼 클릭 시 닫기
    if (event.target.classList.contains("close-delete-creditnote")) {
      closeDeleteModal();
    }
  });

  // Credit Note 데이터 로드 함수
  async function loadCreditNoteDataForDelete() {
    try {
      const response = await fetch('/api/creditnote');
      if (!response.ok) {
        throw new Error('Credit Note 데이터 로드 실패');
      }
      
      const creditNoteData = await response.json();
      console.log("[OPEN] 로드된 Credit Note 데이터:", creditNoteData);
      
      displayCreditNoteList(creditNoteData);
      
    } catch (error) {
      console.error('[OPEN] Credit Note 데이터 로드 중 오류:', error);
      document.getElementById('creditNoteList').innerHTML = '<p style="color: red; text-align: center;">데이터 로드 중 오류가 발생했습니다.</p>';
    }
  }

  // Credit Note 목록 표시 함수
  function displayCreditNoteList(data) {
    const creditNoteList = document.getElementById('creditNoteList');
    const typeFilter = document.getElementById('typeFilter');
    const selectedType = typeFilter ? typeFilter.value : 'all';
    
    console.log('[FILTER] 선택된 타입:', selectedType);
    console.log('[FILTER] 전체 데이터 개수:', data.length);
    
    const filteredData = selectedType === 'all' ? data : data.filter(item => {
      const typeMap = { 'C/N': 'c/nno', 'O/P': 'o/pno', 'L/P': 'l/pno' };
      return item[typeMap[selectedType]];
    });
    
    console.log('[FILTER] 필터링된 데이터 개수:', filteredData.length);
    
    if (filteredData.length === 0) {
      creditNoteList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">열기할 항목이 없습니다.</p>';
      return;
    }
    
    const tableHtml = createCreditNoteTable(filteredData);
    creditNoteList.innerHTML = tableHtml;
    
    setupTypeFilterListener();
  }

  // 테이블 생성 함수
  function createCreditNoteTable(data) {
    const tableHeader = `
      <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
        <thead>
          <tr style="background-color: #f8f9fa;">
            <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 60px;">TYPE</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 100px;">NO</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 100px;">DATE</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 100px;">EURO(€)</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 100px;">DOLLAR($)</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 30px;">✓</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 120px;">ACTION</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    const tableRows = data.map((item, index) => {
      const itemData = extractItemData(item);
      return createTableRow(itemData, index);
    }).join('');
    
    return tableHeader + tableRows + '</tbody></table>';
  }

  // 아이템 데이터 추출 함수
  function extractItemData(item) {
    const typeMap = {
      'c/nno': { type: 'C/N', no: 'c/nno', date: 'c/ndate', euro: 'data.totalcommission', dollar: 'c/ndollar' },
      'o/pno': { type: 'O/P', no: 'o/pno', date: 'o/pdate', euro: 'o/peuro', dollar: 'o/pdollar' },
      'l/pno': { type: 'L/P', no: 'l/pno', date: 'l/pdate', euro: 'l/peuro', dollar: 'l/pdollar' }
    };
    
    for (const [key, fields] of Object.entries(typeMap)) {
      if (item[key]) {
        return {
          type: fields.type,
          no: item[fields.no],
          date: item[fields.date] || '',
          euro: fields.euro.includes('.') ? 
            (item.data?.totalcommission || '') : 
            (item[fields.euro] || ''),
          dollar: item[fields.dollar] || '',
          isused: item.isused || false
        };
      }
    }
    return { type: '', no: '', date: '', euro: '', dollar: '', isused: false };
  }

  // 테이블 행 생성 함수
  function createTableRow(itemData, index) {
    return `
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${itemData.type}</td>
        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${itemData.no}</td>
        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${itemData.date}</td>
        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${itemData.euro}</td>
        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${itemData.dollar}</td>
        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
          <input type="checkbox" ${itemData.isused ? 'checked' : ''} style="transform: scale(1.2); pointer-events: none; accent-color: #007bff; background-color: ${itemData.isused ? '#007bff' : '#fff'}; border: 2px solid #007bff;">
        </td>
        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
          <button onclick="selectSingleItem(${index})" class="top-menu-btn" style="padding: 3px 6px; margin: 0 2px; border: 1px solid #ccc; border-radius: 3px; background: #fff; cursor: pointer; font-size: 10px; min-width: 50px; height: 24px; line-height: 1.2;">Select</button>
          <button onclick="deleteSingleItem(${index})" class="top-menu-btn" style="padding: 3px 6px; margin: 0 2px; border: 1px solid #ccc; border-radius: 3px; background: #fff; cursor: pointer; font-size: 10px; min-width: 50px; height: 24px; line-height: 1.2;">Delete</button>
        </td>
      </tr>
    `;
  }
    
  // 타입 필터 이벤트 리스너 (이벤트 위임 사용)
  function setupTypeFilterListener() {
    document.addEventListener('change', (event) => {
      if (event.target.id === 'typeFilter') {
        const typeFilter = event.target;
        const selectedType = typeFilter.value;
        
        // 현재 모달의 데이터를 다시 로드하여 필터링
        loadCreditNoteDataForDelete();
      }
    });
  }

  // 개별 항목 선택 함수
  async function selectSingleItem(index) {
    try {
      // 현재 표시된 테이블에서 선택할 항목 찾기
      const tableRows = document.querySelectorAll('#creditNoteList tbody tr');
      const targetRow = tableRows[index];
      
      if (!targetRow) {
        alert('선택할 항목을 찾을 수 없습니다.');
        return;
      }
      
      // 항목 식별자 추출 (cells[1]이 NO 열)
      const itemNo = targetRow.cells[1].textContent.trim();
      
      if (!itemNo) {
        alert('선택할 항목 정보를 찾을 수 없습니다.');
        return;
      }
      
      // 서버에서 전체 Credit Note 데이터 불러오기
      const response = await fetch('/api/creditnote');
      if (!response.ok) {
        throw new Error('Credit Note 데이터 로드 실패');
      }
      
      const creditNoteData = await response.json();
      const selectedItem = creditNoteData.find(item => 
        item['c/nno'] === itemNo || item['o/pno'] === itemNo || item['l/pno'] === itemNo
      );
      
      if (!selectedItem) {
        alert('선택한 항목의 데이터를 찾을 수 없습니다.');
        return;
      }
      
      // DOC 모드 설정
      if (selectedItem['c/nno']) {
        selectedDoc = "C/N";
      } else if (selectedItem['o/pno']) {
        selectedDoc = "O/P";
      } else if (selectedItem['l/pno']) {
        selectedDoc = "L/P";
      }
      
      // DOC 버튼 상태 업데이트
      updateDocButtonStates();
      
      // 상단 빈칸에 값 설정
      document.getElementById("orderNoInput").value = selectedItem['c/nno'] || selectedItem['o/pno'] || selectedItem['l/pno'] || '';
      document.getElementById("orderDateInput").value = selectedItem['c/ndate'] || selectedItem['o/pdate'] || selectedItem['l/pdate'] || '';
      document.getElementById("amountInput").value = selectedItem['c/neuro'] || selectedItem['o/peuro'] || selectedItem['l/peuro'] || '';
      document.getElementById("dollarAmountInput").value = selectedItem['c/ndollar'] || selectedItem['o/pdollar'] || selectedItem['l/pdollar'] || '';
      
      // 왼쪽 inputArea는 비우기
      document.getElementById("inputArea").value = '';
      
      // 오른쪽 outputArea에 data 객체 로드
      if (selectedItem.data) {
        const dataString = JSON.stringify(selectedItem.data, null, 2);
        document.getElementById("outputArea").value = dataString;
      } else {
        document.getElementById("outputArea").value = '';
      }
      
      // 모달 닫기
      closeDeleteModal();
      
    } catch (error) {
      console.error('선택 중 오류:', error);
      alert('선택 중 오류가 발생했습니다.');
    }
  }

  // 개별 항목 삭제 함수
  async function deleteSingleItem(index) {
    try {
      if (!confirm('이 항목을 삭제하시겠습니까?')) return;
      
      // 현재 표시된 테이블에서 삭제할 항목 찾기
      const tableRows = document.querySelectorAll('#creditNoteList tbody tr');
      const targetRow = tableRows[index];
      
      if (!targetRow) {
        alert('삭제할 항목을 찾을 수 없습니다.');
        return;
      }
      
      // 항목 식별자 추출 (cells[1]이 NO 열, cells[0]이 TYPE 열)
      const itemNo = targetRow.cells[1].textContent.trim();
      const itemTypeDisplay = targetRow.cells[0].textContent.trim();
      
      if (!itemNo || !itemTypeDisplay) {
        alert('삭제할 항목 정보를 찾을 수 없습니다.');
        return;
      }
      
      // 타입 매핑 (표시용 → API용)
      const typeMap = { 'C/N': 'c/nno', 'O/P': 'o/pno', 'L/P': 'l/pno' };
      const itemType = typeMap[itemTypeDisplay];
      
      if (!itemType) {
        alert('알 수 없는 항목 타입입니다.');
        return;
      }
      
      // 서버에서 해당 항목 삭제 (POST API 사용)
      const deleteResponse = await fetch('/api/creditnote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          action: 'delete',
          type: itemType, 
          identifier: itemNo 
        })
      });
      
      if (deleteResponse.ok) {
        alert('항목이 삭제되었습니다.');
        await loadCreditNoteDataForDelete(); // 데이터 새로고침
      } else {
        alert('삭제 중 오류가 발생했습니다.');
      }
    } catch (error) {
      console.error('삭제 중 오류:', error);
      alert('삭제 중 오류가 발생했습니다.');
    }
  }

  // 행에서 아이템 타입 추출
  async function getItemTypeFromRow(row) {
    const itemNo = row.cells[0].textContent.trim();
    if (!itemNo) return null;
    
    const typeFilter = document.getElementById('typeFilter');
    const selectedType = typeFilter?.value || 'all';
    
    // 'all'인 경우 실제 데이터에서 타입 확인
    if (selectedType === 'all') {
      try {
        const response = await fetch('/api/creditnote');
        if (response.ok) {
          const creditNoteData = await response.json();
          const item = creditNoteData.find(item => 
            item['c/nno'] === itemNo || item['o/pno'] === itemNo || item['l/pno'] === itemNo
          );
          
          if (item) {
            if (item['c/nno'] === itemNo) return 'c/nno';
            if (item['o/pno'] === itemNo) return 'o/pno';
            if (item['l/pno'] === itemNo) return 'l/pno';
          }
        }
      } catch (error) {
        console.error('타입 확인 중 오류:', error);
      }
      return 'c/nno'; // 기본값
    }
    
    const typeMap = { 'C/N': 'c/nno', 'O/P': 'o/pno', 'L/P': 'l/pno' };
    return typeMap[selectedType] || 'c/nno';
  }

  // 페이지 로드 시 초기화
  document.addEventListener('DOMContentLoaded', function() {
    initializeOrderFields();
    updatePlaceholder();
    setupAutoSave();
    restoreInputData();
    setupDocButtons();
    setupConvertButton();
    setupExportButton();
    setupSimpleButton();
    setupOrganizeButton();
  });
</script>

<!-- Credit Note 모달 -->
<div id="deleteCreditNoteModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Credit Note 열기</h3>
      <span class="close-delete-creditnote">&times;</span>
    </div>
    <div class="modal-body">
      <div style="margin-bottom: 15px;">
        <select id="typeFilter" style="width: 67px; padding: 6px 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
          <option value="all">전체</option>
          <option value="L/P">L/P</option>
          <option value="O/P">O/P</option>
          <option value="C/N">C/N</option>
        </select>
      </div>
      <div id="creditNoteList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
      </div>
    </div>
  </div>
</div>
</body>
</html>


